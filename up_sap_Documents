USE [HNT_TRZ]
GO
/****** Object:  StoredProcedure [dbo].[up_sap_Documents]    Script Date: 07/05/2025 01:09:23 p. m. ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[up_sap_Documents]
	@TipoConsulta		int,
	@ParamsDefinitions  NVARCHAR(MAX) = NULL,
	@skip				int = null,
	@pageSize			int = null,
	@Usuarios 			varchar(MAX) = null,
	@idDocumento		numeric(18,0) = NULL,
	@DocEntry			numeric(18,0) = NULL,
	@DocNum				numeric(18,0) = NULL,
	@ObjType			numeric(18,0) = NULL,
	@CardCode			nvarchar(50)  = NULL,
	@CardName			nvarchar(50) = NULL,
	@DocDate			nvarchar(50) = NULL,
	@DocDateHasta		nvarchar(50) = NULL,
	@NumAtCard			nvarchar(50) = '',
	@Series				INT	= 0,
	@CIA				VARCHAR(100) = NULL,
	@CardType			VARCHAR(1) = NULL,
	@PriceList			INT = 16,
	@Key				VARCHAR(100) = NULL,
	@TblUsuario			varchar(50) = NULL,
	@FieldID			smallint = NULL,
	@Desde				DATE = NULL,
	@Hasta				DATE = NULL,
	@sType				VARCHAR(15) = NULL
	-----------------------------------------
   ,@DocDueDate			datetime		= NULL
   ,@TaxDate			datetime		= NULL
   ,@DocType			VARCHAR(100)	= 'I'
   ,@DocCur				varchar(15) = NULL
   ,@DocTotalFC			decimal(18,4) = 0
   ,@DocTotal			decimal(18,4) = 0
   ,@VatSum				decimal(18,4) = 0
   ,@VatSumFC			decimal(18,4) = 0
   ,@DocRate			decimal(18,8) = NULL
   ,@Indicator			varchar(15)	= NULL
   ,@Comments			varchar(500) = NULL
   ,@U_Motivo			varchar(15)	= NULL
   ,@EDocGenTyp			varchar(15)	= NULL
   ,@U_METPAGO2			varchar(15)		= NULL
   ,@userID				int				= NULL
   ,@Rol				int				= NULL
   ,@LineNum			int				= NULL
   ,@ItemCode			varchar(100)	= NULL
   ,@Quantity			decimal(18,8)	= NULL
   ,@Price				decimal(18,8)	= NULL
   ,@Rate				decimal(18,4)	= 1
   ,@Currency			varchar(15)		= NULL
   ,@TaxCode			varchar(15)		= NULL
   ,@WhsCode			varchar(15)		= NULL
   ,@AcctCode			varchar(15)		= NULL
   ,@BaseEntry			decimal(18,0)	= NULL
   ,@BaseLine			decimal(18,0)	= NULL
   ,@BaseType			decimal(18,0)	= NULL
   ,@LineTotal			decimal(18,4)	= 0
   ,@DocNumSAP			decimal(18,0)	= 0
   ,@U_FPROV			varchar(150) = NULL
   ,@ShipDate			DATE			= NULL
   ,@U_Vendedor			varchar(100)	= NULL
   ,@U_Comentario		VARCHAR(150)	= NULL
   ,@ABC				VARCHAR(50)     = NULL
   ,@VI					DECIMAL(18,4)	= NULL
   ,@OnHand				DECIMAL(18,0)	= NULL
   ,@Ideal				DECIMAL(18,0)	= NULL
   ,@DocKey				varchar(50)		= '' OUT
   ,@U_TPedido			nvarchar(10)	= NULL
   ,@U_Titular			nvarchar(10)	= NULL
   ,@U_OC				nvarchar(20)	= NULL
   ,@U_CUENTA			nvarchar(15)	= NULL
   ,@SlpCode			INT				= NULL
   ,@U_PReal			decimal(18,4)	= NULL
   ,@TestModelo			BIT				= 0
   ,@DiscPrcnt			DECIMAL(18,4)   = 0
   ,@DiscPrcnt_H		DECIMAL(18,4)   = 0
   ,@Descuento			DECIMAL(18,4)   = 0
   ,@Documentos			varchar(500)	= NULL
   ,@Factura			int				=NULL
   ,@Cantidad			int				=NULL
   ,@idComponente		int				=NULL
   ,@ItemCodeRemate		varchar(100)	=null
   ,@ItemName			varchar(100)	=null
   ,@CTC				decimal(18,2)=null
   ,@busquedade			int=null
   ,@BusquedaPedidos	int=0
   ,@BusquedaFacturas	int=0
   ,@Top	int=0
   -------------------nuevos parametros
   ,@U_TIPOOV			nvarchar(10)	= NULL
   ,@U_TC				DECIMAL(18,4)   = 0
   ,@U_LugarExp			nvarchar(50)	= NULL
   ,@FE_Calle			nvarchar(30)	= NULL
   ,@FE_NoExt			nvarchar(10)	= NULL
   ,@FE_NoInt			nvarchar(10)	= NULL
   ,@FE_Colonia			nvarchar(50)	= NULL
   ,@FE_Municipio		nvarchar(20)	= NULL
   ,@FE_Estado			nvarchar(20)	= NULL
   ,@FE_CP				nvarchar(15)	= NULL
   ,@FE_Pais			nvarchar(10)	= NULL
   ,@ManBtchNum			nvarchar(15)	= 'N'
   ,@CogsAcct			varchar(15)		= NULL
   ,@U_Price			decimal(18,8)	= NULL
   ,@U_CostoBase		decimal(18,8)	= NULL
   ,@U_CostoBase2		decimal(18,8)	= NULL
   ,@U_PCB				decimal(18,8)	= NULL
   ,@U_StockAlmacen		DECIMAL(18,4)   = 0
   ,@PriceBefDi			decimal(18,8)	= NULL
   ,@U_DiscPrcnt		DECIMAL(18,4)   = 0
   ,@LinetotalFrgn		DECIMAL(18,4)   = 0
   ,@U_Padre			nvarchar(50)	= NULL
   ,@NcmCode			int=0
   ,@ShipToCode			nvarchar(50)	= NULL
   ,@Address			nvarchar(50)	= NULL
   ,@Version			nvarchar(5)		=NULL
   /*****************PEMIJUMO*************************/
   ,@Filler				nvarchar(50) = NULL
   ,@ToWhsCode			nvarchar(50) = NULL
   ,@U_FolioSolicitud	nvarchar(50) = NULL
   ,@Dscription			varchar(50) = NULL
   ,@WhsName			varchar(50) = NULL
   ,@FromWhsCode		nvarchar(50) = NULL
   ,@FromWhsName		varchar(50) = NULL
   ,@BWeight1			decimal(18,4) = NULL
   ,@BVolume			decimal(18,4) = NULL
   ,@U_Tarima			varchar(50) = NULL
   ,@U_TipoAlm			varchar(50) = NULL
   ,@U_Peso				int			= NULL
   ,@U_FolioHalcon		nvarchar(50) = NULL,
   /***************************************************/
   @U_UUID				VARCHAR(50) = NULL, 
   @U_B1SYS_MainUsage	VARCHAR(50) = NULL,
   @U_MetPago			VARCHAR(5) = NULL,
   @U_TC_H				DECIMAL(18,4)   = 0,
   @NumPerMsr			INT = 1,
   @IntrSerial			VARCHAR(50) = NULL, 
   @InDate				VARCHAR(50) = NULL, 
   @BatchNum			VARCHAR(50) = NULL, 
   @SuppSerial			VARCHAR(50) = NULL,
   @MeasureUnit			VARCHAR(15) = NULL,
   @Motivo				VARCHAR(250) = NULL,
   @TransId				INT = NULL,
   @tipoCap				INT = NULL,
   @tipo				BIT = NULL,
   @DocSubType			VARCHAR(10) = NULL,
   @Utilidad			DECIMAL(10, 6) = NULL,
   @Confirmed			VARCHAR(1) = 'N',
   @OnOrder				INT	= NULL,
   /*******************YISUS*************************/
	@PrjCode			nvarchar(70) = NULL,
	@PrjName			nvarchar(70) = NULL,
	@Locked				nvarchar(70) = NULL,
	@datasource			nvarchar(100) = null,
	@UserSign			INT = NULL,
	@ValidFrom			DateTime = NULL,
	@ValidTo			DateTime = NULL,
	@active				nvarchar(70) = NULL,
	@LogInstanc			INT = NULL,
	@UserSign2			INT = NULL,
	@UpdateDate			DateTime = NULL,
	@U_Empresa			nvarchar(70) = NULL,
	@U_Sucursal			nvarchar(70) = NULL,
	@U_NR				nvarchar(70) = NULL,
	@U_Area				nvarchar(70) = NULL,
	@U_CodPuesto		nvarchar(70) = NULL,
	@U_Ruta				nvarchar(70) = NULL,
	@U_Unidad			nvarchar(70) = NULL,
	@U_Telefono			nvarchar(70) = NULL,
	@U_Complemento		nvarchar(70) = NULL,
	@OcrCode			nvarchar(50) = null,
	@TreeType			nvarchar(50) = null,
	@mensaje			nvarchar(500) = null out

	/**************************************************/
	,@Pedimento			varchar(500) =  NULL
	,@Aduana			varchar(500) =  NULL

	,@TrnspCode			INT = NULL
	,@U_Factor			DECIMAL(9,4) = NULL
	,@QR				varbinary(MAX) = null
	,@Empresa			VARCHAR(50) = NULL
	,@WddCode			INT = NULL
	,@WtmCode			INT = NULL
	,@ECommerBP			VARCHAR(30) = NULL
	,@U_ComentarioAuto	VARCHAR(50) = NULL
	,@U_EdocGenType		VARCHAR(1) = NULL
	,@U_Edocnum			VARCHAR(100) = NULL
	,@IsIns				VARCHAR(100) = NULL
	, @FatherCard		NVARCHAR(15) = NULL 
	, @VersionNum		NCHAR(15) = NULL 
	, @Project			NVARCHAR(20) = NULL
	, @GroupNum			INT = -1
	, @BarCode			VARCHAR(100)	= NULL
	, @DiscSumSy		DECIMAL(18, 6)	= NULL
	, @U_FolioCore		NVARCHAR(10) = NULL
	, @U_NoRelFact		NVARCHAR(20) = NULL
	, @U_VersionCFDI	VARCHAR(5) = NULL
	, @U_Delivey_Place	VARCHAR(15) = NULL
	, @U_Load			VARCHAR(25) = NULL
	, @U_TIPOMOV		VARCHAR(100) = NULL
	/**********PAGOS PROVEEDORES***********/
	, @TrsfrAcct		NVARCHAR(15) = NULL
	, @TrsfrSum			DECIMAL(18, 6) = NULL
	, @TrsfrDate		NVARCHAR(50) = NULL
	, @TrsfrRef			NVARCHAR(27) = NULL
	, @DocCurr			NVARCHAR(3) = NULL
	, @JrnlMemo			NVARCHAR(50) = NULL
	, @U_FormaPagoTes	VARCHAR(100) = NULL
	, @FolioHalcon		INT = NULL
	, @U_Autorizado		CHAR(1) = NULL
	, @FormaPagoTes		NVARCHAR(50) = NULL
	, @SumApplied		DECIMAL(18, 6) = NULL
	, @AppliedFC		DECIMAL(18, 6) = NULL
	, @InvoiceType		NVARCHAR(20) = NULL
	, @U_TipoPago		CHAR(2) = NULL
	/************************************************ RETENCIONES **/
	,@WTCode			VARCHAR(100) = NULL
	,@TaxbleAmnt		DECIMAL(18, 4) = NULL
	,@TxblAmntSC		DECIMAL(18, 4) = NULL
	,@WTAmnt			DECIMAL(18, 4) = NULL
	,@WTAmntSC			DECIMAL(18, 4) = NULL
	,@Type				VARCHAR(100) = NULL
	,@Category			VARCHAR(100) = NULL
	,@TipoBase			VARCHAR(100) = NULL
	,@Criteria			VARCHAR(100) = NULL
	
	,@Usuario			 INT	= NULL
	,@JournalMemo		 NVARCHAR(50) = ''
	,@CostingCode2		 NVARCHAR(8) = NULL
	,@CostingCode3		 NVARCHAR(8) = NULL
	,@CostingCode4		 NVARCHAR(8) = NULL
	,@Rounding			 CHAR(1)	= NULL
	,@RoundingDiffAmount DECIMAL(18, 4) = NULL
	,@EmpresaSAP	     VARCHAR (50) = 'HNT'
	,@U_FechaVto		 NVARCHAR(50) = NULL
	,@Opc				 INT = NULL
	,@ExtraDays			 INT = NULL
	/************************************************ PRECIOS DE ENTREGA **/
	,@U_EstadoEntrega	VARCHAR(10) = NULL
	,@AlcCode			NVARCHAR(2) = NULL
	,@OhType			VARCHAR(1) = NULL
	,@CostSum			DECIMAL(19,6) = NULL
	,@InCustCalc		VARCHAR(1) = NULL
	,@Reference			VARCHAR(11) = NULL

	---------------NOTIFICACIONES------------
	,@MSJ				 VARCHAR(MAX) = NULL
	,@Correo             VARCHAR(MAX) = NULL
	,@Body				 VARCHAR (MAX) = NULL
	,@Asunto			 VARCHAR (MAX) = NULL
	,@ID_VentaP			 INT = NULL
	,@MotivoText		 VARCHAR(250) = NULL 
	,@Folio				 INT = NULL
	,@NombreUsuario		 VARCHAR(250) = NULL
	,@PayNoDoc			 VARCHAR(15) = NULL
	,@CounterRef		 VARCHAR(50) = NULL
AS
BEGIN
	DECLARE @QRY  NVARCHAR(MAX)
	DECLARE @PARAMETROS NVARCHAR(MAX)
	DECLARE @Docs TABLE(clave VARCHAR(20))  
	declare @cardcode_ varchar(50), @canal_ int, @subcanal_ int, @listnum_ int
	DECLARE @ArticuloAux varchar(20)

	IF ISNULL(@EmpresaSAP,'') = ''
	BEGIN
			SET @EmpresaSAP = 'HNT'	
	END

	DECLARE @BD VARCHAR(50) = CASE @EmpresaSAP
								WHEN 'HNT' THEN 'HNT_TRZ'
								WHEN 'HNT_DPJ' THEN 'HALCONET'
								WHEN 'SERVIMPO' THEN 'HNT_SERVIMPO'
							END
	DECLARE @BDSAP VARCHAR(50) = CASE @EmpresaSAP
								WHEN 'HNT' THEN 'SBOCTRZ'
								WHEN 'HNT_DPJ' THEN 'SBODPJ'
								WHEN 'SERVIMPO' THEN 'SBOSERVIMPO'
							END
	
	-----Termina Configuracion de documentos
	IF @TipoConsulta = -1
	BEGIN
		Select * From sap.SDK_Document Where Code = @idDocumento
	END
	
	IF @TipoConsulta = -2
	BEGIN
		Select A.*, B.ObjType From sap.SDK_DocumentHeader A
			JOIN sap.SDK_Document B ON A.idDocumento = B.Code
		Where A.idDocumento = @idDocumento
	END

	IF @TipoConsulta = -3
	BEGIN
		Select * From sap.SDK_DocumentLines Where idDocumento = @idDocumento ORDER BY columnIndex
	END
-----Termina Configuracion de documentos
	IF @TipoConsulta = 1
	BEGIN
		--SOLICITUD DE APARTADO PARA REMISIONES DE TIPO PROYECTO
		IF @idDocumento = -11
		BEGIN
			IF @busquedade = 1
			BEGIN
				SET @QRY = '
					Select 
						ODLN.Series, ODLN.DocEntry, ODLN.ObjType, DocNum, DocDate [Fecha de contabilización], OCRD.CardName [Cliente], CASE WHEN DocStatus = ''O'' THEN ''Abierto'' ELSE ''Cerrado'' END [Estado],
						DocCur [Moneda], CASE WHEN DocCur = ''USD'' THEN DocTotalFC ELSE DocTotal END [Total del documento**], 
						CASE WHEN DocCur = ''USD'' THEN PaidFC ELSE PaidToDate END [Importe aplicado**], SlpName [Vendedor], OCTG.PymntGroup [Condiciones de pago], Comments [Comentarios], EDocNum [Documento electrónico]
						, ''Documento SAP''[Tipo]
					From ' + @CIA + '.dbo.ODLN 
						JOIN ' + @CIA + '.dbo.OSLP ON ODLN.SlpCode = OSLP.SlpCode
						JOIN ' + @CIA + '.dbo.OCRD ON ODLN.CardCode = OCRD.CardCode
						JOIN ' + @CIA + '.dbo.OCTG ON OCRD.GroupNum = OCTG.GroupNum AND ODLN.DocType = ''I'''
					IF @DocEntry = 0
					BEGIN
						SET @QRY += ' 
							Where ODLN.DocStatus = ''O'' AND ISNULL(ODLN.U_TipoOV, '''') = ''PRY'' '--DocDate BETWEEN @Desde AND @Hasta
						--IF @CardName <> ''
						--	SET @QRY += ' AND OCRD.CardName like @CardName' funcionalidad copiar de no necesita filtro por nombre 2019-09-08
						IF @Series <> 0
							SET @QRY += ' AND ODLN.Series = @Series'	
						IF @Comments <> '' 
							SET @QRY += ' AND OINV.Comments like @Comments '
			
						IF @CardCode <> '' 
							SET @QRY += ' AND OCRD.CardCode like @CardCode '
					END
					ELSE
					BEGIN
						SET @QRY += ' Where DocNum = @DocNum AND DocType = ''I'' AND ISNULL(ODLN.U_TipoOV, '''') = ''PRY'' '
					END					
					SET @QRY += ' ORDER BY DocNum'

				SET @PARAMETROS = '@CardCode VARCHAR(10), @CardName VARCHAR(500), @Series INT, @Desde DATE, @Hasta DATE, @DocNum INT, @idDocumento numeric(18,0),@Comments varchar(500)'
				EXECUTE sp_executesql @QRY, @PARAMETROS, @CardCode, @CardName, @Series, @Desde, @Hasta, @DocEntry, @idDocumento		,@Comments			
			END
			ELSE
			BEGIN
				SET @QRY = '
					Select 
						ODLN.Series, ODLN.DocEntry, ODLN.ObjType, DocNum, DocDate [Fecha de contabilización], OCRD.CardName [Cliente], CASE WHEN DocStatus = ''O'' THEN ''Abierto'' ELSE ''Cerrado'' END [Estado],
						DocCur [Moneda], CASE WHEN DocCur = ''USD'' THEN DocTotalFC ELSE DocTotal END [Total del documento**], 
						CASE WHEN DocCur = ''USD'' THEN PaidFC ELSE PaidToDate END [Importe aplicado**], SlpName [Vendedor], OCTG.PymntGroup [Condiciones de pago], Comments [Comentarios], EDocNum [Documento electrónico]
						, ''Documento SAP''[Tipo]
					From ' + @CIA + '.dbo.ODLN 
						JOIN ' + @CIA + '.dbo.OSLP ON ODLN.SlpCode = OSLP.SlpCode
						JOIN ' + @CIA + '.dbo.OCRD ON ODLN.CardCode = OCRD.CardCode
						JOIN ' + @CIA + '.dbo.OCTG ON OCRD.GroupNum = OCTG.GroupNum AND ODLN.DocType = ''I'''
					IF @DocEntry = 0
				BEGIN
					SET @QRY += ' 
						Where DocDate BETWEEN @Desde AND @Hasta AND ISNULL(ODLN.U_TipoOV, '''') = ''PRY'' '--DocDate BETWEEN @Desde AND @Hasta
					IF @CardName <> ''
						SET @QRY += ' AND OCRD.CardName like @CardName'
					IF @Series <> 0
						SET @QRY += ' AND ODLN.Series = @Series'	
			
					IF @CardCode <> '' 
						SET @QRY += ' AND OCRD.CardCode like @CardCode '
					IF @Comments <> '' 
						SET @QRY += ' AND OINV.Comments like @Comments '
				END
				ELSE
				BEGIN
					SET @QRY += ' Where DocNum = @DocNum AND DocType = ''I'' AND ISNULL(ODLN.U_TipoOV, '''') = ''PRY'' '
				END		
			

				SET @PARAMETROS = '@CardCode VARCHAR(10), @CardName VARCHAR(500), @Series INT, @Desde DATE, @Hasta DATE, @DocNum INT, @idDocumento numeric(18,0),@Comments varchar(500)'
				EXECUTE sp_executesql @QRY, @PARAMETROS, @CardCode, @CardName, @Series, @Desde, @Hasta, @DocEntry, @idDocumento	,@Comments			
			END			
		END

		--FACTURAS DE PROVEEDOR Y ORDENES DE COMPRA DEL NUEVO MODULO HALCONET PABLO CUAUTLE COATL
		IF @idDocumento = -10
		BEGIN
			--18 FR
			SET @QRY = '
				Select 
					OPCH.Series, OPCH.DocEntry, OPCH.ObjType, DocNum, DocDate [Fecha de contabilización], OCRD.CardName [Cliente], CASE WHEN DocStatus = ''O'' THEN ''Abierto'' ELSE ''Cerrado'' END [Estado],
					DocCur [Moneda], CASE WHEN DocCur = ''USD'' THEN DocTotalFC ELSE DocTotal END [Total del documento**], 
					CASE WHEN DocCur = ''USD'' THEN PaidFC ELSE PaidToDate END [Importe aplicado**], SlpName [Vendedor], OCTG.PymntGroup [Condiciones de pago], Comments [Comentarios], EDocNum [Documento electrónico], ''Documento SAP''[Tipo]
				From SBOCTRZ.dbo.OPCH 
					JOIN SBOCTRZ.dbo.OSLP ON OPCH.SlpCode = OSLP.SlpCode
					JOIN SBOCTRZ.dbo.OCRD ON OPCH.CardCode = OCRD.CardCode
					JOIN SBOCTRZ.dbo.OCTG ON OCRD.GroupNum = OCTG.GroupNum AND OPCH.DocType = ''S'' AND OPCH.DocSubType <> ''DN'''
				IF @DocEntry = 0
				BEGIN
					SET @QRY += ' 
						Where DocDate BETWEEN @Desde AND @Hasta'
					IF @CardName <> ''
						SET @QRY += ' AND OCRD.CardName like @CardName'
					IF @Comments <> '' 
						SET @QRY += ' AND OPCH.Comments like @Comments '
			
					IF @CardCode <> '' 
						SET @QRY += ' AND OCRD.CardCode like @CardCode '
				END
				ELSE
				BEGIN
					SET @QRY += ' Where DocNum = @DocEntry AND DocType = ''S'''
				END
			--22 OC
			SET @QRY += '
				UNION ALL
				Select 
					OPOR.Series, OPOR.DocEntry, OPOR.ObjType, DocNum, DocDate [Fecha de contabilización], OCRD.CardName [Cliente], CASE WHEN DocStatus = ''O'' THEN ''Abierto'' ELSE ''Cerrado'' END [Estado],
					DocCur [Moneda], CASE WHEN DocCur = ''USD'' THEN DocTotalFC ELSE DocTotal END [Total del documento**], 
					CASE WHEN DocCur = ''USD'' THEN PaidFC ELSE PaidToDate END [Importe aplicado**], SlpName [Vendedor], OCTG.PymntGroup [Condiciones de pago], Comments [Comentarios], EDocNum [Documento electrónico], ''Documento SAP''[Tipo]
				From SBOCTRZ.dbo.OPOR 
					JOIN SBOCTRZ.dbo.OSLP ON OPOR.SlpCode = OSLP.SlpCode
					JOIN SBOCTRZ.dbo.OCRD ON OPOR.CardCode = OCRD.CardCode
					JOIN SBOCTRZ.dbo.OCTG ON OCRD.GroupNum = OCTG.GroupNum AND OPOR.DocType = ''S'' AND OPOR.DocSubType <> ''DN'''
				IF @DocEntry = 0
				BEGIN
					SET @QRY += ' 
						Where DocDate BETWEEN @Desde AND @Hasta'
					IF @CardName <> ''
						SET @QRY += ' AND OCRD.CardName like @CardName'
					IF @Comments <> '' 
						SET @QRY += ' AND OPOR.Comments like @Comments '
			
					IF @CardCode <> '' 
						SET @QRY += ' AND OCRD.CardCode like @CardCode '
				END
				ELSE
				BEGIN
					SET @QRY += ' Where DocNum = @DocEntry AND DocType = ''S'''
				END
				
				SET @QRY += ' ORDER BY DocNum'	
		
			SET @PARAMETROS = '@CardCode VARCHAR(10), @CardName VARCHAR(500), @Series INT, @Desde DATE, @Hasta DATE, @DocEntry INT, @idDocumento numeric(18,0),@Comments varchar(500)'
			EXECUTE sp_executesql @QRY, @PARAMETROS, @CardCode, @CardName, @Series, @Desde, @Hasta, @DocEntry,@idDocumento	,@Comments			
		END

		IF @idDocumento = -9
		BEGIN
			SET @QRY = '
				Select CardCode, CardName, Currency From [SBOCTRZ].dbo.OCRD Where CardType = ''S'''

			IF @CardCode <> ''
					SET @QRY += ' AND CardCode like ''' + @CardCode +  ''''
			IF @CardName <> ''
					SET @QRY += ' AND CardName like ''' + @CardName +  ''''

			EXECUTE sp_executesql @QRY

		END

		IF @idDocumento = -8
		BEGIN
			Select DocEntry, DocNum, DocDate, CardName, Comments, 'NE' Documento, ObjType, CASE WHEN DocCur = 'USD' THEN PaidFC ELSE PaidToDate END PaidToDate,
			U_MPAGO2, U_B1SYS_MainUsage, '' UUID, U_MetPago
			From [SBOCTRZ].dbo.ODLN
			Where DocStatus = 'O' AND DocType = 'I' And CardCode = @CardCode 
		END
	
		IF @idDocumento = -7
		BEGIN
			SET @QRY ='
				Select A.CardCode, 
						A.CardName, 
						A.Balance,
						C.SlpName,
						B.GroupName [Código de grupo],
						A.U_Cobranza [Jefa de cobranza],
						D.PymntGroup [Condiciones de pago]
				From SBOCTRZ.dbo.OCRD A
					JOIN SBOCTRZ.dbo.OCRG B ON A.GroupCode = B.GroupCode
					JOIN SBOCTRZ.dbo.OSLP C ON A.SlpCode = C.SlpCode
					JOIN SBOCTRZ.dbo.OCTG D ON D.GroupNum = A.GroupNum
				Where CardType = ''C'' '

			IF @CardCode <> ''
				SET @QRY += '	AND A.CardCode like ''' + @CardCode + ''''
			IF  @CardName <> ''
				SET @QRY += '	AND A.CardName like ''' + @CardName + ''''
			IF @Comments <> ''
				SET @QRY += '	AND ISNULL(A.CardFName, '''') like ''' + @Comments + ''''
			IF @Series > 0
				SET @QRY += '	AND A.SlpCode = ' + CAST(@Series AS VARCHAR(15))
			SET @QRY += '	
				ORDER BY A.CardCode'

			EXECUTE sp_executesql @QRY
		END

		IF @idDocumento = -6
		BEGIN
			Select DocEntry, DocNum, DocDate, CardName, Comments, 'RF' Documento, ObjType, CASE WHEN DocCur = 'USD' THEN PaidFC ELSE PaidToDate END PaidToDate,
				   CASE WHEN U_MPAGO2 = '99' THEN '15' ELSE U_MPAGO2 END U_MPAGO2, ---SOLICITADO POR JUAN FLORES 2022-06-06
				   'G02' U_B1SYS_MainUsage, ISNULL(A.U_Edocnum, '') UUID, 'PUE' U_MetPago
			From [SBOCTRZ].dbo.OINV A
				--LEFT JOIN [SBOCTRZ].dbo.ECM2 B ON A.DocEntry = B.SrcObjAbs AND A.ObjType = B.SrcObjType		
				--LEFT JOIN sap.ECM2_CTRZ C ON A.DocEntry = C.SrcObjAbs AND A.ObjType = C.SrcObjType	
			Where DocStatus = 'O' AND DocType = 'I' And CardCode = @CardCode
		END

		IF @idDocumento = -5
		BEGIN
			SET @QRY = '
				Select CardCode, CardName, Currency From [SBOCTRZ].dbo.OCRD Where CardType = ''C'''

			IF @CardCode <> ''
					SET @QRY += ' AND CardCode like ''' + @CardCode +  ''''
			IF @CardName <> ''
					SET @QRY += ' AND CardName like ''' + @CardName +  ''''

			EXECUTE sp_executesql @QRY

		END
		--IF @idDocumento = -4
		--	BEGIN
		--	IF @NumAtCard = '0'
		--	BEGIN
		--		IF @Rol = 35
		--		BEGIN 
		--		Select A.ItemCode, 
		--			   A.ItemName, 
		--			   A.OnHand, ItmsGrpNam, a.U_Subclas, C.CardCode, C.CardName, A.U_VLGX_PLN, D.Clasificacion,
		--			   BHeight1 Longitud, BWidth1 Ancho, BLength1 Altura, BVolume Volumen, BWeight1 Peso,  A.U_ItemCode,
		--			   U_IGI, U_FraccionAran, A.CodeBars
		--		From [SBOCTRZ].dbo.OITM A
		--			JOIN [SBOCTRZ].dbo.OITB B ON A.ItmsGrpCod = B.ItmsGrpCod
		--			LEFT JOIN [SBOCTRZ].dbo.OCRD C ON C.CardCode = A.CardCode
		--			JOIN purchase.VW_ClasificacionArticulo D ON D.ItemCode = A.ItemCode
		--		Where A.ItemCode like CASE WHEN REPLACE( @CardCode, '*', '%') = '' THEN '%%' ELSE REPLACE( @CardCode, '*', '%') END
		--			  AND A.ItemName like CASE WHEN REPLACE( @CardName, '*', '%') = '' THEN '%%' ELSE REPLACE( @CardName, '*', '%') END
		--			  AND A.ItmsGrpCod in (173,174,179,180,181,182)
		--		END
		--		ELSE
		--		BEGIN 
		--		Select A.ItemCode, 
		--			   A.ItemName, 
		--			   A.OnHand, ItmsGrpNam, a.U_Subclas, C.CardCode, C.CardName, A.U_VLGX_PLN, D.Clasificacion,
		--			   BHeight1 Longitud, BWidth1 Ancho, BLength1 Altura, BVolume Volumen, BWeight1 Peso,  A.U_ItemCode,
		--			   U_IGI, U_FraccionAran, A.CodeBars
		--		From [SBOCTRZ].dbo.OITM A
		--			JOIN [SBOCTRZ].dbo.OITB B ON A.ItmsGrpCod = B.ItmsGrpCod
		--			LEFT JOIN [SBOCTRZ].dbo.OCRD C ON C.CardCode = A.CardCode
		--			JOIN purchase.VW_ClasificacionArticulo D ON D.ItemCode = A.ItemCode
		--		Where A.ItemCode like CASE WHEN REPLACE( @CardCode, '*', '%') = '' THEN '%%' ELSE REPLACE( @CardCode, '*', '%') END
		--			  AND A.ItemName like CASE WHEN REPLACE( @CardName, '*', '%') = '' THEN '%%' ELSE REPLACE( @CardName, '*', '%') END
		--		END

		--	END
		--	ELSE
		--	BEGIN
		--		Select A.ItemCode, 
		--			   A.ItemName, 
		--			   A.OnHand, ItmsGrpNam, a.U_Subclas, C.CardName, A.U_VLGX_PLN, D.Clasificacion,
		--			   BHeight1 Longitud, BWidth1 Ancho, BLength1 Altura, BVolume Volumen, BWeight1 Peso,  A.U_ItemCode
		--			   U_IGI, U_FraccionAran, A.CodeBars
		--		From [SBOCTRZ].dbo.OITM A
		--			JOIN [SBOCTRZ].dbo.OITB B ON A.ItmsGrpCod = B.ItmsGrpCod
		--			LEFT JOIN [SBOCTRZ].dbo.OCRD C ON C.CardCode = A.CardCode
		--			JOIN purchase.VW_ClasificacionArticulo D ON D.ItemCode = A.ItemCode
		--		Where A.ItemCode like CASE WHEN REPLACE( @CardCode, '*', '%') = '' THEN '%%' ELSE REPLACE( @CardCode, '*', '%') END
		--			  AND A.ItemName like CASE WHEN REPLACE( @CardName, '*', '%') = '' THEN '%%' ELSE REPLACE( @CardName, '*', '%') END
		--			  AND B.ItmsGrpCod = @NumAtCard
		--	END
		--END
		IF @idDocumento = -4
		BEGIN
			IF @Empresa IS NULL SET @Empresa = 'SBOCTRZ'
			IF @CardCode IS NULL SET @CardCode = ''
			IF @CardName IS NULL SET @CardName = ''
			IF @NumAtCard = '0'
			BEGIN
				IF @Rol = 35
				BEGIN 
					SET @QRY = '
						SELECT 
							A.ItemCode, 
							A.ItemName, 
							A.OnHand, 
							ItmsGrpNam, 
							a.U_Subclas, 
							C.CardCode, 
							C.CardName, 
							A.U_VLGX_PLN, 
							D.Clasificacion,
							BHeight1 Longitud, 
							BWidth1 Ancho, 
							BLength1 Altura, 
							BVolume Volumen, 
							BWeight1 Peso,  
							A.U_ItemCode,
							U_IGI, 
							U_FraccionAran, 
							A.CodeBars
						FROM 
							' + @Empresa + '.dbo.OITM A
							JOIN ' + @Empresa + '.dbo.OITB B ON A.ItmsGrpCod = B.ItmsGrpCod
							LEFT JOIN ' + @Empresa + '.dbo.OCRD C ON C.CardCode = A.CardCode
							JOIN purchase.VW_ClasificacionArticulo D ON D.ItemCode = A.ItemCode
						WHERE 
							A.ItemCode like CASE WHEN REPLACE( @CardCode, ''*'', ''%'') = '''' THEN ''%%'' ELSE REPLACE( @CardCode, ''*'', ''%'') END
							AND A.ItemName like CASE WHEN REPLACE( @CardName, ''*'', ''%'') = '''' THEN ''%%'' ELSE REPLACE( @CardName, ''*'', ''%'') END
							AND A.ItmsGrpCod in (173,174,179,180,181,182)'
						SET @ParamsDefinitions = '@CardCode varchar(50), @CardName varchar(150)'
					EXEC sp_executesql @QRY, @ParamsDefinitions, @CardCode, @CardName

				END
				ELSE
				BEGIN 
					SET @QRY = '
						SELECT
							A.ItemCode, 
							A.ItemName, 
							A.OnHand, 
							ItmsGrpNam, 
							a.U_Subclas, 
							C.CardCode,
							C.CardName, 
							A.U_VLGX_PLN, 
							D.Clasificacion,
							BHeight1 Longitud, 
							BWidth1 Ancho, 
							BLength1 Altura, 
							BVolume Volumen, 
							BWeight1 Peso,  
							A.U_ItemCode,
							U_IGI, 
							U_FraccionAran, 
							A.CodeBars 
						FROM
							' + @Empresa + '.dbo.OITM A
							JOIN ' + @Empresa + '.dbo.OITB B ON A.ItmsGrpCod = B.ItmsGrpCod
							LEFT JOIN ' + @Empresa + '.dbo.OCRD C ON C.CardCode = A.CardCode
							JOIN purchase.VW_ClasificacionArticulo D ON D.ItemCode = A.ItemCode
						WHERE 
							A.ItemCode like CASE WHEN REPLACE( @CardCode, ''*'', ''%'') = '''' THEN ''%%'' ELSE REPLACE( @CardCode, ''*'', ''%'') END
							AND A.ItemName like CASE WHEN REPLACE( @CardName, ''*'', ''%'') = '''' THEN ''%%'' ELSE REPLACE( @CardName, ''*'', ''%'') END'
						SET @ParamsDefinitions = '@CardCode varchar(50), @CardName varchar(150)'
					EXEC sp_executesql @QRY, @ParamsDefinitions, @CardCode, @CardName
				END
			END
			ELSE
			BEGIN
				SET @QRY = '
					SELECT 
						A.ItemCode, 
						A.ItemName, 
						A.OnHand, 
						ItmsGrpNam, 
						a.U_Subclas, 
						C.CardName, 
						A.U_VLGX_PLN, 
						D.Clasificacion,
						BHeight1 Longitud, 
						BWidth1 Ancho, 
						BLength1 Altura, 
						BVolume Volumen,
						BWeight1 Peso,  
						A.U_ItemCode
						U_IGI, 
						U_FraccionAran, 
						A.CodeBars
					FROM ' + @Empresa + '.dbo.OITM A
						JOIN ' + @Empresa + '.dbo.OITB B ON A.ItmsGrpCod = B.ItmsGrpCod
						LEFT JOIN ' + @Empresa + '.dbo.OCRD C ON C.CardCode = A.CardCode
						JOIN purchase.VW_ClasificacionArticulo D ON D.ItemCode = A.ItemCode
					WHERE 
						A.ItemCode like CASE WHEN REPLACE( @CardCode, ''*'', ''%'') = '''' THEN ''%%'' ELSE REPLACE( @CardCode, ''*'', ''%'') END
						AND A.ItemName like CASE WHEN REPLACE( @CardName, ''*'', ''%'') = '''' THEN ''%%'' ELSE REPLACE( @CardName, ''*'', ''%'') END
						AND B.ItmsGrpCod = @NumAtCard'
					SET @ParamsDefinitions = '@CardCode varchar(200), @CardName varchar(150), @NumAtCard varchar(100)'
				EXEC sp_executesql @QRY, @ParamsDefinitions, @CardCode, @CardName, @NumAtCard
			END
		END

		IF @idDocumento = -3
		BEGIN
			Select DocEntry, DocNum, DocDate, CardName, Comments From [SBOCTRZ].dbo.OPDN Where DocStatus = 'O' And CardCode = @CardCode
		END

		IF @idDocumento = -2
		BEGIN
			--DEJAR SOLO FACTURAS DE RESERVA
			--Select distinct A.DocEntry, A.DocNum, A.DocDate, A.CardName, A.Comments, 'OC' Documento, A.ObjType 
			--From [SBOCTRZ].dbo.OPOR A JOIN [SBOCTRZ].dbo.POR1 B ON A.DocEntry = B.DocEntry AND B.WhsCode IN ('02','14','01','16')
			--							JOIN tbl_RecepcionDocumentos C ON A.DocEntry = C.DocEntry
			--Where A.DocStatus = 'O' And A.CardCode = @CardCode
			--UNION ALL
			--Select distinct A.DocEntry, A.DocNum, A.DocDate, A.CardName, A.Comments, 'OC' Documento, A.ObjType 
			--From [SBOCTRZ].dbo.OPOR A JOIN [SBOCTRZ].dbo.POR1 B ON A.DocEntry = B.DocEntry AND B.WhsCode NOT IN ('02','14','01','16')
			--Where A.DocStatus = 'O' And A.CardCode = @CardCode
			--UNION ALL
			Select DocEntry, DocNum, DocDate, CardName, Comments, 'FR' Documento, ObjType 
			From [SBOCTRZ].dbo.OPCH 
			Where InvntSttus = 'O' And CardCode = @CardCode AND isIns = 'Y'
		END

		--Lista Clientes
		IF @idDocumento = -1
		BEGIN
			SET @QRY = '
				Select CardCode, CardName, Currency,b.slpname Asesor From ' + @CIA +'.dbo.OCRD a
				JOIN ' + @CIA +'.dbo.OSLP b on a.slpcode = b.slpcode 
				Where CardType = ''' + @CardType + ''''

			IF @CardCode <> ''
					SET @QRY += ' AND CardCode like ''%' + @CardCode +  '%'''
			IF @CardName <> ''
					SET @QRY += ' AND CardName like ''%' + @CardName +  '%'''
								
			EXECUTE sp_executesql @QRY

		END

		IF @idDocumento = 1
		BEGIN
			SET @QRY = 'Select 
							 DocEntry, CardCode [S/N], CardName [Nombre], DocNum [Número de documento], ''OC'' [Tipo], ISNULL(NumAtCard,'''') [Folio Proveedor], DocDate [Fecha de contabilización], DocDuedate [Fecha de entrega],
							CASE WHEN DocStatus = ''C'' THEN ''Cerrado''
								 WHEN DocStatus = ''O'' THEN ''Abierto'' End [Estado], 
							 DocCur [Moneda], DocTotal [Total]
						 From [SBOCTRZ].dbo.OPOR 
						 Where Series = 15 AND DocType = ''I'''
			IF @NumAtCard <> ''
				SET @QRY += ' AND NumAtCard like ''' + @NumAtCard + ''''
			IF @CardCode <> ''
				SET @QRY += '
							AND CardCode like '''+ @CardCode + ''''
			IF @CardName <> ''
				SET @QRY += '
							AND CardName like '''+ @CardName + ''''

			SET @QRY += ' AND DocDate BETWEEN ''' + @DocDate + ''' AND ''' + @DocDateHasta + ''''
							

			SET @QRY += 'UNION ALL Select 
							 A.DocNum DocEntry, A.CardCode [S/N], B.CardName [Nombre], A.DocNum [Número de documento], ''Borrador'' [Tipo], ISNULL(A.NumAtCard,'''') [Folio Proveedor], A.DocDate [Fecha de contabilización], A.DocDate [Fecha de entrega],
							 CASE WHEN A.U_autorizado = ''A'' THEN ''Aprobado''
								  WHEN A.U_autorizado = ''P'' THEN ''Pendiente''
								  WHEN A.U_autorizado = ''R'' THEN ''Rechazado'' End [Estado], 
							 A.DocCur [Moneda], A.DocTotal [Total]
						From sap.ODRF A
							JOIN [SBOCTRZ].dbo.OCRD B ON A.CardCode = B.CardCode
						 Where A.Series = 15 and (transid is null or transid = -1)'
			IF @NumAtCard <> ''
				SET @QRY += ' AND A.NumAtCard like ''' + @NumAtCard + ''''
			IF @CardCode <> ''
				SET @QRY += '
							AND A.CardCode like '''+ @CardCode + ''''
			IF @CardName <> ''
				SET @QRY += '
							AND B.CardName like '''+ @CardName + ''''
			SET @QRY += '
							AND A.DocDate BETWEEN ''' + @DocDate + ''' AND ''' + @DocDateHasta + '''' 
		
		--	select @QRY
			EXECUTE sp_executesql @QRY
		END


		IF @idDocumento = 8
		BEGIN
			SET @QRY = '
				Select 
					DocEntry, CardCode [S/N], CardName [Nombre], ''RC'' [Doc], DocNum [Número de documento], ISNULL(NumAtCard,'''') [Folio Proveedor], DocDate [Fecha de contabilización], DocDuedate [Fecha de vencimiento],
					CASE WHEN DocStatus = ''C'' THEN ''Cerrado''
							WHEN DocStatus = ''O'' THEN ''Abierto'' End [Estatus], 
						DocCur [Moneda], DocTotal [Total]
				From [SBOCTRZ].dbo.ORIN 
				Where DocType = ''I'' 
					AND DocDate >= @DocDate
					AND CardCode like CASE WHEN @CardCode = '''' THEN ''%%'' ELSE @CardCode END
					AND CardName like CASE WHEN @CardName = '''' THEN ''%%'' ELSE @CardName END '
			IF @Series <> 0
				SET @QRY += '
					AND Series = @Series'
				SET @QRY += '
					--AND A.CardCode like CASE WHEN @CardCode = '''' THEN ''%%'' ELSE @CardCode END
					--AND B.CardName like CASE WHEN @CardName = '''' THEN ''%%'' ELSE @CardName END
				ORDER BY [Fecha de contabilización]'
			SET @PARAMETROS = '@DocDate DATE, @CardCode VARCHAR(250), @CardName VARCHAR(500), @Series INT'
			EXEC sp_executesql @QRY, @PARAMETROS, @DocDate, @CardCode, @CardName, @Series
		END

		IF @idDocumento = 9
		BEGIN
			Select 
				DocEntry, CardCode [S/N], CardName [Nombre], 'DV' [Doc], DocNum [Número de documento], ISNULL(NumAtCard,'') [Folio Proveedor], DocDate [Fecha de contabilización], DocDuedate [Fecha de vencimiento],
				CASE WHEN DocStatus = 'C' THEN 'Cerrado'
						WHEN DocStatus = 'O' THEN 'Abierto' End [Estatus], 
					DocCur [Moneda], DocTotal [Total]
			From [SBOCTRZ].dbo.ORDN 
			Where DocType = 'I' 
				AND DocDate >= @DocDate
				AND CardCode like CASE WHEN @CardCode = '' THEN '%%' ELSE @CardCode END
				AND CardName like CASE WHEN @CardName = '' THEN '%%' ELSE @CardName END			
			ORDER BY [Fecha de contabilización]
		END

		IF @idDocumento = 13
		BEGIN
			SET @QRY = '
				Select 
					OINV.Series, OINV.DocEntry, OINV.ObjType, DocNum, DocDate [Fecha de contabilización], OCRD.CardName [Cliente], CASE WHEN DocStatus = ''O'' THEN ''Abierto'' ELSE ''Cerrado'' END [Estado],
					DocCur [Moneda], CASE WHEN DocCur = ''USD'' THEN DocTotalFC ELSE DocTotal END [Total del documento**], 
					CASE WHEN DocCur = ''USD'' THEN PaidFC ELSE PaidToDate END [Importe aplicado**], SlpName [Vendedor], OCTG.PymntGroup [Condiciones de pago], Comments [Comentarios], EDocNum [Documento electrónico], ''Documento SAP''[Tipo]
				From ' + @CIA + '.dbo.OINV 
					JOIN ' + @CIA + '.dbo.OSLP ON OINV.SlpCode = OSLP.SlpCode
					JOIN ' + @CIA + '.dbo.OCRD ON OINV.CardCode = OCRD.CardCode
					JOIN ' + @CIA + '.dbo.OCTG ON OCRD.GroupNum = OCTG.GroupNum AND OINV.DocType = ''I'' AND OINV.DocSubType <> ''DN'''
				IF @DocEntry = 0
				BEGIN
					SET @QRY += ' 
						Where DocDate BETWEEN @Desde AND @Hasta'
					IF @CardName <> ''
						SET @QRY += ' AND OCRD.CardName like @CardName'
					IF @Series <> 0
						SET @QRY += ' AND OINV.Series = @Series'	
					IF @Comments <> '' 
						SET @QRY += ' AND OINV.Comments like @Comments '
			
					IF @CardCode <> '' 
						SET @QRY += ' AND OCRD.CardCode like @CardCode '
				END
				ELSE
				BEGIN
					SET @QRY += ' Where DocNum = @DocNum AND DocType = ''I'''
				END
				
				SET @QRY += ' ORDER BY DocNum'	
		
			SET @PARAMETROS = '@CardCode VARCHAR(10), @CardName VARCHAR(500), @Series INT, @Desde DATE, @Hasta DATE, @DocNum INT, @idDocumento numeric(18,0),@Comments varchar(500)'
			EXECUTE sp_executesql @QRY, @PARAMETROS, @CardCode, @CardName, @Series, @Desde, @Hasta, @DocEntry,@idDocumento	,@Comments			
		END

		IF @idDocumento = 15
		BEGIN
			IF @busquedade = 1
			BEGIN
				SET @QRY = '
					Select 
						ODLN.Series, ODLN.DocEntry, ODLN.ObjType, DocNum, DocDate [Fecha de contabilización], OCRD.CardName [Cliente], CASE WHEN DocStatus = ''O'' THEN ''Abierto'' ELSE ''Cerrado'' END [Estado],
						DocCur [Moneda], CASE WHEN DocCur = ''USD'' THEN DocTotalFC ELSE DocTotal END [Total del documento**], 
						CASE WHEN DocCur = ''USD'' THEN PaidFC ELSE PaidToDate END [Importe aplicado**], SlpName [Vendedor], OCTG.PymntGroup [Condiciones de pago], Comments [Comentarios], EDocNum [Documento electrónico]
						, ''Documento SAP''[Tipo]
					From ' + @CIA + '.dbo.ODLN 
						JOIN ' + @CIA + '.dbo.OSLP ON ODLN.SlpCode = OSLP.SlpCode
						JOIN ' + @CIA + '.dbo.OCRD ON ODLN.CardCode = OCRD.CardCode
						JOIN ' + @CIA + '.dbo.OCTG ON OCRD.GroupNum = OCTG.GroupNum AND ODLN.DocType = ''I'' AND ODLN.DocType = ''I'''
					IF @DocEntry = 0
					BEGIN
						SET @QRY += ' 
							Where ODLN.DocStatus = ''O'' '--DocDate BETWEEN @Desde AND @Hasta
						--IF @CardName <> ''
						--	SET @QRY += ' AND OCRD.CardName like @CardName' funcionalidad copiar de no necesita filtro por nombre 2019-09-08
						IF @Series <> 0
							SET @QRY += ' AND ODLN.Series = @Series'	
						IF @Comments <> '' 
							SET @QRY += ' AND OINV.Comments like @Comments '
			
						IF @CardCode <> '' 
							SET @QRY += ' AND OCRD.CardCode like @CardCode '
					END
					ELSE
					BEGIN
						SET @QRY += ' Where DocNum = @DocNum AND DocType = ''I'' AND ODLN.DocType = ''I'''
					END					
					SET @QRY += ' ORDER BY DocNum'

				SET @PARAMETROS = '@CardCode VARCHAR(10), @CardName VARCHAR(500), @Series INT, @Desde DATE, @Hasta DATE, @DocNum INT, @idDocumento numeric(18,0),@Comments varchar(500)'
				EXECUTE sp_executesql @QRY, @PARAMETROS, @CardCode, @CardName, @Series, @Desde, @Hasta, @DocEntry, @idDocumento		,@Comments			
			END
			ELSE
			BEGIN
				SET @QRY = '
					Select 
						ODLN.Series, ODLN.DocEntry, ODLN.ObjType, DocNum, DocDate [Fecha de contabilización], OCRD.CardName [Cliente], CASE WHEN DocStatus = ''O'' THEN ''Abierto'' ELSE ''Cerrado'' END [Estado],
						DocCur [Moneda], CASE WHEN DocCur = ''USD'' THEN DocTotalFC ELSE DocTotal END [Total del documento**], 
						CASE WHEN DocCur = ''USD'' THEN PaidFC ELSE PaidToDate END [Importe aplicado**], SlpName [Vendedor], OCTG.PymntGroup [Condiciones de pago], Comments [Comentarios], EDocNum [Documento electrónico]
						, ''Documento SAP''[Tipo]
					From ' + @CIA + '.dbo.ODLN 
						JOIN ' + @CIA + '.dbo.OSLP ON ODLN.SlpCode = OSLP.SlpCode
						JOIN ' + @CIA + '.dbo.OCRD ON ODLN.CardCode = OCRD.CardCode
						JOIN ' + @CIA + '.dbo.OCTG ON OCRD.GroupNum = OCTG.GroupNum AND ODLN.DocType = ''I'''
					IF @DocEntry = 0
				BEGIN
					SET @QRY += ' 
						Where DocDate BETWEEN @Desde AND @Hasta AND ISNULL(ODLN.U_TipoOV, '''') <> ''PRY'' '--DocDate BETWEEN @Desde AND @Hasta
					IF @CardName <> ''
						SET @QRY += ' AND OCRD.CardName like @CardName'
					IF @Series <> 0
						SET @QRY += ' AND ODLN.Series = @Series'	
			
					IF @CardCode <> '' 
						SET @QRY += ' AND OCRD.CardCode like @CardCode '
					IF @Comments <> '' 
						SET @QRY += ' AND OINV.Comments like @Comments '
				END
				ELSE
				BEGIN
					SET @QRY += ' Where DocNum = @DocNum AND DocType = ''I'' AND ISNULL(ODLN.U_TipoOV, '''') <> ''PRY'' '
				END		
			

				SET @PARAMETROS = '@CardCode VARCHAR(10), @CardName VARCHAR(500), @Series INT, @Desde DATE, @Hasta DATE, @DocNum INT, @idDocumento numeric(18,0),@Comments varchar(500)'
				EXECUTE sp_executesql @QRY, @PARAMETROS, @CardCode, @CardName, @Series, @Desde, @Hasta, @DocEntry, @idDocumento	,@Comments			
				end			
		END

		IF @idDocumento = 23
		BEGIN
			
			SET @QRY = '
				Select 
					OQUT.Series, OQUT.DocEntry, OQUT.ObjType, DocNum, DocDate [Fecha de contabilización], OCRD.CardName [Cliente], CASE WHEN DocStatus = ''O'' THEN ''Abierto'' ELSE ''Cerrado'' END [Estado],
					DocCur [Moneda], CASE WHEN DocCur = ''USD'' THEN DocTotalFC ELSE DocTotal END [Total del documento**], 
					CASE WHEN DocCur = ''USD'' THEN PaidFC ELSE PaidToDate END [Importe aplicado**], SlpName [Vendedor], OCTG.PymntGroup [Condiciones de pago], Comments [Comentarios], EDocNum [Documento electrónico], ''Documento SAP''[Tipo]
				From ' + @CIA + '.dbo.OQUT 
					JOIN ' + @CIA + '.dbo.OSLP ON OQUT.SlpCode = OSLP.SlpCode
					JOIN ' + @CIA + '.dbo.OCRD ON OQUT.CardCode = OCRD.CardCode
					JOIN ' + @CIA + '.dbo.OCTG ON OCRD.GroupNum = OCTG.GroupNum AND OQUT.DocType = ''I'' AND OQUT.DocSubType <> ''DN'''
				
				IF @DocEntry = 0
				BEGIN
					SET @QRY += ' 
						Where DocDate BETWEEN @Desde AND @Hasta'
					IF @CardName <> ''
						SET @QRY += ' AND OCRD.CardName like @CardName'
					IF @Series <> 0
						SET @QRY += ' AND OQUT.Series = @Series'	
			
					IF @CardCode <> '' 
						SET @QRY += ' AND OCRD.CardCode like @CardCode '
				END
				ELSE
				BEGIN
					SET @QRY += ' Where OQUT.DocNum = @DocNum AND DocType = ''I'''
				END		
				SET @QRY += ' AND OQUT.ObjType = @idDocumento'


			SET @QRY += ' UNION ALL
			Select 
					sap.ODRF.Series, sap.ODRF.DocEntry, sap.ODRF.ObjType, sap.ODRF.DocEntry [DocNum], DocDate [Fecha de contabilización], OCRD.CardName [Cliente], CASE WHEN DocStatus = ''O'' THEN ''Abierto'' ELSE ''Cerrado'' END [Estado],
					DocCur [Moneda], CASE WHEN DocCur = ''USD'' THEN DocTotalFC ELSE DocTotal END [Total del documento**], 
					CASE WHEN DocCur = ''USD'' THEN PaidFC ELSE PaidToDate END [Importe aplicado**], SlpName [Vendedor], OCTG.PymntGroup [Condiciones de pago], Comments [Comentarios], EDocNum [Documento electrónico], ''Borrador''[Tipo]
				From ' + @CIA + '.dbo.sap.ODRF 
					JOIN ' + @CIA + '.dbo.OSLP ON sap.ODRF.SlpCode = OSLP.SlpCode
					JOIN ' + @CIA + '.dbo.OCRD ON sap.ODRF.CardCode = OCRD.CardCode
					JOIN ' + @CIA + '.dbo.OCTG ON OCRD.GroupNum = OCTG.GroupNum AND sap.ODRF.DocType = ''I'' AND sap.ODRF.DocSubType <> ''DN'' AND sap.ODRF.DocStatus=''O'''
						
			IF @DocEntry = 0
				BEGIN
					SET @QRY += ' 
						Where DocDate BETWEEN @Desde AND @Hasta'
					IF @CardName <> ''
						SET @QRY += ' AND OCRD.CardName like @CardName'
					IF @Series <> 0
						SET @QRY += ' AND sap.ODRF.Series = @Series'	
			
					IF @CardCode <> '' 
						SET @QRY += ' AND OCRD.CardCode like @CardCode '
				END
				ELSE
				BEGIN
					SET @QRY += ' Where sap.ODRF.DocEntry = @DocNum AND DocType = ''I'''
				END
				
				SET @QRY += ' AND sap.ODRF.ObjType = @idDocumento'
		
			SET @PARAMETROS = '@CardCode VARCHAR(10), @CardName VARCHAR(500), @Series INT, @Desde DATE, @Hasta DATE, @DocNum INT, @idDocumento numeric(18,0),@Comments varchar(500)'
			EXECUTE sp_executesql @QRY, @PARAMETROS, @CardCode, @CardName, @Series, @Desde, @Hasta, @DocEntry, @idDocumento	,@Comments			
		END

		IF @idDocumento = 17
		BEGIN
			if @busquedade =1
			BEGIN
				SET @QRY = '
				Select 
					ORDR.Series, ORDR.DocEntry, ORDR.ObjType, DocNum, DocDate [Fecha de contabilización], OCRD.CardName [Cliente], CASE WHEN DocStatus = ''O'' THEN ''Abierto'' ELSE ''Cerrado'' END [Estado],
					DocCur [Moneda], CASE WHEN DocCur = ''USD'' THEN DocTotalFC ELSE DocTotal END [Total del documento**], 
					CASE WHEN DocCur = ''USD'' THEN PaidFC ELSE PaidToDate END [Importe aplicado**], SlpName [Vendedor], OCTG.PymntGroup [Condiciones de pago], Comments [Comentarios], EDocNum [Documento electrónico], ''Documento SAP''[Tipo]
				From ' + @CIA + '.dbo.ORDR 
					JOIN ' + @CIA + '.dbo.OSLP ON ORDR.SlpCode = OSLP.SlpCode
					JOIN ' + @CIA + '.dbo.OCRD ON ORDR.CardCode = OCRD.CardCode
					JOIN ' + @CIA + '.dbo.OCTG ON OCRD.GroupNum = OCTG.GroupNum AND ORDR.DocType = ''I'' AND ORDR.DocSubType <> ''DN'''
				
				IF @DocEntry = 0
				BEGIN
					SET @QRY += ' 
						Where 1=1  and ORDR.docstatus = ''O'' '--DocDate BETWEEN @Desde AND @Hasta
					--IF @CardName <> ''
					--	SET @QRY += ' AND OCRD.CardName like @CardName'
					IF @Series <> 0
						SET @QRY += ' AND ORDR.Series = @Series'	
					IF @Comments <> '' 
						SET @QRY += ' AND OINV.Comments like @Comments '
			
					IF @CardCode <> '' 
						SET @QRY += ' AND OCRD.CardCode like @CardCode '
				END
				ELSE
				BEGIN
					SET @QRY += ' Where ORDR.DocNum = @DocNum AND DocType = ''I'''
				END		
				SET @QRY += ' AND ORDR.ObjType = @idDocumento'		
				SET @QRY += ' ORDER BY Docdate desc'		
		
				SET @PARAMETROS = '@CardCode VARCHAR(10), @CardName VARCHAR(500), @Series INT, @Desde DATE, @Hasta DATE, @DocNum INT, @idDocumento numeric(18,0),@Comments varchar(500)'
				EXECUTE sp_executesql @QRY, @PARAMETROS, @CardCode, @CardName, @Series, @Desde, @Hasta, @DocEntry, @idDocumento	,@Comments	
			end
			else
			BEGIN
				SET @QRY = '
					Select 
						ORDR.Series, ORDR.DocEntry, ORDR.ObjType, DocNum, DocDate [Fecha de contabilización], OCRD.CardName [Cliente], CASE WHEN DocStatus = ''O'' THEN ''Abierto'' ELSE ''Cerrado'' END [Estado],
						DocCur [Moneda], CASE WHEN DocCur = ''USD'' THEN DocTotalFC ELSE DocTotal END [Total del documento**], 
						CASE WHEN DocCur = ''USD'' THEN PaidFC ELSE PaidToDate END [Importe aplicado**], SlpName [Vendedor], OCTG.PymntGroup [Condiciones de pago], Comments [Comentarios], EDocNum [Documento electrónico], ''Documento SAP''[Tipo]
					From ' + @CIA + '.dbo.ORDR 
						JOIN ' + @CIA + '.dbo.OSLP ON ORDR.SlpCode = OSLP.SlpCode
						JOIN ' + @CIA + '.dbo.OCRD ON ORDR.CardCode = OCRD.CardCode
						JOIN ' + @CIA + '.dbo.OCTG ON OCRD.GroupNum = OCTG.GroupNum AND ORDR.DocType = ''I'' AND ORDR.DocSubType <> ''DN'''
				
					IF @DocEntry = 0
					BEGIN
						SET @QRY += ' 
							Where DocDate BETWEEN @Desde AND @Hasta '--
						IF @CardName <> ''
							SET @QRY += ' AND OCRD.CardName like @CardName'
						IF @Series <> 0
							SET @QRY += ' AND ORDR.Series = @Series'	
					IF @Comments <> '' 
						SET @QRY += ' AND OINV.Comments like @Comments '
			
						IF @CardCode <> '' 
							SET @QRY += ' AND OCRD.CardCode like @CardCode '
					END
					ELSE
					BEGIN
						SET @QRY += ' Where ORDR.DocNum = @DocNum AND DocType = ''I'''
					END		
					SET @QRY += ' AND ORDR.ObjType = @idDocumento'
			
		
				SET @PARAMETROS = '@CardCode VARCHAR(10), @CardName VARCHAR(500), @Series INT, @Desde DATE, @Hasta DATE, @DocNum INT, @idDocumento numeric(18,0),@Comments varchar(500)'
				EXECUTE sp_executesql @QRY, @PARAMETROS, @CardCode, @CardName, @Series, @Desde, @Hasta, @DocEntry, @idDocumento	,@Comments			
			end
		END

		IF @idDocumento = 20
		BEGIN
			SET @QRY = '
					SELECT OPDN.Series
					, OPDN.DocEntry
					, OPDN.ObjType
					, OPDN.DocNum
					, OPDN.DocDate [Fecha de contabilización]
					, OCRD.CardName [Cliente]
					, CASE WHEN DocStatus = ''O'' THEN ''Abierto'' ELSE ''Cerrado'' END [Estado]
					, OPDN.DocCur [Moneda]
					, CASE WHEN DocCur = ''USD'' THEN DocTotalFC ELSE DocTotal END [Total del documento**]
					, CASE WHEN DocCur = ''USD'' THEN PaidFC ELSE PaidToDate END [Importe aplicado**]
					, OSLP.SlpName [Vendedor]
					, OCTG.PymntGroup [Condiciones de pago]
					, Comments [Comentarios]
					, EDocNum [Documento electrónico]
					, ''Documento SAP'' [Tipo]
					FROM ' + @CIA + '.dbo.OPDN 
					JOIN ' + @CIA + '.dbo.OSLP ON OSLP.SlpCode = OPDN.SlpCode
					JOIN ' + @CIA + '.dbo.OCRD ON OCRD.CardCode = OPDN.CardCode
					JOIN ' + @CIA + '.dbo.OCTG ON OCTG.GroupNum = OCRD.GroupNum AND OPDN.DocType = ''I'' AND OPDN.DocSubType <> ''DN'' '
				IF @Comments <> '' 
						SET @QRY += ' WHERE OPDN.DocCur = @Comments '
			
				
			
		
				SET @PARAMETROS = '@Comments varchar(500)'
				EXECUTE sp_executesql @QRY, @PARAMETROS	,@Comments	
		END

		IF @idDocumento = 10008
		BEGIN
			SET @QRY = 'Select 
							 DocEntry, CardCode [S/N], CardName [Nombre], DocNum [Número de documento], ISNULL(NumAtCard,'''') [Folio Proveedor], DocDate [Fecha de contabilización], DocDuedate [Fecha de entrega],
							CASE WHEN DocStatus = ''C'' THEN ''Cerrado''
								 WHEN DocStatus = ''O'' THEN ''Abierto'' End [Estatus], 
							 DocCur [Moneda], DocTotal [Total]
						 From [SBOCTRZ].dbo.OPDN 
						 Where Series = 13 AND DocType = ''I'' '
			IF @NumAtCard <> ''
				SET @QRY += ' AND NumAtCard like ''' + @NumAtCard + ''''

			IF @CardCode <> ''
				SET @QRY += '
							AND DocDate >= ''' + @DocDate + ''' 
							AND CardCode like '''+ @CardCode + ''''
			IF @CardName <> ''
				SET @QRY += '
							AND DocDate >= ''' + @DocDate + '''
							AND CardName like '''+ @CardName + ''''
		
			print @QRY

		--	select @QRY
			EXECUTE sp_executesql @QRY
		END

		IF @idDocumento = 10009
		BEGIN
			SET @QRY = 'Select 
							 DocEntry, CardCode [S/N], CardName [Nombre], DocNum [Número de documento], ISNULL(NumAtCard,'''') [Folio Proveedor], DocDate [Fecha de contabilización], DocDuedate [Fecha de entrega],
							CASE WHEN DocStatus = ''C'' THEN ''Cerrado''
								 WHEN DocStatus = ''O'' THEN ''Abierto'' End [Estatus], 
							 DocCur [Moneda], DocTotal [Total]
						 From [SBOCTRZ].dbo.ORPD 
						 Where Series = 14 AND DocType = ''I'''
			IF @NumAtCard <> ''
				SET @QRY += ' AND NumAtCard like ''' + @NumAtCard + ''''
			IF @CardCode <> ''
				SET @QRY += '
							AND DocDate >= ''' + @DocDate + ''' 
							AND CardCode like '''+ @CardCode + ''''
			IF @CardName <> ''
				SET @QRY += '
							AND DocDate >= ''' + @DocDate + '''
							AND CardName like '''+ @CardName + ''''
		
			print @QRY
			EXECUTE sp_executesql @QRY
		END
	END

	IF @TipoConsulta = 2
	BEGIN
		if @Version is not null
		BEGIN
			SET @QRY ='
				Select top 5 A.ItemCode, A.ItemName, ISNULL( D.Price, B.Price) Price , ISNULL(B.Currency, '''') Currency,isnull(A.ncmcode,1)ncmcode,
				--Select A.ItemCode, A.ItemName,  B.Price -isnull((b.Price*(F.descuento/100)),0) Price , ISNULL(B.Currency, '''') Currency,
					(Select Rate from ' + @CIA + '.dbo.ORTT Where ORTT.RateDate = CAST(GETDATE() AS DATE)) Rate, 
					ISNULL(ManBtchNum, '''') ManBtchNum, 0 OnHand, 0 Ideal,''ZZZ'' Clasificacion 
				From ' + @CIA + '.dbo.OITM A 
					INNER JOIN ' + @CIA + '.dbo.ITM1 B ON A.ItemCode = B.ItemCode AND A.sellitem =''Y'' --AND B.Currency IS NOT NULL		
					LEFT JOIN ' + @CIA + '.dbo.OSPP D ON D.CardCode = @CardCode AND D.ItemCode = A.ItemCode
					JOIN ' + @CIA + '.dbo.OCRD E ON E.CardCode = @CardCode and B.PriceList = E.ListNum 
					left JOIN  sales.ClientesDescuento F on E.cardcode collate database_default = F.CardCode'
			IF ISNULL(@ItemCode, '') <> ''
				SET @QRY += ' WHERE A.ITEMCODE = ''' + @ITEMCODE + ''''

			SET @QRY += '
				ORDER BY A.ItemCode'

			SET @PARAMETROS = '@CardCode VARCHAR(10)'
			EXECUTE sp_executesql @QRY, @PARAMETROS, @CardCode
		end
		else
		BEGIN
			SET @QRY ='
				Select  A.ItemCode, A.ItemName, ISNULL( D.Price, B.Price) Price , ISNULL(B.Currency, '''') Currency,isnull(A.ncmcode,1)ncmcode,
				--Select A.ItemCode, A.ItemName,  B.Price -isnull((b.Price*(F.descuento/100)),0) Price , ISNULL(B.Currency, '''') Currency,
					(Select Rate from ' + @CIA + '.dbo.ORTT Where ORTT.RateDate = CAST(GETDATE() AS DATE)) Rate, 
					ISNULL(ManBtchNum, '''') ManBtchNum, 0 OnHand, 0 Ideal,''ZZZ'' Clasificacion 
				From ' + @CIA + '.dbo.OITM A 
					INNER JOIN ' + @CIA + '.dbo.ITM1 B ON A.ItemCode = B.ItemCode AND A.sellitem =''Y'' --AND B.Currency IS NOT NULL
					LEFT JOIN ' + @CIA + '.dbo.OSPP D ON D.CardCode = @CardCode AND D.ItemCode = A.ItemCode
					JOIN ' + @CIA + '.dbo.OCRD E ON E.CardCode = @CardCode and B.PriceList = E.ListNum 
					left JOIN  sales.ClientesDescuento F on E.cardcode collate database_default = F.CardCode'
			IF ISNULL(@ItemCode, '') <> ''
				SET @QRY += ' WHERE A.ITEMCODE = ''' + @ITEMCODE + ''''

			SET @QRY += '
				ORDER BY A.ItemCode'

			SET @PARAMETROS = '@CardCode VARCHAR(10)'
			EXECUTE sp_executesql @QRY, @PARAMETROS, @CardCode
		end
	END

	IF @TipoConsulta = 3
	BEGIN
		SET @QRY =
			'SELECT Rate FROM ' + @CIA + '.DBO.ORTT WHERE RateDate = CAST(@Key AS DATE)'
		
		SET @PARAMETROS = '@Key VARCHAR(50)'

		EXECUTE sp_executesql @QRY, @PARAMETROS, @Key
	END

	--CONSULTA DE CATALOGO ESPECIFICO DE USUARIO
	IF @TipoConsulta = 4
	BEGIN
		IF (@FieldID = 39 AND @TblUsuario = 'OINV') OR (@FieldID = 31 AND @TblUsuario = 'OCRD') 
		BEGIN
			SET @QRY = '
				Select '''' [Code], '''' [Name] 
				UNION ALL
				Select Usage [Code], Usage + '' - '' + Descr [Name] From SBOCTRZ.dbo.OUSG'
		END
		ELSE
		BEGIN
			SET @QRY =
				'SELECT FldValue[Code], FldValue + '' - '' + Descr[Name]  
				FROM ' + @CIA + '.DBO.UFD1 
				WHERE TableID = @TblUsuario 
				AND FieldID = @FieldID 
				ORDER BY IndexID'
		END

		SET @PARAMETROS = '@TblUsuario VARCHAR(50), @FieldID smallint'
		EXECUTE sp_executesql @QRY, @PARAMETROS, @TblUsuario, @FieldID
	END

	IF @TipoConsulta = 5
	BEGIN
		IF @ObjType = 13
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY =	'
					SELECT 
						isnull(c.ReportID,'''') Edocnum,
						a.ShipToCode address,a.*,b.taxcode FROM ' + @CIA + '.dbo.OINV  a
				JOIN ' + @CIA + '.dbo.crd1 b on a.cardcode = b.cardcode 
				left JOIN ' + @CIA + '.dbo.ECM2 c on a.DocenTry = c.SrcObjAbs 	and a.ObjType = c.SrcObjType	
				Where a.DocenTry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'Borrador'
			BEGIN
				SET @QRY =	'SELECT  a.ShipToCode address,a.*,b.taxcode  FROM ' + @CIA + '.dbo.sap.ODRF a 
				JOIN ' + @CIA + '.dbo.crd1 b on a.cardcode = b.cardcode Where  a.DocenTry = @DocEntry AND a.ObjType =13'
				SET @PARAMETROS = '@DocEntry INT'
			END
		END
		IF @ObjType = 15
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY =	'SELECT a.ShipToCode address,a.*,b.taxcode FROM ' + @CIA + '.dbo.ODLN a 
				JOIN ' + @CIA + '.dbo.crd1 b on a.cardcode = b.cardcode Where a.DocenTry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'Borrador'
			BEGIN
				SET @QRY =	'SELECT a.ShipToCode address,a.*,b.taxcode FROM ' + @CIA + '.dbo.sap.ODRF a 
				JOIN ' + @CIA + '.dbo.crd1 b on a.cardcode = b.cardcode Where a.DocenTry = @DocEntry AND a.ObjType =15'
				SET @PARAMETROS = '@DocEntry INT'
			END
		END

		IF @ObjType = 23
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY =	'SELECT * FROM ' + @CIA + '.dbo.OQUT Where DocenTry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'Borrador'
			BEGIN
				SET @QRY =	'SELECT * FROM ' + @CIA + '.dbo.sap.ODRF Where DocenTry = @DocEntry '
				SET @PARAMETROS = '@DocEntry INT'
			END
		END

		IF @ObjType = 17
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY =	'SELECT a.ShipToCode address,a.*,b.taxcode FROM ' + @CIA + '.dbo.ORDR a 
				JOIN ' + @CIA + '.dbo.crd1 b on a.cardcode = b.cardcode  Where a.DocEntry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'Borrador'
			BEGIN
				SET @QRY =	'SELECT a.ShipToCode address,a.*,b.taxcode FROM ' + @CIA + '.dbo.sap.ODRF a 
				JOIN ' + @CIA + '.dbo.crd1 b on a.cardcode = b.cardcode Where a.DocenTry = @DocEntry AND a.ObjType =17'
				SET @PARAMETROS = '@DocEntry INT'
			END
		END

		EXECUTE sp_executesql @QRY, @PARAMETROS, @DocEntry
	END

	IF @TipoConsulta = 6
	BEGIN
		IF @ObjType = 13
			IF @sType = ''
			BEGIN
				SET @QRY = '
					SELECT A.*, B.WhsName , B.RevenuesAc ,c.ManBtchNum,D.WhsName U_WhsName
					FROM ' + @CIA + '.dbo.INV1 A
						LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
						LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
						LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
					WHERE a.DocenTry = @DocEntry /*and a.TreeType <> ''I''*/'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE
			BEGIN
				SET @QRY = '
					SELECT aa.doccur currency,A.*, B.WhsName, B.RevenuesAc ,c.ManBtchNum,D.WhsName U_WhsName
					FROM ' + @CIA + '.dbo.sap.DRF1 A
						LEFT JOIN ' + @CIA + '.dbo.sap.ODRF aa ON A.docentry = aa.docentry
						LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
						LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode 
						LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
					WHERE a.DocenTry = @DocEntry  AND A.ObjType = 13 /*and a.TreeType <> ''I''*/'
				SET @PARAMETROS = '@DocEntry INT'
			END
		IF @ObjType = 15
			IF @sType = ''
			BEGIN
				SET @QRY = '
					SELECT A.*, B.WhsName , B.RevenuesAc ,c.ManBtchNum,D.WhsName U_WhsName
					FROM ' + @CIA + '.dbo.DLN1 A
						LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
						LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
						LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
					WHERE a.DocenTry = @DocEntry  /*and a.TreeType <> ''I''*/'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE
			BEGIN
				SET @QRY = '
					SELECT A.*, B.WhsName, B.RevenuesAc ,c.ManBtchNum ,D.WhsName U_WhsName
					FROM ' + @CIA + '.dbo.sap.DRF1 A
						LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
						LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
						LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
					WHERE a.DocenTry = @DocEntry  AND A.ObjType =15 /*and a.TreeType <> ''I''*/'
				SET @PARAMETROS = '@DocEntry INT'
			END
		IF @ObjType = 23
			IF @sType = ''
			BEGIN
				SET @QRY = '
					SELECT A.*, B.WhsName, B.RevenuesAc  
					FROM ' + @CIA + '.dbo.QUT1 A
						LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
					WHERE DocenTry = @DocEntry '
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE
			BEGIN
				SET @QRY = '
					SELECT A.*, B.WhsName, B.RevenuesAc 
					FROM ' + @CIA + '.dbo.sap.DRF1 A
						LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
					WHERE a.DocenTry = @DocEntry AND A.ObjType =17 '
				SET @PARAMETROS = '@DocEntry INT'
			END

		IF @ObjType = 17
			IF @sType = ''
			BEGIN
				SET @QRY = '
					SELECT isnull(a.U_StockAlmacen,0)U_StockAlmacen,A.*, B.WhsName, B.RevenuesAc,c.ManBtchNum,D.WhsName U_WhsName
					FROM ' + @CIA + '.dbo.RDR1 A
						LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
						LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
						LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
					WHERE a.DocenTry = @DocEntry /*and a.TreeType <> ''I''*/'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE
			BEGIN
				SET @QRY = '
					SELECT isnull(a.U_StockAlmacen,0)U_StockAlmacenA.*, B.WhsName, B.RevenuesAc ,c.ManBtchNum ,D.WhsName U_WhsName
					FROM ' + @CIA + '.dbo.sap.DRF1 A
						LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
						LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
						LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
					WHERE a.DocenTry = @DocEntry AND A.ObjType =17 /*and a.TreeType <> ''I''*/'
				SET @PARAMETROS = '@DocEntry INT'
			END


		EXECUTE sp_executesql @QRY, @PARAMETROS, @DocEntry
	END

	IF @TipoConsulta = 7
	BEGIN
		IF @ObjType = 13
		BEGIN
				SELECT * FROM(
					Select DocEntry, DocNum From SBOCTRZ.dbo.OINV 
					--Where DocSubType <> 'DN'
					where Series =@Series
					ORDER BY DocEntry  DESC 
					OFFSET 0 ROWS FETCH FIRST 1000 ROWS ONLY
				)T0
			   ORDER BY DocEntry
		END
		IF @ObjType = 15
		BEGIN
			SELECT * FROM(
					Select DocEntry, DocNum From SBOCTRZ.dbo.ODLN 
					where Series = 7
					ORDER BY DocEntry  DESC 
					OFFSET 0 ROWS FETCH FIRST 1000 ROWS ONLY
				)T0
			   ORDER BY DocEntry
		END
		IF @ObjType = 23
		BEGIN
				Select DocEntry, DocNum From SBOCTRZ.dbo.OQUT 
				ORDER BY DocEntry  DESC 
				OFFSET 0 ROWS FETCH FIRST 1000 ROWS ONLY;
		END
		IF @ObjType = 17
		BEGIN
				SELECT * FROM(
					Select DocEntry, DocNum, DocDate From SBOCTRZ.dbo.ORDR  
					where Series = isnull(@Series,9)
					ORDER BY DocEntry  DESC 
					 OFFSET 0 ROWS FETCH FIRST 1000 ROWS ONLY
				)T0
			   ORDER BY DocEntry
		END

	END
	
	IF @TipoConsulta = 11 --SE CONSULTA EL ENCABEZADO DEL FOLIO BORRADOR
	BEGIN
	------------------
		IF @ObjType = 20 --Verificar si esta opcion va a continuar en este nuevo procedimiento
		BEGIN 
			Select CAST(Series AS INT) [Series], *, '' U_FPROV From SBOCTRZ.dbo.OPDN Where DocNum = @Key AND Series = 13
		END
		IF @ObjType = 21 --Verificar si esta opcion va a continuar en este nuevo procedimiento
		BEGIN 
			Select *, '' U_FPROV From SBOCTRZ.dbo.ORPD Where DocNum = @Key-- AND Series = 14
		END
		IF @ObjType = 14 --Verificar si esta opcion va a continuar en este nuevo procedimiento
		BEGIN 
			--IF @sType = 'Borrador'
			--BEGIN
			--	Select CAST(A.DocNum AS INT) DocNum, '' U_FPROV, CAST(A.DocNum AS INT) DocEntry,
			--		B.CardName, A.DocCur, '' NumAtCard, A.DocStatus, A.DocDate, A.DocDate DocDueDate,
			--		A.Comments, A.DocRate, B.CardCode, DocTotal, A.DocTotalFC, A.VatSum, A.VatSumFC, A.U_METPAGO2, A.Indicator, A.Series, A.U_Motivo,
			--		E.LugarExpedicion LugarExp
			--		, E.Calle
			--		, E.NoExt
			--		, E.NoInt
			--		, E.Colonia
			--		, E.Municipio
			--		, E.Estado
			--		, E.CP
			--		, B.VatGroup
			--		, CAST(ISNULL(A.DocNumSAP, 0) AS INT) DocNumSAP
			--	From  SDK_ORIN A
			--		JOIN SBOCTRZ.dbo.OCRD B on A.CardCode = B.CardCode
			--		LEFT JOIN HNT.ExpedicionSeries D ON A.Series = D.Series
			--		LEFT JOIN HNT.Expedicion E ON D.idExpedicion = E.Id 
			--	Where DocNum = @Key AND A.ObjType = 14
			--END

			IF @sType = 'RC'
			BEGIN
				Select CAST(A.DocNum AS INT) DocNum, '' U_FPROV, CAST(A.DocEntry AS INT) DocEntry,
					B.CardName, A.DocCur, '' NumAtCard, A.DocStatus, A.DocDate, A.DocDate DocDueDate,
					A.Comments, A.DocRate, B.CardCode, DocTotal, A.DocTotalFC, A.VatSum, A.VatSumFC, ISNULL(A.U_MPAGO2,'') U_METPAGO2, A.Indicator, CAST(A.Series AS INT) Series, A.U_Motivo,
					E.LugarExpedicion LugarExp
					, E.Calle
					, E.NoExt
					, E.NoInt
					, E.Colonia
					, E.Municipio
					, E.Estado
					, E.CP
					, B.VatGroup
					, CAST(0 AS INT) DocNumSAP
				From  SBOCTRZ.dbo.ORIN A
					JOIN SBOCTRZ.dbo.OCRD B on A.CardCode = B.CardCode
					LEFT JOIN HNT.ExpedicionSeries D ON A.Series = D.Series
					LEFT JOIN HNT.Expedicion E ON D.idExpedicion = E.Id 
				Where A.DocNum = @Key-- AND Series = 14
			END
		END
		IF @ObjType = 16 --Verificar si esta opcion va a continuar en este nuevo procedimiento
		BEGIN 
			--IF @sType = 'Borrador'
			--BEGIN
			--	Select CAST(A.DocNum AS INT) DocNum, '' U_FPROV, CAST(A.DocNum AS INT) DocEntry,
			--		B.CardName, A.DocCur, '' NumAtCard, A.DocStatus, A.DocDate, A.DocDate DocDueDate,
			--		A.Comments, A.DocRate, B.CardCode, DocTotal, A.DocTotalFC, A.VatSum, A.VatSumFC, A.U_METPAGO2, A.Indicator, A.Series, A.U_Motivo,
			--		E.LugarExpedicion LugarExp
			--		, E.Calle
			--		, E.NoExt
			--		, E.NoInt
			--		, E.Colonia
			--		, E.Municipio
			--		, E.Estado
			--		, E.CP
			--		, B.VatGroup
			--		, CAST(ISNULL(A.DocNumSAP, 0) AS INT) DocNumSAP
			--	From  SDK_ORIN A
			--		JOIN SBOCTRZ.dbo.OCRD B on A.CardCode = B.CardCode
			--		LEFT JOIN HNT.ExpedicionSeries D ON A.Series = D.Series
			--		LEFT JOIN HNT.Expedicion E ON D.idExpedicion = E.Id 
			--	Where DocNum = @Key AND A.ObjType = 16
			--END

			IF @sType = 'DV'
			BEGIN
				Select CAST(A.DocNum AS INT) DocNum, '' U_FPROV, CAST(A.DocEntry AS INT) DocEntry,
					B.CardName, A.DocCur, '' NumAtCard, A.DocStatus, A.DocDate, A.DocDate DocDueDate,
					A.Comments, A.DocRate, B.CardCode, DocTotal, A.DocTotalFC, A.VatSum, A.VatSumFC, ISNULL(A.U_MPAGO2,'') U_METPAGO2, A.Indicator, CAST(A.Series AS INT) Series, A.U_Motivo,
					E.LugarExpedicion LugarExp
					, E.Calle
					, E.NoExt
					, E.NoInt
					, E.Colonia
					, E.Municipio
					, E.Estado
					, E.CP
					, B.VatGroup
					, CAST(0 AS INT) DocNumSAP
				From  SBOCTRZ.dbo.ORDN A
					JOIN SBOCTRZ.dbo.OCRD B on A.CardCode = B.CardCode
					LEFT JOIN HNT.ExpedicionSeries D ON A.Series = D.Series
					LEFT JOIN HNT.Expedicion E ON D.idExpedicion = E.Id 
				Where A.DocNum = @Key-- AND Series = 14
			END
		END
		IF @ObjType = 22 --Verificar si esta opcion va a continuar en este nuevo procedimiento
		BEGIN 
			IF @sType = 'DV'
			BEGIN
				Select CAST(A.DocNum AS INT) DocNum, '' U_FPROV, CAST(A.DocEntry AS INT) DocEntry,
					B.CardName, A.DocCur, '' NumAtCard, A.DocStatus, A.DocDate, A.DocDate DocDueDate,
					A.Comments, A.DocRate, B.CardCode, DocTotal, A.DocTotalFC, A.VatSum, A.VatSumFC, ISNULL(A.U_MPAGO2,'') U_METPAGO2, A.Indicator, CAST(A.Series AS INT) Series, A.U_Motivo,
					E.LugarExpedicion LugarExp
					, E.Calle
					, E.NoExt
					, E.NoInt
					, E.Colonia
					, E.Municipio
					, E.Estado
					, E.CP
					, B.VatGroup
					, CAST(0 AS INT) DocNumSAP
				From  SBOCTRZ.dbo.ORDN A
					JOIN SBOCTRZ.dbo.OCRD B on A.CardCode = B.CardCode
					LEFT JOIN HNT.ExpedicionSeries D ON A.Series = D.Series
					LEFT JOIN HNT.Expedicion E ON D.idExpedicion = E.Id 
				Where A.DocNum = @Key-- AND Series = 14
			END
		END
		
		IF @ObjType = 17 --OPCION PARA DEVOLVER EL ENCABEZADO DE UN FOLIO DE TIPO OFERTA DE VTA
		BEGIN
			IF @sType = '17'
			BEGIN
				if exists(select * from SBOCTRZ.dbo.ORDR Where DocEntry = @Key AND ObjType = @ObjType)
					Select CAST(A.DocNum AS INT) DocNum, '' U_FPROV, CAST(A.DocEntry AS INT) DocEntry, A.DocType, CAST(A.ObjType AS INT) ObjType,
						B.CardName, A.DocCur, A.DocStatus, A.DocDate, A.DocDate DocDueDate,
						A.Comments, A.DocRate, B.CardCode, DocTotal, A.DocTotalFC, A.VatSum, A.VatSumFC, A.U_MPAGO2 U_METPAGO2, A.Indicator, CAST(A.Series AS INT) Series, A.U_Motivo,
						E.LugarExpedicion LugarExp
						, E.Calle
						, E.NoExt
						, E.NoInt
						, E.Colonia
						, E.Municipio
						, E.Estado
						, E.CP
						, bb.TaxCode VatGroup
						, CAST(ISNULL(A.DocNum, 0) AS INT) DocNumSAP
						,A.NumAtCard, A.DocDueDate, A.U_TPedido, A.U_Titular, A.U_OC, A.SlpCode
						,a.U_TIPOOV, ISNULL(A.U_TC,0)[U_TC],isnull(a.EDocNum,'')EDocNum,a.EDocErrMsg
						,a.ShipToCode address
					From  SBOCTRZ.dbo.ORDR A
						JOIN SBOCTRZ.dbo.OCRD B on A.CardCode = B.CardCode
						JOIN SBOCTRZ.dbo.crd1 bb on b.CardCode = bb.CardCode  and AdresType = 'S'
						LEFT JOIN HNT.ExpedicionSeries D ON A.Series = D.Series
						LEFT JOIN HNT.Expedicion E ON D.idExpedicion = E.Id 
					Where A.DocEntry = @Key AND A.ObjType = @ObjType--14
			END

		END
		IF @ObjType = 15 --OPCION PARA DEVOLVER EL ENCABEZADO DE UN FOLIO DE TIPO OFERTA DE VTA
		BEGIN
			--IF @sType = 'Borrador'
			--BEGIN
			--	Select CAST(A.DocNum AS INT) DocNum, '' U_FPROV, CAST(A.DocNum AS INT) DocEntry, A.DocType, A.ObjType,
			--		B.CardName, A.DocCur, A.DocStatus, A.DocDate, A.DocDate DocDueDate,
			--		A.Comments, A.DocRate, B.CardCode, DocTotal, A.DocTotalFC, A.VatSum, A.VatSumFC, A.U_METPAGO2, A.Indicator, A.Series, A.U_Motivo,
			--		E.LugarExpedicion LugarExp
			--		, E.Calle
			--		, E.NoExt
			--		, E.NoInt
			--		, E.Colonia
			--		, E.Municipio
			--		, E.Estado
			--		, E.CP
			--		, B.VatGroup
			--		, CAST(ISNULL(A.DocNumSAP, 0) AS INT) DocNumSAP
			--		,A.NumAtCard, A.DocDueDate, A.U_TPedido, A.U_Titular, A.U_OC, A.SlpCode, A.U_CUENTA
			--		,a.U_TipoOV, ISNULL(A.U_UTC,0)[U_TC],'' EdocNum
			--	From  SAP_DocumentHeader A
			--		JOIN SBOCTRZ.dbo.OCRD B on A.CardCode = B.CardCode
			--		LEFT JOIN HNT.ExpedicionSeries D ON A.Series = D.Series
			--		LEFT JOIN HNT.Expedicion E ON D.idExpedicion = E.Id 
			--	Where DocNum = @Key AND A.ObjType = @ObjType--14
			--END	
			--ELSE 
			IF @sType = '15'
			BEGIN
				if exists(select * from SBOCTRZ.dbo.ODLN Where DocEntry = @Key AND ObjType = @ObjType)
					Select CAST(A.DocNum AS INT) DocNum, '' U_FPROV, CAST(A.DocEntry AS INT) DocEntry, A.DocType, CAST(A.ObjType AS INT) ObjType,
						B.CardName, A.DocCur, A.DocStatus, A.DocDate, A.DocDate DocDueDate,
						A.Comments, A.DocRate, B.CardCode, DocTotal, A.DocTotalFC, A.VatSum, A.VatSumFC, A.U_MPAGO2 U_METPAGO2, A.Indicator, CAST(A.Series AS INT) Series, A.U_Motivo,
						E.LugarExpedicion LugarExp
						, E.Calle
						, E.NoExt
						, E.NoInt
						, E.Colonia
						, E.Municipio
						, E.Estado
						, E.CP
						, bb.TaxCode VatGroup
						, CAST(ISNULL(A.DocNum, 0) AS INT) DocNumSAP
						,A.NumAtCard, A.DocDueDate, A.U_TPedido, A.U_Titular, A.U_OC, A.SlpCode
						,a.U_TipoOV, ISNULL(A.U_TC,0)[U_TC],isnull(a.EDocNum,'')EDocNum,a.EDocErrMsg
						,a.ShipToCode address
					From  SBOCTRZ.dbo.ODLN A
						JOIN SBOCTRZ.dbo.OCRD B on A.CardCode = B.CardCode
						JOIN SBOCTRZ.dbo.crd1 bb on b.CardCode = bb.CardCode  and AdresType = 'S'
						LEFT JOIN HNT.ExpedicionSeries D ON A.Series = D.Series
						LEFT JOIN HNT.Expedicion E ON D.idExpedicion = E.Id 
					Where A.DocEntry = @Key AND A.ObjType = @ObjType--14
			END
		END
		IF @ObjType = 13 --OPCION PARA DEVOLVER EL ENCABEZADO DE UN FOLIO DE TIPO OFERTA DE VTA
		BEGIN
			IF @sType = '13'
			BEGIN
				if exists(select * from SBOCTRZ.dbo.OINV Where DocEntry = @Key AND ObjType = @ObjType)
					Select CAST(A.DocNum AS INT) DocNum, '' U_FPROV, CAST(A.DocEntry AS INT) DocEntry, A.DocType, CAST(A.ObjType AS INT) ObjType,
						B.CardName, A.DocCur, A.DocStatus, A.DocDate, A.DocDate DocDueDate,
						A.Comments, A.DocRate, B.CardCode, DocTotal, A.DocTotalFC, A.VatSum, A.VatSumFC, A.U_MPAGO2 U_METPAGO2, A.Indicator, CAST(A.Series AS INT) Series, A.U_Motivo,
						E.LugarExpedicion LugarExp
						, E.Calle
						, E.NoExt
						, E.NoInt
						, E.Colonia
						, E.Municipio
						, E.Estado
						, E.CP
						, bb.TaxCode VatGroup
						, CAST(ISNULL(A.DocNum, 0) AS INT) DocNumSAP
						,A.NumAtCard, A.DocDueDate, A.U_TPedido, A.U_Titular, A.U_OC, A.SlpCode
						,a.U_TipoOV, ISNULL(A.U_TC,0)[U_TC]
						,A.EDocGenTyp
						, isnull(c.ReportID,'')EDocNum
						--,A.EDocNum
						,a.EDocErrMsg
						,a.ShipToCode address
					From  SBOCTRZ.dbo.OINV A
						JOIN SBOCTRZ.dbo.OCRD B on A.CardCode = B.CardCode
						JOIN SBOCTRZ.dbo.crd1 bb on b.CardCode = bb.CardCode  and AdresType = 'S'
						LEFT JOIN HNT.ExpedicionSeries D ON A.Series = D.Series
						LEFT JOIN HNT.Expedicion E ON D.idExpedicion = E.Id 
						left JOIN SBOCTRZ.dbo.ECM2 c on a.DocenTry = c.SrcObjAbs and a.ObjType = c.SrcObjType	
					Where A.DocEntry = @Key AND A.ObjType = @ObjType--14
			END
		END
	END

	IF @TipoConsulta = 12 --SE CONSULTA LOS DETALLES DEL FOLIO BORRADOR
	BEGIN
		IF @ObjType = 20 --Verificar si esta opcion va a continuar en este nuevo procedimiento
		BEGIN 
			Select A.VisOrder LineNum, ISNULL(C.BWeight1, 0) BWeight1, 
			ISNULL((Select POR1.Quantity From SBOCTRZ.dbo.POR1 WHERE POR1.DocEntry = A.BaseEntry AND POR1.LineNum = A.BaseLine), 0) Quantity,  
			ISNULL(/*A.U_Recibido*/0, 0) OpenQty, A.Quantity FacturadoQty, 
			B.WhsName, ISNULL((C.BVolume/1000000)*35.3147, 0) BVolume, *
			,D.WhsName U_WhsName,a.TaxCode
			From SBOCTRZ.dbo.PDN1 A
				INNER JOIN SBOCTRZ.dbo.OWHS B on A.WhsCode = B.WhsCode 
				LEFT JOIN SBOCTRZ.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
				INNER JOIN SBOCTRZ.dbo.OITM C on C.ItemCode = A.ItemCode
			Where A.DocEntry = @Key
			ORDER BY  A.VisOrder
		END
		IF @ObjType = 21 --Verificar si esta opcion va a continuar en este nuevo procedimiento
		BEGIN 
			Select A.VisOrder LineNum, ISNULL(C.BWeight1, 0) BWeight1, A.OpenQty, A.Quantity, 
			B.WhsName, ISNULL((C.BVolume/1000000)*35.3147, 0) BVolume, *
			,D.WhsName U_WhsName
			From SBOCTRZ.dbo.RPD1 A
				INNER JOIN SBOCTRZ.dbo.OWHS B on A.WhsCode = B.WhsCode 
				LEFT JOIN SBOCTRZ.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
				INNER JOIN SBOCTRZ.dbo.OITM C on C.ItemCode = A.ItemCode
			Where A.DocEntry = @Key
			ORDER BY  A.VisOrder
		END
		IF @ObjType = 14 --Verificar si esta opcion va a continuar en este nuevo procedimiento
		BEGIN 
			--IF @sType = 'Borrador'
			--BEGIN
			--	Select CAST(A.LineNum AS INT) LineNum, A.ItemCode, C.ItemName Dscription, A.Quantity, A.Price,
			--		A.WhsCode, B.WhsName, CAST(0 AS DECIMAL(18, 4)) LineTotal, NULL ShipDate, 'O' LineStatus,
			--		'' U_Comentario, A.Currency, A.Rate, 
 		--			ISNULL(C.BWeight1, 0) BWeight1,
			--		ISNULL((C.BVolume/1000000)*35.3147, 0) BVolume,  A.DocNum DocEntry,
			--		A.AccountCode, A.TaxCode, A.BaseEntry, A.BaseLine, A.BaseType, C.ManBtchNum
			--	From SDK_RIN1 A
			--		INNER JOIN SBOCTRZ.dbo.OWHS B on A.WhsCode = B.WhsCode 
			--		INNER JOIN SBOCTRZ.dbo.OITM C on C.ItemCode = A.ItemCode
			--	Where A.DocNum = @Key 
			--	ORDER BY  A.LineNum
			--END
			IF @sType = 'RC'
			BEGIN
				Select CAST(A.LineNum AS INT) LineNum, A.ItemCode, C.ItemName Dscription, A.Quantity, A.Price,
					A.WhsCode, B.WhsName, CAST(0 AS DECIMAL(18, 4)) LineTotal, NULL ShipDate, 'O' LineStatus,
					'' U_Comentario, A.Currency, A.Rate, 
 					ISNULL(C.BWeight1, 0) BWeight1,
					ISNULL((C.BVolume/1000000)*35.3147, 0) BVolume,  A.DocEntry,
					A.AcctCode AccountCode, A.TaxCode, A.BaseEntry, A.BaseLine, A.BaseType, C.ManBtchNum
					,a.OpenQty,a.U_DiscPrcnt,a.U_Price
					,a.TotalFrgn,a.U_Warehouse ,F.WhsName U_WhsName,A.U_Tc,a.visorder,a.TaxCode
				From SBOCTRZ.dbo.RIN1 A
					INNER JOIN SBOCTRZ.dbo.OWHS B on A.WhsCode = B.WhsCode 
					LEFT JOIN SBOCTRZ.dbo.OWHS F ON A.U_Warehouse = F.WhsCode
					INNER JOIN SBOCTRZ.dbo.OITM C on C.ItemCode = A.ItemCode
					INNER JOIN SBOCTRZ.dbo.ORIN D on D.DocEntry = A.DocEntry
				Where D.DocEntry = @Key
				ORDER BY  A.LineNum
			END
		END
		IF @ObjType = 16 --Verificar si esta opcion va a continuar en este nuevo procedimiento
		BEGIN 
			--IF @sType = 'Borrador'
			--BEGIN
			--	Select CAST(A.LineNum AS INT) LineNum, A.ItemCode, C.ItemName Dscription, A.Quantity, A.Price,
			--		A.WhsCode, B.WhsName, CAST(0 AS DECIMAL(18, 4)) LineTotal, NULL ShipDate, 'O' LineStatus,
			--		'' U_Comentario, A.Currency, A.Rate, 
 		--			ISNULL(C.BWeight1, 0) BWeight1,
			--		ISNULL((C.BVolume/1000000)*35.3147, 0) BVolume,  A.DocNum DocEntry,
			--		A.AccountCode, A.TaxCode, A.BaseEntry, A.BaseLine, A.BaseType, C.ManBtchNum,0 OpenQty
			--	From SDK_RIN1 A
			--		INNER JOIN SBOCTRZ.dbo.OWHS B on A.WhsCode = B.WhsCode 
			--		INNER JOIN SBOCTRZ.dbo.OITM C on C.ItemCode = A.ItemCode
			--	Where A.DocNum = @Key
			--	ORDER BY  A.LineNum
			--END
			IF @sType = 'DV'
			BEGIN
				Select CAST(A.LineNum AS INT) LineNum, A.ItemCode, C.ItemName Dscription, A.Quantity, A.Price,
					A.WhsCode, B.WhsName, CAST(0 AS DECIMAL(18, 4)) LineTotal, NULL ShipDate, 'O' LineStatus,
					'' U_Comentario, A.Currency, A.Rate, 
 					ISNULL(C.BWeight1, 0) BWeight1,
					ISNULL((C.BVolume/1000000)*35.3147, 0) BVolume,  A.DocEntry,
					A.AcctCode AccountCode, A.TaxCode, A.BaseEntry, A.BaseLine, A.BaseType, C.ManBtchNum
					,a.OpenQty,a.U_DiscPrcnt,a.U_Price
					,a.TotalFrgn,a.U_Warehouse ,F.WhsName U_WhsName,A.U_Tc,a.visorder,a.TaxCode
				From SBOCTRZ.dbo.RDN1 A
					INNER JOIN SBOCTRZ.dbo.OWHS B on A.WhsCode = B.WhsCode 
					LEFT JOIN SBOCTRZ.dbo.OWHS F ON A.U_Warehouse = F.WhsCode
					INNER JOIN SBOCTRZ.dbo.OITM C on C.ItemCode = A.ItemCode
					INNER JOIN SBOCTRZ.dbo.ORIN D on D.DocEntry = A.DocEntry
				Where D.DocEntry = @Key
				ORDER BY  A.LineNum
			END
		END
		IF @ObjType = 23 --OPCION PARA DEVOLVER EL DETALLE DE UN FOLIO ESPECIFICO
		BEGIN
			IF @sType = '23'
			BEGIN
				IF EXISTS(SELECT * FROM SBOCTRZ.dbo.OQUT WHERE DocNum = @Key AND ObjType = @ObjType)
				BEGIN
					SELECT A.LineNum, A.ItemCode, A.Dscription, A.Quantity, A.U_PReal, A.Price, A.DiscPrcnt, A.WhsCode, B.WhsName
					,A.LineTotal, A.ShipDate, A.LineStatus, A.U_Comentario, A.Currency, A.Rate, A.U_Padre, A.AcctCode[AccountCode], ISNULL(C.BWeight1, 0) BWeight1
					,C.BVolume, C.ManBtchNum, A.BaseEntry, A.BaseLine, A.BaseType, C.ManBtchNum,a.OpenQty,a.U_DiscPrcnt,a.U_Price
					,a.TotalFrgn,a.U_Warehouse ,D.WhsName U_WhsName,A.U_Tc,a.visorder,a.TaxCode,a.u_StockAlmacen,a.CogsAcct
					FROM SBOCTRZ.dbo.QUT1 A
					LEFT JOIN SBOCTRZ.dbo.OWHS B ON A.WhsCode = B.WhsCode
					LEFT JOIN SBOCTRZ.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
					INNER JOIN SBOCTRZ.dbo.OITM C on C.ItemCode = A.ItemCode
					Where A.DocEntry = @Key AND A.ObjType = @ObjType--14
				END
			END
		END
		--------------------------------------------------------------------------------------------------------------------------------------
		IF @ObjType = 17 --OPCION PARA DEVOLVER EL DETALLE DE UN FOLIO ESPECIFICO
		BEGIN
			IF @sType = '17'
			BEGIN
				IF EXISTS(SELECT * FROM SBOCTRZ.dbo.ORDR WHERE DocEntry = @Key AND ObjType = @ObjType)
				BEGIN
					SELECT A.LineNum, A.ItemCode, A.Dscription, A.Quantity, A.U_PReal, A.Price, A.DiscPrcnt, A.WhsCode, B.WhsName
					,A.LineTotal, A.ShipDate, A.LineStatus, A.U_Comentario, A.Currency, A.Rate, A.U_Padre, A.AcctCode[AccountCode],ISNULL(C.BWeight1, 0) BWeight1
					,C.BVolume, C.ManBtchNum, A.BaseEntry, A.BaseLine, A.BaseType, C.ManBtchNum,a.OpenQty,a.U_DiscPrcnt,a.U_Price
					,a.TotalFrgn,a.U_Warehouse ,D.WhsName U_WhsName,A.U_Tc,a.visorder,a.TaxCode,a.u_StockAlmacen,a.CogsAcct
					FROM SBOCTRZ.dbo.RDR1 A
					LEFT JOIN SBOCTRZ.dbo.OWHS B ON A.WhsCode = B.WhsCode
					LEFT JOIN SBOCTRZ.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
					INNER JOIN SBOCTRZ.dbo.OITM C on C.ItemCode = A.ItemCode
					Where A.DocEntry = @Key AND A.ObjType = @ObjType /*and a.TreeType <> 'I'*/--14
				END
			END		
		END
		IF @ObjType = 15 --OPCION PARA DEVOLVER EL DETALLE DE UN FOLIO ESPECIFICO
		BEGIN
			IF @sType = '15'
			BEGIN
				IF EXISTS(SELECT * FROM SBOCTRZ.dbo.ODLN WHERE DocEntry = @Key AND ObjType = @ObjType)
				BEGIN
					SELECT A.LineNum, A.ItemCode, A.Dscription, A.Quantity, A.U_PReal, A.Price, A.DiscPrcnt, A.WhsCode, B.WhsName
					,A.LineTotal, A.ShipDate, A.LineStatus, A.U_Comentario, A.Currency, A.Rate, A.U_Padre, A.AcctCode[AccountCode], ISNULL(C.BWeight1, 0) BWeight1
					,C.BVolume, C.ManBtchNum, A.BaseEntry, A.BaseLine, A.BaseType, C.ManBtchNum,a.OpenQty,a.U_DiscPrcnt,a.U_Price
					,a.TotalFrgn ,a.U_Warehouse ,D.WhsName U_WhsName,A.U_Tc,a.visorder,a.TaxCode,a.u_StockAlmacen,a.CogsAcct
					FROM SBOCTRZ.dbo.DLN1 A
					LEFT JOIN SBOCTRZ.dbo.OWHS B ON A.WhsCode = B.WhsCode
					LEFT JOIN SBOCTRZ.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
					INNER JOIN SBOCTRZ.dbo.OITM C on C.ItemCode = A.ItemCode
					Where A.DocEntry = @Key AND A.ObjType = @ObjType /*and a.TreeType <> 'I'*/--14
				END
			END
		END
		IF @ObjType = 13 --OPCION PARA DEVOLVER EL DETALLE DE UN FOLIO ESPECIFICO
		BEGIN
			IF @sType = '13'
			BEGIN
				IF EXISTS(SELECT * FROM SBOCTRZ.dbo.OINV WHERE DocEntry = @Key AND ObjType = @ObjType)
				BEGIN
					SELECT A.LineNum, A.ItemCode, A.Dscription, A.Quantity, A.U_PReal, A.Price, A.DiscPrcnt, A.WhsCode, B.WhsName
					,A.LineTotal, A.ShipDate, A.LineStatus, A.U_Comentario, A.Currency, A.Rate, A.U_Padre, A.AcctCode[AccountCode],ISNULL(C.BWeight1, 0) BWeight1
					,C.BVolume, C.ManBtchNum, A.BaseEntry, A.BaseLine, A.BaseType, C.ManBtchNum,a.OpenQty,a.U_DiscPrcnt,a.U_Price
					,a.TotalFrgn ,a.U_Warehouse ,D.WhsName U_WhsName,A.U_Tc,a.visorder,a.TaxCode,a.u_StockAlmacen,a.CogsAcct
					FROM SBOCTRZ.dbo.INV1 A
					LEFT JOIN SBOCTRZ.dbo.OWHS B ON A.WhsCode = B.WhsCode
					LEFT JOIN SBOCTRZ.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
					INNER JOIN SBOCTRZ.dbo.OITM C on C.ItemCode = A.ItemCode
					Where A.DocEntry = @Key AND A.ObjType = @ObjType /*and a.TreeType <> 'I'*/--14
				END
			END
		END
	END

	IF @TipoConsulta = 13 --anexos
	BEGIN
		SET @QRY  = '
		WITH RUTAS(CardCode, CodRuta) AS (SELECT CardCode, CodRuta FROM logistics.Rutas where CardCode = @CardCode)

		SELECT TOP 1 OC.CardCode, OC.CardName, OC.CardType, OC.GroupCode
		,(case when oc.currency = ''$'' then oc.balance else oc.balanceFC END) Saldo
		,(case when oc.currency = ''$'' then oc.DNotesBal else oc.DNoteBalFC END) DNotesBal
		,isnull(oc.CreditLine,0)CreditLine 
		,(case when oc.currency = ''$'' then isnull(oc.CreditLine,0)-isnull(oc.Balance,0) else isnull(oc.CreditLine,0)-isnull(oc.BalanceFC,0) END)  Disponible
		,oc.currency,isnull(oc.phone1,'''')+''  ''+isnull(oc.phone2,'''')+''  ''+isnull(oc.cellular,'''') Tel,isnull(oc.e_mail,'''')+''  ''+isnull(oc.u_correo,'''')Email
		,isnull(tg.PymntGroup,'''')PymntGroup
		, [PJ-FLOT].dbo.SinComaFinal(
		  (    
		   SELECT Rt.CodRuta + '', ''    
		   FROM RUTAS Rt    
		   WHERE Rt.CardCode = OC.CardCode
		   ORDER BY Rt.CodRuta   
					FOR XML PATH('''')    
		  )) [CodigosRutas] 
		  ,tv.Name TipoRuta
		  ,OC.U_Cobranza
		  ,ca.Name Canal
		  ,OO.IndName Subcanal
		  ,OS.SlpName
		  ,ISNULL(OC.U_Extradays, 0)[U_Extradays]
		  ,ISNULL(OC.CardFName, '''')[CardFName]
		From ' + @CIA + '.dbo.OCRD OC
		left JOIN ' + @CIA + '.dbo.OSLP OS on oc.slpcode = os.slpcode
		left JOIN ' + @CIA + '.dbo.OOND OO on OC.Industryc = OO.IndCode
		left JOIN ' + @CIA + '.dbo.OCTG tg on oc.GroupNum = tg.GroupNum
		left JOIN ' + @CIA + '.dbo.[@HNT_CANALES] ca on U_Canal = ca.Code
		left JOIN ' + @CIA + '.dbo.[@HNT_TIPOVISITA] tv on U_TipoVisita = tv.Code
		WHERE OC.CardCode = @CardCode
		'
		SET @PARAMETROS = '@CardCode nvarchar(50)'

		EXECUTE sp_executesql @QRY, @PARAMETROS, @CardCode
	END

	IF @TipoConsulta = 14 --modelos de autorizacion
	BEGIN
		--IF 1 = 0
		IF NOT EXISTS (Select * From sap.ODRF WHERE DocEntry = @DocNum AND U_Autorizado = 'R')
		BEGIN
			DECLARE @id int
			EXEC dbo.up_HNT_Autorizaciones @TipoConsulta = 1,  @ObjType = @ObjType, @DocID = @DocNum, @Valor = @DocNum, @UserID = @userID, @OWDD_ID = @id output, @Test = @TestModelo ,@Version =@Version
		
			IF @TestModelo = 1
			BEGIN
				Select A.Descripcion, NoAutorizacion, D.Nombre
				From 
					hnt.ModelosAutorizacion A
					JOIN hnt.ModelosAutorizacionUsuarios B ON A.Code = B.Code
					JOIN hnt.ModelosAutorizacionDocumentos C ON A.Code = C.Code
					JOIN hnt.Usuarios D ON D.UserID = B.UserID
				WHERE A.Code = 20
				ORDER BY B.Orden
			END
			Select 1
		END
	END

	IF @TipoConsulta = 15
	BEGIN
		SELECT A.AcctCode, A.AcctName FROM SBOCTRZ.dbo.OACT A
			JOIN sap.UsuarioAcctCode B ON A.AcctCode = B.AcctCode
		WHERE  Postable = 'Y' AND B.UserId = @UserID
	END

	IF @TipoConsulta = 16 --CONSULTA PARA DEVOLVER LOS ARTICULOS DE UN CLIENTE DE TODAS LAS facturas
	BEGIN
		INSERT INTO @Docs SELECT item FROM dbo.fu_hnt_OBTIENE_TABLA_DE_ARRAY(dbo.fu_hnt_OBTIENE_ARRAY(@Documentos,',')); 

		IF EXISTS(SELECT * FROM @Docs where clave = 'OI') and not exists(SELECT * FROM @Docs where clave = 'OC')
		BEGIN
			SELECT top (@top) 'IN ' + CAST(O.DocNum AS varchar(50)) + ' (' + CAST(O1.LineNum AS varchar(50)) + ')'[Documento]
				, O.DocDate[Fecha], O1.Quantity[Cantidad], cast(O1.PriceBefDi as decimal(18,2)) [Precio Unitario],cast( O1.U_PReal as decimal(18,2))[Precio Real]
				, g.OnHand Stock,o.DocEntry,o.ObjType, 'Ver' Ver, O.Version
			FROM sap.VW_OINV O 
			INNER JOIN sap.VW_INV1 O1 ON O.DocEntry = O1.DocEntry AND O.Version = O1.Version
			INNER JOIN SBOCTRZ.dbo.OITW G ON o1.ItemCode = G.ItemCode and G.WhsCode = @WhsCode
			WHERE O.DocDate BETWEEN CAST(DATEADD(DAY, -1000, GETDATE()) AS date) AND CAST(GETDATE() AS DATE)
			AND O.CardCode = @CardCode AND O1.ItemCode = @ItemCode
			ORDER BY o.docdate desc
		END
		IF EXISTS(SELECT * FROM @Docs where clave = 'OC') and not exists(SELECT * FROM @Docs where clave = 'OI')
		BEGIN
			SELECT top (@top)'OC ' + CAST(O.DocNum AS varchar(50)) + ' (' + CAST(O1.LineNum AS varchar(50)) + ')'[Documento]
				, O.DocDate[Fecha], O1.Quantity[Cantidad], cast(O1.PriceBefDi as decimal(18,2)) [Precio Unitario],cast( O1.U_PReal as decimal(18,2))[Precio Real]
				, g.OnHand Stock,o.DocEntry,o.ObjType,'Ver' Ver, O.Version
			FROM sap.VW_ORDR O
			INNER JOIN sap.VW_RDR1 O1 ON O.DocEntry = O1.DocEntry AND O.Version = O1.Version
			INNER JOIN SBOCTRZ.dbo.OITW G ON o1.ItemCode = G.ItemCode and G.WhsCode = @WhsCode
			WHERE O.DocDate BETWEEN CAST(DATEADD(DAY, -1000, GETDATE()) AS date) AND CAST(GETDATE() AS DATE)
			AND O.CardCode = @CardCode AND O1.ItemCode = @ItemCode 
			ORDER BY  O.DocDate desc
		END
		IF EXISTS(SELECT * FROM @Docs where clave = 'OC') and  exists(SELECT * FROM @Docs where clave = 'OI')
		BEGIN
			SELECT TOP (@top) * From(
				SELECT 
					'IN ' + CAST(O.DocNum AS varchar(50)) + ' (' + CAST(O1.LineNum AS varchar(50)) + ')'[Documento]
					, O.DocDate[Fecha], O1.Quantity[Cantidad], cast(O1.PriceBefDi as decimal(18,2)) [Precio Unitario],cast( O1.U_PReal as decimal(18,2))[Precio Real]
					, g.OnHand Stock,o.DocEntry,o.ObjType,'Ver' Ver, O.Version
				FROM sap.VW_OINV O
				INNER JOIN sap.VW_INV1 O1 ON O.DocEntry = O1.DocEntry AND O.Version = O1.Version
				INNER JOIN SBOCTRZ.dbo.OITW G ON o1.ItemCode = G.ItemCode and G.WhsCode = @WhsCode
				WHERE O.DocDate BETWEEN CAST(DATEADD(DAY, -1000, GETDATE()) AS date) AND CAST(GETDATE() AS DATE)
				AND O.CardCode = @CardCode AND O1.ItemCode = @ItemCode 
				UNION  ALL	
				SELECT 
					'OC ' + CAST(O.DocNum AS varchar(50)) + ' (' + CAST(O1.LineNum AS varchar(50)) + ')'[Documento]
					, O.DocDate[Fecha], O1.Quantity[Cantidad], cast(O1.PriceBefDi as decimal(18,2)) [Precio Unitario],cast( O1.U_PReal as decimal(18,2))[Precio Real]
					,g.OnHand Stock,o.DocEntry,o.ObjType,'Ver' Ver, O.Version
				FROM sap.VW_ORDR O
				INNER JOIN sap.VW_RDR1 O1 ON O.DocEntry = O1.DocEntry AND O.Version = O1.Version
				INNER JOIN SBOCTRZ.dbo.OITW G ON o1.ItemCode = G.ItemCode and G.WhsCode = @WhsCode
				WHERE O.DocDate BETWEEN CAST(DATEADD(DAY, -1000, GETDATE()) AS date) AND CAST(GETDATE() AS DATE)
				AND O.CardCode = @CardCode AND O1.ItemCode = @ItemCode)T0
			ORDER BY  Fecha desc
		END
		
	END

	IF @TipoConsulta = 17
	BEGIN
		IF @Series <= 0
		BEGIN
			SELECT ROW_NUMBER() OVER(ORDER BY value) [index], value
			into #temp
			FROM bsl_Split(@Key, '|')  
			WHERE RTRIM(value) <> '';  

			SELECT @Series = IIF(TRY_PARSE(value AS INT) IS NULL, '0', value) FROM #temp WHERE [index] = 1
			SELECT @Key = ISNULL(RTRIM(value), '') FROM #temp WHERE [index] = 2
		END
		---PARA ACTIVAR IVA 8% EN FRONTERA
		IF @Series IN (76, 78, 113, 115, 137, 139, 194, 198, 200, 207, 210, 212,217,220,222)
			SET @TaxCode = 'IVAPA08'
		ELSE
		SET @TaxCode = 'IVAPA16'
		
		SET @CardType = ''

		IF @Series IN (13, 14, 15, 16, 17)
			SET @CardType = 'C'
		ELSE
			SET @CardType = 'S'
					   
		IF @Key = '' SET @Key = '%%'
		SET @QRY = '
			Select
                --''CATS7406241NG'' LicTradNum,
				case when currency = ''##'' then ''USD'' else currency end currency, ISNULL(''' + @TaxCode + ''', ''IVAAC16'') VatGroup, OSTA.Name [VatGroupN], ISNULL(CD.Descuento, 0) Discount, *,
				''' + @TaxCode + ''' TaxCode,
				ISNULL(Utilidad, 0) LimiteUtilidad
			From SBOCTRZ.dbo.OCRD
				LEFT JOIN SBOCTRZ.dbo.OSTA ON OCRD.VatGroup = OSTA.Code
				LEFT JOIN SBOCTRZ.dbo.OEDG ON OEDG.ObjCode = OCRD.CardCode
				LEFT JOIN SBOCTRZ.dbo.EDG1 ON OEDG.AbsEntry = EDG1.AbsEntry AND ObjKey = -1
				LEFT JOIN sales.ClientesDescuento CD on OCRD.CardCode collate database_default = CD.CardCode
				--LEFT JOIN sales.ClientesDescuento CD on OCRD.CardCode collate database_default = CASE WHEN OCRD.QryGroup8 = ''Y'' OR OCRD.QryGroup9 = ''Y'' THEN CD.cardcode END
				LEFT JOIN SBOCTRZ.dbo.OCTG OC ON OCRD.GroupNum = OC.GroupNum
				LEFT JOIN credit.ObjetivoUtilidad OU ON OU.CodCliente = OCRD.CardCode
			Where OCRD.CardCode like  ''' + @Key + '''
				AND OCRD.CardName like ''%' + ISNULL(@CardName, '') + '%''
				AND OCRD.CardType = ''C'' 
			order by OCRD.CardCode asc'

		 EXECUTE sp_executesql @QRY
	 END

	 IF @TipoConsulta = 18 --lista alternativos
	 BEGIN
		select  @listnum_=a.listnum 
				from SBOCTRZ.dbo.OCRD a
				where a.cardcode = @CardCode

		select d.Itemcode,AltItem,d.ItemName,e.ItmsGrpNam,d.ManBtchNum,ISNULL( g.Price, f.Price) Price,f.Currency,d.ItmsGrpCod
		from SBOCTRZ.dbo.oali c 
			left JOIN SBOCTRZ.dbo.OITM d on c.AltItem = d.ItemCode 
			left JOIN SBOCTRZ.dbo.OITB e on d.ItmsGrpCod = e.ItmsGrpCod  
			left JOIN SBOCTRZ.dbo.ITM1 f on d.ItemCode = f.ItemCode and f.PriceList = @listnum_ 
			LEFT JOIN SBOCTRZ.dbo.OSPP g ON g.CardCode = @cardcode
		 where  c.OrigItem = @itemcode

	 END

	IF @TipoConsulta = 19
	BEGIN
		SELECT -1 TrnspCode, '-- Ship To--' TrnspName
		UNION ALL
		SELECT TrnspCode, TrnspName FROM SBOCTRZ.DBO.OSHP
	END

	if @TipoConsulta = 20 --obtener almacen
	BEGIN
		select WhsCode+' | '+WhsName Almacen, RevenuesAc,SaleCostAc from SBOCTRZ.dbo.OWHS where WhsCode = @WhsCode
	end
	if @TipoConsulta = 21 --esta en borrador o documento regular
	BEGIN
		IF @sType = '23'
			BEGIN
				if exists(select * from SBOCTRZ.dbo.OQUT Where DocNum = @Key AND ObjType = @ObjType)
					Select 1 Tipo
				else
					Select 0 Tipo
			end
		IF @ObjType = '17'
		BEGIN
			 
			DECLARE @Ky INT
			IF @sType = '17'
			BEGIN
				SET @Ky = (SELECT DocNum FROM SBOCTRZ.dbo.ORDR WHERE DocEntry = @Key)
				IF ISNULL(@Ky,0)>0
					SET @Key = @Ky
			END

			if exists(select * from SBOCTRZ.dbo.ORDR Where DocNum = @Key AND ObjType = @ObjType)
				Select 1 Tipo
			else
				Select 0 Tipo
		END

	end

	IF @TipoConsulta = 22 
	BEGIN
		IF @ObjType = '23'
		BEGIN
			SELECT TOP 1 DocEntry, DocNum FROM SBOCTRZ.dbo.OQUT WHERE DocNum = @Key
		END
		IF @ObjType = '17'
		BEGIN
			SELECT TOP 1 DocEntry, DocNum FROM SBOCTRZ.dbo.ORDR WHERE DocNum = @Key
		END
		IF @ObjType = '15'
		BEGIN
			SELECT TOP 1 DocEntry, DocNum FROM SBOCTRZ.dbo.ODLN WHERE DocNum = @Key
		END
		IF @ObjType = '67'
		BEGIN
			SELECT TOP 1 DocEntry, DocNum FROM SBOCTRZ.dbo.OWTR WHERE DocNum = @Key
		END
		IF @ObjType = '13'
		BEGIN
			SELECT TOP 1 DocEntry, DocNum FROM SBOCTRZ.dbo.OINV WHERE DocNum = @Key
		END
	END
	IF @TipoConsulta = 23 --insertar en venta perdida
	BEGIN
		IF ISNULL(@Opc,1) = 1 
		BEGIN
			Select @OnHand = OnHand, 
			@OnOrder = IsCommited From SBOCTRZ.dbo.OITW Where ItemCode = @ItemCode AND WhsCode = @WhsCode
		
			DECLARE @Clasificacion VARCHAR = (Select Clasificacion From purchase.Items_ABC Where tipo = 'GENERAL' AND ItemCode = @ItemCode)--@ItemCode)
			--SELECT @Clasificacion

			DECLARE @Propiedad VARCHAR =  (Select ItemCode From SBOCTRZ.dbo.OITM Where ItemCode = @ItemCode AND (QryGroup4 = 'Y' OR QryGroup6 = 'Y' ))
			--SELECT @Propiedad

			--IF @Clasificacion = 'B' OR @Clasificacion = 'C' 
			--BEGIN
			--	SELECT 'No se puede cargar el articulo ' + @ItemCode + ' debido a que tiene clasificación: ' + @Clasificacion [Mensaje], 'error' [Tipo] 
			--END  --Solicitud por Leticia  06/01/2020 hecho por Angel
			IF @Propiedad IS NOT NULL
			BEGIN
				SELECT 'No se puede cargar el articulo ' + @ItemCode + ' debido a que tiene propiedad de Remate o Compra Especial.' [Mensaje], 'error' [Tipo] 
			END
			ELSE IF @Quantity < @OnHand AND @Motivo IN('01'/*SIN STOCK*/,'06'/*STOCK INSUFICIENTE*/)
			BEGIN
				SELECT 'No se puede cargar el articulo ' + @ItemCode + ' debido a que hay stock suficiente para cubrir la venta.' [Mensaje], 'error' [Tipo] 
			END
			ELSE 
			BEGIN
				IF ISNULL(@FatherCard,'') = 'MOVIL' --SI PROVIENE DE UN MOVIL
					SET @Opc = 2 --SE LE ASIGNA AHORA LA OPCION 2 PARA QUE INSERTE LA VENTA
				ELSE --DE LO CONTRARIO SE DEVUELVE EL MENSAJE 
					SELECT 'Se agrego al grid la venta' [Mensaje], 'success' [Tipo] 
				

			END
		END

		IF @Opc = 2 --Venta perdida
		BEGIN
			Select @OnHand = OnHand, 
			@OnOrder = IsCommited From SBOCTRZ.dbo.OITW Where ItemCode = @ItemCode AND WhsCode = @WhsCode
		
			IF NOT EXISTS (Select * From [sales].[VentaPerdida] Where  BaseEntry = @BaseEntry AND BaseLine = @BaseLine AND BaseType = @BaseType)
			BEGIN
				INSERT INTO [sales].[VentaPerdida](NumBorrador, BaseEntry, BaseLine, BaseType, CardCode, ItemCode, WhsCode, Cantidad, vPerdida, Faltante, Motivo, Comments, Fecha, Hora, UserID, TipoCaptura, OnHand, IsCommited, FatherCard, Estado)
				VALUES (@DocEntry, @BaseEntry, @BaseLine, @BaseType, @CardCode, @ItemCode, @WhsCode, 0, @Cantidad, @Quantity , @Motivo, @Comments, GETDATE(), GETDATE(), @userID, 1, @OnHand, @OnOrder, @FatherCard, 'O')
			
				SET @Folio = SCOPE_IDENTITY();
				--SELECT @Folio AS NewID;
				SELECT @NombreUsuario = (select Nombre from hnt.Usuarios where UserID = @userID)

				SELECT 'Articulo ' + @ItemCode + ' insertado correctamente.' [Mensaje], 'success' [Tipo] 

				IF @Motivo IN ('02', '04', '07')
				BEGIN
					--SELECT @Correo = (SELECT Correo from hnt.usuarios where rol = 16 and Activo = 'Y' AND Almacen = @WhsCode)
					SELECT @Correo = (SELECT CONCAT(Correo, ';') FROM hnt.Usuarios WHERE Rol IN (16) AND Activo = 'Y' AND Almacen = @WhsCode AND Correo IS NOT NULL FOR XML PATH(''))
					SELECT @MotivoText = 
						CASE @Motivo
							WHEN '02' THEN 'Mercancia dañada'
							WHEN '04' THEN 'Faltante de almacén'
							WHEN '07' THEN 'Producto cambiado'
							ELSE NULL 
						END;

					Select @Body =  '<p>Se registro una venta perdida: </p>' +
													'<p><span style="font-weight: bold" >Folio: </span>' + CAST(@Folio AS VARCHAR(MAX)) + '</p>' +
													'<p><span style="font-weight: bold" >Artículo: </span>' + @ItemCode + '</p>' +
													'<p><span style="font-weight: bold" >Motivo: </span>' + @MotivoText + '</p>' +
													'<p><span style="font-weight: bold" >Cliente: </span>' + @CardCode + '</p>' +
													'<p><span style="font-weight: bold" >Comentarios: </span>' + @Comments + '</p>' +
													'<p><span style="font-weight: bold" >Usuario que agrego venta perdida: </span>' + @NombreUsuario + '</p>'
													+
													'<p style="font-size: 10px;">Este correo se envio a: ' + ' ' + ISNULL(@Correo, 'No especificado') + ' ' + '</p>'; 
					Select @Asunto = 'Registro de Venta Perdida'

					SET @Body = HNT_TRZ.dbo.fu_hnt_Str_Mail(@Asunto, @Body)

					EXEC msdb.dbo.sp_send_dbmail   
						@profile_name ='Correo Halconet',
						@recipients = @Correo,
						@blind_copy_recipients = 'halconet@tractozone.com.mx;azucena.flores@tractozone.com.mx',
						@subject = @Asunto,
						@body = @Body,
						@body_format= 'HTML'
				END	
			END
			ELSE
			BEGIN
				INSERT INTO [sales].[VentaPerdida](NumBorrador, BaseEntry, BaseLine, BaseType, CardCode, ItemCode, vPerdida, Faltante, Motivo, Comments, Fecha, Hora, UserID, TipoCaptura, WhsCode, OnHand, IsCommited, FatherCard, Estado)
				VALUES (@DocEntry, @BaseEntry, @BaseLine, @BaseType, @CardCode, @ItemCode, @Quantity, 0, @Motivo, @Comments, GETDATE(), GETDATE(), @userID, 2, @WhsCode, @OnHand, @OnOrder, @FatherCard, 'O')
				
				SET @Folio = SCOPE_IDENTITY();
				--SELECT @Folio AS NewID;
				SELECT @NombreUsuario = (select Nombre from hnt.Usuarios where UserID = @userID)

				SELECT 'Articulo ' + @ItemCode + ' insertado correctamente.' [Mensaje], 'success' [Tipo]
				
				IF @Motivo IN ('02', '04', '07')
				BEGIN
					--SELECT @Correo = (SELECT Correo from hnt.usuarios where rol = 16 and Activo = 'Y' AND Almacen = @WhsCode)
					SELECT @Correo = (SELECT CONCAT(Correo, ';') FROM hnt.Usuarios WHERE Rol IN (16) AND Activo = 'Y' AND Almacen = @WhsCode AND Correo IS NOT NULL FOR XML PATH(''))
					SELECT @MotivoText = 
						CASE @Motivo
							WHEN '02' THEN 'Mercancia dañada'
							WHEN '04' THEN 'Faltante de almacén'
							WHEN '07' THEN 'Producto cambiado'
							ELSE NULL 
						END;

					Select @Body = '<p>Se registro una venta perdida: </p>' +
												'<p><span style="font-weight: bold" >Folio: </span>' + CAST(@Folio AS VARCHAR(MAX)) + '</p>' +
												'<p><span style="font-weight: bold" >Artículo: </span>' + @ItemCode + '</p>' +
												'<p><span style="font-weight: bold" >Motivo: </span>' + @MotivoText + '</p>' +
												'<p><span style="font-weight: bold" >Cliente: </span>' + @CardCode + '</p>' +
												'<p><span style="font-weight: bold" >Comentarios: </span>' + @Comments + '</p>' +
												'<p><span style="font-weight: bold" >Usuario que agrego venta perdida: </span>' + @NombreUsuario + '</p>'
												+
													'<p style="font-size: 10px;">Este correo se envio a: ' + ' ' + ISNULL(@Correo, 'No especificado') + ' ' + '</p>';
					Select @Asunto = 'Registro de Venta Perdida'

					SET @Body = HNT_TRZ.dbo.fu_hnt_Str_Mail(@Asunto, @Body)

						EXEC msdb.dbo.sp_send_dbmail   
							@profile_name ='Correo Halconet',
							@recipients = @Correo,
							@blind_copy_recipients = 'halconet@tractozone.com.mx;azucena.flores@tractozone.com.mx',
							@subject = @Asunto,
							@body = @Body,
							@body_format= 'HTML'
				END	
			END
		END
	END

	--EXECUTE up_sap_Documents @TipoConsulta = 23, @DocEntry = -1 , @BaseEntry = -1, @BaseLine = -1, @BaseType = -1, @CardCode = 'T 250', @ItemCode = '110500', @Quantity = 2, @Cantidad = 0, @Motivo = '05', @Comments = 'a', @UserId = '4242', @tipoCap = 0, @WhsCode = '12'
	IF @TipoConsulta = 24 --eliminar en venta perdida
	BEGIN
		--delete tbl_VentaPerdida where factura = @Factura
		select ''
	end

	/*JLUIS 2020-02-27 LA TABLA NO EXISTE EN HALCONET*/
	--if @TipoConsulta = 29 --guardar remates
	--BEGIN
	--	if not exists (select * from tbl_ConfiguracionRemate where itemCodeOriginal = @ItemCode and itemCodeRemate =@ItemCodeRemate)
	--		insert into tbl_ConfiguracionRemate(itemcoderemate,itemcodeoriginal,descuento,fecha) 
	--		values (@ItemCodeRemate,@ItemCode,0.05,getdate())
	--	else 
	--		update tbl_ConfiguracionRemate set itemCodeRemate = @ItemCodeRemate,itemCodeOriginal=@ItemCode where itemCodeOriginal = @ItemCode and itemCodeRemate =@ItemCodeRemate
	--end
	--IF @TipoConsulta = 30 --eliminar en remates
	--BEGIN
	--	delete tbl_ConfiguracionRemate where id = @idComponente
	--end

	IF @TipoConsulta = 31 --consultar un componente ejes
	BEGIN

		Select 0 Id, B.ItemCode, B.ItemName From sales.CotizadorItems A
			JOIN SBOCTRZ.dbo.OITM b on a.itemcode = b.ItemCode		 
		Where Eje <> A.ItemCode
	end

	/*JLUIS 2020-02-27 LA TABLA NO EXISTE EN HALCONET*/
	--IF @TipoConsulta = 32 --consultar remates de un articulo
	--BEGIN

	--	if @CardCode is null
	--	BEGIN
	--		select a.itemcoderemate,b.ItemName itemnameRemate,a.itemcodeoriginal,c.itemname itemnameOriginal
	--		from tbl_ConfiguracionRemate a
	--		JOIN SBOCTRZ.dbo.OITM b on a.itemcoderemate collate database_default = b.ItemCode
	--		JOIN SBOCTRZ.dbo.OITM c on a.itemcodeoriginal collate database_default = c.ItemCode
	--		where a.itemCodeOriginal = @ItemCode 
	--	end
	--	else
	--	BEGIN
	--		select a.itemcoderemate,b.ItemName itemnameRemate,a.itemcodeoriginal,c.itemname itemnameOriginal,isnull(descuento,0)descuento,b.ManBtchNum,isnull(d.Price,0) Precio
	--		from tbl_ConfiguracionRemate a
	--		JOIN SBOCTRZ.dbo.OITM b on a.itemcoderemate collate database_default = b.ItemCode
	--		JOIN SBOCTRZ.dbo.OITM c on a.itemcodeoriginal collate database_default = c.ItemCode
	--		JOIN SBOCTRZ.dbo.ITM1 d on b.ItemCode = d.ItemCode
	--		JOIN SBOCTRZ.dbo.ocrd e on d.PriceList = e.ListNum
	--		where a.itemCodeOriginal = @ItemCode and e.CardCode = @CardCode
	--	end
	--end
	--IF @TipoConsulta = 33 --consultar cliente tc
	--BEGIN
	--	select id,a.Cardode,b.CardName,Desde,Hasta ,TC,'Eliminar' Eliminar
	--	from sales.ConfigCliente a
	--	JOIN SBOCTRZ.dbo.OCRD b on a.Cardode collate database_default = b.CardCode
	--end

	--if @TipoConsulta = 34 --guardar cliente tc
	--BEGIN
	--	if not exists (select * from sales.ConfigCliente where Cardode = @CardCode)
	--		insert into sales.ConfigCliente(Cardode,Desde,Hasta,TC,fecha) 
	--		values (@CardCode,@Desde,@Hasta,@CTC,getdate())
	--	else 
	--		update sales.ConfigCliente set TC = @CTC,Desde=@Desde,Hasta=@Hasta where Cardode = @CardCode
	--end

	--IF @TipoConsulta = 35 --eliminar cliente tc
	--BEGIN
	--	delete sales.ConfigCliente where id = @idComponente
	--end

	IF @TipoConsulta = -36 --articulos 
	BEGIN
		
		IF EXISTS (SELECT item FROM [dbo].fu_hnt_OBTIENE_TABLA_DE_ARRAY([dbo].fu_hnt_OBTIENE_ARRAY((select ListaPrecios from  [sales].VUsuarioConfig where ClaveEntidad = @userID),',')) WHERE Item = 22)
			SELECT @PriceList = 22
		ELSE
			SELECT @PriceList = 11

		SET @QRY ='
		select
			ItmsGrpNam
			, ItemCode
			, ItemName
			, Price
			, Currency
			, ncmcode
			, Rate
			, ManBtchNum
			--, Stock
			, U_PCompra
			, ListaMateriales
			, isnull(CantidadOTs, 0) CantidadOTs
			, (Stock - isnull(CantidadOTs, 0)) [Stock]
		from(
			Select 
				F.ItmsGrpNam, A.ItemCode, A.ItemName, ISNULL(ISNULL( D.Price, B.Price), 0) Price, 
				ISNULL(B.Currency, '''') Currency, isnull(A.ncmcode, 1) ncmcode,
				(Select Rate from ' + @CIA + '.dbo.ORTT Where ORTT.RateDate = CAST(GETDATE() AS DATE)) Rate, 
				ISNULL(ManBtchNum, '''') ManBtchNum, G.OnHand Stock,
				ISNULL(H.Price, 0) U_PCompra,
				CASE WHEN A.ItemCode = (SELECT TOP 1 x.Parent FROM sap.OITT x WHERE x.Parent = A.ItemCode) THEN ''Y'' ELSE ''N'' END ListaMateriales
			From ' + @CIA + '.dbo.OITM A 
				JOIN ' + @CIA + '.dbo.ITM1 B ON A.ItemCode = B.ItemCode AND A.sellitem =''Y'' 
				JOIN ' + @CIA + '.dbo.OITB F ON A.ItmsGrpCod = F.ItmsGrpCod 
				JOIN ' + @CIA + '.dbo.OITW G ON A.ItemCode = G.ItemCode and G.WhsCode = @WhsCode
				LEFT JOIN ' + @CIA + '.dbo.OSPP D ON D.CardCode = @CardCode AND D.ItemCode = A.ItemCode
				JOIN ' + @CIA + '.dbo.OCRD E ON E.CardCode = @CardCode and B.PriceList = E.ListNum 
				LEFT JOIN ' + @CIA + '.dbo.ITM1 H ON A.ItemCode = H.ItemCode AND H.PriceList = @PriceList
				LEFT JOIN ' + @CIA + '.dbo.OBCD I ON A.ItemCode = I.ItemCode AND I.BcdCode = ''' + ISNULL(@BarCode, '') + '''

			Where 1 = 1
				AND A.ItemType <> ''F'''
		IF ISNULL(@ItemCode, '') <> ''
			SET @QRY += ' and A.ItemCode like ''' + @ITEMCODE + ''''
		IF ISNULL(@ItemName, '') <> ''
			SET @QRY += ' and A.ItemName like ''' + @ItemName + ''''
		IF ISNULL(@BarCode, '') <> ''
			SET @QRY += ' and I.BcdCode = ''' + @BarCode + ''''

		SET @QRY += '
			--ORDER BY A.ItemCode
		)t0
		outer apply
		(
			
			
			select isnull(SUM([disponible]),0) [CantidadOTs] from (
			select

				CASE 
					WHEN B1.OpenQty IS NOT NULL THEN 
							CASE
								WHEN AA.CantidadSurtida = B1.Quantity THEN B1.OpenQty
								WHEN AA.CantidadSurtida <> B1.Quantity THEN AA.CantidadSurtida - (SELECT SUM(Quantity) FROM SBOCTRZ.dbo.INV1 WHERE BaseEntry = B1.DocEntry AND BaseType = B1.ObjType AND ItemCode = AA.ItemCode_OrdenTrabajo)	
							END
					WHEN B2.OpenQty IS NOT NULL THEN 
						CASE
								WHEN AA.CantidadSurtida = B2.Quantity THEN B2.OpenQty
								WHEN AA.CantidadSurtida <> B2.Quantity THEN AA.CantidadSurtida - (SELECT SUM(Quantity) FROM SBOCTRZ.dbo.DLN1 WHERE BaseEntry = B2.DocEntry AND BaseType = B2.ObjType AND ItemCode = AA.ItemCode_OrdenTrabajo)	
							END
					WHEN B3.OpenQty IS NOT NULL THEN 
							CASE
								WHEN AA.CantidadSurtida = B3.Quantity THEN B3.OpenQty
								WHEN AA.CantidadSurtida <> B3.Quantity THEN AA.CantidadSurtida - (SELECT SUM(Quantity) FROM SBOCTRZ.dbo.INV1 WHERE BaseEntry = B3.DocEntry AND BaseType = B3.ObjType AND ItemCode = AA.ItemCode_OrdenTrabajo)	
							END
				END [disponible]
	
			from logistics.WMS_OrdenesTrabajoDetail AA
				JOIN logistics.WMS_OrdenesTrabajo B on B.IdOrdenTrabajo = AA.IdOrdenTrabajo
				LEFT JOIN SBOCTRZ.dbo.RDR1 B1 ON B1.DocEntry = B.DocEntry AND B1.ObjType = B.ObjType AND B1.ItemCode = AA.ItemCode_OrdenTrabajo
				LEFT JOIN SBOCTRZ.dbo.INV1 B2 ON B2.DocEntry = B.DocEntry AND B2.ObjType = B.ObjType AND B2.ItemCode = AA.ItemCode_OrdenTrabajo
				LEFT JOIN SBOCTRZ.dbo.DLN1 B3 ON B3.DocEntry = B.DocEntry AND B3.ObjType = B.ObjType AND B3.ItemCode = AA.ItemCode_OrdenTrabajo
			WHERE AA.ItemCode_OrdenTrabajo = t0.ItemCode and AA.AfectaDisponible = 1
			and AA.EstatusItem = ''Y'' and B.Almacen = @WhsCode
			)t0 

			--select
			--	sum(isnull(CantidadSurtida * AfectaDisponible, 0)) CantidadOTs
			--from logistics.WMS_OrdenesTrabajo A
			--	join logistics.WMS_OrdenesTrabajoDetail B on B.IdOrdenTrabajo = A.IdOrdenTrabajo
			--where A.Almacen = @WhsCode and b.ItemCode_OrdenTrabajo = t0.ItemCode and B.AfectaDisponible in (1,-1)

		)t2
			'

		SET @PARAMETROS = '@CardCode VARCHAR(10), @WhsCode varchar(15), @PriceList INT'
		EXECUTE sp_executesql @QRY, @PARAMETROS, @CardCode, @WhsCode, @PriceList
	END

	IF @TipoConsulta = 36 --articulos 
	BEGIN
		
		IF EXISTS (SELECT item FROM [dbo].fu_hnt_OBTIENE_TABLA_DE_ARRAY([dbo].fu_hnt_OBTIENE_ARRAY((select ListaPrecios from  [sales].VUsuarioConfig where ClaveEntidad = @userID),',')) WHERE Item = 22)
			SELECT @PriceList = 22
		ELSE
			SELECT @PriceList = 11

		SET @QRY ='
			Select 
				F.ItmsGrpNam, A.ItemCode, A.ItemName, ISNULL(ISNULL( D.Price, B.Price), 0) Price, 
				ISNULL(B.Currency, '''') Currency, isnull(A.ncmcode, 1) ncmcode,
				(Select Rate from ' + @CIA + '.dbo.ORTT Where ORTT.RateDate = CAST(GETDATE() AS DATE)) Rate, 
				ISNULL(ManBtchNum, '''') ManBtchNum, G.OnHand Stock,
				ISNULL(H.Price, 0) U_PCompra,
				CASE WHEN A.ItemCode = (SELECT TOP 1 x.Parent FROM sap.OITT x WHERE x.Parent = A.ItemCode) THEN ''Y'' ELSE ''N'' END ListaMateriales
			From ' + @CIA + '.dbo.OITM A 
				JOIN ' + @CIA + '.dbo.ITM1 B ON A.ItemCode = B.ItemCode AND A.sellitem =''Y'' 
				JOIN ' + @CIA + '.dbo.OITB F ON A.ItmsGrpCod = F.ItmsGrpCod 
				JOIN ' + @CIA + '.dbo.OITW G ON A.ItemCode = G.ItemCode and G.WhsCode = @WhsCode
				LEFT JOIN ' + @CIA + '.dbo.OSPP D ON D.CardCode = @CardCode AND D.ItemCode = A.ItemCode
				JOIN ' + @CIA + '.dbo.OCRD E ON E.CardCode = @CardCode and B.PriceList = E.ListNum 
				LEFT JOIN ' + @CIA + '.dbo.ITM1 H ON A.ItemCode = H.ItemCode AND H.PriceList = @PriceList
				LEFT JOIN ' + @CIA + '.dbo.OBCD I ON A.ItemCode = I.ItemCode AND I.BcdCode = ''' + ISNULL(@BarCode, '') + '''
			Where 1 = 1
				AND A.ItemType <> ''F'''
		IF ISNULL(@ItemCode, '') <> ''
			SET @QRY += ' and A.ItemCode like ''' + @ITEMCODE + ''''
		IF ISNULL(@ItemName, '') <> ''
			SET @QRY += ' and A.ItemName like ''' + @ItemName + ''''
		IF ISNULL(@BarCode, '') <> ''
			SET @QRY += ' and I.BcdCode = ''' + @BarCode + ''''

		SET @QRY += '
			ORDER BY A.ItemCode'

		SET @PARAMETROS = '@CardCode VARCHAR(10), @WhsCode varchar(15), @PriceList INT'
		EXECUTE sp_executesql @QRY, @PARAMETROS, @CardCode, @WhsCode, @PriceList
	END

	--IF @TipoConsulta = 37 --consultar cliente tc
	--BEGIN
	--	select id,a.Cardode,Desde,Hasta ,isnull(TC,0) TC
	--	from sales.ConfigCliente a
	--	where a.cardode = @CardCode
	--	and @Desde between a.Desde and isnull(a.Hasta,'2050-08-08')
	--end

	IF @TipoConsulta = 38 --buscar documentos pendientes
	BEGIN
		select a.*, B.Descripcion 
		from sap.OWDD a
			JOIN hnt.ModelosAutorizacion b on a.WtmCode = b.Code
		where a.DocEntry = @DocNum and a.ObjType = @ObjType and a.Status = 'W'
	END
	if @TipoConsulta = 39 --actualizar documentos (pendientes/autorizados)
	BEGIN
		DECLARE @codigo_ INT
		DECLARE @id2 INT

		SET @codigo_  = (select top 1 A.WddCode from sap.OWDD A JOIN sap.wdd1 B ON A.WddCode = B.WddCode where A.ObjType = @ObjType and A.docentry = @docentry AND UserID = @userID ORDER BY A.WddCode desc)
		
		IF EXISTS(SELECT * FROM sap.OWDD WHERE [ObjType] = @ObjType AND [DocEntry] = @docentry AND [WddCode] = @codigo_ AND Status IN ('Y', 'N'))
		BEGIN
			RAISERROR('El documento ya ha sido procesado previamente', 11, 1);
		END

		UPDATE sap.OWDD SET [Status]= 'Y' WHERE [ObjType] = @ObjType AND [DocEntry] = @docentry AND [WddCode] = @codigo_
		UPDATE sap.WDD1 SET [Status]= 'Y', [Comment] = @Comments, [UpdateDate] = GETDATE() WHERE [UserID] = @userID AND [WddCode] = @codigo_
		UPDATE sap.ODRF SET [U_ComentarioAut] = @Comments WHERE [DocEntry] = @DocEntry	

		EXEC dbo.up_HNT_Autorizaciones @TipoConsulta = 1, @ObjType = @ObjType, @DocID = @docentry, @Valor = @docentry, @UserID = @userID, @OWDD_ID = @id2 OUTPUT, @Test = 0, @Version ='V2'

		--if @ObjType = 17
		--BEGIN
		--	set @codigo_  = (select top 1 A.WddCode from sap.OWDD A JOIN sap.wdd1 B ON A.WddCode = B.WddCode where A.ObjType = @ObjType and A.docentry = @docentry AND UserID = @userID ORDER BY A.WddCode desc)
			
		--	update sap.OWDD set Status= 'Y' where ObjType = @ObjType and docentry = @docentry and WddCode = @codigo_
		--	update sap.WDD1 set Status= 'Y',comment = @Comments, updatedaTE = getdate() where UserID = @userID and WddCode = @codigo_
		--	Update sap.ODRF SET U_ComentarioAut = @Comments Where DocEntry = @DocEntry	

		--	EXEC dbo.up_HNT_Autorizaciones @TipoConsulta = 1,  @ObjType = @ObjType, @DocID = @docentry, @Valor = @docentry, @UserID = @userID, @OWDD_ID = @id2 output, @Test = 0 ,@Version ='V2'
		--end
		--if @ObjType = 13
		--BEGIN
		--	set @codigo_  = (select top 1 A.WddCode from sap.OWDD A JOIN sap.wdd1 B ON A.WddCode = B.WddCode where A.ObjType = @ObjType and A.docentry = @docentry AND UserID = @userID ORDER BY A.WddCode desc)
			
		--	update sap.OWDD set Status= 'Y' where ObjType = @ObjType and docentry = @docentry and WddCode = @codigo_
		--	update sap.WDD1 set Status= 'Y',comment = @Comments, updatedaTE = getdate() where UserID = @userID and WddCode = @codigo_
		--	Update sap.ODRF SET U_ComentarioAut = @Comments Where DocEntry = @DocEntry	

		--	EXEC dbo.up_HNT_Autorizaciones @TipoConsulta = 1,  @ObjType = @ObjType, @DocID = @docentry, @Valor = @docentry, @UserID = @userID, @OWDD_ID = @id2 output, @Test = 0 ,@Version ='V2'
		--end
		--if @ObjType = 15
		--BEGIN
		--	set @codigo_  = (select top 1 A.WddCode from sap.OWDD A JOIN sap.wdd1 B ON A.WddCode = B.WddCode where A.ObjType = @ObjType and A.docentry = @docentry AND UserID = @userID ORDER BY A.WddCode desc)

		--	update sap.OWDD set Status= 'Y' where ObjType = @ObjType and docentry = @docentry 
		--	update sap.WDD1 set Status= 'Y',comment = @Comments, updatedaTE = getdate() where UserID = @userID and WddCode = @codigo_
		--	Update sap.ODRF SET U_ComentarioAut = @Comments Where DocEntry = @DocEntry	

		--	EXEC dbo.up_HNT_Autorizaciones @TipoConsulta = 1,  @ObjType = @ObjType, @DocID = @docentry, @Valor = @docentry, @UserID = @userID, @OWDD_ID = @id2 output, @Test = 0 ,@Version ='V2'
		--end
	end

	if @tipoconsulta = 40 --lista de pedidos condignas traspasos
	BEGIN
		Select 
			ORDR.Series, ORDR.DocEntry, ORDR.ObjType, DocNum, DocDate [Fecha de contabilización], OCRD.CardName [Cliente], CASE WHEN DocStatus = 'O' THEN 'Abierto' ELSE 'Cerrado' END [Estado],
			DocCur [Moneda], CASE WHEN DocCur = 'USD' THEN DocTotalFC ELSE DocTotal END [Total del documento**], 
			CASE WHEN DocCur = 'USD' THEN PaidFC ELSE PaidToDate END [Importe aplicado**], SlpName [Vendedor], OCTG.PymntGroup [Condiciones de pago], Comments [Comentarios], EDocNum [Documento electrónico], 'Documento SAP'[Tipo]
			,ORDR.u_tpedido ,(select Descr from SBOCTRZ.dbo.UFD1 where TableID = 'ORDR' and FieldID =5 and FldValue= u_tpedido) Pedido,ordr.cardcode
		From SBOCTRZ.dbo.ORDR 
			JOIN SBOCTRZ.dbo.OSLP ON ORDR.SlpCode = OSLP.SlpCode
			JOIN SBOCTRZ.dbo.OCRD ON ORDR.CardCode = OCRD.CardCode
			JOIN SBOCTRZ.dbo.OCTG ON OCRD.GroupNum = OCTG.GroupNum AND ORDR.DocType = 'I' AND ORDR.DocSubType <> 'DN' and DocStatus = 'O' 
			and ORDR.u_tpedido in ('01','02')

	end
	IF @TipoConsulta = 41 --consultar cliente descuento
	BEGIN
		select id,a.Cardcode,b.CardName,Desde,Hasta ,Descuento,'Eliminar' Eliminar
		from sales.ClientesDescuento a
		JOIN SBOCTRZ.dbo.OCRD b on a.Cardcode collate database_default = b.CardCode
	end
	if @TipoConsulta = 42 --guardar cliente descuento
	BEGIN
		if not exists (select * from sales.ClientesDescuento where Cardcode = @CardCode)
			insert into sales.ClientesDescuento(Cardcode,Desde,Hasta,Descuento,fecha) 
			values (@CardCode,@Desde,@Hasta,@Descuento,getdate())
		else 
			update sales.ClientesDescuento set Descuento = @Descuento,Desde=@Desde,Hasta=@Hasta where Cardcode = @CardCode
	end
	IF @TipoConsulta = 43 --eliminar cliente descuento
	BEGIN
		delete sales.ClientesDescuento where id = @idComponente
	end
	IF @TipoConsulta = 44 --actualizar costo base facturas
	BEGIN
		UPDATE SBOCTRZ.dbo.INV1 SET U_CostoBase = NULL WHERE DocEntry = @DocEntry
	end
	
	--IF @TipoConsulta = 45 --consultar cliente almacen
	--BEGIN
	--	select top 1 id,a.almacen , a.almacen +' | '+a.nombreA NombreA
	--	from tbl_ClienteAlmacen a where a.cardcode = @cardcode
	--end

	if @tipoconsulta = 46 --documentos auorizados y pendientes
	BEGIN
		Select @Rol = Rol From hnt.Usuarios Where UserID = @userID

		SET @QRY = '
			SELECT --TOP 300
				0 WtmCode,
				0 WddCode,
				0 StepCode,
				c.ObjType,
				c.DocEntry ,
				F.CardCode + '' - '' + f.CardName [Cliente],
				case when c.ObjType=17 then ''Pedido'' 
					when c.ObjType=13 then ''Factura'' 
					when c.ObjType=15 then ''Entrega'' 
					when c.ObjType=14 then ''Nota de crédito'' 
					when c.ObjType=16 then ''Devolución'' 
					when c.ObjType=20 then ''Entrada de mercancías'' 
					when c.ObjType=22 then ''Pedido de proveedor''
					else ''Documento'' 
				end [Documento],
				case when c.ObjType=17 then H1.DocNum 
					when c.ObjType=13 then H3.DocNum 
					when c.ObjType=14 then H4.DocNum 
					when c.ObjType=15 then H2.DocNum
					when c.ObjType=16 then H5.DocNum
					when c.ObjType=20 then H6.DocNum
					when c.ObjType=22 then H7.DocNum
					else 0 
				end [Doc Sap],
				c.TransId [numDocEntry],
				D.Nombre [Autor],
				case 
					when c.TransId > 0 then ''Creado'' 
					else 
						case when c.u_autorizado=''P'' then ''Pendiente (Autorización)'' 
							when c.u_autorizado=''A'' then ''Autorizado'' 
							when c.u_autorizado=''R'' then ''Rechazado'' 
						else ''Pendiente'' 
						end 
				end Estado
				,isnull(c.u_oc,'''') [Orden de compra],
				C.Comments [Comentarios],
				CASE WHEN C.U_Autorizado = ''R'' THEN C.TaxInvNo ELSE C.PickRmrk END Detalles
				,''Ver''	Ver
			FROM  sap.ODRF C 
				LEFT JOIN hnt.Usuarios D with (nolock) ON D.UserID = C.U_FolioHalcon
				LEFT JOIN SBOCTRZ.DBO.OCRD F with (nolock) ON C.CardCode COLLATE DATABASE_DEFAULT = F.CardCode
				LEFT JOIN SBOCTRZ.DBO.ORDR H1 with (nolock) ON H1.DocEntry = C.TransId AND H1.ObjType = C.ObjType
				LEFT JOIN SBOCTRZ.DBO.ODLN H2 with (nolock) ON H2.DocEntry = C.TransId AND H2.ObjType = C.ObjType
				LEFT JOIN SBOCTRZ.DBO.OINV H3 with (nolock) ON H3.DocEntry = C.TransId AND H3.ObjType = C.ObjType
				LEFT JOIN SBOCTRZ.DBO.ORIN H4 with (nolock) ON H4.DocEntry = C.TransId AND H4.ObjType = C.ObjType
				LEFT JOIN SBOCTRZ.DBO.ORDN H5 with (nolock) ON H5.DocEntry = C.TransId AND H5.ObjType = C.ObjType
				LEFT JOIN SBOCTRZ.DBO.OPDN H6 with (nolock) ON H6.DocEntry = C.TransId AND H6.ObjType = C.ObjType
				LEFT JOIN SBOCTRZ.DBO.OPOR H7 with (nolock) ON H7.DocEntry = C.TransId AND H7.ObjType = C.ObjType
			WHERE cast(c.DocDate as date) between @Desde and @Hasta AND C.ObjType NOT IN (67)'
		IF @Rol NOT IN  (1, 24)
			SET @Qry += '
				and D.UserID = @userID '

		SET @QRY += '
					
			UNION ALL
				
			SELECT --TOP 10
				0 WtmCode,
				0 WddCode,
				0 StepCode,
				c.ObjType,
				ISNULL(c.DocEntry, 0),
				C.CardCode + '' - '' + C.CardName  [Cliente],
				''Socio de negocios'' [Documento],
				NULL [Doc Sap],
				0 [numDocEntry],
				D.Nombre [Autor],
					 
				CASE WHEN C.U_Autorizado =''A'' THEN ''Alta Pendiente'' 
						WHEN C.U_Autorizado =''U'' THEN ''Actualizaciones Pendientes'' 
						WHEN C.U_Autorizado =''C'' THEN ''Cambios aplicados'' 
						WHEN C.U_Autorizado =''p'' THEN ''Pendiente (Vaidacion Transaction)'' 
						ELSE ''Pendiente'' 
				END Estado,
				'''' [Orden de compra],
				'''' [Comentarios],
				C.Notes Detalles,
				''Ver''	Ver
			FROM sap.OCRD C 
				JOIN hnt.Usuarios D with (nolock) ON D.UserID = C.UserSign
				LEFT JOIN SBOCTRZ.DBO.OCRD E with (nolock) ON C.CardCode = E.CardCode
			WHERE CAST(C.UpdateDate AS DATE) = CAST(GETDATE() AS DATE) AND C.CardCode <> '''' '
		
		IF @Rol NOT IN  (1, 24)
			SET @Qry += '
				and D.UserID = @userID '

		SET @QRY += '
			ORDER BY 5 desc--, Cliente desc'

		SET @Parametros = '@Desde DATE, @Hasta DATE, @userID INT'
		EXEC sp_executesql @QRY, @Parametros, @Desde, @Hasta, @userID
	end

	if @TipoConsulta = 47
	BEGIN
		select 'G'[Code], 'Generate'[Name]  
		union all
		select 'L'[Code], 'Generate - Later'[Name]  
		union all
		select 'N'[Code], 'Not Relevant'[Name]  
	end
	if @TipoConsulta = 48 --expedicion
	BEGIN		
		Select a.id,a.Series,b.Id,b.SeriesName,b.LugarExpedicion,b.Calle,b.NoExt,b.NoInt,b.Colonia,b.Municipio,b.Estado,b.CP,'México' Pais 
		From hnt.ExpedicionSeries a 
		JOIN hnt.Expedicion b on a.idExpedicion = b.Id where  Series = @series
	end

	IF @TipoConsulta = 49 --autorizacion 
	BEGIN		
		--if @Version is not null
		--	update sap.ODRF set u_autorizado = 'A', TransId = @TransId, AssetDate = GETDATE() where docentry= @Docentry --AND TransId > 0
		
		--IF NOT EXISTS (SELECT * FROM sap.ODRF WHERE DocEntry = @DocEntry AND TransId IS NULL AND U_Autorizado = 'A')
		UPDATE sap.ODRF SET u_autorizado = 'A', TransId = @TransId, AssetDate = GETDATE() 
		WHERE docentry= @Docentry AND ISNULL(TransId, 0) <= 0
	END

	if @TipoConsulta = 50--stock
	BEGIN		
		select b.OnHand Stock,a.itemcode,whscode from SBOCTRZ.dbo.itm1 a
		JOIN SBOCTRZ.dbo.oitw b on A.ItemCode = b.ItemCode and b.WhsCode = @WhsCode
		where a.itemcode = @Itemcode
		group by a.itemcode,b.OnHand,whscode
	end
	if @TipoConsulta = 51--unidad de medida
	BEGIN		
		select  OITM.SalUnitMsr unidadMedida from SBOCTRZ.dbo.oitm where itemcode =  @Itemcode
	end
	if @TipoConsulta = 52--autoriza stock
	BEGIN		
		if 	@ObjType <> '15'
		BEGIN
			SET @QRY = ' if  (select invntitem from [SBOCTRZ].dbo.OITM where itemcode = '''+ @Itemcode+''') = ''Y''
					BEGIN
						if(select  isnull(b.OnHand,0)Stock from [SBOCTRZ].dbo.itm1 a
						JOIN [SBOCTRZ].dbo.oitw b on A.ItemCode = b.ItemCode and b.WhsCode ='''+ @WhsCode
						+''' where a.itemcode ='''+ @Itemcode+''' group by  b.OnHand) > 0 
							Select ''Y'' Stock
						else
							Select ''N'' Stock
					end
					else
						Select ''Y'' Stock
					'	
		end		
		else	
			SET @QRY = ' Select ''Y'' Stock '									
		EXECUTE sp_executesql @QRY
	end
	if @TipoConsulta = 53 --rechazaR
	BEGIN	
		update sap.ODRF set u_autorizado='R', TransId = -1, docstatus ='R', AssetDate = GETDATE()  where /*objtype = @ObjType and*/ docentry= @DocEntry 
	end
	if @TipoConsulta = 54 --rechazar documentos (pendientes/autorizados)
	BEGIN
			declare @codigo2_ int
			if @ObjType = 13
			BEGIN
				IF @WddCode IS NULL
					set @codigo2_  = (select top 1 A.WddCode from sap.OWDD A JOIN sap.wdd1 B ON A.WddCode = B.WddCode where A.ObjType = 13 and A.docentry = @docentry AND UserID = @userID ORDER BY A.WddCode desc)
				ELSE 
					SET @codigo2_ = @WddCode

				set @WtmCode  = (select top 1 A.WtmCode from sap.OWDD A JOIN sap.wdd1 B ON A.WddCode = B.WddCode where A.ObjType = 13 and A.docentry = @docentry AND UserID = @userID ORDER BY A.WddCode desc)

				update sap.OWDD set Status= 'N' where ObjType = 13 and docentry = @docentry  and WtmCode = @WtmCode
				update sap.WDD1 set Status= 'N',comment=@Comments,updatedate=getdate() where UserID = @userID and WddCode = @codigo2_			
				update sap.ODRF set DocStatus = 'R', U_Autorizado = 'R', TaxInvNo = @Comments, AssetDate = GETDATE()  where docentry=@docentry --and ObjType = 13
			end
			if @ObjType = 15
			BEGIN
				IF @WddCode IS NULL
					set @codigo2_  = (select top 1 A.WddCode from sap.OWDD A JOIN sap.wdd1 B ON A.WddCode = B.WddCode where A.ObjType = 15 and A.docentry = @docentry AND UserID = @userID ORDER BY A.WddCode desc)
				ELSE 
					SET @codigo2_ = @WddCode

				set @WtmCode  = (select top 1 A.WtmCode from sap.OWDD A JOIN sap.wdd1 B ON A.WddCode = B.WddCode where A.ObjType = 15 and A.docentry = @docentry AND UserID = @userID ORDER BY A.WddCode desc)

				update sap.OWDD set Status= 'N' where ObjType = 15 and docentry = @docentry and WtmCode = @WtmCode
				update sap.WDD1 set Status= 'N',comment=@Comments,updatedate=getdate() where UserID = @userID and WddCode = @codigo2_	
				update sap.ODRF set DocStatus = 'R', U_Autorizado = 'R', TaxInvNo = @Comments, AssetDate = GETDATE()  where docentry=@docentry --and ObjType = 15
			end
			if @ObjType = 17
			BEGIN
				IF @WddCode IS NULL
					set @codigo2_  = (select top 1 A.WddCode from sap.OWDD A JOIN sap.wdd1 B ON A.WddCode = B.WddCode where A.ObjType = 17 and A.docentry = @docentry AND UserID = @userID ORDER BY A.WddCode desc)
				ELSE 
					SET @codigo2_ = @WddCode

				set @WtmCode  = (select top 1 A.WtmCode from sap.OWDD A JOIN sap.wdd1 B ON A.WddCode = B.WddCode where A.ObjType = 17 and A.docentry = @docentry AND UserID = @userID ORDER BY A.WddCode desc)

				update sap.OWDD set Status= 'N' where ObjType = 17 and docentry = @docentry  and WtmCode = @WtmCode
				update sap.WDD1 set Status= 'N',comment=@Comments,updatedate=getdate() where UserID = @userID and WddCode = @codigo2_			
				update sap.ODRF set DocStatus = 'R', U_Autorizado = 'R', TaxInvNo = @Comments, AssetDate = GETDATE()  where docentry=@docentry --and ObjType = 13
			end
			if @ObjType = 22
			BEGIN
				IF @WddCode IS NULL
					set @codigo2_  = (select top 1 A.WddCode from sap.OWDD A JOIN sap.wdd1 B ON A.WddCode = B.WddCode where A.ObjType = 22 and A.docentry = @docentry AND UserID = @userID ORDER BY A.WddCode desc)
				ELSE 
					SET @codigo2_ = @WddCode

				set @WtmCode  = (select top 1 A.WtmCode from sap.OWDD A JOIN sap.wdd1 B ON A.WddCode = B.WddCode where A.ObjType = 22 and A.docentry = @docentry AND UserID = @userID ORDER BY A.WddCode desc)
				
				update sap.OWDD set Status= 'N' where ObjType = 22 and docentry = @docentry and WtmCode = @WtmCode
				update sap.WDD1 set Status= 'N',comment=@Comments,updatedate=getdate() where UserID = @userID and WddCode = @codigo2_			
				update sap.ODRF set DocStatus = 'R', U_Autorizado = 'R', TaxInvNo = @Comments, AssetDate = GETDATE()  where docentry=@docentry --and ObjType = 13
			end
	end
	if @TipoConsulta = 55 --direcciones
	BEGIN
		select address Code, address Name from SBOCTRZ.dbo.crd1  where cardcode = @cardcode and adresType = 'S'
	end

	--	If @tipoConsulta = 56 --guardar borrador sap.ODRF encabezado
	--BEGIN
	--	if @DocType = 'dDocument_Items'
	--		SET @DocType = 'I'
	--	ELSE IF @DocType = '20'
	--		SET @DocType = 'I'
	--	ELSE IF @DocType = '16'
	--		SET @DocType = 'I'
	--	ELSE IF @DocType = '14'
	--		SET @DocType = 'I'
	--	ELSE IF @DocType = '22'
	--		SET @DocType = 'I'
			

	--	IF (@DocEntry = 0 )
	--	BEGIN
	--		SET @DocEntry = ISNULL((SELECT MAX(DocEntry) FROM sap.ODRF) + 1, 1)
			
	--		IF @DocEntry < 0 SET @DocEntry = 1
			
	--		IF @DocCur = 'USD'
	--		BEGIN
	--			SELECT @DocTotalFC = @DocTotal,  @VatSumFC =  @VatSum
	--			SELECT @DocTotal = @DocTotal * @DocRate, @VatSum =  @VatSum * @DocRate
	--		END

	--		IF @ObjType = 14
	--		BEGIN
	--			SELECT @FE_CP = U_FE_CP, @U_LugarExp = U_LugarExp
	--			FROM SBOCTRZ.dbo.OINV WHERE DocNum = @NumAtCard AND CardCode = @CardCode

	--		--	SET @U_METPAGO2 = '15'
	--		END

	--		SET @U_TIPOOV = CASE WHEN ISNULL(@U_TIPOOV, '') = '' THEN 'SUR' ELSE @U_TIPOOV END

 --           IF(@ObjType IN (13, 15, 17))
 --               SET @U_Titular = CASE WHEN ISNULL(@U_Titular, '')  = ''
 --                                     THEN '00' ELSE @U_Titular END --LLENAR TITULAR CON 00 CUANDO LO DEJEN VACIO
	--		--SET @EDocGenTyp = 'N'

	--		IF @ObjType = 67
	--		BEGIN
	--			SET @GroupNum = CASE WHEN @GroupNum = 0 THEN -1 ELSE @GroupNum END --correccion, cambiar tipo de dato a INT? en controlador
	--			SET @GroupNum = CASE WHEN @GroupNum not in (-1) THEN @GroupNum ELSE 7 END
	--		END

	--		SELECT @U_VersionCFDI = '33'

	--		--IF @Series = 76
	--		SELECT @U_VersionCFDI = '40'

	--		--select * from SBOCTRZ.dbo.NNM1 where ObjectCode = 13 AND SERIESNAME LIKE '%LAR%'

	--		INSERT INTO sap.ODRF (DocEntry,		Docnum,		Series,		DocType,	CardCode,	DocDate,	DocDueDate,		DocRate,	Indicator,	DocCur,		Comments,	U_Motivo,	EDocGenTyp,		U_MPAGO2,		ObjType,	DocTotal,	DocTotalFC,		VatSumFC,	VatSum,		NumAtCard,	U_TPedido,	U_Titular,	U_OC,	SlpCode ,	U_CUENTA,	U_FolioHalcon,	U_TIPOOV ,	U_TC ,		U_LugarExp,		U_FE_Calle,	U_FE_NoExt,	U_FE_NoInt,	U_FE_Colonia,	U_FE_Municipio,	U_FE_Estado,	U_FE_Pais,	U_FE_CP,	ShipToCode,		CreateDate,					Filler,		ToWhsCode,	U_FolioSolicitud,	U_UUID,		U_B1SYS_MainUsage,	DiscPrcnt,		U_MetPago,	UpdateDate, U_Autorizado,	Confirmed,	TrnspCode,	U_Factor,	ECommerBP,	U_Comentarios,		U_EdocGenType,	U_Edocnum,	isins,	FatherCard,		VersionNum,		GroupNum,	DiscSumSy,	/*U_FolioCore,*/	U_NoRelFact,	U_VersionCFDI,	U_Load,	U_Delivery_Place, TaxDate,	JrnlMemo,	 Rounding,  RoundDif)
	--		VALUES(			      @DocEntry,	@DocEntry,	@Series,	@DocType,	@CardCode,	@DocDate,	@DocDueDate,	@DocRate,	@Indicator,	@DocCur,	@Comments,	@U_Motivo,	@EDocGenTyp,	@U_METPAGO2,	@ObjType,	@DocTotal,	@DocTotalFC,	@VatSumFC,	@VatSum,	@NumAtCard,	@U_TPedido,	@U_Titular,	@U_OC,	@SlpCode,	@U_CUENTA,	@userID,		@U_TIPOOV,	@U_TC_H,	@U_LugarExp,	@FE_Calle,	@FE_NoExt,	@FE_NoInt,	@FE_Colonia,	@FE_Municipio,	@FE_Estado,		@FE_Pais,	@FE_CP,		@ShipToCode,	cast(getdate() as date),	@Filler,	@ToWhsCode,	@U_FolioSolicitud,	@U_UUID,	@U_B1SYS_MainUsage,	@DiscPrcnt_H,	@U_MetPago,	GETDATE(),	NULL,			@Confirmed,	@TrnspCode,	@U_Factor,	@ECommerBP,	@U_ComentarioAuto,	@U_EdocGenType,	@U_Edocnum,	@IsIns,	@FatherCard,	@VersionNum,	@GroupNum,	@DiscSumSy,	/*@U_FolioCore,*/	@U_NoRelFact,	@U_VersionCFDI,	@U_Load,@U_Delivey_Place, @TaxDate, @JournalMemo, @Rounding, @RoundingDiffAmount)
			
	--		select top 1 DocEntry from sap.ODRF ORDER BY docentry desc
	--	END
	--	else
	--	BEGIN
	--		if (select top 1 ISNULL(transid, 0) from sap.ODRF where DocEntry= @DocEntry) <= 0
	--		BEGIN
	--			IF @DocCur = 'USD'
	--			BEGIN
	--				SELECT @DocTotalFC = @DocTotal,  @VatSumFC =  @VatSum
	--				SELECT @DocTotal = @DocTotal * @DocRate, @VatSum =  @VatSum * @DocRate
	--			END

	--			--IF  NOT EXISTS(Select * From sap.ODRF WHERE DocNum = @DocEntry AND (U_Autorizado = 'R')) --DOCUMENTO RECHAZADO
	--			--	OR
	--			--	NOT EXISTS (SELECT * FROM sap.ODRF WHERE DocEntry = @DocEntry AND TransId IS NULL AND U_Autorizado = 'A') -- EL FILA PARA CREARSE
	--			IF EXISTS(Select * From sap.ODRF WHERE DocNum = @DocEntry AND U_Autorizado IS NULL)
	--			BEGIN
	--				UPDATE sap.ODRF 
	--				set 
	--					DocRate = @DocRate,Comments=@Comments,U_Motivo=@U_Motivo,EDocGenTyp=@EDocGenTyp,
	--					U_MPAGO2=@U_METPAGO2,DocTotal=@DocTotal,DocTotalFC=@DocTotalFC,VatSum=@VatSum,NumAtCard=@NumAtCard,U_Titular=@U_Titular,
	--					U_OC=@U_OC,SlpCode=@SlpCode,U_CUENTA=@U_CUENTA,U_TIPOOV=@U_TIPOOV,U_TC=@U_TC_H,ShipToCode=@ShipToCode,
	--					DiscPrcnt = @DiscPrcnt_H, U_B1SYS_MainUsage = @U_B1SYS_MainUsage, U_MetPago = @U_MetPago, TrnspCode = @TrnspCode, U_Factor = @U_Factor,
	--					U_FolioSolicitud = @U_FolioSolicitud, U_Comentarios = @U_ComentarioAuto,
	--					U_EdocGenType = @U_EdocGenType, U_Edocnum = @U_Edocnum,
	--					TransId= NULL, U_Autorizado = NULL,--, Series = @Series
	--					TaxDate = @TaxDate, JrnlMemo = @JournalMemo, Rounding = @Rounding, RoundDif = @RoundingDiffAmount
	--				WHERE DocEntry= @DocEntry
				
	--				--UPDATE sap.ODRF set transid = null, u_autorizado = 'P' WHERE DocEntry= @DocEntry 
	--			END
	--			ELSE
	--			BEGIN
	--				SET @DocEntry = @DocEntry
	--				--RAISERROR ('El documento no se puede modificar.' , 11, 1)
	--			END
	--		end
	--		select top 1 DocEntry from sap.ODRF where DocEntry= @DocEntry 
	--	end

	--	--MIENTRAS AUN ESTE COMO PENDIENTE SE ELIMINAN LINAS PARA PERMIRIR AL USUARIO MODIDIFAR SU DOCUMENTO
	--	IF EXISTS(Select * From sap.ODRF WHERE DocNum = @DocEntry AND U_Autorizado IS NULL)
	--	BEGIN
	--		DELETE FROM sap.DRF1 WHERE DocEntry = @DocEntry
	--		DELETE FROM sap.DRF5 WHERE AbsEntry = @DocEntry
	--	END
	--end


	If @tipoConsulta = 56 --guardar borrador sap.ODRF encabezado
	BEGIN

		SET @QRY ='

			IF @DocType = ''dDocument_Items''
				SET @DocType = ''I''
			ELSE IF @DocType = ''20''
				SET @DocType = ''I''
			ELSE IF @DocType = ''16''
				SET @DocType = ''I''
			ELSE IF @DocType = ''14''
				SET @DocType = ''I''
			ELSE IF @DocType = ''22''
				SET @DocType = ''I''
			
			IF (@DocEntry = 0 )
			BEGIN
				SET @DocEntry = ISNULL((SELECT MAX(DocEntry) FROM ['+@BD+'].sap.ODRF) + 1, 1)
			
				IF @DocEntry < 0 SET @DocEntry = 1
			
				IF @DocCur = ''USD''
				BEGIN
					SELECT @DocTotalFC = @DocTotal,  @VatSumFC =  @VatSum
					SELECT @DocTotal = @DocTotal * @DocRate, @VatSum =  @VatSum * @DocRate
				END

				IF @ObjType = 14
				BEGIN
					SELECT @FE_CP = U_FE_CP, @U_LugarExp = U_LugarExp
					FROM ['+@BDSAP+'].dbo.OINV WHERE DocNum = @NumAtCard AND CardCode = @CardCode

		   ----	SET @U_METPAGO2 = ''15''
				END

				SET @U_TIPOOV = CASE WHEN ISNULL(@U_TIPOOV, '''') = '''' THEN ''SUR'' ELSE @U_TIPOOV END

				IF(@ObjType IN (13, 15, 17))
					SET @U_Titular = CASE WHEN ISNULL(@U_Titular, '''')  = ''''
										  THEN ''00'' ELSE @U_Titular END -- LLENAR TITULAR CON 00 CUANDO LO DEJEN VACIO
				
				IF @ObjType = 17
				BEGIN
					SELECT @ShipToCode = ShipToDef FROM SBOCTRZ.dbo.OCRD WHERE CardCode = @CardCode
				END

				IF @ObjType = 67
				BEGIN
					SET @GroupNum = CASE WHEN @GroupNum = 0 THEN -1 ELSE @GroupNum END --correccion, cambiar tipo de dato a INT? en controlador
					SET @GroupNum = CASE WHEN @GroupNum not in (-1) THEN @GroupNum ELSE 7 END
				END

				SELECT @U_VersionCFDI = ''33''

			  --IF @Series = 76
				SELECT @U_VersionCFDI = ''40''

			  -- select * from ['+@BDSAP+'].dbo.NNM1 where ObjectCode = 13 AND SERIESNAME LIKE ''%LAR%''

				INSERT INTO ['+@BD+'].sap.ODRF (DocEntry,		Docnum,		Series,		DocType,	CardCode,	DocDate,	DocDueDate,		DocRate,	Indicator,	DocCur,		Comments,	U_Motivo,	EDocGenTyp,		U_MPAGO2,		ObjType,	DocTotal,	DocTotalFC,		VatSumFC,	VatSum,		NumAtCard,	U_TPedido,	U_Titular,	U_OC,	SlpCode ,	U_CUENTA,	U_FolioHalcon,	U_TIPOOV ,	U_TC ,		U_LugarExp,		U_FE_Calle,	U_FE_NoExt,	U_FE_NoInt,	U_FE_Colonia,	U_FE_Municipio,	U_FE_Estado,	U_FE_Pais,	U_FE_CP,	ShipToCode,		CreateDate,					Filler,		ToWhsCode,	U_FolioSolicitud,	U_UUID,		U_B1SYS_MainUsage,	DiscPrcnt,		U_MetPago,	UpdateDate, U_Autorizado,	Confirmed,	TrnspCode,	U_Factor,	ECommerBP,	U_Comentarios,		U_EdocGenType,	U_Edocnum,	isins,	FatherCard,		VersionNum,		GroupNum,	DiscSumSy,	/*U_FolioCore,*/	U_NoRelFact,	U_VersionCFDI,	U_Load,	U_Delivery_Place, TaxDate,	JrnlMemo,	 Rounding,  RoundDif, U_FechaVto, ExtraDays)
				VALUES(			      @DocEntry,	@DocEntry,	@Series,	@DocType,	@CardCode,	@DocDate,	@DocDueDate,	@DocRate,	@Indicator,	@DocCur,	@Comments,	@U_Motivo,	@EDocGenTyp,	@U_METPAGO2,	@ObjType,	@DocTotal,	@DocTotalFC,	@VatSumFC,	@VatSum,	@NumAtCard,	@U_TPedido,	@U_Titular,	@U_OC,	@SlpCode,	@U_CUENTA,	@userID,		@U_TIPOOV,	@U_TC_H,	@U_LugarExp,	@FE_Calle,	@FE_NoExt,	@FE_NoInt,	@FE_Colonia,	@FE_Municipio,	@FE_Estado,		@FE_Pais,	@FE_CP,		@ShipToCode,	cast(getdate() as date),	@Filler,	@ToWhsCode,	@U_FolioSolicitud,	@U_UUID,	@U_B1SYS_MainUsage,	@DiscPrcnt_H,	@U_MetPago,	GETDATE(),	NULL,			@Confirmed,	@TrnspCode,	@U_Factor,	@ECommerBP,	@U_ComentarioAuto,	@U_EdocGenType,	@U_Edocnum,	@IsIns,	@FatherCard,	@VersionNum,	@GroupNum,	@DiscSumSy,	/*@U_FolioCore,*/	@U_NoRelFact,	@U_VersionCFDI,	@U_Load,@U_Delivey_Place, @TaxDate, @JournalMemo, @Rounding, @RoundingDiffAmount, @U_FechaVto, @ExtraDays)
			
				select top 1 DocEntry from ['+@BD+'].sap.ODRF ORDER BY docentry desc
			END
			else
			BEGIN
				if (select top 1 ISNULL(transid, 0) from ['+@BD+'].sap.ODRF where DocEntry= @DocEntry) <= 0
				BEGIN
					IF @DocCur = ''USD''
					BEGIN
						SELECT @DocTotalFC = @DocTotal,  @VatSumFC =  @VatSum
						SELECT @DocTotal = @DocTotal * @DocRate, @VatSum =  @VatSum * @DocRate
					END

			----	IF  NOT EXISTS(Select * From ['+@BD+'].sap.ODRF WHERE DocNum = @DocEntry AND (U_Autorizado = ''R'')) --DOCUMENTO RECHAZADO
			----		OR
			----		NOT EXISTS (SELECT * FROM ['+@BD+'].sap.ODRF WHERE DocEntry = @DocEntry AND TransId IS NULL AND U_Autorizado = ''A'') -- EL FILA PARA CREARSE
					IF EXISTS(Select * From ['+@BD+'].sap.ODRF WHERE DocNum = @DocEntry AND U_Autorizado IS NULL)
					BEGIN
						UPDATE ['+@BD+'].sap.ODRF 
						set 
							DocRate = @DocRate, Comments = @Comments, U_Motivo = @U_Motivo, EDocGenTyp = @EDocGenTyp,
							U_MPAGO2=@U_METPAGO2,DocTotal=@DocTotal,DocTotalFC=@DocTotalFC,VatSum=@VatSum,
							NumAtCard = @NumAtCard, U_Titular = @U_Titular, U_OC = @U_OC,SlpCode = @SlpCode,
							U_CUENTA = @U_CUENTA, U_TIPOOV = @U_TIPOOV, U_TC = @U_TC_H, ShipToCode = @ShipToCode,
							DiscPrcnt = @DiscPrcnt_H, U_B1SYS_MainUsage = @U_B1SYS_MainUsage, U_MetPago = @U_MetPago, 
							TrnspCode = @TrnspCode, U_Factor = @U_Factor, U_FolioSolicitud = @U_FolioSolicitud, 
							U_Comentarios = @U_ComentarioAuto, U_EdocGenType = @U_EdocGenType, U_Edocnum = @U_Edocnum,
							TransId= NULL, U_Autorizado = NULL,--, Series = @Series
							TaxDate = @TaxDate, JrnlMemo = @JournalMemo, Rounding = @Rounding, RoundDif = @RoundingDiffAmount,
							U_TPedido = @U_TPedido
						WHERE DocEntry= @DocEntry
				
			----		UPDATE ['+@BD+'].sap.ODRF set transid = null, u_autorizado = ''P'' WHERE DocEntry= @DocEntry 
					END
					ELSE
					BEGIN
						SET @DocEntry = @DocEntry
			----		RAISERROR (''El documento no se puede modificar.'' , 11, 1)
					END
				end
				select top 1 DocEntry from ['+@BD+'].sap.ODRF where DocEntry= @DocEntry 
			end

			----MIENTRAS AUN ESTE COMO PENDIENTE SE ELIMINAN LINAS PARA PERMIRIR AL USUARIO MODIDIFAR SU DOCUMENTO
			IF EXISTS(Select * From ['+@BD+'].sap.ODRF WHERE DocNum = @DocEntry AND U_Autorizado IS NULL)
			BEGIN
				DELETE FROM ['+@BD+'].sap.DRF1 WHERE DocEntry = @DocEntry
				DELETE FROM ['+@BD+'].sap.DRF5 WHERE AbsEntry = @DocEntry
				DELETE FROM ['+@BD+'].sap.DRF2 WHERE DocEntry = @DocEntry
			END
		'


		SET @PARAMETROS = 
						'@DocEntry INT,
						@Series INT,
						@DocType VARCHAR(100),
						@CardCode nvarchar(50),
						@DocDate nvarchar(50),
						@DocDueDate datetime,
						@DocRate decimal(18,8),
						@Indicator varchar(15),
						@DocCur varchar(15),
						@Comments varchar(500),
						@U_Motivo varchar(15),
						@EDocGenTyp varchar(15),
						@U_METPAGO2 varchar(15),
						@ObjType numeric(18,0),
						@DocTotal decimal(18,4),
						@DocTotalFC decimal(18,4),
						@VatSumFC decimal(18,4),'
		SET @PARAMETROS += '
						@VatSum decimal(18,4),
						@NumAtCard nvarchar(50),
						@U_TPedido nvarchar(10),
						@U_Titular nvarchar(10),
						@U_OC nvarchar(20),
						@SlpCode INT,
						@U_CUENTA nvarchar(15),
						@userID INT,
						@U_TIPOOV nvarchar(10),
						@U_TC_H DECIMAL(18,4),
						@U_LugarExp nvarchar(50),
						@FE_Calle nvarchar(30),
						@FE_NoExt nvarchar(10),
						@FE_NoInt nvarchar(10),
						@FE_Colonia nvarchar(50),
						@FE_Municipio nvarchar(20),
						@FE_Estado nvarchar(20),
						@FE_Pais nvarchar(10),
						@FE_CP nvarchar(15),'
		SET @PARAMETROS += '
						@ShipToCode nvarchar(50),
						@Filler nvarchar(50),
						@ToWhsCode nvarchar(50),
						@U_FolioSolicitud nvarchar(50),
						@U_UUID nvarchar(50),
						@U_B1SYS_MainUsage nvarchar(50),
						@DiscPrcnt_H DECIMAL(18,4),
						@U_MetPago VARCHAR(5),
						@Confirmed VARCHAR(1),
						@TrnspCode INT,
						@U_Factor DECIMAL(9,4),
						@ECommerBP VARCHAR(30),
						@U_ComentarioAuto VARCHAR(50),
						@U_Edocnum VARCHAR(100),
						@IsIns VARCHAR(100),
						@FatherCard NVARCHAR(15),
						@VersionNum NCHAR(15),
						@GroupNum int,'
		SET @PARAMETROS += '
					@DiscSumSy DECIMAL(18, 6),
					@U_NoRelFact NVARCHAR(20),
					@U_VersionCFDI VARCHAR(5),
					@U_Load VARCHAR(25),
					@U_Delivey_Place VARCHAR(15),
					@TaxDate datetime,
					@JournalMemo NVARCHAR(50),
					@Rounding CHAR(1),
					@RoundingDiffAmount DECIMAL(18, 4),
					@U_EdocGenType VARCHAR(1),
					@U_FechaVto VARCHAR(50),
					@ExtraDays INT
					'	
		EXECUTE sp_executesql @QRY, @PARAMETROS, 
				@DocEntry,
				@Series,
				@DocType,
				@CardCode,
				@DocDate,
				@DocDueDate,
				@DocRate,
				@Indicator,
				@DocCur,
				@Comments,
				@U_Motivo,
				@EDocGenTyp,
				@U_METPAGO2,
				@ObjType,
				@DocTotal,
				@DocTotalFC,
				@VatSumFC,
				@VatSum,
				@NumAtCard,
				@U_TPedido,
				@U_Titular,
				@U_OC,
				@SlpCode,
				@U_CUENTA,
				@userID,
				@U_TIPOOV,
				@U_TC_H,
				@U_LugarExp,
				@FE_Calle,
				@FE_NoExt,
				@FE_NoInt,
				@FE_Colonia,
				@FE_Municipio,
				@FE_Estado,
				@FE_Pais,
				@FE_CP,
				@ShipToCode,
				@Filler,
				@ToWhsCode,
				@U_FolioSolicitud,
				@U_UUID,
				@U_B1SYS_MainUsage,
				@DiscPrcnt_H,
				@U_MetPago,
				@Confirmed,
				@TrnspCode,
				@U_Factor,
				@ECommerBP,
				@U_ComentarioAuto,
				@U_Edocnum,
				@IsIns,
				@FatherCard,
				@VersionNum,
				@GroupNum,
				@DiscSumSy,
				@U_NoRelFact,
				@U_VersionCFDI,
				@U_Load,
				@U_Delivey_Place,
				@TaxDate,
				@JournalMemo,
				@Rounding,
				@RoundingDiffAmount,
				@U_EdocGenType,
				@U_FechaVto,
				@ExtraDays
	end


	IF @TipoConsulta = 57 --SE GUARDA EL DETALLE DEL DOCUMENTO BORRADOR
	BEGIN

	SET @QRY = CAST('
		--PARA QUE SIEMPRE SE INSERTEN TODAS LAS LINEAS, PARA EVITAR DUPLICADOS SE ELIMINAN AL TERMIANRE DE GUARDAR EL ENCABEZADO
		IF EXISTS(Select * From ['+@BD+'].sap.ODRF WHERE DocNum = @DocEntry AND U_Autorizado IS NULL)
			SET @LineNum = -1

		IF @LineNum > -1 
		BEGIN
			update ['+@BD+'].sap.ODRF set U_ComentarioAut = GETDATE() where DocEntry = @DocEntry

			IF @Currency = ''USD''
				set @LinetotalFrgn = @U_Price * @Quantity
			
			SELECT @OcrCode = C.U_NormaReparto 
			FROM 
				['+@BD+'].SAP.ODRF A 
				JOIN ['+@BDSAP+'].dbo.OCRD B ON A.CardCode = B.CardCode
				JOIN ['+@BDSAP+'].dbo.[@HNT_NRSUC] C ON B.GroupCode =C.Code
			WHERE DocNum = @DocEntry

			IF NOT EXISTS(Select * From ['+@BD+'].sap.ODRF WHERE DocNum =  @DocEntry AND (U_Autorizado in (''R'', ''A'')))
			BEGIN
				UPDATE ['+@BD+'].sap.DRF1 SET 
					totalfrgn = @LinetotalFrgn,
					ItemCode = @ItemCode,
					Quantity = @Quantity,
					Price = @Price,
					Rate = @Rate,
					U_PReal = @U_PReal,
					LineTotal = @LineTotal,
					Currency = @Currency,
					TaxCode = @TaxCode,
					WhsCode = @WhsCode,
					AcctCode = @AcctCode,
					CogsAcct = @CogsAcct,
					U_Price  = @U_Price,
					U_StockAlmacen = @U_StockAlmacen,
					U_TC = @U_TC,
					PriceBefDi = @PriceBefDi,
					U_DiscPrcnt = @U_DiscPrcnt,
					BaseEntry = @BaseEntry,
					BaseLine = @BaseLine,
					BaseType = @BaseType,
					U_Padre = @U_Padre,
					NcmCode = @NcmCode, 
					Dscription = @Dscription,
					FromWhsCod = @FromWhsCode,
					Weight1 = @BWeight1,
					Volume = @BVolume,
					U_Tarima = @U_Tarima,
					U_TipoAlm = @U_TipoAlm,
					U_Comentario = @U_Comentario,
					NumPerMsr = @NumPerMsr, 
					unitMsr = @MeasureUnit,
					OcrCode = @OcrCode,
					OcrCode2 = @CostingCode2,
					OcrCode3 = @CostingCode3,
					OcrCode4 = @CostingCode4			
				WHERE 
					DocEntry = @DocEntry AND LineNum = @LineNum
			END
			ELSE
			BEGIN
				SET @DocEntry = @DocEntry
			END
		END
		ELSE' AS VARCHAR(MAX))

		SET @QRY += CAST('
		BEGIN
			SET @LineNum = ISNULL((SELECT MAX(LineNum) FROM ['+@BD+'].sap.DRF1 WHERE DocEntry = @DocEntry) + 1, 1)		
			
			BEGIN
				IF @Currency = ''USD''
					SET @LinetotalFrgn = @U_Price * @Quantity

				SELECT @OcrCode = C.U_NormaReparto 
				FROM 
					['+@BD+'].SAP.ODRF A 
					JOIN ['+@BDSAP+'].dbo.OCRD B ON A.CardCode = B.CardCode
					JOIN ['+@BDSAP+'].dbo.[@HNT_NRSUC] C ON B.GroupCode =C.Code
				WHERE DocNum = @DocEntry
			END

			IF @ObjType IN(17, 13)--Pedido/Factura
			BEGIN
				IF @BaseType = 15-- si la factura proviene de un pedido cabiar la cuena de costo
					SET @CogsAcct = ''1140-003-002''
				ELSE--si no, tomar la cuenta de costo del almacen
					SET @CogsAcct = (SELECT SaleCostAc FROM ['+@BDSAP+'].dbo.OWHS WHERE WhsCode = @WhsCode)
							
			END

			IF @ObjType IN(17, 13, 15)
			BEGIN
				IF ISNULL(@AcctCode, '''') = ''''
					SET @AcctCode = (SELECT RevenuesAc FROM ['+@BDSAP+'].dbo.OWHS WHERE WhsCode = @WhsCode)--Cuenta de ventas de acuerdo al almacen.
			END

			IF @ObjType = 15
				SET @CogsAcct = ''1140-003-002''
			
			IF(@ObjType in (22))
			BEGIN
				IF @ShipDate IS NULL SET @ShipDate = @DocDueDate
			END
		
			IF @ObjType IN (13, 17, 15)
			BEGIN
				SELECT @U_CostoBase2 = Price FROM ['+@BDSAP+'].dbo.ITM1 WHERE PriceList = 13 AND ItemCode = @ItemCode

				IF EXISTS(SELECT * FROM ['+@BDSAP+'].dbo.OCRD WHERE CardCode = @CardCode AND QryGroup36 = ''Y'')
					SELECT @U_CostoBase = Price FROM ['+@BDSAP+'].dbo.ITM1 WHERE PriceList = 13 AND ItemCode = @ItemCode
				
				IF EXISTS(SELECT * FROM ['+@BDSAP+'].dbo.OCRD WHERE CardCode = @CardCode AND GroupCode in (165,167,169)) --PARA Clientes de mexicali, ensenada y tijuana tomar lp 17 Costo base EN 
					SELECT @U_CostoBase = Price FROM ['+@BDSAP+'].dbo.ITM1 WHERE PriceList = 15 AND ItemCode = @ItemCode
			END

			----SI EL ARTICULO EN SU PRECIO DE COMPRA ES PESOS, SE INSERTARÁ NULL EN EL CAMPO DE USUARIO U_TC
			IF EXISTS(
				SELECT A.ItemCode, B.Currency, B.Price FROM ['+ @BDSAP +'].dbo.OITM A
				INNER JOIN ['+ @BDSAP +'].dbo.ITM1 B ON B.ItemCode = A.ItemCode AND B.PriceList = 7
				WHERE 1 = 1
				AND A.ItemCode = @ItemCode
				AND B.Currency = ''$''
			)
			BEGIN
				INSERT INTO ['+@BD+'].sap.DRF1 (DocEntry,  ObjType,  LineNum , totalfrgn,      Visorder, ItemCode , OpenQty,   Quantity,  Price,  Rate,  U_PReal,  LineTotal,  Currency,  TaxCode , WhsCode , AcctCode,  CogsAcct,  U_Price 
				, U_StockAlmacen , PriceBefDi , U_DiscPrcnt,  BaseEntry,  BaseLine,  BaseType , U_Padre,  NcmCode,  Dscription,  FromWhsCod,   Weight1,   Volume,   U_Tarima,  U_TipoAlm,  U_Comentario,  NumPerMsr,  unitMsr,      U_Peso, U_Vendedor
				,   Factor1, OcrCode,  TreeType,  U_CostoBase,	U_CostoBase2,	DocDate,	Project, OcrCode2,	OcrCode3,		OcrCode4, U_TIPOMOV, U_TC)
				VALUES				 (			@DocEntry, @ObjType, @LineNum, @LinetotalFrgn, @LineNum, @ItemCode, @Quantity, @Quantity, @Price, @Rate, @U_PReal, @LineTotal, @Currency, @TaxCode, @WhsCode, @AcctCode, @CogsAcct, @U_Price
				, @U_StockAlmacen, @PriceBefDi, @U_DiscPrcnt, @BaseEntry, @BaseLine, @BaseType, @U_Padre, @NcmCode, @Dscription, @FromWhsCode, @BWeight1, @BVolume, @U_Tarima, @U_TipoAlm, @U_Comentario, @NumPerMsr, @MeasureUnit, @U_Peso, @U_Vendedor
				, @U_TC,   @OcrCode, @TreeType, @U_CostoBase,	@U_CostoBase2,	GETDATE(),	@Project, @CostingCode2,	@CostingCode3,	@CostingCode4,  @U_TIPOMOV, NULL)
			END
			ELSE
			BEGIN
				INSERT INTO ['+@BD+'].sap.DRF1 (DocEntry,  ObjType,  LineNum , totalfrgn,      Visorder, ItemCode , OpenQty,   Quantity,  Price,  Rate,  U_PReal,  LineTotal,  Currency,  TaxCode , WhsCode , AcctCode,  CogsAcct,  U_Price , U_StockAlmacen , PriceBefDi , U_DiscPrcnt,  BaseEntry,  BaseLine,  BaseType , U_Padre,  NcmCode,  Dscription,  FromWhsCod,   Weight1,   Volume,   U_Tarima,  U_TipoAlm,  U_Comentario,  NumPerMsr,  unitMsr,      U_Peso, U_Vendedor,   Factor1, OcrCode,  TreeType,  U_CostoBase,	U_CostoBase2,	DocDate,	Project, OcrCode2,	OcrCode3,		OcrCode4,		U_TIPOMOV)
				VALUES				 (			@DocEntry, @ObjType, @LineNum, @LinetotalFrgn, @LineNum, @ItemCode, @Quantity, @Quantity, @Price, @Rate, @U_PReal, @LineTotal, @Currency, @TaxCode, @WhsCode, @AcctCode, @CogsAcct, @U_Price, @U_StockAlmacen, @PriceBefDi, @U_DiscPrcnt, @BaseEntry, @BaseLine, @BaseType, @U_Padre, @NcmCode, @Dscription, @FromWhsCode, @BWeight1, @BVolume, @U_Tarima, @U_TipoAlm, @U_Comentario, @NumPerMsr, @MeasureUnit, @U_Peso, @U_Vendedor, @U_TC,   @OcrCode, @TreeType, @U_CostoBase,	@U_CostoBase2,	GETDATE(),	@Project, @CostingCode2,	@CostingCode3,	@CostingCode4,  @U_TIPOMOV)
			END

			/*Si la utilidad sin en TC esta debajo el 18% tomar en cuenta el TC de HNT 
			[Para lineas seguridad industrial aplica 18%] - Solicita Liliana Navarro 19 de enero
			173	JOST WELDING
			174	JOSTEIN SAFETY
			(173,174,179,180,181,182) --otras lineas
			*/
			IF @ObjType in (13, 15, 17)
			BEGIN
				UPDATE ['+@BD+'].sap.DRF1 SET U_TC = NULL WHERE DocEntry = @DocEntry 
							
				DECLARE @lineNumAux INT
				DECLARE cur_Utilidad CURSOR FOR Select LineNum From ['+@BD+'].sap.DRF1 Where DocEntry = @DocEntry 
				OPEN cur_Utilidad
				FETCH NEXT FROM cur_Utilidad INTO @lineNumAux
				WHILE @@fetch_status = 0
				BEGIN
					BEGIN TRY
						DECLARE @limiteu DECIMAL(18, 4) = 0.18 --sE CAMBIA DE 15 a 18 SOL JM 2022-01-04

						IF EXISTS (Select * FROM ['+@BDSAP+'].dbo.OITM Where ItemCode =  @ItemCode AND ItmsGrpCod IN (173,174,179,180,181,182))--PARA LINEAS DE CANAL IND SE APLICA ESTE PORCENTAJE
						BEGIN
							SET @limiteu = 0.18
						END
					
						SELECT @Utilidad = ISNULL([dbo].[fu_sales_GetUtilidadDraft](@DocEntry, @lineNumAux), 0)

						IF ISNULL(@Utilidad, 0) < @limiteu
							UPDATE ['+@BD+'].sap.DRF1 SET U_TC = Factor1 WHERE DocEntry = @DocEntry AND LineNum = @lineNumAux
						ELSE
							UPDATE ['+@BD+'].sap.DRF1 SET U_TC = NULL WHERE DocEntry = @DocEntry AND LineNum = @lineNumAux
					END TRY
					BEGIN CATCH
					END CATCH

					FETCH NEXT FROM cur_Utilidad INTO @lineNumAux
				END
				CLOSE cur_Utilidad
				DEALLOCATE cur_Utilidad
			END
		END
		
		---------=========Actualizar costo base segun lista especial seleccionada

		SELECT @LineNum
	' AS VARCHAR(MAX))

	
	SET @PARAMETROS ='
					@DocEntry INT,
					@LinetotalFrgn DECIMAL(18,4),
					@U_Price decimal(18,8),
					@Quantity decimal(18,8),
					@OcrCode  nvarchar(50),
					@ObjType numeric(18,0),
					@BaseType decimal(18,0),
					@CogsAcct varchar(15),
					@WhsCode  varchar(15),
					@ShipDate DATE,
					@DocDueDate datetime,
					@U_CostoBase2 decimal(18,8),
					@U_CostoBase  decimal(18,8),
					@Utilidad	  DECIMAL(10, 6),
					@LineNum	  INT,
					@CardCode	  nvarchar(50),
					@ItemCode	  varchar(100),
					@Price		  decimal(18,8),
					@Rate		  decimal(18,4),								
				'
				
	SET @PARAMETROS += '
					@U_PReal	  decimal(18,4), 	  
					@LineTotal	  decimal(18,4),
					@Currency	  varchar(15),	
					@TaxCode	  varchar(15),
					@AcctCode	  varchar(15),
					@U_StockAlmacen DECIMAL(18,4),
					@U_TC		  DECIMAL(18,4),
					@PriceBefDi	  decimal(18,8),
					@U_DiscPrcnt  DECIMAL(18,4),
					@BaseEntry	  decimal(18,0),
					@BaseLine	  decimal(18,0),
					@U_Padre	  nvarchar(50),
					@NcmCode	  int,   
					@Dscription   varchar(50),
					@FromWhsCode  nvarchar(50),
					@BWeight1	  decimal(18,4),
					@BVolume	  decimal(18,4),
					@U_Tarima	  varchar(50),
					@U_TipoAlm	  varchar(50),
					@U_Comentario VARCHAR(150),
					@NumPerMsr    INT,
					@MeasureUnit  VARCHAR(15),
					@U_Peso		  INT,
					@U_Vendedor	  varchar(100),
					@TreeType	  nvarchar(50),
					@Project	  NVARCHAR(20), 
					@CostingCode2 NVARCHAR(8),
					@CostingCode3 NVARCHAR(8),
					@CostingCode4 NVARCHAR(8),
					@U_TIPOMOV	  VARCHAR(100)
				   '
	
	EXECUTE sp_executesql @QRY, @PARAMETROS, 
								@DocEntry,
								@LinetotalFrgn,
								@U_Price,
								@Quantity,
								@OcrCode,
								@ObjType,
								@BaseType,
								@CogsAcct,
								@WhsCode,
								@ShipDate,
								@DocDueDate,
								@U_CostoBase2,
								@U_CostoBase,
								@Utilidad,
								@LineNum,
								@CardCode,
								@ItemCode,
								@Price,
								@Rate,
								@U_PReal, 	  
								@LineTotal,
								@Currency,	
								@TaxCode,
								@AcctCode,
								@U_StockAlmacen,
								@U_TC,
								@PriceBefDi,
								@U_DiscPrcnt,
								@BaseEntry,
								@BaseLine,
								@U_Padre,
								@NcmCode,   
								@Dscription,
								@FromWhsCode,
								@BWeight1,
								@BVolume,
								@U_Tarima,
								@U_TipoAlm,
								@U_Comentario,
								@NumPerMsr,
								@MeasureUnit,
								@U_Peso,
								@U_Vendedor,
								@TreeType,
								@Project, 
								@CostingCode2,
								@CostingCode3,
								@CostingCode4,
								@U_TIPOMOV


	END


	IF @TipoConsulta = 58 --encabezado del borrador
	BEGIN
		--Factura
		IF @ObjType = 13
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY =	'SELECT '''' TipoDocumento, REPLACE(REPLACE(LEFT(CAST(U_B1SYS_SignMsg AS VARCHAR(MAX)), 6), ''|'', ''''), ''?'', '''') VersionCFDI, 
									ISNULL(Nombre, '''') [Autor], isnull(d.ReportID,'''') Edocnum, 
									a.ShipToCode address, c.u_foliohalcon,a.*,
									(SELECT TOP 1 x.TaxCode FROM SBOCTRZ.dbo.INV1 x WHERE DocEntry = A.DocEntry) taxcode, 
									CASE U_Canal WHEN ''1'' THEN ''Transporte'' WHEN ''2'' THEN ''Mayoreo'' WHEN ''3'' THEN ''Armadores'' END Canal
									, ISNULL((Select TOP 1 PorcenUtilidad From dbo.fu_logistics_GetTBLUtilidadxFactura(A.DocEntry, ''FA'')), 0) Utilidad
									, F.SlpName Vendedor
							FROM ' + @CIA + '.dbo.OINV  a
								JOIN ' + @CIA + '.dbo.crd1 b on a.cardcode = b.cardcode and a.ShipToCode = b.Address AND AdresType = ''S''
								left JOIN sap.ODRF c on a.docentry = c.transid
								left JOIN sap.ECM2_CTRZ d on a.DocenTry = d.SrcObjAbs and a.ObjType = d.SrcObjType	
								left JOIN hnt.Usuarios U ON A.U_FolioHalcon = U.UserID
								JOIN ' + @CIA + '.dbo.OCRD E ON A.CardCode = E.CardCode
								LEFT JOIN ' + @CIA + '.dbo.OSLP F ON F.SlpCode = A.SlpCode
							Where a.DocenTry = @DocEntry'
							SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY =	'SELECT 
								''BorradorHNT'' TipoDocumento, 
								'''' VersionCFDI, 
								ISNULL(Nombre, '''') [Autor], 
								A.ShipToCode address,
								C.cardname,
								C.slpcode,	
								(SELECT TOP 1 x.TaxCode FROM sap.DRF1 x WHERE DocEntry = A.DocEntry) taxcode,
								--A.DocDate,
								--DATEADD(DD, ISNULL(OC.ExtraDays, 0), A.DocDate) [DocDueDate],
								
								--Estas dos lineas hacen que todos los documentos se generen con fecha de contabilicacion del dia en curso 
								--evitando asi que se generen documentos con fechas atrasadas, Solicita: Jacqueline 
								CASE WHEN A.TransId IS NULL THEN CAST(GETDATE() AS DATE) ELSE  A.[DocDate] END [DocDate],
								--CASE WHEN A.TransId IS NULL THEN DATEADD(DD, ISNULL(OC.ExtraDays, 0), CAST(GETDATE() AS DATE)) ELSE  A.[DocDueDate] END [DocDueDate],
								CASE WHEN A.TransId IS NULL 
									 THEN IIF(ISNULL(A.ExtraDays, 0) > 0, DATEADD(DD, ISNULL(A.ExtraDays, 0), CAST(GETDATE() AS DATE)), DATEADD(DD, ISNULL(OC.ExtraDays, 0), CAST(GETDATE() AS DATE))) 
									 ELSE  A.[DocDueDate] END [DocDueDate],

								A.*,
								CASE U_Canal WHEN ''1'' THEN ''Transporte'' WHEN ''2'' THEN ''Mayoreo'' WHEN ''3'' THEN ''Armadores'' END Canal, 
								ISNULL((Select TOP 1 PorcenUtilidad From dbo.fu_logistics_GetTBLUtilidadxFactura(A.DocEntry, ''DR'')), 0) Utilidad,
								F.SlpName Vendedor
							FROM sap.ODRF A
							JOIN ' + @CIA + '.dbo.CRD1 B on A.cardcode = B.cardcode and A.ShipToCode = B.Address AND AdresType = ''S''
							JOIN ' + @CIA + '.dbo.OCRD C on A.cardcode = C.cardcode 
							LEFT JOIN ' + @CIA + '.dbo.OCTG OC ON C.GroupNum = OC.GroupNum
							LEFT JOIN hnt.Usuarios U ON A.U_FolioHalcon = U.UserID
							LEFT JOIN ' + @CIA + '.dbo.OSLP F ON F.SlpCode = A.SlpCode
							WHERE
								A.DocenTry = @DocEntry 
								AND a.ObjType = 13'

							SET @PARAMETROS = '@DocEntry INT'
			END		
		END
		--Nota de credito
		IF @ObjType = 14--NOTA DE CREDITO 04-12-2017
		BEGIN
			IF @sType = 'RC'
			BEGIN
				SET @QRY =	'SELECT REPLACE(REPLACE(LEFT(CAST(U_B1SYS_SignMsg AS VARCHAR(MAX)), 6), ''|'', ''''), ''?'', '''') VersionCFDI,
					c.u_foliohalcon,a.*,b.taxcode VatGroup FROM ' + @CIA + '.dbo.ORIN  a
				JOIN ' + @CIA + '.dbo.crd1 b on a.cardcode = b.cardcode AND Adrestype = ''S''
				left JOIN ' + @CIA + '.dbo.ECM2 d on a.DocenTry = d.SrcObjAbs 	and a.ObjType = d.SrcObjType	
				left JOIN sap.ODRF c on a.docentry = c.transid
				Where a.Docnum = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY =	'SELECT '''' VersionCFDI, ISNULL(A.U_Autorizado, ''P'') DocStatus, b.taxcode VatGroup,  c.cardname,c.slpcode,a.* FROM sap.ODRF a
				JOIN ' + @CIA + '.dbo.ocrd c on a.cardcode = c.cardcode 
				JOIN ' + @CIA + '.dbo.crd1 b on B.cardcode = C.cardcode AND Adrestype = ''S''
				Where a.DocenTry = @DocEntry AND a.ObjType = 14'
				SET @PARAMETROS = '@DocEntry INT'
			END

		END
		--Entrega
		IF @ObjType = 15
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY =	'SELECT '''' TipoDocumento, '''' VersionCFDI, 
					ISNULL(Nombre, '''') [Autor], a.ShipToCode address,c.u_foliohalcon,a.*,
					(SELECT TOP 1 x.TaxCode FROM SBOCTRZ.dbo.DLN1 x WHERE DocEntry = A.DocEntry) taxcode
					, ISNULL((Select TOP 1 PorcenUtilidad From dbo.fu_logistics_GetTBLUtilidadxFactura(A.DocEntry, ''RE'')), 0) Utilidad
				FROM ' + @CIA + '.dbo.ODLN a 
				JOIN ' + @CIA + '.dbo.crd1 b on a.cardcode = b.cardcode 				
				left JOIN sap.ODRF c on a.docentry = c.transid
				left JOIN hnt.Usuarios U ON A.U_FolioHalcon =  U.UserID
				Where a.DocenTry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY =	'SELECT  ''BorradorHNT'' TipoDocumento, '''' VersionCFDI, ISNULL(Nombre, '''') [Autor], a.ShipToCode address,c.cardname,c.slpcode,
				(SELECT TOP 1 x.TaxCode FROM sap.DRF1 x WHERE DocEntry = A.DocEntry) taxcode,
				a.* 
				FROM sap.ODRF a
				JOIN ' + @CIA + '.dbo.crd1 b on a.cardcode = b.cardcode and a.ShipToCode = b.Address
				JOIN ' + @CIA + '.dbo.ocrd c on a.cardcode = c.cardcode 
				left JOIN hnt.Usuarios U ON A.U_FolioHalcon = U.UserID
				Where a.DocenTry = @DocEntry AND a.ObjType =15'
				SET @PARAMETROS = '@DocEntry INT'
			END
		END
		--Devolucion
		IF @ObjType = 16--DEVOLUCIONES(VENTAS) 04-12-2017
		BEGIN
			IF @sType = 'DV'
			BEGIN
				SET @QRY =	'SELECT c.u_foliohalcon,a.*,b.taxcode VatGroup FROM ' + @CIA + '.dbo.ORDN  a
				JOIN ' + @CIA + '.dbo.crd1 b on a.cardcode = b.cardcode AND Adrestype = ''S''
				left JOIN sap.ODRF c on a.docentry = c.transid
				Where a.Docnum = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY =	'SELECT ISNULL(A.U_Autorizado, ''P'') DocStatus, b.taxcode VatGroup,  c.cardname,c.slpcode,a.* FROM sap.ODRF a
				JOIN ' + @CIA + '.dbo.ocrd c on a.cardcode = c.cardcode 
				JOIN ' + @CIA + '.dbo.crd1 b on B.cardcode = C.cardcode AND Adrestype = ''S''
				Where a.DocenTry = @DocEntry AND a.ObjType =16'
				SET @PARAMETROS = '@DocEntry INT'
			END

		END
		--Pedido
		IF @ObjType = 17
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY =	'SELECT '''' TipoDocumento, '''' VersionCFDI, ISNULL(Nombre, '''') [Autor], a.ShipToCode address,a.*, 
					(SELECT TOP 1 x.TaxCode FROM SBOCTRZ.dbo.RDR1 x WHERE DocEntry = A.DocEntry) taxcode
					, ISNULL((Select TOP 1 PorcenUtilidad From dbo.fu_logistics_GetTBLUtilidadxFactura(A.DocEntry, ''OV'')), 0) Utilidad
					, ''''[Canal], F.SlpName Vendedor
				FROM ' + @CIA + '.dbo.ORDR a				
					left JOIN hnt.Usuarios U ON A.U_FolioHalcon = U.UserID
					LEFT JOIN SBOCTRZ.dbo.OSLP F ON F.SlpCode = A.SlpCode
				Where a.DocEntry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY =	'SELECT  ''BorradorHNT'' TipoDocumento, '''' VersionCFDI, ISNULL(Nombre, '''') [Autor], a.ShipToCode address,c.cardname,c.slpcode,
				(SELECT TOP 1 x.TaxCode FROM sap.DRF1 x WHERE DocEntry = A.DocEntry) taxcode,
				a.* 
				, ISNULL((Select TOP 1 PorcenUtilidad From dbo.fu_logistics_GetTBLUtilidadxFactura(A.DocEntry, ''DR'')), 0) Utilidad,
				CASE U_Canal WHEN ''1'' THEN ''Transporte'' WHEN ''2'' THEN ''Mayoreo'' WHEN ''3'' THEN ''Armadores'' END Canal
				, F.SlpName Vendedor
				FROM sap.ODRF a
				JOIN ' + @CIA + '.dbo.crd1 b on a.cardcode = b.cardcode and b.adrestype = ''S''
				JOIN ' + @CIA + '.dbo.ocrd c on a.cardcode = c.cardcode 
				left JOIN hnt.Usuarios U ON A.U_FolioHalcon = U.UserID
				LEFT JOIN SBOCTRZ.dbo.OSLP F ON F.SlpCode = A.SlpCode
				Where a.DocenTry = @DocEntry AND a.ObjType = 17 '
				SET @PARAMETROS = '@DocEntry INT'
			END
		END
		/*ES UNA FACTURA** PMJM*/
		IF @ObjType = 18  
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY = ' SELECT a.* FROM ' + @CIA + '.dbo.OPCH a Where a.DocEntry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY =	' SELECT a.* FROM sap.ODRF a WHERE a.DocEnTry = @DocEntry AND a.ObjType = 18 '
				SET @PARAMETROS = '@DocEntry INT'
			END
		END

		IF @ObjType = 19  
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY = ' SELECT a.* FROM ' + @CIA + '.dbo.ORPC a Where a.DocEntry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY =	' SELECT a.* FROM sap.ODRF a WHERE a.DocEnTry = @DocEntry AND a.ObjType = 19 '
				SET @PARAMETROS = '@DocEntry INT'
			END
		END
		--Entrada de mercancias
		IF @ObjType = 20--ENTRADA DE MERCANCIAS
		BEGIN
			IF @sType = 'EP'
			BEGIN
				SET @QRY =	'SELECT c.u_foliohalcon,a.*,b.taxcode VatGroup FROM ' + @CIA + '.dbo.OPDN  a
				Left JOIN ' + @CIA + '.dbo.crd1 b on a.cardcode = b.cardcode AND Adrestype = ''S''
				left JOIN sap.ODRF c on a.docentry = c.transid
				Where a.Docnum = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY =	'SELECT ISNULL(A.U_Autorizado, ''P'') DocStatus, ''''VatGroup,  c.cardname,c.slpcode,a.* FROM sap.ODRF a
				JOIN ' + @CIA + '.dbo.ocrd c on a.cardcode = c.cardcode 
				Where a.DocenTry = @DocEntry AND a.ObjType =20'
				SET @PARAMETROS = '@DocEntry INT'
			END

		END
		--PEDIDO DE PROVEEDORES
		IF @ObjType = 22
		BEGIN	
			IF @sType = ''
			BEGIN
			SET @QRY = 'Select '''' TipoDocumento, LEFT(CONVERT(VARCHAR, U_FechaVto, 120), 10) U_FechaVto, CAST(TrnspCode AS INT) TrnspCode,  *, '''' U_FPROV 
				From ['+@BDSAP+'].dbo.OPOR Where DocNum = @DocEntry AND Series = 15 '
			END
			ELSE IF @sType = 'OC'
			BEGIN
			SET @QRY = '
				Select '''' TipoDocumento, LEFT(CONVERT(VARCHAR, U_FechaVto, 120), 10) U_FechaVto, CAST(TrnspCode AS INT) TrnspCode,  *, '''' U_FPROV 
				From SBOCTRZ.dbo.OPOR Where DocNum = @DocEntry AND DocType = ''S'' '
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN

			SET @QRY ='	Select ''BorradorHNT'' TipoDocumento, 
					   CAST(A.DocNum AS INT) DocEntry, 
					   CAST(A.DocNum AS INT) DocNum,
					   B.CardName,
					   A.DocDueDate, A.* 
				From ['+@BD+'].sap.ODRF A
				LEFT JOIN ['+@BDSAP+'].DBO.OCRD B ON A.CardCode = B.CardCode
				Where A.DocNum = @DocEntry  --AND A.Series = 15
				'
			END

			SET @PARAMETROS = '@DocEntry INT'

		END	
		--PAGOS A PROVEEDORES
		IF @ObjType = 46
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY = ' SELECT a.* FROM ' + @CIA + '.dbo.OVPM a Where a.DocNum = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY =	' SELECT a.* FROM sap.OVPM a WHERE a.DocNum = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
		END
		--ENTRADAS DE MERCANCÍA DE INVENTARIOS
		IF @ObjType = 59
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY = ' SELECT a.* FROM ' + @CIA + '.dbo.OIGN a Where a.DocEntry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY =	' SELECT a.* FROM sap.ODRF a WHERE a.DocEnTry = @DocEntry AND a.ObjType = 59 '
				SET @PARAMETROS = '@DocEntry INT'
			END
		END
		--SALIDA DE MERCANCÍA DE INVENTARIOS
		IF @ObjType = 60
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY = ' SELECT a.* FROM ' + @CIA + '.dbo.OIGE a Where a.DocEntry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY =	' SELECT a.* FROM sap.ODRF a WHERE a.DocEnTry = @DocEntry AND a.ObjType = 60 '
				SET @PARAMETROS = '@DocEntry INT'
			END
		END
		--Traspaso
		IF @ObjType = 67 /*ES UN TRASPASO** PMJM*/ 
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY = ' SELECT a.* FROM ' + @CIA + '.dbo.OWTR a Where a.DocEntry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY =	' SELECT a.* FROM sap.ODRF a WHERE a.DocEnTry = @DocEntry AND a.ObjType = 67 '
				SET @PARAMETROS = '@DocEntry INT'
			END
		END
		--PRECIOS DE ENTREGA
		IF @ObjType = 69
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY = ' SELECT a.* FROM ' + @CIA + '.dbo.OIPF a Where a.DocEntry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY =	' SELECT a.* FROM sap.OIPF a WHERE a.DocEntry = @DocEntry AND A.U_EmpresaRel = ''' + @CIA + ''''
				SET @PARAMETROS = '@DocEntry INT'
			END
		END
		--REVALORIZACIÓN DE INVENTARIO
		IF @ObjType = 162
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY = ' SELECT a.* FROM ' + @CIA + '.dbo.OMRV a Where a.DocEntry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY =	' SELECT a.* FROM sap.OMRV a WHERE a.DocEntry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
		END

		EXECUTE sp_executesql @QRY, @PARAMETROS, @DocEntry
	END

	IF @TipoConsulta = 59
	BEGIN
		IF @ObjType = 13
			IF @sType = ''
			BEGIN
				SET @QRY = '
					SELECT case when a.currency = ''USD'' then a.totalfrgn else a.linetotal end linetotal,A.*, B.WhsName , B.RevenuesAc ,c.ManBtchNum,D.WhsName U_WhsName,
						CAST(0 AS DECIMAL(18, 4)) Utilidad, CAST(0 AS DECIMAL(18, 4)) PMM,
						CAST([dbo].[fu_sales_GetCostoBasePorLinea](A.DocEntry, A.LineNum) AS DECIMAL(18, 4)) CostoBase
						,ISNULL((SELECT SUM(Y.CantidadSurtida) FROM logistics.WMS_OrdenesTrabajo X JOIN logistics.WMS_OrdenesTrabajoDetail Y On Y.IdOrdenTrabajo = X.IdOrdenTrabajo WHERE X.ObjType = A.BaseType AND X.DocEntry = A.BaseEntry AND Y.LineNum = A.BaseLine AND Y.AfectaDisponible = 1), 0)[CantidadSurtida]
					FROM ' + @CIA + '.dbo.INV1 A
						LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
						LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
						LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
						LEFT JOIN ' + @CIA + '.dbo.ITM1 E ON A.ItemCode = E.ItemCode AND E.PriceList = 4
					WHERE a.DocenTry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY = '
					SELECT case when a.currency = ''USD'' then a.totalfrgn else a.linetotal end linetotal,c.itemcode ,c.itemname Dscription,A.*, B.WhsName, B.RevenuesAc ,c.ManBtchNum ,D.WhsName U_WhsName,
						ISNULL(dbo.[fu_sales_GetUtilidadDraft](A.DocEntry, A.LineNum), 0) Utilidad, ISNULL(-1*(1 - ( CASE WHEN A.Currency = ''USD'' THEN A.U_PReal * H.TC ELSE A.U_PReal END / NULLIF(E.Price, 0))), 0) PMM,
						CAST(0 AS DECIMAL(18, 4)) CostoBase, I.ItmsGrpNam
						,ISNULL((SELECT SUM(Y.CantidadSurtida) FROM logistics.WMS_OrdenesTrabajo X JOIN logistics.WMS_OrdenesTrabajoDetail Y On Y.IdOrdenTrabajo = X.IdOrdenTrabajo WHERE X.ObjType = A.BaseType AND X.DocEntry = A.BaseEntry AND Y.LineNum = A.BaseLine AND Y.AfectaDisponible = 1), 0) [CantidadSurtida]
					FROM sap.DRF1 A
						LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
						LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
						LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
						LEFT JOIN sap.ODRF F ON A.DocEntry = F.DocEntry AND A.ObjType = 13
						LEFT JOIN ' + @CIA + '.dbo.OCRD G ON F.CardCode = G.CardCode
						LEFT JOIN sales.HISTORY_TC H ON F.DocDate = H.Fecha
						LEFT JOIN ' + @CIA + '.dbo.ITM1 E ON A.ItemCode = E.ItemCode AND E.PriceList = CASE WHEN U_Canal = ''1'' THEN 3 ELSE 6 END
						LEFT JOIN ' + @CIA + '.dbo.OITB I ON C.ItmsGrpCod = I.ItmsGrpCod
					WHERE a.DocenTry = @DocEntry  AND A.ObjType = 13'
				SET @PARAMETROS = '@DocEntry INT'
			END
		IF @ObjType = 15
			IF @sType = ''
			BEGIN
				SET @QRY = '
					SELECT case when a.currency = ''USD'' then a.totalfrgn else a.linetotal end linetotal,A.*, B.WhsName , B.RevenuesAc ,c.ManBtchNum,D.WhsName U_WhsName
						,ISNULL((SELECT SUM(Y.CantidadSurtida) FROM logistics.WMS_OrdenesTrabajo X JOIN logistics.WMS_OrdenesTrabajoDetail Y On Y.IdOrdenTrabajo = X.IdOrdenTrabajo WHERE X.ObjType = A.BaseType AND X.DocEntry = A.BaseEntry AND Y.LineNum = A.BaseLine AND Y.AfectaDisponible = 1), 0)[CantidadSurtida]
					FROM ' + @CIA + '.dbo.DLN1 A
						LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
						LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
						LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
					WHERE a.DocenTry = @DocEntry  /*and a.TreeType <> ''I''*/'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY = '
					SELECT case when a.currency = ''USD'' then a.totalfrgn else a.linetotal end linetotal,c.itemcode ,a.NcmCode,c.itemname Dscription,A.*, B.WhsName, B.RevenuesAc ,c.ManBtchNum ,D.WhsName U_WhsName
						,ISNULL((SELECT SUM(Y.CantidadSurtida) FROM logistics.WMS_OrdenesTrabajo X JOIN logistics.WMS_OrdenesTrabajoDetail Y On Y.IdOrdenTrabajo = X.IdOrdenTrabajo WHERE X.ObjType = A.BaseType AND X.DocEntry = A.BaseEntry AND Y.LineNum = A.BaseLine AND Y.AfectaDisponible = 1), 0)[CantidadSurtida]
					FROM sap.DRF1 A
						LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
						LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
						LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
					WHERE a.DocenTry = @DocEntry AND A.ObjType = 15 '
				SET @PARAMETROS = '@DocEntry INT '
			END
		
		IF @ObjType = 17
			IF @sType = ''
			BEGIN
				SET @QRY = '
					SELECT case when a.currency = ''USD'' then a.totalfrgn else a.linetotal end linetotal,A.*, B.WhsName, B.RevenuesAc,c.ManBtchNum,D.WhsName U_WhsName
						, CAST(0 AS DECIMAL(18, 4)) Utilidad
						, CAST(0 AS DECIMAL(18, 4)) PMM
						, CAST(0 AS DECIMAL(18, 4)) CostoBase,  '''' ItmsGrpNam
						, ISNULL((SELECT SUM(Y.CantidadSurtida) FROM logistics.WMS_OrdenesTrabajo X JOIN logistics.WMS_OrdenesTrabajoDetail Y On Y.IdOrdenTrabajo = X.IdOrdenTrabajo WHERE X.ObjType = 17 AND X.DocEntry = A.DocenTry AND Y.LineNum = A.LineNum AND Y.AfectaDisponible = 1), 0)[CantidadSurtida]
					FROM ' + @CIA + '.dbo.RDR1 A
						LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
						LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
						LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
					WHERE a.DocenTry = @DocEntry /*and a.TreeType <> ''I''*/'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY = '
					SELECT case when a.currency = ''USD'' then a.totalfrgn else a.linetotal end linetotal,c.itemcode ,c.itemname Dscription,A.*, B.WhsName, B.RevenuesAc ,c.ManBtchNum ,D.WhsName U_WhsName
						, ISNULL(dbo.[fu_sales_GetUtilidadDraft](A.DocEntry, A.LineNum), 0) Utilidad
						, ISNULL(-1*(1 - ( CASE WHEN A.Currency = ''USD'' THEN A.U_PReal * H.TC ELSE A.U_PReal END / NULLIF(E.Price, 0))), 0) PMM
						, CAST(0 AS DECIMAL(18, 4)) CostoBase, I.ItmsGrpNam
						, CAST(0 AS DECIMAL(18, 4)) [CantidadSurtida]
					FROM sap.DRF1 A
						LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
						LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode						
						LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode						
						LEFT JOIN sap.ODRF F ON A.DocEntry = F.DocEntry AND A.ObjType = 17
						LEFT JOIN ' + @CIA + '.dbo.OCRD G ON F.CardCode = G.CardCode
						LEFT JOIN sales.HISTORY_TC H ON F.DocDate = H.Fecha
						LEFT JOIN ' + @CIA + '.dbo.ITM1 E ON A.ItemCode = E.ItemCode AND E.PriceList = CASE WHEN U_Canal = ''1'' THEN 3 ELSE 6 END
						LEFT JOIN ' + @CIA + '.dbo.OITB I ON C.ItmsGrpCod = I.ItmsGrpCod
					WHERE a.DocenTry = @DocEntry  '
				SET @PARAMETROS = '@DocEntry INT'
			END

		IF @ObjType = 46
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY = ' SELECT A.* FROM ' + @CIA + '.dbo.VPM2 A WHERE DocNum = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				if exists (SELECT * FROM SAP.OVPM WHERE DOCNUM = @DocEntry and DocType <> 'A') 
				SET @QRY = ' SELECT A.* FROM sap.VPM2 A WHERE DocNum = @DocEntry'
				ELSE 
				SET @QRY = ' SELECT A.* FROM sap.VPM4 A WHERE DocNum = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
		END
		--ENTRADAS DE MERCANCÍA DE INVENTARIOS
		IF @ObjType = 59 
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY = ' SELECT A.*, '''' WhsName, ''''[RevenuesAc], C.ManBtchNum, ''''U_WhsName FROM ' + @CIA + '.dbo.IGN1 A LEFT JOIN ' + @CIA + '.dbo.OITM C ON A.ItemCode = C.ItemCode AND C.ItemType <> ''F'' WHERE A.DocEnTry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY = ' SELECT A.*, '''' WhsName, ''''[RevenuesAc], C.ManBtchNum, ''''U_WhsName FROM sap.DRF1 A LEFT JOIN ' + @CIA + '.dbo.OITM C ON A.ItemCode = C.ItemCode AND C.ItemType <> ''F'' WHERE A.DocEnTry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
		END
		--SALIDA DE MERCANCÍA DE INVENTARIOS
		IF @ObjType = 60 
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY = ' SELECT A.*, '''' WhsName, ''''[RevenuesAc], C.ManBtchNum, ''''U_WhsName FROM ' + @CIA + '.dbo.IGE1 A LEFT JOIN ' + @CIA + '.dbo.OITM C ON A.ItemCode = C.ItemCode AND C.ItemType <> ''F'' WHERE A.DocEnTry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY = ' SELECT A.*, '''' WhsName, ''''[RevenuesAc], C.ManBtchNum, ''''U_WhsName FROM sap.DRF1 A LEFT JOIN ' + @CIA + '.dbo.OITM C ON A.ItemCode = C.ItemCode AND C.ItemType <> ''F'' WHERE A.DocEnTry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
		END

		IF @ObjType = 67 /*ES UN TRASPASO** PMJM*/ 
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY = ' SELECT A.*, '''' WhsName, ''''[RevenuesAc], C.ManBtchNum, ''''U_WhsName FROM ' + @CIA + '.dbo.WTR1 A LEFT JOIN ' + @CIA + '.dbo.OITM C ON A.ItemCode = C.ItemCode AND C.ItemType <> ''F'' WHERE A.DocEnTry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY = ' SELECT A.*, '''' WhsName, ''''[RevenuesAc], C.ManBtchNum, ''''U_WhsName FROM sap.DRF1 A LEFT JOIN ' + @CIA + '.dbo.OITM C ON A.ItemCode = C.ItemCode AND C.ItemType <> ''F'' WHERE A.DocEnTry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
		END

		IF @ObjType = 14 --Detalle de notas de  credito
		BEGIN
			IF @sType = 'RC'
			BEGIN
				SET @QRY = '
					SELECT  A.*, B.WhsName , B.RevenuesAc ,c.ManBtchNum,D.WhsName U_WhsName
					FROM ' + @CIA + '.dbo.RIN1 A
						LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
						LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
						LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
					WHERE a.DocenTry = @DocEntry and a.TreeType <> ''I'''
				SET @PARAMETROS = '@DocEntry INT'
			END
			IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY = '
					SELECT c.itemcode ,c.itemname Dscription,A.*, B.WhsName, B.RevenuesAc ,c.ManBtchNum ,D.WhsName U_WhsName
					FROM sap.DRF1 A
						LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
						LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
						LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
					WHERE a.DocenTry = @DocEntry  '
				SET @PARAMETROS = '@DocEntry INT'
			END
		END

		IF @ObjType = 16 --Detalle devoluciones
		BEGIN
			IF @sType = 'DV'
			BEGIN
				SET @QRY = '
					SELECT  A.*, B.WhsName , B.RevenuesAc ,c.ManBtchNum,D.WhsName U_WhsName
					FROM ' + @CIA + '.dbo.RDN1 A
						LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
						LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
						LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
					WHERE a.DocenTry = @DocEntry and a.TreeType <> ''I'''
				SET @PARAMETROS = '@DocEntry INT'
			END
			IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY = '
					SELECT c.itemcode ,c.itemname Dscription,A.*, B.WhsName, B.RevenuesAc ,c.ManBtchNum ,D.WhsName U_WhsName
					FROM sap.DRF1 A
						LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
						LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
						LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
					WHERE a.DocenTry = @DocEntry  '
				SET @PARAMETROS = '@DocEntry INT'
			END
		END

		IF @ObjType = 20 --Detalle de Entradas de mercancia
		BEGIN
			IF @sType = 'EP'
			BEGIN
				SET @QRY = '
					SELECT CASE WHEN a.currency = ''USD'' THEN a.totalfrgn ELSE a.linetotal END LineTotal, A.*, B.WhsName , B.RevenuesAc ,c.ManBtchNum,D.WhsName U_WhsName
					FROM ' + @CIA + '.dbo.PDN1 A
						LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
						LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
						LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
					WHERE a.DocenTry = @DocEntry and a.TreeType <> ''I'''
				SET @PARAMETROS = '@DocEntry INT'
			END
			IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY = '
					SELECT c.itemcode ,c.itemname Dscription,A.*, B.WhsName, B.RevenuesAc ,c.ManBtchNum ,D.WhsName U_WhsName
					FROM sap.DRF1 A
						LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
						LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
						LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
					WHERE a.DocenTry = @DocEntry  '
				SET @PARAMETROS = '@DocEntry INT'
			END
		END

		IF @ObjType = 22
		BEGIN
			IF @sType = ''
			BEGIN	

			SET @QRY = '
				Select  ISNULL(CAST(A.U_StockAlmacen AS DECIMAL(18,4)), 0.0)U_stockAlmacen,A.VisOrder LineNum, ISNULL(C.BWeight1, 0) BWeight1, *, B.WhsName, ISNULL((C.BVolume/1000000)*35.3147, 0) BVolume,
					D.Clasificacion ABC, 
					ISNULL(CAST(A.U_StockAlmacen AS DECIMAL(18,4)), 0) U_StockAlmacen,
					CAST(0 AS DECIMAL(18,4)) VI,  
					/*ISNULL(CAST(D.Ideal AS DECIMAL(18,4)), 0)*/ 0 Ideal,  
					ISNULL(CAST(D.OnHand AS DECIMAL(18,4)), 0) OnHand,
					CAST(0 AS DECIMAL(18,4)) QtyOriginal,
					/*ISNULL(CAST((SELECT CAST(SUM(ISNULL(MTH12, 0) + ISNULL(MTH11, 0) + ISNULL(MTH10, 0)) / 3  AS DECIMAL)
						FROM purchase.HISTORY_VENTAS x WHERE x.ItemCode = A.ItemCode) / 30 * F.U_VLGX_HP AS DECIMAL), 0)*/0 VecesIdeal					
				From  ['+@BDSAP+'].dbo.POR1 A
					INNER JOIN  ['+@BDSAP+'].dbo.OWHS B on A.WhsCode = B.WhsCode 
					INNER JOIN  ['+@BDSAP+'].dbo.OITM C on C.ItemCode = A.ItemCode
					LEFT JOIN purchase.VW_VIGeneral D ON A.ItemCode = D.ItemCode
					INNER JOIN  ['+@BDSAP+'].dbo.OPOR P ON P.DocEntry = A.DocEntry
					INNER JOIN  ['+@BDSAP+'].dbo.OCRD F on F.CardCode = P.CardCode
				Where A.DocEntry = @DocEntry
				'

				SET @PARAMETROS = '@DocEntry INT'

			END
			ELSE IF @sType = 'OC'
			BEGIN	
				SET @QRY = '
				SELECT 
					ISNULL(CAST(A.U_StockAlmacen AS DECIMAL(18,4)), 0.0)U_stockAlmacen,
					A.*, 
					NULL[WhsName],
					ISNULL(CAST((SELECT CAST(SUM(ISNULL(MTH12, 0) + ISNULL(MTH11, 0) + ISNULL(MTH10, 0)) / 3  AS DECIMAL)
					FROM purchase.HISTORY_VENTAS x WHERE x.ItemCode = A.ItemCode) / 30 * F.U_VLGX_HP AS DECIMAL), 0) VecesIdeal
				FROM ['+@BDSAP+'].dbo.POR1 A
				JOIN ['+@BDSAP+'].dbo.OPOR B ON A.DocEntry = B.DocEntry
			    JOIN ['+@BDSAP+'].dbo.OCRD F on F.CardCode = B.CardCode
				WHERE A.DocEntry = @DocEntry AND B.DocType = ''S''
				'
					SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
			--	SELECT @DocType = DocType FROM sap.ODRF where DocEntry = @DocEntry
			IF  @EmpresaSAP = 'HNT' BEGIN  SELECT @DocType = DocType FROM sap.ODRF where DocEntry = @DocEntry END
			IF  @EmpresaSAP = 'HNT_DPJ' BEGIN  SELECT @DocType = DocType FROM HALCONET.sap.ODRF where DocEntry = @DocEntry END
			IF  @EmpresaSAP = 'SERVIMPO' BEGIN  SELECT @DocType = DocType FROM   HNT_SERVIMPO.sap.ODRF where DocEntry = @DocEntry END

				IF @DocType = 'S'
				BEGIN					
					SET @QRY = '
						
						Select 				
							CAST(A.LineNum AS INT) LineNum,
							ISNULL(C.ItemName, Dscription) Dscription,
							A.Quantity OpenQty,
							''O'' LineStatus,
							ISNULL(C.BWeight1, 0) BWeight1

							, 0.0 Ideal  
							, 0.0 OnHand
							, *
							, B.WhsName, ISNULL((C.BVolume/1000000)*35.3147, 0) BVolume

							, 0.0 VecesIdeal
						From ['+@BD+'].sap.DRF1 A
							LEFT JOIN ['+@BDSAP+'].dbo.OWHS B on A.WhsCode = B.WhsCode 
							LEFT JOIN ['+@BDSAP+'].dbo.OITM C on C.ItemCode = A.ItemCode	
							LEFT JOIN ['+@BD+'].SAP.ODRF O ON O.DocEntry = A.DocEntry
							LEFT JOIN ['+@BDSAP+'].dbo.OCRD F on F.CardCode = O.CardCode
						Where A.DocEntry = @DocEntry 
						'
				END
				ELSE
				BEGIN					
					SET @QRY = '
						SELECT
							T0.DocEntry
							, T0.ItemCode
							, SUM(B.Stock + B.Solicitado + B.Transito) OnHand
							, IdealMensual Ideal
							--, CASE WHEN ISNULL(T0.IdealMensual, 0) = 0 THEN SUM(B.Stock + B.Solicitado + B.Transito) ELSE SUM(B.Stock + B.Solicitado + B.Transito) / T0.IdealMensual END MesesIdeal
						into #temp
						FROM(
							SELECT 
								A.ItemCode
								, A.DocEntry
								, SUM(A.Quantity) Quantity
								, ROUND(StockingQty_O, 0) IdealMensual
							FROM
								['+@BD+'].sap.DRF1 A
								LEFT JOIN purchase.IDL_IDEAL_GENERAL B ON A.ItemCode = B.ItemCode
							WHERE
								A.ObjType = 22
								AND DocEntry = @DocEntry
							GROUP BY A.ItemCode, StockingQty_O, A.DocEntry
						)T0
							JOIN ['+@BDSAP+'].dbo.OITM A ON T0.ItemCode = A.ItemCode
							JOIN ['+@BDSAP+'].dbo.OCRD C ON A.CardCode = C.CardCode
							/*LEFT*/ JOIN purchase.VW_Solicitados_Transitos B ON T0.ItemCode = B.ItemCode 
								AND B.WhsCode IN (Select x.WhsCode From purchase.ZonaProveedor x Where x.CardCode = A.CardCode)
						GROUP BY T0.ItemCode, T0.DocEntry, T0.IdealMensual

						Select 
							CAST(A.LineNum AS INT) LineNum,
							ISNULL(C.ItemName, Dscription) Dscription,
							A.Quantity OpenQty,
							''O'' LineStatus,
							ISNULL(C.BWeight1, 0) BWeight1

							, ISNULL(CAST(G.Ideal AS DECIMAL(18,4)), 0) Ideal  
							, ISNULL(CAST(G.OnHand AS DECIMAL(18,4)), 0) OnHand
							, *
							, B.WhsName, ISNULL((C.BVolume/1000000)*35.3147, 0) BVolume
							--ISNULL(CAST(D.Ideal AS DECIMAL(18,4)), 0) Ideal,  
							--ISNULL(CAST(D.OnHand AS DECIMAL(18,4)), 0) OnHand

							, ISNULL(ISNULL(CAST(G.OnHand AS DECIMAL(18,4)), 0) / NULLIF(ISNULL(CAST((SELECT CAST(SUM(ISNULL(MTH12, 0) + ISNULL(MTH11, 0) + ISNULL(MTH10, 0)) / 3  AS DECIMAL)
								FROM purchase.HISTORY_VENTAS x WHERE x.ItemCode = A.ItemCode) AS DECIMAL), 0), 0), 0) VecesIdeal
						From ['+@BD+'].sap.DRF1 A
							LEFT JOIN ['+@BDSAP+'].dbo.OWHS B on A.WhsCode = B.WhsCode 
							LEFT JOIN ['+@BDSAP+'].dbo.OITM C on C.ItemCode = A.ItemCode	
							LEFT JOIN purchase.VW_VIGeneral D ON A.ItemCode = D.ItemCode
							LEFT JOIN ['+@BD+'].SAP.ODRF O ON O.DocEntry = A.DocEntry
							LEFT JOIN ['+@BDSAP+'].dbo.OCRD F on F.CardCode = O.CardCode
							LEFT JOIN #temp G ON A.ItemCode = G.ItemCode
						Where A.DocEntry = @DocEntry 
					
						DROP TABLE #temp
						'
				END

				SET @PARAMETROS = '@DocEntry INT'
			END
		END

		IF @ObjType = 18 /*ES UNA FACTURA** PMJM*/ 
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY = ' SELECT A.*, '''' WhsName, ''''[RevenuesAc], C.ManBtchNum, ''''U_WhsName FROM ' + @CIA + '.dbo.PCH1 A LEFT JOIN ' + @CIA + '.dbo.OITM C ON A.ItemCode = C.ItemCode AND C.ItemType <> ''F'' WHERE A.DocEnTry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY = ' SELECT A.*, '''' WhsName, ''''[RevenuesAc], C.ManBtchNum, ''''U_WhsName FROM sap.DRF1 A LEFT JOIN ' + @CIA + '.dbo.OITM C ON A.ItemCode = C.ItemCode AND C.ItemType <> ''F'' WHERE A.DocEnTry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
		END

		IF @ObjType = 19
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY = ' SELECT A.*, '''' WhsName, ''''[RevenuesAc], C.ManBtchNum, ''''U_WhsName FROM ' + @CIA + '.dbo.RPC1 A LEFT JOIN ' + @CIA + '.dbo.OITM C ON A.ItemCode = C.ItemCode AND C.ItemType <> ''F'' WHERE A.DocEnTry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY = ' SELECT A.*, '''' WhsName, ''''[RevenuesAc], C.ManBtchNum, ''''U_WhsName FROM sap.DRF1 A LEFT JOIN ' + @CIA + '.dbo.OITM C ON A.ItemCode = C.ItemCode AND C.ItemType <> ''F'' WHERE A.DocEnTry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
		END
		--PRECIOS DE ENTREGA
		IF @ObjType = 69
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY = ' SELECT A.* FROM ' + @CIA + '.dbo.IPF1 A WHERE DocEntry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY = ' SELECT A.* FROM sap.IPF1 A WHERE DocEntry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
		END
		--REVALORIZACIÓN DE INVENTARIO
		IF @ObjType = 162
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY = ' SELECT A.* FROM ' + @CIA + '.dbo.MRV1 A WHERE DocEntry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY = ' SELECT A.* FROM sap.MRV1 A WHERE DocEntry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
		END

		EXECUTE sp_executesql @QRY, @PARAMETROS, @DocEntry
	END

	/*PCC*/
	--IF @TipoConsulta = 58 --encabezado del borrador
	--BEGIN
	--	--Factura
	--	IF @ObjType = 13
	--	BEGIN
	--		IF @sType = ''
	--		BEGIN
	--			SET @QRY =	'SELECT '''' TipoDocumento, REPLACE(REPLACE(LEFT(CAST(U_B1SYS_SignMsg AS VARCHAR(MAX)), 6), ''|'', ''''), ''?'', '''') VersionCFDI, 
	--								ISNULL(Nombre, '''') [Autor], isnull(d.ReportID,'''') Edocnum, 
	--								a.ShipToCode address, c.u_foliohalcon,a.*,
	--								(SELECT TOP 1 x.TaxCode FROM SBOCTRZ.dbo.INV1 x WHERE DocEntry = A.DocEntry) taxcode, 
	--								CASE U_Canal WHEN ''1'' THEN ''Transporte'' WHEN ''2'' THEN ''Mayoreo'' WHEN ''3'' THEN ''Armadores'' END Canal
	--								, ISNULL((Select TOP 1 PorcenUtilidad From dbo.fu_logistics_GetTBLUtilidadxFactura(A.DocEntry, ''FA'')), 0) Utilidad
	--								, F.SlpName Vendedor
	--						FROM ' + @CIA + '.dbo.OINV  a
	--							JOIN ' + @CIA + '.dbo.crd1 b on a.cardcode = b.cardcode and a.ShipToCode = b.Address AND AdresType = ''S''
	--							left JOIN sap.ODRF c on a.docentry = c.transid
	--							left JOIN sap.ECM2_CTRZ d on a.DocenTry = d.SrcObjAbs and a.ObjType = d.SrcObjType	
	--							left JOIN hnt.Usuarios U ON A.U_FolioHalcon = U.UserID
	--							JOIN ' + @CIA + '.dbo.OCRD E ON A.CardCode = E.CardCode
	--							LEFT JOIN ' + @CIA + '.dbo.OSLP F ON F.SlpCode = A.SlpCode
	--						Where a.DocenTry = @DocEntry'
	--						SET @PARAMETROS = '@DocEntry INT'
	--		END
	--		ELSE IF @sType = 'BorradorHNT'
	--		BEGIN
	--			SET @QRY =	'SELECT ''BorradorHNT'' TipoDocumento, '''' VersionCFDI, ISNULL(Nombre, '''') [Autor], a.ShipToCode address,c.cardname,c.slpcode,	
	--							(SELECT TOP 1 x.TaxCode FROM sap.DRF1 x WHERE DocEntry = A.DocEntry) taxcode,
	--							a.*,
	--							CASE U_Canal WHEN ''1'' THEN ''Transporte'' WHEN ''2'' THEN ''Mayoreo'' WHEN ''3'' THEN ''Armadores'' END Canal
	--							, ISNULL((Select TOP 1 PorcenUtilidad From dbo.fu_logistics_GetTBLUtilidadxFactura(A.DocEntry, ''DR'')), 0) Utilidad
	--							, F.SlpName Vendedor
	--						FROM sap.ODRF a
	--							JOIN ' + @CIA + '.dbo.crd1 b on a.cardcode = b.cardcode and a.ShipToCode = b.Address AND AdresType = ''S''
	--							JOIN ' + @CIA + '.dbo.ocrd c on a.cardcode = c.cardcode 
	--							left JOIN hnt.Usuarios U ON A.U_FolioHalcon = U.UserID
	--							LEFT JOIN ' + @CIA + '.dbo.OSLP F ON F.SlpCode = A.SlpCode
	--						Where a.DocenTry = @DocEntry AND a.ObjType = 13'
	--						SET @PARAMETROS = '@DocEntry INT'
	--		END		
	--	END
	--	--Nota de credito
	--	IF @ObjType = 14--NOTA DE CREDITO 04-12-2017
	--	BEGIN
	--		IF @sType = 'RC'
	--		BEGIN
	--			SET @QRY =	'SELECT REPLACE(REPLACE(LEFT(CAST(U_B1SYS_SignMsg AS VARCHAR(MAX)), 6), ''|'', ''''), ''?'', '''') VersionCFDI,
	--				c.u_foliohalcon,a.*,b.taxcode VatGroup FROM ' + @CIA + '.dbo.ORIN  a
	--			JOIN ' + @CIA + '.dbo.crd1 b on a.cardcode = b.cardcode AND Adrestype = ''S''
	--			left JOIN ' + @CIA + '.dbo.ECM2 d on a.DocenTry = d.SrcObjAbs 	and a.ObjType = d.SrcObjType	
	--			left JOIN sap.ODRF c on a.docentry = c.transid
	--			Where a.Docnum = @DocEntry'
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--		ELSE IF @sType = 'BorradorHNT'
	--		BEGIN
	--			SET @QRY =	'SELECT '''' VersionCFDI, ISNULL(A.U_Autorizado, ''P'') DocStatus, b.taxcode VatGroup,  c.cardname,c.slpcode,a.* FROM sap.ODRF a
	--			JOIN ' + @CIA + '.dbo.ocrd c on a.cardcode = c.cardcode 
	--			JOIN ' + @CIA + '.dbo.crd1 b on B.cardcode = C.cardcode AND Adrestype = ''S''
	--			Where a.DocenTry = @DocEntry AND a.ObjType = 14'
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END

	--	END
	--	--Entrega
	--	IF @ObjType = 15
	--	BEGIN
	--		IF @sType = ''
	--		BEGIN
	--			SET @QRY =	'SELECT '''' TipoDocumento, '''' VersionCFDI, 
	--				ISNULL(Nombre, '''') [Autor], a.ShipToCode address,c.u_foliohalcon,a.*,
	--				(SELECT TOP 1 x.TaxCode FROM SBOCTRZ.dbo.DLN1 x WHERE DocEntry = A.DocEntry) taxcode
	--				, ISNULL((Select TOP 1 PorcenUtilidad From dbo.fu_logistics_GetTBLUtilidadxFactura(A.DocEntry, ''RE'')), 0) Utilidad
	--			FROM ' + @CIA + '.dbo.ODLN a 
	--			JOIN ' + @CIA + '.dbo.crd1 b on a.cardcode = b.cardcode 				
	--			left JOIN sap.ODRF c on a.docentry = c.transid
	--			left JOIN hnt.Usuarios U ON A.U_FolioHalcon =  U.UserID
	--			Where a.DocenTry = @DocEntry'
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--		ELSE IF @sType = 'BorradorHNT'
	--		BEGIN
	--			SET @QRY =	'SELECT  ''BorradorHNT'' TipoDocumento, '''' VersionCFDI, ISNULL(Nombre, '''') [Autor], a.ShipToCode address,c.cardname,c.slpcode,
	--			(SELECT TOP 1 x.TaxCode FROM sap.DRF1 x WHERE DocEntry = A.DocEntry) taxcode,
	--			a.* 
	--			FROM sap.ODRF a
	--			JOIN ' + @CIA + '.dbo.crd1 b on a.cardcode = b.cardcode and a.ShipToCode = b.Address
	--			JOIN ' + @CIA + '.dbo.ocrd c on a.cardcode = c.cardcode 
	--			left JOIN hnt.Usuarios U ON A.U_FolioHalcon = U.UserID
	--			Where a.DocenTry = @DocEntry AND a.ObjType =15'
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--	END
	--	--Decolucion
	--	IF @ObjType = 16--DEVOLUCIONES(VENTAS) 04-12-2017
	--	BEGIN
	--		IF @sType = 'DV'
	--		BEGIN
	--			SET @QRY =	'SELECT c.u_foliohalcon,a.*,b.taxcode VatGroup FROM ' + @CIA + '.dbo.ORDN  a
	--			JOIN ' + @CIA + '.dbo.crd1 b on a.cardcode = b.cardcode AND Adrestype = ''S''
	--			left JOIN sap.ODRF c on a.docentry = c.transid
	--			Where a.Docnum = @DocEntry'
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--		ELSE IF @sType = 'BorradorHNT'
	--		BEGIN
	--			SET @QRY =	'SELECT ISNULL(A.U_Autorizado, ''P'') DocStatus, b.taxcode VatGroup,  c.cardname,c.slpcode,a.* FROM sap.ODRF a
	--			JOIN ' + @CIA + '.dbo.ocrd c on a.cardcode = c.cardcode 
	--			JOIN ' + @CIA + '.dbo.crd1 b on B.cardcode = C.cardcode AND Adrestype = ''S''
	--			Where a.DocenTry = @DocEntry AND a.ObjType =16'
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END

	--	END
	--	--Pedido
	--	IF @ObjType = 17
	--	BEGIN
	--		IF @sType = ''
	--		BEGIN
	--			SET @QRY =	'SELECT '''' TipoDocumento, '''' VersionCFDI, ISNULL(Nombre, '''') [Autor], a.ShipToCode address,a.*, 
	--				(SELECT TOP 1 x.TaxCode FROM SBOCTRZ.dbo.RDR1 x WHERE DocEntry = A.DocEntry) taxcode
	--				, ISNULL((Select TOP 1 PorcenUtilidad From dbo.fu_logistics_GetTBLUtilidadxFactura(A.DocEntry, ''OV'')), 0) Utilidad
	--			FROM ' + @CIA + '.dbo.ORDR a 
	--				left JOIN hnt.Usuarios U ON A.U_FolioHalcon = U.UserID
	--			Where a.DocEntry = @DocEntry'
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--		ELSE IF @sType = 'BorradorHNT'
	--		BEGIN
	--			SET @QRY =	'SELECT  ''BorradorHNT'' TipoDocumento, '''' VersionCFDI, ISNULL(Nombre, '''') [Autor], a.ShipToCode address,c.cardname,c.slpcode,
	--			(SELECT TOP 1 x.TaxCode FROM sap.DRF1 x WHERE DocEntry = A.DocEntry) taxcode,
	--			a.* 
	--			FROM sap.ODRF a
	--			JOIN ' + @CIA + '.dbo.crd1 b on a.cardcode = b.cardcode and b.adrestype = ''S''
	--			JOIN ' + @CIA + '.dbo.ocrd c on a.cardcode = c.cardcode 
	--			left JOIN hnt.Usuarios U ON A.U_FolioHalcon = U.UserID
	--			Where a.DocenTry = @DocEntry AND a.ObjType = 17 '
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--	END
	--	/*ES UNA FACTURA** PMJM*/
	--	IF @ObjType = 18  
	--	BEGIN
	--		IF @sType = ''
	--		BEGIN
	--			SET @QRY = ' SELECT a.* FROM ' + @CIA + '.dbo.OPCH a Where a.DocEntry = @DocEntry'
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--		ELSE IF @sType = 'BorradorHNT'
	--		BEGIN
	--			SET @QRY =	' SELECT a.* FROM sap.ODRF a WHERE a.DocEnTry = @DocEntry AND a.ObjType = 18 '
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--	END

	--	IF @ObjType = 19  
	--	BEGIN
	--		IF @sType = ''
	--		BEGIN
	--			SET @QRY = ' SELECT a.* FROM ' + @CIA + '.dbo.ORPC a Where a.DocEntry = @DocEntry'
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--		ELSE IF @sType = 'BorradorHNT'
	--		BEGIN
	--			SET @QRY =	' SELECT a.* FROM sap.ODRF a WHERE a.DocEnTry = @DocEntry AND a.ObjType = 19 '
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--	END
	--	--Entrada de mercancias
	--	IF @ObjType = 20--ENTRADA DE MERCANCIAS
	--	BEGIN
	--		IF @sType = 'EP'
	--		BEGIN
	--			SET @QRY =	'SELECT c.u_foliohalcon,a.*,b.taxcode VatGroup FROM ' + @CIA + '.dbo.OPDN  a
	--			Left JOIN ' + @CIA + '.dbo.crd1 b on a.cardcode = b.cardcode AND Adrestype = ''S''
	--			left JOIN sap.ODRF c on a.docentry = c.transid
	--			Where a.Docnum = @DocEntry'
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--		ELSE IF @sType = 'BorradorHNT'
	--		BEGIN
	--			SET @QRY =	'SELECT ISNULL(A.U_Autorizado, ''P'') DocStatus, ''''VatGroup,  c.cardname,c.slpcode,a.* FROM sap.ODRF a
	--			JOIN ' + @CIA + '.dbo.ocrd c on a.cardcode = c.cardcode 
	--			Where a.DocenTry = @DocEntry AND a.ObjType =20'
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END

	--	END
	--	--PEDIDO DE PROVEEDORES
	--	IF @ObjType = 22
	--	BEGIN	
	--		IF @sType = ''
	--		BEGIN
	--			Select '' TipoDocumento, LEFT(CONVERT(VARCHAR, U_FechaVto, 120), 10) U_FechaVto, CAST(TrnspCode AS INT) TrnspCode,  *, '' U_FPROV 
	--			From SBOCTRZ.dbo.OPOR Where DocNum = @DocEntry AND Series = 15
	--		END
	--		ELSE IF @sType = 'OC'
	--		BEGIN
	--			Select '' TipoDocumento, LEFT(CONVERT(VARCHAR, U_FechaVto, 120), 10) U_FechaVto, CAST(TrnspCode AS INT) TrnspCode,  *, '' U_FPROV 
	--			From SBOCTRZ.dbo.OPOR Where DocNum = @DocEntry AND DocType = 'S'
	--		END
	--		ELSE IF @sType = 'BorradorHNT'
	--		BEGIN
	--			Select 'BorradorHNT' TipoDocumento, 
	--				   CAST(A.DocNum AS INT) DocEntry, 
	--				   CAST(A.DocNum AS INT) DocNum,
	--				   B.CardName,
	--				   A.DocDueDate, A.* 
	--			From sap.ODRF A
	--				JOIN SBOCTRZ.DBO.OCRD B ON A.CardCode = B.CardCode
	--			Where A.DocNum = @DocEntry --AND A.Series = 15
	--		END
	--	END	
	--	--Traspaso
	--	IF @ObjType = 67 /*ES UN TRASPASO** PMJM*/ 
	--	BEGIN
	--		IF @sType = ''
	--		BEGIN
	--			SET @QRY = ' SELECT a.* FROM ' + @CIA + '.dbo.OWTR a Where a.DocEntry = @DocEntry'
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--		ELSE IF @sType = 'BorradorHNT'
	--		BEGIN
	--			SET @QRY =	' SELECT a.* FROM sap.ODRF a WHERE a.DocEnTry = @DocEntry AND a.ObjType = 67 '
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--	END

	--	EXECUTE sp_executesql @QRY, @PARAMETROS, @DocEntry
	--END

	--IF @TipoConsulta = 59
	--BEGIN
	--	IF @ObjType = 13
	--		IF @sType = ''
	--		BEGIN
	--			SET @QRY = '
	--				SELECT case when a.currency = ''USD'' then a.totalfrgn else a.linetotal end linetotal,A.*, B.WhsName , B.RevenuesAc ,c.ManBtchNum,D.WhsName U_WhsName,
	--					CAST(0 AS DECIMAL(18, 4)) Utilidad, CAST(0 AS DECIMAL(18, 4)) PMM,
	--					CAST([dbo].[fu_sales_GetCostoBasePorLinea](A.DocEntry, A.LineNum) AS DECIMAL(18, 4)) CostoBase
	--				FROM ' + @CIA + '.dbo.INV1 A
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
	--					LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
	--					LEFT JOIN ' + @CIA + '.dbo.ITM1 E ON A.ItemCode = E.ItemCode AND E.PriceList = 4
	--				WHERE a.DocenTry = @DocEntry'
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--		ELSE IF @sType = 'BorradorHNT'
	--		BEGIN
	--			SET @QRY = '
	--				SELECT case when a.currency = ''USD'' then a.totalfrgn else a.linetotal end linetotal,c.itemcode ,c.itemname Dscription,A.*, B.WhsName, B.RevenuesAc ,c.ManBtchNum ,D.WhsName U_WhsName,
	--					ISNULL(dbo.[fu_sales_GetUtilidadDraft](A.DocEntry, A.LineNum), 0) Utilidad, ISNULL(-1*(1 - ( CASE WHEN A.Currency = ''USD'' THEN A.U_PReal * H.TC ELSE A.U_PReal END / NULLIF(E.Price, 0))), 0) PMM,
	--					CAST(0 AS DECIMAL(18, 4)) CostoBase, I.ItmsGrpNam
	--				FROM sap.DRF1 A
	--					LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
	--					LEFT JOIN sap.ODRF F ON A.DocEntry = F.DocEntry AND A.ObjType = 13
	--					LEFT JOIN ' + @CIA + '.dbo.OCRD G ON F.CardCode = G.CardCode
	--					LEFT JOIN sales.HISTORY_TC H ON F.DocDate = H.Fecha
	--					LEFT JOIN ' + @CIA + '.dbo.ITM1 E ON A.ItemCode = E.ItemCode AND E.PriceList = CASE WHEN U_Canal = ''1'' THEN 3 ELSE 6 END
	--					LEFT JOIN ' + @CIA + '.dbo.OITB I ON C.ItmsGrpCod = I.ItmsGrpCod
	--				WHERE a.DocenTry = @DocEntry  AND A.ObjType = 13'
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--	IF @ObjType = 15
	--		IF @sType = ''
	--		BEGIN
	--			SET @QRY = '
	--				SELECT case when a.currency = ''USD'' then a.totalfrgn else a.linetotal end linetotal,A.*, B.WhsName , B.RevenuesAc ,c.ManBtchNum,D.WhsName U_WhsName
	--				FROM ' + @CIA + '.dbo.DLN1 A
	--					LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
	--				WHERE a.DocenTry = @DocEntry  /*and a.TreeType <> ''I''*/'
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--		ELSE IF @sType = 'BorradorHNT'
	--		BEGIN
	--			SET @QRY = '
	--				SELECT case when a.currency = ''USD'' then a.totalfrgn else a.linetotal end linetotal,c.itemcode ,a.NcmCode,c.itemname Dscription,A.*, B.WhsName, B.RevenuesAc ,c.ManBtchNum ,D.WhsName U_WhsName
	--				FROM sap.DRF1 A
	--					LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
	--				WHERE a.DocenTry = @DocEntry AND A.ObjType = 15 '
	--			SET @PARAMETROS = '@DocEntry INT '
	--		END
		
	--	IF @ObjType = 17
	--		IF @sType = ''
	--		BEGIN
	--			SET @QRY = '
	--				SELECT case when a.currency = ''USD'' then a.totalfrgn else a.linetotal end linetotal,A.*, B.WhsName, B.RevenuesAc,c.ManBtchNum,D.WhsName U_WhsName
	--				FROM ' + @CIA + '.dbo.RDR1 A
	--					LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
	--				WHERE a.DocenTry = @DocEntry /*and a.TreeType <> ''I''*/'
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--		ELSE IF @sType = 'BorradorHNT'
	--		BEGIN
	--			SET @QRY = '
	--				SELECT case when a.currency = ''USD'' then a.totalfrgn else a.linetotal end linetotal,c.itemcode ,c.itemname Dscription,A.*, B.WhsName, B.RevenuesAc ,c.ManBtchNum ,D.WhsName U_WhsName
	--				FROM sap.DRF1 A
	--					LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
	--				WHERE a.DocenTry = @DocEntry  '
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END

	--	IF @ObjType = 67 /*ES UN TRASPASO** PMJM*/ 
	--	BEGIN
	--		IF @sType = ''
	--		BEGIN
	--			SET @QRY = ' SELECT A.*, '''' WhsName, ''''[RevenuesAc], C.ManBtchNum, ''''U_WhsName FROM ' + @CIA + '.dbo.WTR1 A LEFT JOIN ' + @CIA + '.dbo.OITM C ON A.ItemCode = C.ItemCode AND C.ItemType <> ''F'' WHERE A.DocEnTry = @DocEntry'
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--		ELSE IF @sType = 'BorradorHNT'
	--		BEGIN
	--			SET @QRY = ' SELECT A.*, '''' WhsName, ''''[RevenuesAc], C.ManBtchNum, ''''U_WhsName FROM sap.DRF1 A LEFT JOIN ' + @CIA + '.dbo.OITM C ON A.ItemCode = C.ItemCode AND C.ItemType <> ''F'' WHERE A.DocEnTry = @DocEntry'
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--	END

	--	IF @ObjType = 14 --Detalle de notas de  credito
	--	BEGIN
	--		IF @sType = 'RC'
	--		BEGIN
	--			SET @QRY = '
	--				SELECT  A.*, B.WhsName , B.RevenuesAc ,c.ManBtchNum,D.WhsName U_WhsName
	--				FROM ' + @CIA + '.dbo.RIN1 A
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
	--					LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
	--				WHERE a.DocenTry = @DocEntry and a.TreeType <> ''I'''
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--		IF @sType = 'BorradorHNT'
	--		BEGIN
	--			SET @QRY = '
	--				SELECT c.itemcode ,c.itemname Dscription,A.*, B.WhsName, B.RevenuesAc ,c.ManBtchNum ,D.WhsName U_WhsName
	--				FROM sap.DRF1 A
	--					LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
	--				WHERE a.DocenTry = @DocEntry  '
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--	END

	--	IF @ObjType = 16 --Detalle devoluciones
	--	BEGIN
	--		IF @sType = 'DV'
	--		BEGIN
	--			SET @QRY = '
	--				SELECT  A.*, B.WhsName , B.RevenuesAc ,c.ManBtchNum,D.WhsName U_WhsName
	--				FROM ' + @CIA + '.dbo.RDN1 A
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
	--					LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
	--				WHERE a.DocenTry = @DocEntry and a.TreeType <> ''I'''
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--		IF @sType = 'BorradorHNT'
	--		BEGIN
	--			SET @QRY = '
	--				SELECT c.itemcode ,c.itemname Dscription,A.*, B.WhsName, B.RevenuesAc ,c.ManBtchNum ,D.WhsName U_WhsName
	--				FROM sap.DRF1 A
	--					LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
	--				WHERE a.DocenTry = @DocEntry  '
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--	END

	--	IF @ObjType = 20 --Detalle de Entradas de mercancia
	--	BEGIN
	--		IF @sType = 'EP'
	--		BEGIN
	--			SET @QRY = '
	--				SELECT CASE WHEN a.currency = ''USD'' THEN a.totalfrgn ELSE a.linetotal END LineTotal, A.*, B.WhsName , B.RevenuesAc ,c.ManBtchNum,D.WhsName U_WhsName
	--				FROM ' + @CIA + '.dbo.PDN1 A
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
	--					LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
	--				WHERE a.DocenTry = @DocEntry and a.TreeType <> ''I'''
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--		IF @sType = 'BorradorHNT'
	--		BEGIN
	--			SET @QRY = '
	--				SELECT c.itemcode ,c.itemname Dscription,A.*, B.WhsName, B.RevenuesAc ,c.ManBtchNum ,D.WhsName U_WhsName
	--				FROM sap.DRF1 A
	--					LEFT JOIN ' + @CIA + '.dbo.OITM c ON A.itemcode = c.itemcode
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS B ON A.WhsCode = B.WhsCode
	--					LEFT JOIN ' + @CIA + '.dbo.OWHS D ON A.U_Warehouse = D.WhsCode
	--				WHERE a.DocenTry = @DocEntry  '
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--	END

	--	IF @ObjType = 22
	--	BEGIN
	--		IF @sType = ''
	--		BEGIN	
	--			Select  ISNULL(CAST(A.U_StockAlmacen AS DECIMAL(18,4)), 0.0)U_stockAlmacen,A.VisOrder LineNum, ISNULL(C.BWeight1, 0) BWeight1, *, B.WhsName, ISNULL((C.BVolume/1000000)*35.3147, 0) BVolume,
	--				D.Clasificacion ABC, 
	--				ISNULL(CAST(A.U_StockAlmacen AS DECIMAL(18,4)), 0) U_StockAlmacen,
	--				CAST(0 AS DECIMAL(18,4)) VI,  
	--				ISNULL(CAST(D.Ideal AS DECIMAL(18,4)), 0) Ideal,  
	--				ISNULL(CAST(D.OnHand AS DECIMAL(18,4)), 0) OnHand,
	--				CAST(0 AS DECIMAL(18,4)) QtyOriginal
	--			From SBOCTRZ.dbo.POR1 A
	--				INNER JOIN SBOCTRZ.dbo.OWHS B on A.WhsCode = B.WhsCode 
	--				INNER JOIN SBOCTRZ.dbo.OITM C on C.ItemCode = A.ItemCode
	--				LEFT JOIN purchase.VW_VIGeneral D ON A.ItemCode = D.ItemCode
	--			Where A.DocEntry = @DocEntry
	--		END
	--		IF @sType = 'OC'
	--		BEGIN	
	--			SELECT 
	--				A.*, NULL[WhsName]
	--			FROM SBOCTRZ.dbo.POR1 A
	--			JOIN SBOCTRZ.dbo.OPOR B ON A.DocEntry = B.DocEntry
	--			Where A.DocEntry = @DocEntry AND B.DocType = 'S'
	--		END
	--		ELSE IF @sType = 'BorradorHNT'
	--		BEGIN
	--			SET @QRY = '
	--			Select CAST(A.LineNum AS INT) LineNum,
	--				   ISNULL(C.ItemName, Dscription) Dscription,
	--				   A.Quantity OpenQty,
	--				   ''O'' LineStatus,
	--				ISNULL(C.BWeight1, 0) BWeight1, *, B.WhsName, ISNULL((C.BVolume/1000000)*35.3147, 0) BVolume,
	--				ISNULL(CAST(D.Ideal AS DECIMAL(18,4)), 0) Ideal,  
	--				ISNULL(CAST(D.OnHand AS DECIMAL(18,4)), 0) OnHand
	--			From sap.DRF1 A
	--				LEFT JOIN SBOCTRZ.dbo.OWHS B on A.WhsCode = B.WhsCode 
	--				LEFT JOIN SBOCTRZ.dbo.OITM C on C.ItemCode = A.ItemCode	
	--				LEFT JOIN purchase.VW_VIGeneral D ON A.ItemCode = D.ItemCode
	--			Where A.DocEntry = @DocEntry '

	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--	END

	--	IF @ObjType = 18 /*ES UNA FACTURA** PMJM*/ 
	--	BEGIN
	--		IF @sType = ''
	--		BEGIN
	--			SET @QRY = ' SELECT A.*, '''' WhsName, ''''[RevenuesAc], C.ManBtchNum, ''''U_WhsName FROM ' + @CIA + '.dbo.PCH1 A LEFT JOIN ' + @CIA + '.dbo.OITM C ON A.ItemCode = C.ItemCode AND C.ItemType <> ''F'' WHERE A.DocEnTry = @DocEntry'
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--		ELSE IF @sType = 'BorradorHNT'
	--		BEGIN
	--			SET @QRY = ' SELECT A.*, '''' WhsName, ''''[RevenuesAc], C.ManBtchNum, ''''U_WhsName FROM sap.DRF1 A LEFT JOIN ' + @CIA + '.dbo.OITM C ON A.ItemCode = C.ItemCode AND C.ItemType <> ''F'' WHERE A.DocEnTry = @DocEntry'
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--	END

	--	IF @ObjType = 19
	--	BEGIN
	--		IF @sType = ''
	--		BEGIN
	--			SET @QRY = ' SELECT A.*, '''' WhsName, ''''[RevenuesAc], C.ManBtchNum, ''''U_WhsName FROM ' + @CIA + '.dbo.RPC1 A LEFT JOIN ' + @CIA + '.dbo.OITM C ON A.ItemCode = C.ItemCode AND C.ItemType <> ''F'' WHERE A.DocEnTry = @DocEntry'
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--		ELSE IF @sType = 'BorradorHNT'
	--		BEGIN
	--			SET @QRY = ' SELECT A.*, '''' WhsName, ''''[RevenuesAc], C.ManBtchNum, ''''U_WhsName FROM sap.DRF1 A LEFT JOIN ' + @CIA + '.dbo.OITM C ON A.ItemCode = C.ItemCode AND C.ItemType <> ''F'' WHERE A.DocEnTry = @DocEntry'
	--			SET @PARAMETROS = '@DocEntry INT'
	--		END
	--	END

	--	EXECUTE sp_executesql @QRY, @PARAMETROS, @DocEntry
	--END
	/*PCC*/

	
	IF @TipoConsulta = 60
	BEGIN
		IF @sType = 'ORDR_SAP'
		BEGIN
			--PARA CERRAR PEDIDOS ANTES DE UNA APERTURA
			--Select  A.DocEntry, A.DocNum, A.ObjType, DocDate--, A.U_MetPago, A.Series--, B.Estatus
			--From SBOCTRZ.dbo.ORDR A
			--	--LEFT JOIN  logistics.WMS_SurtidoDocumentos B ON A.DocEntry =  B.DocEntry AND A.ObjType = B.ObjType
			--Where 
			--	DocStatus = 'O'  
			--	AND U_TPedido <> 'TL'
			--	AND A.CardCode NOT IN ('C1038', 'R191','R192', 'T197') --leticia genera estos pedidos
			--	AND A.Series = 141--IN (SELECT x.Serie FROM sap.SeriesWMS x WHERE x.ObjType = 17)
			--	AND A.U_MetPago = ''
			--PARA CERRAR PEDIDOS DE SUCURSALES QUE AUN NO USAN WMS
			--UNION ALL
			--Select  A.DocEntry, A.DocNum, A.ObjType, DocDate From SBOCTRZ.dbo.ORDR A
			--Where A.DocDueDate < CAST(DATEADD(DD, -3, GETDATE()) AS DATE)
			--	AND DocStatus = 'O'  AND U_TPedido <> 'TL'
			--	AND A.CardCode NOT IN ('C1038', 'R191','R192', 'T197') --leticia genera estos pedidos
			--	AND A.Series NOT IN (SELECT x.Serie FROM sap.SeriesWMS x WHERE x.ObjType = 17)
			--PARA CERRAR PEDIDOS DE SUCURSALES QUE USAN WMS
			--UNION ALL 
			SELECT A.DocEntry, A.DocNum, B.ObjType, DocDate 
			FROM sap.DocumentCancelaciones A
				JOIN SBOCTRZ.dbo.ORDR B ON A.DocEntry =  B.DocEntry AND A.ObjType = B.ObjType
			WHERE 
				B.DocStatus = 'O'
			ORDER BY DocEntry DESC
		END
		--ELSE IF @sType = 'DRAFT_SAP'
		--BEGIN
		--	Select TOP 0 DocEntry, docdate From SBOCTRZ.dbo.ODRF 
		--	Where DocDate < CAST(GETDATE() AS DATE) AND WddStatus = '-'
		--END
		ELSE IF @sType = 'OINV_COSTOS'
		BEGIN
			Select  
				D.DocEntry, D.DocNum, '2022-10-31' DocDate, D.U_TransId, 
				E.SaleCostAc ctaCosto, B.CogsAcct, C.CogsOcrCod,
				SUM(C.Quantity * B.StockPrice) monto
			from 
				SBOCTRZ.dbo.ODLN A
				JOIN SBOCTRZ.dbo.DLN1 B ON A.DocEntry = B.DocEntry
				JOIN SBOCTRZ.dbo.INV1 C ON C.BaseEntry = B.DocEntry AND c.BaseLine = B.LineNum AND C.BaseType = b.ObjType
				JOIN SBOCTRZ.dbo.OINV D ON D.DoceNtry = C.DocEntry
				JOIN SBOCTRZ.dbo.OWHS E ON E.WhsCode = C.WhsCode
			Where 
				D.U_TransId <= 0
				AND B.CogsAcct = '1140-003-002'
				AND MONTH(D.DocDate) = 10
				AND YEAR(D.DocDate) = 2022 
				--and d.docnum = 500071657
			Group By 
				D.DocNum, D.DocDate, D.U_TransId, E.SaleCostAc, B.CogsAcct, D.DocEntry, C.CogsOcrCod--,A.DocNum, A.DocDate
			Having (SUM(C.Quantity * B.StockPrice)) <> 0 
				
			/*
		select sum(Debit-credit) from SBOCTRZ.dbo.jdt1 where refdate <= '2019-10-31' and Account = '1140-003-002'
			*/
		END
		ELSE IF @sType = 'ORIN_COSTOS'
		BEGIN
			Select 
				'2022-10-31' DocDate, A.Docnum, A.DocEntry, B.CogsAcct ctaRem, E.SaleCostAc ctaCost, B.OcrCode, b.CogsOcrCod, SUM(D.StockPrice * B.Quantity) Asiento
            From SBOCTRZ.dbo.ORIN A
                JOIN SBOCTRZ.dbo.RIN1 B ON A.DocEntry = B.DocEntry
                JOIN SBOCTRZ.dbo.INV1 C ON C.LineNum = B.BaseLine AND C.DocEntry = B.BaseEntry AND C.ObjType = B.BaseType
                JOIN SBOCTRZ.dbo.DLN1 D ON D.LineNum = C.BaseLine AND D.DocEntry = C.BaseEntry AND D.ObjType = C.BaseType
                JOIN SBOCTRZ.dbo.OWHS E ON E.WhsCode = B.WhsCode
                JOIN SBOCTRZ.dbo.ODLN F ON F.DocEntry = D.DocEntry
            Where 
                B.CogsAcct = '1140-003-002'AND A.DocType = 'I'
                AND A.U_TransId = -1
				AND MONTH(A.DocDate) = 10
				AND YEAR(A.DocDate) = 2022 
				--and a.DocEntry = 31706
			Group By B.CogsAcct, E.SaleCostAc, A.DocEntry, a.docnum, B.OcrCode, b.CogsOcrCod
		END
		ELSE
		BEGIN
			--Select ObjType, DocEntry From sap.ODRF Where TransID IS NULL and objtype in (13,15,17)  and ( u_autorizado='A')
			--Select 
			--	ObjType, DocEntry
			--From(
			--	Select 
			--		ROW_NUMBER() OVER(Partition By CardCode Order By DocEntry)Num,
			--		DocEntry, 
			--		ObjType,
			--		CardCode
			--	From 
			--		sap.ODRF 
			--	Where 
			--		/*DocDate between dateadd(dd, -3, GETDATE()) AND CAST(GETDATE() AS DATE)
			--		AND */ObjType in (17, 13, 15)
			--		--AND u_FOLIOHALCON <> 268
			--		AND TransID IS NULL
			--		AND (U_Autorizado = 'A')
			--		)T0
			--union all
			Select 
				ObjType, DocEntry
			From(
				Select 
					ROW_NUMBER() OVER(Partition By CardCode Order By A.DocEntry) Num,
					A.DocEntry, 
					A.ObjType,
					CardCode,
					SUM(CASE WHEN B.Status IN ('W', 'N') THEN 1 ELSE 0 END) Errores 
				From 
					sap.ODRF A
						LEFT JOIN sap.OWDD B ON A.DocEntry = B.Docentry AND A.Objtype = B.Objtype
				Where 
					A.ObjType in (17, 13, 15)
					AND TransID IS NULL
					AND U_Autorizado = 'A'
					AND A.DocDate between dateadd(dd, -5, GETDATE()) AND CAST(GETDATE() AS DATE)	
				GROUP BY 
					A.DocEntry, A.ObjType, CardCode
				)T0
			Where Errores = 0 -- PARA VALIDAR QUE LOS DOCS GENERADOS QUE TENGAN UN MODELO DE AUTORIZACION YA ESTEN AUTORIZADOS
			UNION ALL
			Select ObjType, DocEntry From sap.ODRF Where TransID IS NULL and objtype = 67
			union all
			Select ObjType, DocEntry From sap.ODRF Where TransID IS NULL and objtype in(14, 16) AND U_Autorizado = 'A'
			union all
			Select ObjType, DocEntry From sap.ODRF Where TransID IS NULL and objtype in(20) AND U_Autorizado = 'A'
			union all
			Select ObjType, DocEntry From sap.ODRF Where TransID IS NULL and objtype = 18
			union all
			Select ODRF.ObjType, ODRF.DocEntry From sap.ODRF
				JOIN SBOCTRZ.DBO.OCRD ON ODRF.CardCode = OCRD.CardCode
			Where TransID IS NULL and ODRF.ObjType = 22 AND U_Autorizado = 'A' AND OCRD.QryGroup44 = 'N'
			UNION ALL
			Select ODRF.ObjType, ODRF.DocEntry From sap.ODRF
				JOIN SBOCTRZ.DBO.OCRD ON ODRF.CardCode = OCRD.CardCode
			Where TransID IS NULL and ODRF.ObjType = 22 AND U_Autorizado = 'A' AND ODRF.Transfered = 'Y'
				
		END
	END



	IF @TipoConsulta = 61
	BEGIN
		IF @DocNumSAP = 0 SET @DocnumSAP = NULL
		UPDATE sap.ODRF SET TransId = @DocNumSAP, PickRmrk = @Comments WHERE DocEntry = @DocEntry
		UPDATE [sales].[VentaPerdida] SET DocEntry = @DocNumSAP Where NumBorrador = @DocEntry 
	END

	if @TipoConsulta = 62 --elimiar linea borrador
	BEGIN
		delete sap.DRF1 where DocenTry = @DocEntry  and LineNum = @LineNum
	end

	if @TipoConsulta = 63 --ACTUALIZA ESTADO DESPUES DE VALIDAR MODELOS DE AUTORIZACION 
	BEGIN
		--IF NOT EXISTS (SELECT * FROM sap.ODRF WHERE DocEntry = @DocEntry AND TransId IS NULL AND U_Autorizado = 'A')
		--BEGIN
			UPDATE sap.ODRF SET u_autorizado = @sType WHERE /*objtype = @ObjType and*/ docentry= @DocNum 
		
			IF @sType = 'A'  
				UPDATE sap.ODRF SET TransId = NULL  WHERE /*objtype = @ObjType and*/ docentry= @DocNum
		--END
	end

	IF @TipoConsulta = 64 --comentario de error
	BEGIN
		UPDATE sap.ODRF SET  PickRmrk = @Comments WHERE DocEntry = @DocEntry
	END

	IF @TipoConsulta = 65 --datos articulo
	BEGIN
		SET @QRY ='
			Select A.ItemCode, A.ItemName, ISNULL( D.Price, B.Price) Price , ISNULL(B.Currency, '''') Currency,isnull(A.ncmcode,1)ncmcode,
				(Select Rate from ' + @CIA + '.dbo.ORTT Where ORTT.RateDate = CAST(GETDATE() AS DATE)) Rate, 
				ISNULL(ManBtchNum, '''') ManBtchNum, 0 OnHand, 0 Ideal,''ZZZ'' Clasificacion 
			From ' + @CIA + '.dbo.OITM A 
				INNER JOIN ' + @CIA + '.dbo.ITM1 B ON A.ItemCode = B.ItemCode AND A.sellitem =''Y'' --AND B.Currency IS NOT NULL
				LEFT JOIN ' + @CIA + '.dbo.OSPP D ON D.CardCode = @CardCode AND D.ItemCode = A.ItemCode
				JOIN ' + @CIA + '.dbo.OCRD E ON E.CardCode = @CardCode and B.PriceList = E.ListNum 
				left JOIN  sales.ClientesDescuento F on E.cardcode collate database_default =  F.CardCode'
		IF ISNULL(@ItemCode, '') <> ''
			SET @QRY += ' WHERE A.ITEMCODE = ''' + @ITEMCODE + ''''

		SET @QRY += '
			ORDER BY A.ItemCode'

		SET @PARAMETROS = '@CardCode VARCHAR(10)'
		EXECUTE sp_executesql @QRY, @PARAMETROS, @CardCode
	END

	if @tipoconsulta = 66 --actualizar comentario y oc
	BEGIN
		if @ObjType = 13
			BEGIN		
				update SBOCTRZ.dbo.oinv set Comments = @Comments,U_OC=@U_OC  where docentry=@docentry and ObjType = 13
			end
	end

	if @TipoConsulta = -66
	begin
		if @ObjType = 17
		begin

			if @U_TIPOOV = 'SUR' and (select U_TIPOOV from SBOCTRZ.dbo.ORDR where DocEntry = @DocEntry) = 'COT'
			begin
				update SBOCTRZ.dbo.ORDR set Comments = @Comments, U_TIPOOV = @U_TIPOOV where DocEntry = @DocEntry and ObjType = 17 
			end
			begin
				update SBOCTRZ.dbo.ORDR set Comments = @Comments where DocEntry = @DocEntry and ObjType = 17 
			end
		end
	end

	if @tipoconsulta = 67 --buscar ejes
	BEGIN
		select * from sales.CotizadorItems  Y where  Y.Clasificacion = 'Ejes' AND Y.Accesorios = 'Eje' and  itemcode = @ItemCode
		UNION ALL
		select * from sales.CotizadorItems  Y where  Y.Clasificacion = 'Suspensiones' AND Y.Accesorios = 'Suspensión' and  itemcode = @ItemCode
	end

	IF @TipoConsulta = 68
	BEGIN
		Select ObjType, DocEntry From sap.ODRF Where DocEntry= 10030
	END

	IF @TipoConsulta = 69
	BEGIN
		--DELETE FROM sap.DRF2 WHERE DocEntry = @DocEntry AND LineNum = @LineNum

		INSERT INTO sap.DRF2 (DocEntry, LineNum, ItemCode, WhsCode, IntrSerial, InDate, BatchNum, SuppSerial, Quantity)
		VALUES (@DocEntry, @LineNum, @ItemCode, @WhsCode, @IntrSerial, @InDate, @BatchNum, @SuppSerial, @Quantity)
	END

	IF @TipoConsulta = 70
	BEGIN
		Select * From sap.DRF2 Where DocEntry = @DocEntry AND LineNum = @LineNum
	END
	
	IF @TipoConsulta = 71
	BEGIN
		DECLARE @Tbl TABLE(DocEntry INT)

		INSERT INTO @Tbl
		SELECT BaseEntry From sap.DRF1 Where DocEntry = @DocEntry and docentry is not null and @docentry > 0
		--10708
		SELECT
			DocEntry, BaseEntry, BaseLine, BaseType,
			DocNum, ItemCode, Pedido, Factura, Stock,
			isnull(CASE WHEN ISNULL(Factura, 0) < qPedido AND Stock <= qPedido THEN Stock - ISNULL(Factura, 0) 
					 WHEN ISNULL(Factura, 0) <= qPedido AND Stock > qPedido THEN qPedido - ISNULL(Factura, 0) END,0) [Faltante],
			CASE WHEN qPedido > Stock THEN qPedido - Stock END [Venta perdida],
			Motivo, Comments, WhsCode
		FROM(
			SELECT	DISTINCT
				@DocEntry DocEntry, ISNULL(C.BaseEntry, B.DocEntry) BaseEntry, ISNULL(C.BaseLine, B.LineNum) BaseLine, ISNULL(C.BaseType, B.ObjType) BaseType,
			
				A.DocNum, B.ItemCode, 
				B.OpenQty Pedido,
				F.OnHand Stock,
				
				Motivo, ISNULL(D.Comments, '') Comments,
				
				CASE WHEN B.TreeType = 'I' THEN
					(Select TOP 1 x.WhsCode From sap.DRF1 x WHERE x.BaseEntry = B.DocEntry AND B.LineNum -1 = x.BaseLine) 
				ELSE 
					B.WhsCode
				END WhsCode,
				
				CASE WHEN B.TreeType = 'I' THEN
					(Select TOP 1 x.Quantity From sap.DRF1 x WHERE x.BaseEntry = B.DocEntry AND B.LineNum -1 = x.BaseLine) * 4
				ELSE 
					ISNULL(C.Quantity, 0)
				END Factura,
				B.OpenQty qPedido
			FROM
				SBOCTRZ.dbo.ORDR A 
				JOIN SBOCTRZ.dbo.RDR1 B ON A.DocEntry = B.DocEntry
				JOIN SBOCTRZ.dbo.OITW F ON F.WhsCode = B.WhsCode AND F.ItemCode = B.ItemCode 
				left JOIN sap.DRF1 C ON B.LineNum = C.BaseLine AND B.DocEntry = C.BaseEntry AND B.ObjType = C.BaseType AND B.DocEntry = C.BaseEntry  AND C.BaseType = 17
				LEFT JOIN [sales].[VentaPerdida] D ON D.BaseLine = ISNULL(C.BaseLine, B.LineNum) AND D.BaseEntry = ISNULL(C.BaseEntry, B.DocEntry) 
			WHERE
				A.DocEntry IN (Select * From @Tbl)
				AND B.LineStatus = 'O' 
				AND B.TreeType <> 'S'
				AND 1 = 0 -- PARA INACTIVAR VENTA PERDIDA
				)T0
		WHERE CASE WHEN ISNULL(Factura, 0) < qPedido AND Stock <= qPedido THEN Stock - ISNULL(Factura, 0) 
					 WHEN ISNULL(Factura, 0) <= qPedido AND Stock > qPedido THEN qPedido - ISNULL(Factura, 0) 
					 END
				 + 
				 CASE WHEN qPedido > Stock THEN qPedido - Stock ELSE 0 END > 0
				 or (qPedido < factura and qpedido > 0)
	END

	IF @TipoConsulta = 72
	BEGIN
		Select * from(
			Select '01' Code, 'Sin stock' Name, 0 Active  UNION ALL
			Select '02' Code, 'Mercancía dañada' Name, 1  UNION ALL
			Select '03' Code, 'El Cliente no lo quiso' Name, 0  UNION ALL
			Select '04' Code, 'Faltante de almacén' Name, 1  UNION ALL 
			Select '05' Code, 'El cliente cambio pedido' Name, 0 UNION ALL
			Select '06' Code, 'Stock insuficiente' Name, 1 UNION ALL
			Select '07' Code, 'Producto cambiado' Name, 1 
			)T0
		Where Active = 1
	END

	IF @TipoConsulta = 73
	BEGIN
		IF @ObjType in (13,14,24)
		BEGIN
			IF @ObjType = 13 AND ISNULL(@DocSubType, '') = ''
				SELECT @TransId = TransID, @DocSubType = '' FROM SBOCTRZ.DBO.OINV WHERE DocNum = @DocEntry
			IF @ObjType = 13 AND @DocSubType = 'DN'
				SELECT @TransId = TransID, @DocSubType = 'DN' FROM SBOCTRZ.DBO.OINV WHERE DocNum = @DocEntry and DocSubType = 'DN'
			IF @ObjType = 14
				SELECT @TransId = TransID FROM SBOCTRZ.DBO.ORIN WHERE DocNum=@DocEntry
			IF @ObjType = 24
				SELECT @TransId = TransId FROM SBOCTRZ.DBO.ORCT WHERE DocNum=@DocEntry
			
			IF @ObjType = 24
			BEGIN
				SELECT 
					T1.InvType [ObjType],
					T1.DocEntry [DocEntry],
					CASE WHEN T1.InvType = 13 AND @DocSubType = '' THEN 'Factura de deudores'
						 WHEN T1.InvType = 13 AND @DocSubType = 'DN' THEN 'Nota de débito'
						 WHEN T1.InvType = 14 THEN 'Nota de crédito'
						 WHEN T1.InvType = 24 THEN 'Pago recibido'
						END [Tipo de documento], 
					T2.DocNum [Número de documento],
					'' 'Tipo de reconciliación',
					CASE WHEN T0.DocCurr = '$' THEN T1.SumApplied ELSE T1.AppliedFC END [Importe aplicado],
					T2.DocDate [Fecha de contabilización],
					-1 ReconNum,
					'Ver' Ver
				FROM SBOCTRZ.DBO.ORCT T0
					INNER JOIN SBOCTRZ.DBO.RCT2 T1 ON T0.DocNum = T1.DocNum
					INNER JOIN SBOCTRZ.DBO.OINV T2 ON T1.DocEntry = T2.DocEntry
				WHERE T0.DocNUM = @DocEntry
			END
			ELSE
			BEGIN
				SELECT 
					T0.SrcObjTyp [ObjType],
					T0.SrcObjAbs [DocEntry],
					CASE WHEN T0.SrcObjTyp = 13 AND @DocSubType = '' THEN 'Factura de deudores'
						 WHEN T0.SrcObjTyp = 13 AND @DocSubType = 'DN' THEN 'Nota de débito'
						 WHEN T0.SrcObjTyp = 14 THEN 'Nota de crédito'
						 WHEN T0.SrcObjTyp = 24 THEN 'Pago recibido'
						END [Tipo de documento], 
					T1.BaseRef [Número de documento],
					CASE WHEN T2.ReconType  = 3 THEN 'Pago'
						END 'Tipo de reconciliación',
					T1.Debit - Credit [Importe aplicado],
					T1.RefDate [Fecha de contabilización],
					T0.ReconNum,
					'Ver' Ver
				FROM SBOCTRZ.DBO.ITR1 T0
				INNER JOIN SBOCTRZ.DBO.JDT1 T1 ON T0.TransRowId = T1.Line_ID AND T0.TransId = T1.TransId
				INNER JOIN SBOCTRZ.DBO.OITR T2 ON T0.ReconNum = T2.ReconNum
				WHERE EXISTS(SELECT U0.ReconNum FROM SBOCTRZ.DBO.ITR1 U0 WHERE U0.TransId = (@TransId)
				AND U0.TransRowId = 0 AND T2.ReconNum = U0.ReconNum)
				AND (T1.TransId <> (@TransId) OR T1.Line_ID <> 0)
			END

		END
		IF @ObjType in (15, 16)
		BEGIN
			IF @ObjType = 15
				SELECT @TransId = DocEntry FROM SBOCTRZ.DBO.ODLN WHERE DocNum=@DocEntry
			IF @ObjType = 16
				SELECT @TransId = DocEntry FROM SBOCTRZ.DBO.ORDN WHERE DocNum=@DocEntry

			SELECT DISTINCT A.ObjType, 
				A.DocEntry, 'Entregas' [Tipo de documento],
				A.DocNum [Número de documento],
				'' [Tipo de reconciliación],
				A.DocTotal [Importe aplicado],
				A.DocDate [Fecha de contabilización],
				0 ReconNum,
				'Ver' Ver
			FROM SBOCTRZ.dbo.ODLN A
				JOIN SBOCTRZ.dbo.DLN1 B ON A.DocEntry = B.DocEntry
			WHERE B.TrgetEntry = @TransId  AND B.TargetType = @ObjType
			UNION ALL
			SELECT DISTINCT A.ObjType, 
				A.DocEntry, 'Factura de deudores' [Tipo de documento],
				A.DocNum [Número de documento],
				'' [Tipo de reconciliación],
				A.DocTotal [Importe aplicado],
				A.DocDate [Fecha de contabilización],
				0 ReconNum,
				'Ver' Ver
			FROM SBOCTRZ.dbo.OINV A
				JOIN SBOCTRZ.dbo.INV1 B ON A.DocEntry = B.DocEntry
			WHERE B.BaseEntry = @TransId  AND B.BaseType = @ObjType
			UNION ALL
			SELECT DISTINCT A.ObjType, 
				A.DocEntry, 'Devolución' [Tipo de documento],
				A.DocNum [Número de documento],
				'' [Tipo de reconciliación],
				A.DocTotal [Importe aplicado],
				A.DocDate [Fecha de contabilización],
				0 ReconNum,
				'Ver' Ver
			FROM SBOCTRZ.dbo.ORDN A
				JOIN SBOCTRZ.dbo.RDN1 B ON A.DocEntry = B.DocEntry
			WHERE B.BaseEntry = @TransId  AND B.BaseType = @ObjType
		END

	END

	IF @TipoConsulta = 74
	BEGIN
		Select * From SBOCTRZ.dbo.ITM1 Where PriceList = 13
		AND ItemCode = @ItemCode
	END

	IF @TipoConsulta = 75
	BEGIN
		DECLARE @TC  DECIMAL (18, 4), @RateDate DATE
		SET @RateDate = @DocDate
		WHILE @TC IS NULL
		BEGIN
			SELECT @TC = Rate FROM SBOCTRZ.dbo.ORTT WHERE RateDate = @RateDate
			SET @RateDate = DATEADD(DD, -1, @RateDate)
		END

		IF @Rate < @TC
		BEGIN
			RAISERROR ('EL TIPO DE CAMBIO NO PUEDE SER MENOR AL DE SAP.' , 11, 1)
		END
		ELSE
			BEGIN
			IF NOT EXISTS (Select * From sap.ORTT Where DocRate =  @DocDate)
				INSERT INTO sap.ORTT (DocRate, Rate, CreateDate) VALUES (@DocDate, @Rate, GETDATE())
			ELSE
				UPDATE sap.ORTT SET Rate = @Rate Where DocRate = @DocDate
		END
	END

	IF @TipoConsulta = 76
	BEGIN
		SELECT Rate FROM sap.ORTT WHERE DocRate = @DocDate
	END
		
	IF @TipoConsulta = 77
	BEGIN
		Select dbo.[uf_HNT_HabilitarU_TC](@CardCode, @SlpCode, @ItemCode) Result
	END

	if @TipoConsulta = 78
	BEGIN
			if not exists (select * from sap.OPRJ where PrjCode = @prjcode)
			BEGIN
				DECLARE @CrearProyect VARCHAR(1) = 'N' --Si cre crea

				IF @U_Complemento = '002'
					SET @CrearProyect = 'P' --los de nomina no se crean hasta que se autoricen
				
				insert into  hnt_trz.sap.OPRJ values (@prjcode,@prjName,@CrearProyect,'I',46,getdate(),Getdate(),@CrearProyect,0,46,GETDATE(),@U_Empresa,@U_Sucursal,@U_NR,@U_Area,@U_CodPuesto,@U_Ruta,@U_Unidad,@U_Telefono,@U_Complemento, '')
				insert into Halconet.sap.OPRJ values (@prjcode,@prjName,@CrearProyect,'I',46,getdate(),Getdate(),@CrearProyect,0,46,GETDATE(),@U_Empresa,@U_Sucursal,@U_NR,@U_Area,@U_CodPuesto,@U_Ruta,@U_Unidad,@U_Telefono,@U_Complemento, '')

				---LAS AUTORIZACIONES SE MANDAN POR MODELO DE AUTORIZACION
				--declare @body nvarchar(max)
				--if (@U_Complemento = '005')
				--begin
				-- set @body = 'Por este medio se notifica el ALTA de la Unidad ' + @U_Unidad + ' con Num. de Proyecto ' + @prjCode
				--		declare @tableHTML nvarchar(max) = 
				--		N'<table border="1" widht=80%>' +  
				--		N'<td style="text-align:center"> ' + @body + '</td></table>'

				--		EXEC msdb.dbo.sp_send_dbmail   
				--		@profile_name ='Correo Halconet',
				--		@recipients = 'rosario.fierro@tractozone.com.mx',
				--		@subject = 'Alta Codigo de Puesto',
				--		@body = @tableHTML,--@MsjCorreo,
				--		@body_format = 'HTML',
				--		@copy_recipients = 'halconet@tractozone.com.mx;luis.olivos@tractozone.com.mx'
				--end

			end
			--else
			--BEGIN
			--	Update sap.OPRJ
			--	set
			--	Locked = @Locked ,
			--	UserSign = @UserSign ,
			--	ValidFrom = @ValidFrom ,
			--	ValidTo = @ValidTo ,
			--	active = @active ,
			--	LogInstanc = @LogInstanc ,
			--	UserSign2 = @UserSign2 ,
			--	UpdateDate = @UpdateDate ,
			--	U_NivProy = @NivProx ,
			--	U_Sucursal = @U_Sucursal ,
			--	U_Area = @U_Area ,
			--	U_CPuesto = @U_CPuesto ,
			--	U_Nombre = @U_Nombre ,
			--	U_Placa = @U_Placa ,
			--	U_TipoVehiculo = @U_TipoVehiculo ,
			--	U_NormaRep = @U_NormaRep ,
			--	U_NoTel = @U_NoTel ,
			--	U_Compania = @U_Compania ,
			--	U_Anterior = @U_Anterior ,
			--	U_Tag = @U_Tag ,
			--	U_Tarjeta = @U_Tarjeta ,
			--	U_IAVE = @U_IAVE ,
			--	U_Viapass = @U_Viapass 
			--	where PrjCode = @PrjCode
			--end
		
		set @mensaje = @prjCode
	end

	IF @TipoConsulta = 79
	BEGIN
		select top 40 * from sap.OPRJ where active = 'N'
	end

	if @TipoConsulta = 80
	BEGIN
		select * from sap.OPRJ where prjCode = @prjCode 
	end

	IF @TipoConsulta = 81 
	BEGIN
		SELECT id, DocEntry, ObjType, Nombre, Extension, '' btn FROM hnt.[Files_Documentos] WHERE DocEntry = @DocEntry AND @ObjType = @ObjType			
	END

	if @TipoConsulta = 82
	begin
		SELECT @mensaje = FORMAT(MAX(CAST(prjCode AS INT)) + 1,'0000000') FROM HNT_TRZ.sap.OPRJ WHERE U_Complemento = @U_Complemento
		IF ISNULL(@mensaje, '') = ''
			SELECT @mensaje = format(max(cast(prjCode as int)) + 1,'0000000') FROM SBOCTRZ.dbo.OPRJ WHERE U_Complemento = @U_Complemento
		--SELECT @mensaje = format(isnull(max(cast(prjCode as int)),9999) + 1,'0000000') FROM HNT_TRZ.sap.OPRJ WHERE U_Complemento = @U_Complemento
		--IF ISNULL(@mensaje, '') = '0000000'
		--	SELECT @mensaje = format(isnull(max(cast(prjCode as int)),9999) + 1,'0000000') FROM SBOCTRZ.dbo.OPRJ WHERE U_Complemento = @U_Complemento
					
		--select  format(isnull(max(cast(prjCode as int)),9999) + 1,'0000000') from HNT_TRZ.sap.OPRJ
	end

	if @TipoConsulta = 83
	begin
		Update sap.OPRJ SET Active = @Active, U_Comentariros = @Comments Where PrjCode = @PrjCode
	end

	---------------------SALDOS INICIALES
	IF @TipoConsulta = 84
	BEGIN
		SELECT LEFT(CONVERT(VARCHAR, U_FechaVto, 120), 10) U_FechaVto, *
		FROM sap.ODRF 
		Where DocenTry = @DocEntry AND ObjType = @ObjType
	END 

	IF @TipoConsulta = 85
	BEGIN
		SELECT B.ManBtchNum ,A.*
		FROM sap.DRF1 A
			LEFT JOIN [SBOCTRZ].DBO.OITM B ON A.ItemCode = B.ItemCode
		WHERE A.DocenTry = @DocEntry 
			AND A.ObjType = @ObjType
	END

	IF @TipoConsulta = 86
	BEGIN
		IF @ObjType = 13--FACTURA DE DEUDORES
		BEGIN
			SELECT TOP 20 DocEntry, ObjType
			FROM sap.ODRF 
			WHERE DocType = 'S' AND TransId IS NULL AND ObjType = @ObjType 
				AND DocNum Not IN (Select x.NumAtCard from SBOCTRZ.dbo.OINV x)
		END
		IF @ObjType = 18--FACTURAS DE RESERVA
		BEGIN
			SELECT  DocEntry, ObjType
			FROM sap.ODRF 
			WHERE DocType = 'S' AND TransId IS NULL AND ObjType = 18 
				AND DocNum Not IN (Select x.NumAtCard from SBOCTRZ.dbo.OPCH x )
		END
		IF @ObjType = 15--REMISIONES
		BEGIN
			SELECT DocEntry, ObjType
			FROM sap.ODRF 
			WHERE TransId IS NULL AND ObjType = @ObjType 
		END
	END 

	IF @TipoConsulta = 87
	BEGIN
		IF @DocNumSAP = 0 SET @DocnumSAP = NULL

		UPDATE sap.ODRF SET TransId = @DocNumSAP, PickRmrk = @Comments WHERE DocEntry = @DocEntry AND ObjType = @ObjType
	END
		
	IF @TipoConsulta = 88 --revisar stock
	BEGIN
		--SELECT 10000 OnHand
	
		IF ISNULL(@TreeType, '') = ''
			SELECT @TreeType = TreeType FROM SBOCTRZ.dbo.OITM A WHERE ItemCode = @ItemCode
		
		IF (@TreeType IN('N', 'I'))
		BEGIN --articulo que no es balata
			IF EXISTS (SELECT A.ItemCode FROM SBOCTRZ.dbo.OITM A WHERE ItemCode = @ItemCode AND InvntItem = 'N')--ARTICULOS NO INVENTARIABLES *MO*
				SELECT 0 OnHand
			ELSE
			BEGIN
				SELECT B.OnHand 
				FROM SBOCTRZ.dbo.OITM A
					JOIN SBOCTRZ.dbo.OITW B on A.ItemCode = B.ItemCode
				WHERE B.ItemCode = @itemcode AND  B.WhsCode = @WhsCode AND B.OnHand >= @Quantity 
			END
		END
		ELSE 
			SELECT CAST(MIN(ROUND(B.OnHand / IT.Quantity, 0, 1)) AS DECIMAL(10, 2)) OnHand
			FROM  SBOCTRZ.dbo.OITM A
				JOIN SBOCTRZ.dbo.ITT1 IT on it.code = a.itemcode
				JOIN SBOCTRZ.dbo.OITW B on a.ItemCode = b.ItemCode
			WHERE 
				IT.Father = @ItemCode 
				AND B.WhsCode = @WhsCode 
			HAVING CAST(MIN(ROUND(B.OnHand / IT.Quantity, 0, 1)) AS DECIMAL(10, 2))  >= @Quantity
	END 

	IF @TipoConsulta = 89 --revisar stock
	BEGIN
		--SELECT 10000 OnHand

		IF ISNULL(@TreeType, '') = ''
			SELECT @TreeType = TreeType FROM SBOCTRZ.dbo.OITM A WHERE ItemCode = @ItemCode
		
		IF (@TreeType IN('N' , 'I'))
		BEGIN --articulo que no es balata
			IF EXISTS (SELECT A.ItemCode FROM SBOCTRZ.dbo.OITM A WHERE ItemCode = @ItemCode AND InvntItem = 'N')--ARTICULOS NO INVENTARIABLES *MO*
				SELECT 0 OnHand
			ELSE
			BEGIN
				SELECT B.OnHand 
				FROM SBOCTRZ.dbo.OITM A
					JOIN SBOCTRZ.dbo.OITW B on A.ItemCode = B.ItemCode
				WHERE B.ItemCode = @itemcode AND  B.WhsCode = @WhsCode-- AND B.OnHand > 0 
			END
		END
		ELSE
		BEGIN
			--IF @TreeType = 'I'---SI ES COMPONETE DE UNA LISTA DE MATERIALES BUSCAR EL PADRE PARA VALIDAR EL STOCK EN CONJUNTO
			--	SELECT @ItemCode = Father FROM SBOCTRZ.dbo.ITT1 WHERE Code =  @ItemCode

			SELECT CAST(MIN(ROUND(B.OnHand / IT.Quantity, 0, 1)) AS DECIMAL(10, 2)) OnHand
			FROM  SBOCTRZ.dbo.OITM A
				JOIN SBOCTRZ.dbo.ITT1 IT on it.code = a.itemcode
				JOIN SBOCTRZ.dbo.OITW B on a.ItemCode = b.ItemCode
			WHERE 
				IT.Father = @ItemCode 
				AND B.WhsCode = @WhsCode 
			--HAVING CAST(MIN(ROUND(B.OnHand / IT.Quantity, 0, 1)) AS DECIMAL(10, 2))  > 0
		END
	END 

	IF @TipoConsulta = 90
	BEGIN
		INSERT INTO sap.LotesOcupados (sBatchNum, sPedimento, sAduana, nIdFolio, sItemCode, nCantidadUtilizada, sCodAlmacen, dCreate)
										  VALUES (@BatchNum, @Pedimento, @Aduana, @DocNum, @ItemCode, @Quantity, @ToWhsCode, GETDATE())
	END

	IF @TipoConsulta = 91
	BEGIN
		DELETE sap.LotesOcupados
	END

	IF @TipoConsulta = 92
	BEGIN
		select * from sap.OPRJ where locked = 'N' and (U_Empresa in ('SCPJ','DPJ','KLU', 'CTR') and U_Complemento in (/*'001','003',*/'002','005'))
	end

	if @TipoConsulta = 93
	begin
		Update sap.OPRJ SET Locked = @Active, U_Comentariros = @Comments Where PrjCode = @PrjCode
	end

	if @TipoConsulta = 94
	begin
		Update SBOCTRZ.dbo.INV1 SET U_PReal = @U_PReal, U_TC = @U_TC, U_Padre = @U_Padre, U_PCB = @U_PCB
		Where DocEntry = @DocEntry AND LineNum = @LineNum

		IF @U_CostoBase <> 0 
			Update SBOCTRZ.dbo.INV1 SET U_CostoBase = @U_CostoBase 
			Where DocEntry = @DocEntry AND LineNum = @LineNum
		ELSE IF @U_CostoBase = 0 
			Update SBOCTRZ.dbo.INV1 SET U_CostoBase = NULL 
			Where DocEntry = @DocEntry AND LineNum = @LineNum
	end

	if @TipoConsulta = 95 --buscar cliente
		select isnull(cardname,'No existe el cliente') Nombre from SBOCTRZ.dbo.ocrd where cardcode = @Cardcode

	--Para Carga de Activos Fijos
	if @Tipoconsulta = 96
	begin
	--SBOCTRZ.dbo.ITM5 para revisar si estan cargados.
	--conexion de sap utilizada 10006
	--	Update sap.SDK_Document
	--set UserName = null,Password = null
	--where Code = 10006
				Select 'SEET-0125' ItemCode,'TEPEACA' NR,'0010692' PrjCode,Cast('2018-12-01' as date) ValidFrom --Union all

	end

	IF @Tipoconsulta = 97
	BEGIN
		IF @ObjType = 17
			SELECT MAX(DocEntry) FROM SBOCTRZ.dbo.ORDR
		ELSE IF @ObjType = 15
			SELECT MAX(DocEntry) FROM SBOCTRZ.dbo.ODLN
		ELSE IF @ObjType = 13
			SELECT MAX(DocEntry) FROM SBOCTRZ.dbo.OINV
	END

	IF @TipoConsulta = 98
	BEGIN
		SELECT Code ItemCode, Quantity * @Quantity Quantity FROM SBOCTRZ.DBO.ITT1
		WHERE Father = @ItemCode
	END

	

	IF @TipoConsulta = 99
	BEGIN
		SELECT Quantity Multiplo   
		FROM SBOCTRZ.DBO.ITT1
		WHERE Father = @U_Padre
			AND Code = @ItemCode
	END

	IF @TipoConsulta = 100
	BEGIN
		SELECT Code ItemCode
		FROM SBOCTRZ.DBO.ITT1
		WHERE Father = @ItemCode
	END

	IF @TipoConsulta = 101
	BEGIN
		--SELECT B.Price FROM SBOCTRZ.dbo.OCRD A
		--	JOIN [SBOCTRZ].DBO.ITM1 B ON A.ListNum = B.PriceList
		--WHERE A.CardCode = @CardCode
		--	AND B.ItemCode = @ItemCode

		SELECT B.Price, C.NCMCode, C.SalUnitMsr, C.SalPackMsr FROM SBOCTRZ.dbo.OCRD A
			JOIN [SBOCTRZ].DBO.ITM1 B ON A.ListNum = B.PriceList
			JOIN SBOCTRZ.dbo.OITM C ON C.ItemCode = B.ItemCode
		WHERE A.CardCode = @CardCode
			AND B.ItemCode = @ItemCode

	END

	IF @TipoConsulta = 102
	BEGIN
		INSERT INTO [sap].[Document_QR] VALUES (@Empresa, @Objtype, @DocEntry, @QR) 
	END

	IF @TipoConsulta = 103
	BEGIN
		IF(@ObjType = 1)
		BEGIN
			SELECT 
				CASE WHEN DB = 'SBOCTRZ' THEN 'CTR'
					 WHEN DB = 'SBOLOGTRANSP' THEN 'LOGTRA'
					 WHEN DB = 'SB1CPEJ' THEN 'CPEJ' END[Empresa],
				1[ObjType], 
				A.DocEntry,
				UUID[ReportId], 
				RFCRemitente[Rfc],
				RFCDestinatario[LicTradNum],
				0[DocTotal],
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello, 
				CreateDate[DocDate]
				,X.DocEntry
				,A.IdCCP
				,FORMAT(A.FechaHoraSalida, 'yyyy-MM-ddTHH:mm:00')[FechaHoraSalida]
				,FORMAT(A.FechaTimbrado, 'yyyy-MM-ddTHH:mm:ss')[FechaTimbrado]
			FROM sap.CFDICartaPorte A
				LEFT JOIN sap.Document_QR X ON  X.ObjType = 1 
								AND Empresa = CASE WHEN DB = 'SBOCTRZ' THEN 'CTR' 
												   WHEN DB = 'SBOLOGTRANSP' THEN 'LOGTRA' 
												   WHEN DB = 'SB1CPEJ' THEN 'CPEJ' END 
								AND X.DocEntry = A.DocEntry
			WHERE 
				ISNULL(UUID, '') != ''
				AND X.Docentry IS NULL
		END
		IF(@ObjType = 13)
		BEGIN
			Select TOP 10
				'CTR' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'CTZ190712MB1' Rfc,
				A.LicTradNum,
				CAST(CASE WHEN A.DocCur = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SBOCTRZ.dbo.OINV A
				JOIN SBOCTRZ.dbo.ECM2 B ON A.DocEntry = B.SrcObjAbs AND A.ObjType = B.SrcObjType
				LEFT JOIN sap.Document_QR X ON X.ObjType = A.ObjType AND Empresa = 'CTR' AND A.DocEntry = X.DocEntry
			WHERE 
				X.DocEntry IS NULL
				AND isnull(B.ReportId, '') != ''
				AND A.CreateDate >= DATEADD(dd,-10, GETDATE())
			UNION ALL
			SELECT TOP 10 
				'CTR' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'CTZ190712MB1' Rfc,
				A.LicTradNum,
				CAST(CASE WHEN A.DocCur = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SBOCTRZ.dbo.OINV A
				JOIN HNT_TRZ.sap.ECM2_CTRZ B ON A.DocEntry = B.SrcObjAbs AND A.ObjType = B.SrcObjType
				LEFT JOIN sap.Document_QR X ON X.ObjType = A.ObjType AND Empresa = 'CTR' AND A.DocEntry = X.DocEntry
			WHERE 
				X.DocEntry IS NULL
				AND isnull(B.ReportId, '') != ''
				AND A.CreateDate >= DATEADD(dd,-10, GETDATE())
			--SE AGREGA LOGISTICA 2021-09-07
			UNION ALL
			SELECT TOP 10 
				'LOGTRA' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'LTP160708I34' Rfc,
				A.LicTradNum,
				CAST(CASE WHEN A.DocCur = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SBOLOGTRANSP.dbo.OINV A
				JOIN HNT_TRZ.sap.ECM2_LOGTRA B ON A.DocEntry = B.SrcObjAbs AND A.ObjType = B.SrcObjType				
				LEFT JOIN sap.Document_QR X ON X.ObjType = A.ObjType AND Empresa = 'LOGTRA' AND A.DocEntry = X.DocEntry
			WHERE 
				X.DocEntry IS NULL and 
				isnull(B.ReportId, '') != ''
				AND A.CreateDate >= DATEADD(dd,-10, GETDATE())
			UNION ALL
			SELECT TOP 10 
				'CPEJ' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'CPE140305L14' Rfc,
				A.LicTradNum,
				CAST(CASE WHEN A.DocCur = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SB1CPEJ.dbo.OINV A
				JOIN HNT_CPEJ.sap.ECM2 B ON A.DocEntry = B.SrcObjAbs AND A.ObjType = B.SrcObjType
				LEFT JOIN sap.Document_QR X ON X.ObjType = A.ObjType AND Empresa = 'CPEJ' AND A.DocEntry = X.DocEntry
			WHERE 
				X.DocEntry IS NULL and 
				isnull(B.ReportId, '') != ''
				AND A.CreateDate >= DATEADD(dd,-10, GETDATE())
			/*********************************/
			UNION ALL
			SELECT TOP 10 
				'SERVIMP' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'SIP151109AX2' Rfc,
				A.LicTradNum,
				CAST(CASE WHEN A.DocCur = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SBOSERVIMPO.dbo.OINV A
				JOIN HNT_TRZ.sap.ECM2_SERVIMPO B ON A.DocEntry = B.SrcObjAbs AND A.ObjType = B.SrcObjType
				LEFT JOIN sap.Document_QR X ON X.ObjType = A.ObjType AND Empresa = 'SERVIMP' AND A.DocEntry = X.DocEntry
			WHERE 
				X.DocEntry IS NULL and 
				isnull(B.ReportId, '') != ''
				AND A.CreateDate >= DATEADD(dd,-10, GETDATE())
			/*********************************/
			UNION ALL
			SELECT TOP 10 
				'SERVCORP' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'SCP131003ITA' Rfc,
				A.LicTradNum,
				CAST(CASE WHEN A.DocCur = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SERVCORP.dbo.OINV A
				JOIN HNT_TRZ.sap.ECM2_SERVCORP B ON A.DocEntry = B.SrcObjAbs AND A.ObjType = B.SrcObjType
				LEFT JOIN sap.Document_QR X ON X.ObjType = A.ObjType AND Empresa = 'SERVCORP' AND A.DocEntry = X.DocEntry
			WHERE 
				X.DocEntry IS NULL and 
				isnull(B.ReportId, '') != ''
				AND A.CreateDate >= DATEADD(dd,-10, GETDATE())
			UNION ALL
			SELECT TOP 10 
				'DTRZ' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'DTZ1905289A2' Rfc,
				A.LicTradNum,
				CAST(CASE WHEN A.DocCur = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SBODTRZ.dbo.OINV A
				JOIN HNT_TRZ.sap.ECM2_DTRZ B ON A.DocEntry = B.SrcObjAbs AND A.ObjType = B.SrcObjType
				LEFT JOIN sap.Document_QR X ON X.ObjType = A.ObjType AND Empresa = 'DTRZ' AND A.DocEntry = X.DocEntry
			WHERE 
				X.DocEntry IS NULL and 
				isnull(B.ReportId, '') != ''
				AND A.CreateDate >= DATEADD(dd,-10, GETDATE())
			UNION ALL
			SELECT TOP 10 
				'WISER' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'WFI230707229' Rfc,
				A.LicTradNum,
				CAST(CASE WHEN A.DocCur = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SBOWISER.dbo.OINV A
				JOIN HNT_TRZ.sap.ECM2_WISER B ON A.DocEntry = B.SrcObjAbs AND A.ObjType = B.SrcObjType
				LEFT JOIN sap.Document_QR X ON X.ObjType = A.ObjType AND Empresa = 'WISER' AND A.DocEntry = X.DocEntry
			WHERE 
				X.DocEntry IS NULL and 
				isnull(B.ReportId, '') != ''
				AND A.CreateDate >= DATEADD(dd,-10, GETDATE())
			UNION ALL
			SELECT TOP 10 
				'AWISER' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'AWI240731BC8' Rfc,
				A.LicTradNum,
				CAST(CASE WHEN A.DocCur = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SBOWISER.dbo.OINV A
				JOIN HNT_TRZ.sap.ECM2_AWISER B ON A.DocEntry = B.SrcObjAbs AND A.ObjType = B.SrcObjType
				LEFT JOIN sap.Document_QR X ON X.ObjType = A.ObjType AND Empresa = 'AWISER' AND A.DocEntry = X.DocEntry
			WHERE 
				X.DocEntry IS NULL and 
				isnull(B.ReportId, '') != ''
				AND A.CreateDate >= DATEADD(dd,-10, GETDATE())
			ORDER BY DOCDATE DESC
		END	
		IF(@ObjType = 14)
		BEGIN
			Select TOP 10
				'CTR' Empresa,	
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'CTZ190712MB1' Rfc,
				A.LicTradNum,
				CAST(CASE WHEN A.DocCur = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SBOCTRZ.dbo.ORIN A
				JOIN SBOCTRZ.dbo.ECM2 B ON A.DocEntry = B.SrcObjAbs AND A.ObjType = B.SrcObjType
				LEFT JOIN sap.Document_QR X ON X.ObjType = A.ObjType AND Empresa = 'CTR' AND A.DocEntry = X.DocEntry
			WHERE 
				X.DocEntry IS NULL and
				isnull(B.ReportId, '') != '' 
				AND A.CreateDate >= DATEADD(dd,-10, GETDATE())
			--AND A.DocDate between '2019-01-01' and '2019-01-31' --= CAST(GETDATE() AS DATE)
			--ORDER BY DOCDATE DESC
			UNION ALL
			SELECT TOP 10 
				'CTR' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'CTZ190712MB1' Rfc,
				A.LicTradNum,
				CAST(CASE WHEN A.DocCur = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SBOCTRZ.dbo.ORIN A
				JOIN HNT_TRZ.sap.ECM2_CTRZ B ON A.DocEntry = B.SrcObjAbs AND A.ObjType = B.SrcObjType
				LEFT JOIN sap.Document_QR X ON X.ObjType = A.ObjType AND Empresa = 'CTR' AND A.DocEntry = X.DocEntry
			WHERE 
				X.DocEntry IS NULL AND
				isnull(B.ReportId, '') != ''
				AND A.CreateDate >= DATEADD(dd,-10, GETDATE())
			--SE AGREGA LOGISTICA
			UNION ALL
			SELECT TOP 10 
				'LOGTRA' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'LTP160708I34' Rfc,
				A.LicTradNum,
				CAST(CASE WHEN A.DocCur = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SBOLOGTRANSP.dbo.ORIN A
				JOIN HNT_TRZ.sap.ECM2_LOGTRA B ON A.DocEntry = B.SrcObjAbs AND A.ObjType = B.SrcObjType				
				LEFT JOIN sap.Document_QR X ON X.ObjType = A.ObjType AND Empresa = 'LOGTRA' AND A.DocEntry = X.DocEntry
			WHERE 
				X.DocEntry IS NULL 
				AND isnull(B.ReportId, '') != ''
				AND A.CreateDate >= DATEADD(dd,-10, GETDATE())
			/*********************************/
			UNION ALL
			SELECT TOP 10 
				'CPEJ' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'CPE140305L14' Rfc,
				A.LicTradNum,
				CAST(CASE WHEN A.DocCur = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SB1CPEJ.dbo.ORIN A
				JOIN HNT_CPEJ.sap.ECM2 B ON A.DocEntry = B.SrcObjAbs AND A.ObjType = B.SrcObjType				
				LEFT JOIN sap.Document_QR X ON X.ObjType = A.ObjType AND Empresa = 'CPEJ' AND A.DocEntry = X.DocEntry
			WHERE 
				X.DocEntry IS NULL 
				AND isnull(B.ReportId, '') != ''
				AND A.CreateDate >= DATEADD(dd,-10, GETDATE())
			/*********************************/
			UNION ALL
			SELECT TOP 10 
				'SERVIMP' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'SIP151109AX2' Rfc,
				A.LicTradNum,
				CAST(CASE WHEN A.DocCur = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SBOSERVIMPO.dbo.ORIN A
				JOIN HNT_TRZ.sap.ECM2_SERVIMPO B ON A.DocEntry = B.SrcObjAbs AND A.ObjType = B.SrcObjType
				LEFT JOIN sap.Document_QR X ON X.ObjType = A.ObjType AND Empresa = 'SERVIMP' AND A.DocEntry = X.DocEntry
			WHERE 
				X.DocEntry IS NULL AND ISNULL(B.ReportId, '') != ''
				AND A.CreateDate >= DATEADD(dd,-10, GETDATE())
			/*********************************/
			UNION ALL
			SELECT TOP 10 
				'SERVCORP' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'SCP131003ITA' Rfc,
				A.LicTradNum,
				CAST(CASE WHEN A.DocCur = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SERVCORP.dbo.ORIN A
				JOIN HNT_TRZ.sap.ECM2_SERVCORP B ON A.DocEntry = B.SrcObjAbs AND A.ObjType = B.SrcObjType
				LEFT JOIN sap.Document_QR X ON X.ObjType = A.ObjType AND Empresa = 'SERVCORP' AND A.DocEntry = X.DocEntry
			WHERE 
				X.DocEntry IS NULL AND ISNULL(B.ReportId, '') != ''
				AND A.CreateDate >= DATEADD(dd,-10, GETDATE())
			UNION ALL
			SELECT TOP 10 
				'DTRZ' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'DTZ1905289A2' Rfc,
				A.LicTradNum,
				CAST(CASE WHEN A.DocCur = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SBODTRZ.dbo.ORIN A
				JOIN HNT_TRZ.sap.ECM2_DTRZ B ON A.DocEntry = B.SrcObjAbs AND A.ObjType = B.SrcObjType
				LEFT JOIN sap.Document_QR X ON X.ObjType = A.ObjType AND Empresa = 'DTRZ' AND A.DocEntry = X.DocEntry
			WHERE 
				X.DocEntry IS NULL AND ISNULL(B.ReportId, '') != ''
				AND A.CreateDate >= DATEADD(dd,-10, GETDATE())
			UNION ALL
			SELECT TOP 10 
				'WISER' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'WFI230707229' Rfc,
				A.LicTradNum,
				CAST(CASE WHEN A.DocCur = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SBOWISER.dbo.ORIN A
				JOIN HNT_TRZ.sap.ECM2_WISER B ON A.DocEntry = B.SrcObjAbs AND A.ObjType = B.SrcObjType
				LEFT JOIN sap.Document_QR X ON X.ObjType = A.ObjType AND Empresa = 'WISER' AND A.DocEntry = X.DocEntry
			WHERE 
				X.DocEntry IS NULL AND ISNULL(B.ReportId, '') != ''
				AND A.CreateDate >= DATEADD(dd,-10, GETDATE())
			UNION ALL
			SELECT TOP 10 
				'AWISER' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'AWI240731BC8' Rfc,
				A.LicTradNum,
				CAST(CASE WHEN A.DocCur = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SBOWISER.dbo.ORIN A
				JOIN HNT_TRZ.sap.ECM2_AWISER B ON A.DocEntry = B.SrcObjAbs AND A.ObjType = B.SrcObjType
				LEFT JOIN sap.Document_QR X ON X.ObjType = A.ObjType AND Empresa = 'AWISER' AND A.DocEntry = X.DocEntry
			WHERE 
				X.DocEntry IS NULL AND ISNULL(B.ReportId, '') != ''
				AND A.CreateDate >= DATEADD(dd,-10, GETDATE())
			ORDER BY DOCDATE DESC
			
		END	
		IF(@ObjType = 24)
		BEGIN
			Select TOP 10
				'CTR' Empresa,	
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'CTZ190712MB1' Rfc,
				C.LicTradNum,
				CAST(CASE WHEN A.DocCurr = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SBOCTRZ.dbo.ORCT A
				JOIN SBOCTRZ.dbo.ECM2 B ON A.DocEntry = B.SrcObjAbs AND B.SrcObjType = 24
				JOIN SBOCTRZ.dbo.OCRD C ON A.CardCode = C.CardCode
			WHERE 
				A.DocEntry Not IN (Select X.DocEntry From sap.Document_QR X WHERE X.ObjType = 24 AND Empresa = 'CTR') AND
				isnull(B.ReportId, '') != '' 
				--AND A.DocDate between '2019-01-01' and '2019-01-31' --= CAST(GETDATE() AS DATE)
				--ORDER BY DOCDATE DESC
			UNION ALL
			SELECT TOP 10 
				'CTR' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'CTZ190712MB1' Rfc,
				C.LicTradNum,
				CAST(CASE WHEN A.DocCurr = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SBOCTRZ.dbo.ORCT A
				JOIN HNT_TRZ.sap.ECM2_CTRZ B ON A.DocEntry = B.SrcObjAbs AND B.SrcObjType = 24
				JOIN SBOCTRZ.dbo.OCRD C ON A.CardCode = C.CardCode
			WHERE 
				A.DocEntry Not IN (Select X.DocEntry From sap.Document_QR X WHERE X.ObjType = 24 AND Empresa = 'CTR') and 
				isnull(B.ReportId, '') != ''
			--SE AGREGA LOGISTICA
			UNION ALL
			SELECT TOP 10 
				'LOGTRA' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'LTP160708I34' Rfc,
				C.LicTradNum,
				CAST(CASE WHEN A.DocCurr = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SBOLOGTRANSP.dbo.ORCT A
				JOIN HNT_TRZ.sap.ECM2_LOGTRA B ON A.DocEntry = B.SrcObjAbs AND B.SrcObjType = 24
				JOIN SBOLOGTRANSP.dbo.OCRD C ON A.CardCode = C.CardCode
			WHERE 
				A.DocEntry Not IN (Select X.DocEntry From sap.Document_QR X WHERE X.ObjType = 24 AND Empresa = 'LOGTRA') and 
				isnull(B.ReportId, '') != ''
			/*********************************/
			UNION ALL
			SELECT TOP 10 
				'CPEJ' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'CPE140305L14' Rfc,
				C.LicTradNum,
				CAST(CASE WHEN A.DocCurr = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SB1CPEJ.dbo.ORCT A
				JOIN HNT_CPEJ.sap.ECM2 B ON A.DocEntry = B.SrcObjAbs AND B.SrcObjType = 24
				JOIN SB1CPEJ.dbo.OCRD C ON A.CardCode = C.CardCode
			WHERE 
				A.DocEntry Not IN (Select X.DocEntry From sap.Document_QR X WHERE X.ObjType = 24 AND Empresa = 'CPEJ') and 
				isnull(B.ReportId, '') != ''
			/*********************************/
			UNION ALL
			SELECT TOP 10 
				'SERVIMP' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'SIP151109AX2' Rfc,
				C.LicTradNum,
				CAST(CASE WHEN A.DocCurr = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SBOSERVIMPO.dbo.ORCT A
				JOIN HNT_TRZ.sap.ECM2_SERVIMPO B ON A.DocEntry = B.SrcObjAbs AND B.SrcObjType = 24
				JOIN SBOSERVIMPO.dbo.OCRD C ON A.CardCode = C.CardCode
			WHERE 
				A.DocEntry Not IN (Select X.DocEntry From sap.Document_QR X WHERE X.ObjType = 24 AND Empresa = 'SERVIMP') and 
				isnull(B.ReportId, '') != ''
			/*********************************/
			UNION ALL
			SELECT TOP 10 
				'SERVCORP' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'SCP131003ITA' Rfc,
				C.LicTradNum,
				CAST(CASE WHEN A.DocCurr = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SERVCORP.dbo.ORCT A
				JOIN HNT_TRZ.sap.ECM2_SERVCORP B ON A.DocEntry = B.SrcObjAbs AND B.SrcObjType = 24
				JOIN SERVCORP.dbo.OCRD C ON A.CardCode = C.CardCode
			WHERE 
				A.DocEntry Not IN (Select X.DocEntry From sap.Document_QR X WHERE X.ObjType = 24 AND Empresa = 'SERVCORP') and 
				isnull(B.ReportId, '') != ''
			UNION ALL
			SELECT TOP 10 
				'DTRZ' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'DTZ1905289A2' Rfc,
				C.LicTradNum,
				CAST(CASE WHEN A.DocCurr = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SBODTRZ.dbo.ORCT A
				JOIN HNT_TRZ.sap.ECM2_DTRZ B ON A.DocEntry = B.SrcObjAbs AND B.SrcObjType = 24
				JOIN SBODTRZ.dbo.OCRD C ON A.CardCode = C.CardCode
			WHERE 
				A.DocEntry Not IN (Select X.DocEntry From sap.Document_QR X WHERE X.ObjType = 24 AND Empresa = 'DTRZ') and 
				isnull(B.ReportId, '') != ''
			UNION ALL
			SELECT TOP 10 
				'WISER' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'WFI230707229' Rfc,
				C.LicTradNum,
				CAST(CASE WHEN A.DocCurr = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SBOWISER.dbo.ORCT A
				JOIN HNT_TRZ.sap.ECM2_WISER B ON A.DocEntry = B.SrcObjAbs AND B.SrcObjType = 24
				JOIN SBOWISER.dbo.OCRD C ON A.CardCode = C.CardCode
			WHERE 
				A.DocEntry Not IN (Select X.DocEntry From sap.Document_QR X WHERE X.ObjType = 24 AND Empresa = 'WISER') and 
				isnull(B.ReportId, '') != ''
			SELECT TOP 10 
				'AWISER' Empresa,
				A.ObjType, 
				A.DocEntry,
				B.ReportId,
				'AWI240731BC8' Rfc,
				C.LicTradNum,
				CAST(CASE WHEN A.DocCurr = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
				RIGHT(CAST(U_B1SYS_SignDigest AS VARCHAR(MAX)), 8) Sello,
				A.DocDate
			FROM SBOWISER.dbo.ORCT A
				JOIN HNT_TRZ.sap.ECM2_AWISER B ON A.DocEntry = B.SrcObjAbs AND B.SrcObjType = 24
				JOIN SBOWISER.dbo.OCRD C ON A.CardCode = C.CardCode
			WHERE 
				A.DocEntry Not IN (Select X.DocEntry From sap.Document_QR X WHERE X.ObjType = 24 AND Empresa = 'AWISER') and 
				isnull(B.ReportId, '') != ''
			ORDER BY DOCDATE DESC
		END	
	END

	--IF @tipoconsulta = 104 --documentos auorizados y pendientes
	--BEGIN
	--	Select @Rol = Rol From hnt.Usuarios Where UserID = @userID

	--	SET @QRY = '
 --           SELECT * FROM 
 --           (
 --               SELECT --TOP 300
 --                   0 WtmCode,
 --                   0 WddCode,
 --                   0 StepCode,
 --                   c.ObjType,
 --                   c.DocEntry ,
 --                   F.CardCode + '' - '' + f.CardName [Cliente],
 --                   case when c.ObjType=17 then ''Pedido'' 
 --                       when c.ObjType=13 then ''Factura'' 
 --                       when c.ObjType=15 then ''Entrega'' 
 --                       when c.ObjType=14 then ''Nota de crédito'' 
 --                       when c.ObjType=16 then ''Devolución'' 
 --                       when c.ObjType=20 then ''Entrada de mercancías'' 
 --                       when c.ObjType=22 then ''Pedido de proveedor''
 --                       else ''Documento'' 
 --                   end [Documento],
 --                   case when c.ObjType=17 then H1.DocNum 
 --                       when c.ObjType=13 then H3.DocNum 
 --                       when c.ObjType=14 then H4.DocNum 
 --                       when c.ObjType=15 then H2.DocNum
 --                       when c.ObjType=16 then H5.DocNum
 --                       when c.ObjType=20 then H6.DocNum
 --                       when c.ObjType=22 then H7.DocNum
 --                       else 0 
 --                   end [Doc Sap],
 --                   c.TransId [numDocEntry],
 --                   D.Nombre [Autor],
 --                   case 
 --                       when c.TransId > 0 then ''Creado'' 
 --                       else 
 --                           case when c.u_autorizado=''P'' then ''Pendiente (Autorización)'' 
 --                               when c.u_autorizado=''A'' then ''Autorizado'' 
 --                               when c.u_autorizado=''R'' then ''Rechazado'' 
 --                           else ''Pendiente'' 
 --                           end 
 --                   end Estado,
	--				isnull(c.u_oc,'''') [Orden de compra],
 --                   C.Comments [Comentarios],
 --                   CASE WHEN C.U_Autorizado = ''R'' THEN C.TaxInvNo ELSE C.PickRmrk END Detalles

	--				, sap.Get_StatusDocument(C.DocEntry, ''VENTAS'') [EstadoAut]

 --                   , ''Ver''	Ver
	--				, [dbo].[fu_hnt_Exceptions](C.PickRmrk, C.ObjType)[Timbrar]
 --               FROM  sap.ODRF C with (nolock)
 --                   LEFT JOIN hnt.Usuarios D with (nolock) ON D.UserID = C.U_FolioHalcon
 --                   LEFT JOIN SBOCTRZ.DBO.OCRD F with (nolock) ON C.CardCode COLLATE DATABASE_DEFAULT = F.CardCode
 --                   LEFT JOIN SBOCTRZ.DBO.ORDR H1 with (nolock) ON H1.DocEntry = C.TransId AND H1.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.ODLN H2 with (nolock) ON H2.DocEntry = C.TransId AND H2.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.OINV H3 with (nolock) ON H3.DocEntry = C.TransId AND H3.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.ORIN H4 with (nolock) ON H4.DocEntry = C.TransId AND H4.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.ORDN H5 with (nolock) ON H5.DocEntry = C.TransId AND H5.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.OPDN H6 with (nolock) ON H6.DocEntry = C.TransId AND H6.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.OPOR H7 with (nolock) ON H7.DocEntry = C.TransId AND H7.ObjType = C.ObjType
 --               WHERE cast(c.DocDate as date) between @Desde and @Hasta AND C.ObjType NOT IN (67)'
        
 --       SET @Qry += '
 --                   and D.UserID in (' + @Usuarios + ')' 

 --       SET @QRY += '
                        
 --               UNION ALL
                    
 --               SELECT --TOP 10
 --                   0 WtmCode,
 --                   0 WddCode,
 --                   0 StepCode,
 --                   c.ObjType,
 --                   ISNULL(c.DocEntry, 0),
 --                   C.CardCode + '' - '' + C.CardName  [Cliente],
 --                   ''Socio de negocios'' [Documento],
 --                   NULL [Doc Sap],
 --                   0 [numDocEntry],
 --                   D.Nombre [Autor],
                        
 --                   CASE WHEN C.U_Autorizado =''A'' THEN ''Alta Pendiente'' 
 --                           WHEN C.U_Autorizado =''U'' THEN ''Actualizaciones Pendientes'' 
 --                           WHEN C.U_Autorizado =''C'' THEN ''Cambios aplicados'' 
 --                           WHEN C.U_Autorizado =''p'' THEN ''Pendiente (Vaidacion Transaction)'' 
 --                           ELSE ''Pendiente'' 
 --                   END Estado,
 --                   '''' [Orden de compra],
 --                   '''' [Comentarios],
 --                   C.Notes Detalles

	--				, '''' [EstadoAut]

 --                   , ''Ver''	Ver
	--				, [dbo].[fu_hnt_Exceptions](C.Notes, C.ObjType)
 --               FROM sap.OCRD C 
 --                   JOIN hnt.Usuarios D with (nolock) ON D.UserID = C.UserSign
 --                   LEFT JOIN SBOCTRZ.DBO.OCRD E with (nolock) ON C.CardCode = E.CardCode
 --               WHERE CAST(C.UpdateDate AS DATE) = CAST(GETDATE() AS DATE) AND C.CardCode <> '''' '
            
 --       SET @Qry += '
 --                   and D.UserID in(' + @Usuarios + ')'


	--	SET @QRY += '
	--			UNION ALL

 --               SELECT 
 --                   0 WtmCode,
 --                   0 WddCode,
 --                   0 StepCode,
 --                   c.ObjType,
 --                   c.DocEntry ,
 --                   F.CardCode + '' - '' + f.CardName [Cliente],
 --                   case when c.ObjType=17 then ''Pedido'' 
 --                       when c.ObjType=13 then ''Factura'' 
 --                       when c.ObjType=15 then ''Entrega'' 
 --                       when c.ObjType=14 then ''Nota de crédito'' 
 --                       when c.ObjType=16 then ''Devolución'' 
 --                       when c.ObjType=20 then ''Entrada de mercancías'' 
 --                       when c.ObjType=22 then ''Pedido de proveedor''
 --                       else ''Documento'' 
 --                   end [Documento],
 --                   case when c.ObjType=17 then H1.DocNum 
 --                       when c.ObjType=13 then H3.DocNum 
 --                       when c.ObjType=14 then H4.DocNum 
 --                       when c.ObjType=15 then H2.DocNum
 --                       when c.ObjType=16 then H5.DocNum
 --                       when c.ObjType=20 then H6.DocNum
 --                       when c.ObjType=22 then H7.DocNum
 --                       else 0 
 --                   end [Doc Sap],
 --                   c.TransId [numDocEntry],
 --                   D.Nombre [Autor],
 --                   case 
 --                       when c.TransId > 0 then ''Creado'' 
 --                       else 
 --                           case when c.u_autorizado=''P'' then ''Pendiente (Autorización)'' 
 --                               when c.u_autorizado=''A'' then ''Autorizado'' 
 --                               when c.u_autorizado=''R'' then ''Rechazado'' 
 --                           else ''Pendiente'' 
 --                           end 
 --                   end Estado
 --                   ,isnull(c.u_oc,'''') [Orden de compra],
 --                   C.Comments [Comentarios],
 --                   CASE WHEN C.U_Autorizado = ''R'' THEN C.TaxInvNo ELSE C.PickRmrk END Detalles

	--				, sap.Get_StatusDocument(C.DocEntry, ''VENTAS'') [EstadoAut]

 --                   ,''Ver''	Ver
	--				, [dbo].[fu_hnt_Exceptions](C.PickRmrk, C.ObjType)
 --               FROM  sap.ODRF C with (nolock)
 --                   LEFT JOIN hnt.Usuarios D with (nolock) ON D.UserID = C.U_FolioHalcon
 --                   LEFT JOIN SBOCTRZ.DBO.OCRD F with (nolock) ON C.CardCode COLLATE DATABASE_DEFAULT = F.CardCode
 --                   LEFT JOIN SBOCTRZ.DBO.ORDR H1 with (nolock) ON H1.DocEntry = C.TransId AND H1.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.ODLN H2 with (nolock) ON H2.DocEntry = C.TransId AND H2.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.OINV H3 with (nolock) ON H3.DocEntry = C.TransId AND H3.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.ORIN H4 with (nolock) ON H4.DocEntry = C.TransId AND H4.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.ORDN H5 with (nolock) ON H5.DocEntry = C.TransId AND H5.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.OPDN H6 with (nolock) ON H6.DocEntry = C.TransId AND H6.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.OPOR H7 with (nolock) ON H7.DocEntry = C.TransId AND H7.ObjType = C.ObjType
	--				LEFT JOIN hnt.Usuarios E WITH (nolock) ON E.titular = C.EDocPrefix
 --               WHERE cast(c.DocDate as date) between @Desde and @Hasta AND C.ObjType NOT IN (67)
	--			AND ISNULL(C.FatherCard, '''') = ''MOVIL''
	--			'
	--			SET @Qry += '
	--					and E.UserID in (' + @Usuarios + ')'
				

 --       SET @QRY += ') T1
 --           ORDER BY 5 desc
 --           --OFFSET @skip ROWS
 --           --FETCH NEXT @pageSize ROWS ONLY'

	--	SET @Parametros = '@Desde DATE, @Hasta DATE, @userID INT, @skip INT, @pageSize INT'
	--	EXEC sp_executesql @QRY, @Parametros, @Desde, @Hasta, @userID, @skip, @pageSize
	--end

	IF @tipoconsulta = 104 --documentos autorizados y pendientes
	BEGIN
		Select @Rol = Rol From hnt.Usuarios Where UserID = @userID
		DECLARE @DocStatus VARCHAR(200) = '';
		DECLARE @DocStatusA VARCHAR(200) = '';
		IF @Rol = 17 
		BEGIN
		SET @DocStatus = 'CASE C.DocStatus When ''O'' Then ''Abierto'' When ''C'' Then ''Cerrado'' End [Estado_Documento],'
		SET @DocStatusA = ''''' [Estado_Documento],'
		END

		SET @QRY = '
            SELECT * FROM 
            (
                SELECT --TOP 300
				    '+@DocStatus+'					
                    0 WtmCode,
                    0 WddCode,
                    0 StepCode,
                    c.ObjType,
                    c.DocEntry ,
                    F.CardCode + '' - '' + f.CardName [Cliente],
                    case when c.ObjType=17 then ''Pedido'' 
                        when c.ObjType=13 then ''Factura'' 
                        when c.ObjType=15 then ''Entrega'' 
                        when c.ObjType=14 then ''Nota de crédito'' 
                        when c.ObjType=16 then ''Devolución'' 
                        when c.ObjType=20 then ''Entrada de mercancías'' 
                        when c.ObjType=22 then ''Pedido de proveedor''
                        else ''Documento'' 
                    end [Documento],
                    case when c.ObjType=17 then H1.DocNum 
                        when c.ObjType=13 then H3.DocNum 
                        when c.ObjType=14 then H4.DocNum 
                        when c.ObjType=15 then H2.DocNum
                        when c.ObjType=16 then H5.DocNum
                        when c.ObjType=20 then H6.DocNum
                        when c.ObjType=22 then H7.DocNum
                        else 0 
                    end [Doc Sap],
                    c.TransId [numDocEntry],
                    D.Nombre [Autor],
                    case 
                        when c.TransId > 0 then ''Creado'' 
                        else 
                            case when c.u_autorizado=''P'' then ''Pendiente (Autorización)'' 
                                when c.u_autorizado=''A'' then ''Autorizado'' 
                                when c.u_autorizado=''R'' then ''Rechazado'' 
                            else ''Pendiente'' 
                            end 
                    end Estado,
					isnull(c.u_oc,'''') [Orden de compra],
                    C.Comments [Comentarios],
                    CASE WHEN C.U_Autorizado = ''R'' THEN C.TaxInvNo ELSE C.PickRmrk END Detalles

					, sap.Get_StatusDocument(C.DocEntry, ''VENTAS'') [EstadoAut]

                    , ''Ver''	Ver
					, [dbo].[fu_hnt_Exceptions](C.PickRmrk, C.ObjType)[Timbrar]
                FROM  sap.ODRF C with (nolock)
                    LEFT JOIN hnt.Usuarios D with (nolock) ON D.UserID = C.U_FolioHalcon
                    LEFT JOIN SBOCTRZ.DBO.OCRD F with (nolock) ON C.CardCode COLLATE DATABASE_DEFAULT = F.CardCode
                    LEFT JOIN SBOCTRZ.DBO.ORDR H1 with (nolock) ON H1.DocEntry = C.TransId AND H1.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.ODLN H2 with (nolock) ON H2.DocEntry = C.TransId AND H2.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.OINV H3 with (nolock) ON H3.DocEntry = C.TransId AND H3.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.ORIN H4 with (nolock) ON H4.DocEntry = C.TransId AND H4.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.ORDN H5 with (nolock) ON H5.DocEntry = C.TransId AND H5.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.OPDN H6 with (nolock) ON H6.DocEntry = C.TransId AND H6.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.OPOR H7 with (nolock) ON H7.DocEntry = C.TransId AND H7.ObjType = C.ObjType
                WHERE cast(c.DocDate as date) between @Desde and @Hasta AND C.ObjType NOT IN (67)'
        
        SET @Qry += '
                    and D.UserID in (' + @Usuarios + ')' 

        SET @QRY += '
                        
                UNION ALL
                    
                SELECT --TOP 10
					 '+@DocStatusA+'	
                    0 WtmCode,
                    0 WddCode,
                    0 StepCode,
                    c.ObjType,
                    ISNULL(c.DocEntry, 0),
                    C.CardCode + '' - '' + C.CardName  [Cliente],
                    ''Socio de negocios'' [Documento],
                    NULL [Doc Sap],
                    0 [numDocEntry],
                    D.Nombre [Autor],
                        
                    CASE WHEN C.U_Autorizado =''A'' THEN ''Alta Pendiente'' 
                            WHEN C.U_Autorizado =''U'' THEN ''Actualizaciones Pendientes'' 
                            WHEN C.U_Autorizado =''C'' THEN ''Cambios aplicados'' 
                            WHEN C.U_Autorizado =''p'' THEN ''Pendiente (Vaidacion Transaction)'' 
                            ELSE ''Pendiente'' 
                    END Estado,
                    '''' [Orden de compra],
                    '''' [Comentarios],
                    C.Notes Detalles

					, '''' [EstadoAut]

                    , ''Ver''	Ver
					, [dbo].[fu_hnt_Exceptions](C.Notes, C.ObjType)
                FROM sap.OCRD C 
                    JOIN hnt.Usuarios D with (nolock) ON D.UserID = C.UserSign
                    LEFT JOIN SBOCTRZ.DBO.OCRD E with (nolock) ON C.CardCode = E.CardCode
                WHERE CAST(C.UpdateDate AS DATE) = CAST(GETDATE() AS DATE) AND C.CardCode <> '''' '
            
        SET @Qry += '
                    and D.UserID in(' + @Usuarios + ')'


		SET @QRY += '
				UNION ALL

                SELECT 
					'+@DocStatus+'	
                    0 WtmCode,
                    0 WddCode,
                    0 StepCode,
                    c.ObjType,
                    c.DocEntry ,
                    F.CardCode + '' - '' + f.CardName [Cliente],
                    case when c.ObjType=17 then ''Pedido'' 
                        when c.ObjType=13 then ''Factura'' 
                        when c.ObjType=15 then ''Entrega'' 
                        when c.ObjType=14 then ''Nota de crédito'' 
                        when c.ObjType=16 then ''Devolución'' 
                        when c.ObjType=20 then ''Entrada de mercancías'' 
                        when c.ObjType=22 then ''Pedido de proveedor''
                        else ''Documento'' 
                    end [Documento],
                    case when c.ObjType=17 then H1.DocNum 
                        when c.ObjType=13 then H3.DocNum 
                        when c.ObjType=14 then H4.DocNum 
                        when c.ObjType=15 then H2.DocNum
                        when c.ObjType=16 then H5.DocNum
                        when c.ObjType=20 then H6.DocNum
                        when c.ObjType=22 then H7.DocNum
                        else 0 
                    end [Doc Sap],
                    c.TransId [numDocEntry],
                    D.Nombre [Autor],
                    case 
                        when c.TransId > 0 then ''Creado'' 
                        else 
                            case when c.u_autorizado=''P'' then ''Pendiente (Autorización)'' 
                                when c.u_autorizado=''A'' then ''Autorizado'' 
                                when c.u_autorizado=''R'' then ''Rechazado'' 
                            else ''Pendiente'' 
                            end 
                    end Estado
                    ,isnull(c.u_oc,'''') [Orden de compra],
                    C.Comments [Comentarios],
                    CASE WHEN C.U_Autorizado = ''R'' THEN C.TaxInvNo ELSE C.PickRmrk END Detalles

					, sap.Get_StatusDocument(C.DocEntry, ''VENTAS'') [EstadoAut]

                    ,''Ver''	Ver
					, [dbo].[fu_hnt_Exceptions](C.PickRmrk, C.ObjType)
                FROM  sap.ODRF C with (nolock)
                    LEFT JOIN hnt.Usuarios D with (nolock) ON D.UserID = C.U_FolioHalcon
                    LEFT JOIN SBOCTRZ.DBO.OCRD F with (nolock) ON C.CardCode COLLATE DATABASE_DEFAULT = F.CardCode
                    LEFT JOIN SBOCTRZ.DBO.ORDR H1 with (nolock) ON H1.DocEntry = C.TransId AND H1.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.ODLN H2 with (nolock) ON H2.DocEntry = C.TransId AND H2.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.OINV H3 with (nolock) ON H3.DocEntry = C.TransId AND H3.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.ORIN H4 with (nolock) ON H4.DocEntry = C.TransId AND H4.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.ORDN H5 with (nolock) ON H5.DocEntry = C.TransId AND H5.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.OPDN H6 with (nolock) ON H6.DocEntry = C.TransId AND H6.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.OPOR H7 with (nolock) ON H7.DocEntry = C.TransId AND H7.ObjType = C.ObjType
					LEFT JOIN hnt.Usuarios E WITH (nolock) ON E.titular = C.EDocPrefix
                WHERE cast(c.DocDate as date) between @Desde and @Hasta AND C.ObjType NOT IN (67)
				AND ISNULL(C.FatherCard, '''') = ''MOVIL''
				'
				SET @Qry += '
						and E.UserID in (' + @Usuarios + ')'
				

        SET @QRY += ') T1
            ORDER BY 5 desc
            --OFFSET @skip ROWS
            --FETCH NEXT @pageSize ROWS ONLY'

		SET @Parametros = '@Desde DATE, @Hasta DATE, @userID INT, @skip INT, @pageSize INT'
		EXEC sp_executesql @QRY, @Parametros, @Desde, @Hasta, @userID, @skip, @pageSize
	end



	/*
	IF @TipoConsulta = 105
	BEGIN
		SET @QRY = '
			SELECT top 3 * 
			FROM(
				Select 
					ObjType, DocEntry
				From(
					Select  
						ROW_NUMBER() OVER(Partition By CardCode Order By A.DocEntry) Num,
						A.DocEntry, 
						A.ObjType,
						CardCode,
						SUM(CASE WHEN B.Status IN (''W'', ''N'') THEN 1 ELSE 0 END) Errores 
					From 
						sap.ODRF A
							LEFT JOIN sap.OWDD B ON A.DocEntry = B.Docentry AND A.Objtype = B.Objtype
					Where 
						A.ObjType in (17, 13, 15)
						AND TransID IS NULL
						AND U_Autorizado = ''A''
						AND ISNULL(FatherCard, '''') <> ''MOVIL''
						AND A.DocDate between dateadd(dd, -5, GETDATE()) AND CAST(GETDATE() AS DATE)	
					GROUP BY 
						A.DocEntry, A.ObjType, CardCode
					)T0
				Where Errores = 0 -- PARA VALIDAR QUE LOS DOCS GENERADOS QUE TENGAN UN MODELO DE AUTORIZACION YA ESTEN AUTORIZADOS
				
				union all
				Select ObjType, DocEntry From sap.ODRF 
				Where TransID IS NULL and objtype = 17
					AND (U_Autorizado = ''A'')
					AND ISNULL(FatherCard, '''') = ''MOVIL''
				union all
				Select  ObjType, DocEntry From sap.ODRF Where TransID IS NULL and objtype = 67
				union all
				Select  ObjType, DocEntry From sap.ODRF Where TransID IS NULL and objtype in(14, 16) AND U_Autorizado = ''A''
				union all
				Select TOP 2 ObjType, DocEntry From sap.ODRF Where TransID IS NULL and objtype in(20) AND U_Autorizado = ''A''
				union all
				Select TOP 2 ObjType, DocEntry From sap.ODRF Where TransID IS NULL and objtype IN(18, 19) AND DocType = ''I''
				union all
				Select TOP 2 ObjType, DocEntry From sap.ODRF Where TransID IS NULL and objtype IN(18) AND DocType = ''S'' AND U_Autorizado = ''A''
				union all
				Select TOP 2 ODRF.ObjType, ODRF.DocEntry From sap.ODRF
					JOIN SBOCTRZ.DBO.OCRD ON ODRF.CardCode = OCRD.CardCode
				Where TransID IS NULL and ODRF.ObjType = 22 AND U_Autorizado = ''A'' AND OCRD.QryGroup44 = ''N''
					AND DocType = ''I''
				UNION ALL
				Select TOP 2 ODRF.ObjType, ODRF.DocEntry From sap.ODRF
					JOIN SBOCTRZ.DBO.OCRD ON ODRF.CardCode = OCRD.CardCode
				Where TransID IS NULL and ODRF.ObjType = 22 AND U_Autorizado = ''A'' AND ODRF.Transfered = ''Y''
				UNION ALL
				Select TOP 2 ObjType, DocEntry From sap.ODRF Where TransID IS NULL and objtype = 22 AND DocType = ''S'' AND U_Autorizado = ''A''
				UNION ALL
				Select TOP 2 ObjType, DocEntry From sap.ODRF Where TransID IS NULL and objtype in(59, 60) AND U_Autorizado = ''A''
				UNION ALL
				Select TOP 2 ObjType, DocNum From sap.OVPM Where TransID IS NULL AND U_Autorizado = ''A''
				)T0 
			WHERE ObjType in (0 ' + CASE WHEN @U_Edocnum != '' THEN ',' ELSE '' END  + @U_Edocnum + ')
				AND DocEntry NOT IN(1355726) /*DOCNUMENTO PRUEBA PEMIJUMO LISTAS DE PRECIO*/
			ORDER BY ObjType DESC, DocEntry ASC 
				'
				--print @QRY
		EXECUTE sp_executesql @QRY
	END
	*/
	IF @TipoConsulta = 105
	BEGIN
		SET @QRY = '
		SELECT 
			ObjType, DocEntry
		FROM(
			SELECT 
				ObjType, DocEntry
			FROM(
				SELECT  
					ROW_NUMBER() OVER(Partition By CardCode Order By A.DocEntry) Num,
					A.DocEntry, 
					A.ObjType,
					CardCode,
					SUM(CASE WHEN B.Status IN (''W'', ''N'') THEN 1 ELSE 0 END) Errores 
				FROM sap.ODRF A
				LEFT JOIN sap.OWDD B ON A.DocEntry = B.Docentry AND A.Objtype = B.Objtype
				WHERE 
					A.ObjType in (17, 13, 15)
					AND TransID IS NULL
					AND U_Autorizado = ''A''
					AND A.DocDate BETWEEN DATEADD(DAY, -10, GETDATE()) AND CAST(GETDATE() AS DATE)	
				GROUP BY 
					A.DocEntry, A.ObjType, CardCode
				)T0	
			WHERE Errores = 0 --PARA VALIDAR QUE LOS DOCS GENERADOS QUE TENGAN UN MODELO DE AUTORIZACION YA ESTEN AUTORIZADOS
			UNION ALL
			SELECT ObjType, DocEntry FROM sap.ODRF 
			WHERE TransID IS NULL 
				AND ObjType IN (14, 16, 20, 59, 60) 
				AND U_Autorizado = ''A'' 
				AND CAST(CreateDate AS DATE) BETWEEN CAST(DATEADD(DAY, -10, GETDATE())AS DATE) AND CAST(GETDATE()AS DATE)
			UNION ALL
			SELECT ObjType, DocEntry FROM sap.ODRF WHERE TransID IS NULL AND ObjType IN (18, 22) AND DocType = ''S'' AND U_Autorizado = ''A'' AND U_Autorizado = ''A'' AND CAST(CreateDate AS DATE) BETWEEN CAST(DATEADD(DAY, -10, GETDATE())AS DATE) AND CAST(GETDATE()AS DATE)
			UNION ALL
			SELECT ObjType, DocEntry FROM sap.ODRF WHERE TransID IS NULL AND ObjType IN(18, 19) AND DocType = ''I'' AND CAST(CreateDate AS DATE) BETWEEN CAST(DATEADD(DAY, -10, GETDATE())AS DATE) AND CAST(GETDATE()AS DATE)
			UNION ALL
			SELECT ObjType, DocEntry FROM sap.ODRF WHERE TransID IS NULL AND ObjType IN (67) AND CAST(CreateDate AS DATE) BETWEEN CAST(DATEADD(DAY, -10, GETDATE())AS DATE) AND CAST(GETDATE()AS DATE) AND U_Autorizado = ''A''
			UNION ALL
			SELECT ODRF.ObjType, ODRF.DocEntry FROM sap.ODRF JOIN SBOCTRZ.DBO.OCRD ON ODRF.CardCode = OCRD.CardCode WHERE TransID IS NULL and ODRF.ObjType = 22 AND U_Autorizado = ''A'' AND OCRD.QryGroup44 = ''N'' AND DocType = ''I'' AND CAST(ODRF.CreateDate AS DATE) BETWEEN CAST(DATEADD(DAY, -10, GETDATE())AS DATE) AND CAST(GETDATE()AS DATE)
			UNION ALL
			SELECT ODRF.ObjType, ODRF.DocEntry FROM sap.ODRF JOIN SBOCTRZ.DBO.OCRD ON ODRF.CardCode = OCRD.CardCode WHERE TransID IS NULL and ODRF.ObjType = 22 AND U_Autorizado = ''A'' AND ODRF.Transfered = ''Y'' AND CAST(ODRF.CreateDate AS DATE) BETWEEN CAST(DATEADD(DAY, -10, GETDATE())AS DATE) AND CAST(GETDATE()AS DATE)
			UNION ALL
			SELECT ObjType, DocNum FROM sap.OVPM WHERE TransID IS NULL AND U_Autorizado = ''A''-- AND CAST(DocDate AS DATE) BETWEEN CAST(DATEADD(DAY, -10, GETDATE())AS DATE) AND CAST(GETDATE()AS DATE)
			UNION ALL
			SELECT 162[ObjType], DocEntry FROM sap.OMRV WHERE TransId IS NULL AND U_Autorizado = ''A''
		)T0 
		WHERE 
			ObjType in (0 ' + CASE WHEN @U_Edocnum != '' THEN ',' ELSE '' END  + @U_Edocnum + ')
		ORDER BY ObjType DESC, DocEntry ASC'
		EXECUTE sp_executesql @QRY
	END

	IF @TipoConsulta = 106
	BEGIN
		SET @QRY = '
		SELECT  ''U_'' + AliasID AliasID FROM ' + @CIA + '.dbo.CUFD Where TableID in(''OINV'')
		'
		EXECUTE sp_executesql @QRY
	END

	IF @TipoConsulta = 107
	BEGIN
		SET @QRY = '
		SELECT  ''U_'' + AliasID AliasID FROM ' + @CIA + '.dbo.CUFD Where TableID in(''INV1'')
		'
		EXECUTE sp_executesql @QRY
	END

	IF @TipoConsulta = 108
	BEGIN
		SELECT 
			B.ItemCode
			, B.ItemName
			, D.Price
			, F.Price PC
			, A.Quantity
			, C.OnHand
			, B.NCMCode
			, B.ManBtchNum
			, G.ItmsGrpNam
		FROM 
			sap.OITT A
			JOIN SBOCTRZ.dbo.OITM B ON A.ItemCode = B.ItemCode
			JOIN SBOCTRZ.dbo.OITW C ON A.ItemCode = C.ItemCode AND C.WhsCode = @WhsCode
			JOIN SBOCTRZ.dbo.ITM1 D ON A.ItemCode = D.ItemCode 
			JOIN SBOCTRZ.dbo.OCRD E ON E.CardCode = @CardCode AND D.PriceList = E.ListNum
			JOIN SBOCTRZ.dbo.ITM1 F ON A.ItemCode = F.ItemCode AND F.PriceList = 11
			LEFT JOIN SBOCTRZ.dbo.OITB G ON G.ItmsGrpCod = ISNULL(B.U_Itmsgrpcod, B.ItmsGrpCod)
		WHERE A.Parent = @ItemCode
	END

	IF @TipoConsulta = 109
	BEGIN
		SELECT * FROM SBOCTRZ.dbo.OITW
		WHERE ItemCode = @ItemCode AND WhsCode = @WhsCode
	END

	IF @TipoConsulta = 110
	BEGIN
		IF EXISTS(SELECT * FROM sap.ECM2_CTRZ where SrcObjAbs = @DocEntry AND SrcObjType = @ObjType AND ActStatus = 'N' AND GenType = 'G')
		BEGIN
			UPDATE sap.ECM2_CTRZ SET ActStatus = 'P' where SrcObjAbs = @DocEntry AND SrcObjType = @ObjType AND ActStatus = 'N' AND GenType = 'G'
		END
	END

	----documentos auorizados y pendientes Nw Version
	--IF @tipoconsulta = 111 
	--BEGIN
	--	Select @Rol = Rol From hnt.Usuarios Where UserID = @userID

	--	SET @QRY = '
 --           SELECT * FROM 
 --           (
 --               SELECT
 --                   0 WtmCode,
 --                   0 WddCode,
 --                   0 StepCode,
 --                   c.ObjType,
 --                   c.DocEntry [Numero de documento],
 --                   F.CardCode + '' - '' + f.CardName [Cliente],
 --                   case when c.ObjType=17 then ''Pedido'' 
 --                       when c.ObjType=13 then ''Factura'' 
 --                       when c.ObjType=15 then ''Entrega'' 
 --                       when c.ObjType=14 then ''Nota de crédito'' 
 --                       when c.ObjType=16 then ''Devolución'' 
 --                       when c.ObjType=20 then ''Entrada de mercancías'' 
 --                       when c.ObjType=22 then ''Pedido de proveedor''
 --                       else ''Documento'' 
 --                   end [Documento],
 --                   case when c.ObjType=17 then H1.DocNum 
 --                       when c.ObjType=13 then H3.DocNum 
 --                       when c.ObjType=14 then H4.DocNum 
 --                       when c.ObjType=15 then H2.DocNum
 --                       when c.ObjType=16 then H5.DocNum
 --                       when c.ObjType=20 then H6.DocNum
 --                       when c.ObjType=22 then H7.DocNum
 --                       else 0 
 --                   end [Documento SAP],
 --                   c.TransId [numDocEntry],
 --                   D.Nombre [Autor],
 --                   case 
 --                       when c.TransId > 0 then ''Creado'' 
 --                       else 
 --                           case when c.u_autorizado=''P'' then ''Pendiente (Autorización)'' 
 --                               when c.u_autorizado=''A'' then ''Autorizado'' 
 --                               when c.u_autorizado=''R'' then ''Rechazado'' 
 --                           else ''Pendiente'' 
 --                           end 
 --                   end Estado,
	--				isnull(c.u_oc,'''') [Orden de compra],
 --                   C.Comments [Comentarios]
	--				, sap.Get_StatusDocument(C.DocEntry, ''VENTAS'') [Estado Aut]
 --                   , CASE WHEN C.U_Autorizado = ''R'' THEN C.TaxInvNo ELSE C.PickRmrk END Detalles
 --                   , ''Ver''	Ver
	--				, [dbo].[fu_hnt_Exceptions](C.PickRmrk, C.ObjType)[Timbrar]
 --               FROM  sap.ODRF C with (nolock)
 --                   LEFT JOIN hnt.Usuarios D with (nolock) ON D.UserID = C.U_FolioHalcon
 --                   LEFT JOIN SBOCTRZ.DBO.OCRD F with (nolock) ON C.CardCode COLLATE DATABASE_DEFAULT = F.CardCode
 --                   LEFT JOIN SBOCTRZ.DBO.ORDR H1 with (nolock) ON H1.DocEntry = C.TransId AND H1.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.ODLN H2 with (nolock) ON H2.DocEntry = C.TransId AND H2.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.OINV H3 with (nolock) ON H3.DocEntry = C.TransId AND H3.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.ORIN H4 with (nolock) ON H4.DocEntry = C.TransId AND H4.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.ORDN H5 with (nolock) ON H5.DocEntry = C.TransId AND H5.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.OPDN H6 with (nolock) ON H6.DocEntry = C.TransId AND H6.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.OPOR H7 with (nolock) ON H7.DocEntry = C.TransId AND H7.ObjType = C.ObjType
 --               WHERE cast(c.DocDate as date) between @Desde and @Hasta AND C.ObjType NOT IN (67)'
 --       SET @Qry += '
 --                   and D.UserID in (' + @Usuarios + ')' 
 --       SET @QRY += '
 --               UNION ALL
 --               SELECT 
 --                   0 WtmCode,
 --                   0 WddCode,
 --                   0 StepCode,
 --                   c.ObjType,
 --                   ISNULL(c.DocEntry, 0),
 --                   C.CardCode + '' - '' + C.CardName  [Cliente],
 --                   ''Socio de negocios'' [Documento],
 --                   NULL [Doc Sap],
 --                   0 [numDocEntry],
 --                   D.Nombre [Autor],
 --                   CASE WHEN C.U_Autorizado =''A'' THEN ''Alta Pendiente'' 
 --                           WHEN C.U_Autorizado =''U'' THEN ''Actualizaciones Pendientes'' 
 --                           WHEN C.U_Autorizado =''C'' THEN ''Cambios aplicados'' 
 --                           WHEN C.U_Autorizado =''p'' THEN ''Pendiente (Vaidacion Transaction)'' 
 --                           ELSE ''Pendiente'' 
 --                   END Estado,
 --                   '''' [Orden de compra],
 --                   '''' [Comentarios]
	--				, '''' [EstadoAut]
 --                   , C.Notes Detalles
 --                   , ''Ver''	Ver
	--				, [dbo].[fu_hnt_Exceptions](C.Notes, C.ObjType)
 --               FROM sap.OCRD C 
 --                   JOIN hnt.Usuarios D with (nolock) ON D.UserID = C.UserSign
 --                   LEFT JOIN SBOCTRZ.DBO.OCRD E with (nolock) ON C.CardCode = E.CardCode
 --               WHERE CAST(C.UpdateDate AS DATE) = CAST(GETDATE() AS DATE) AND C.CardCode <> '''' '
 --       SET @Qry += '
 --                   and D.UserID in(' + @Usuarios + ')'
	--	SET @QRY += '
	--			UNION ALL
 --               SELECT 
 --                   0 WtmCode,
 --                   0 WddCode,
 --                   0 StepCode,
 --                   c.ObjType,
 --                   c.DocEntry ,
 --                   F.CardCode + '' - '' + f.CardName [Cliente],
 --                   case when c.ObjType=17 then ''Pedido'' 
 --                       when c.ObjType=13 then ''Factura'' 
 --                       when c.ObjType=15 then ''Entrega'' 
 --                       when c.ObjType=14 then ''Nota de crédito'' 
 --                       when c.ObjType=16 then ''Devolución'' 
 --                       when c.ObjType=20 then ''Entrada de mercancías'' 
 --                       when c.ObjType=22 then ''Pedido de proveedor''
 --                       else ''Documento'' 
 --                   end [Documento],
 --                   case when c.ObjType=17 then H1.DocNum 
 --                       when c.ObjType=13 then H3.DocNum 
 --                       when c.ObjType=14 then H4.DocNum 
 --                       when c.ObjType=15 then H2.DocNum
 --                       when c.ObjType=16 then H5.DocNum
 --                       when c.ObjType=20 then H6.DocNum
 --                       when c.ObjType=22 then H7.DocNum
 --                       else 0 
 --                   end [Doc Sap],
 --                   c.TransId [numDocEntry],
 --                   D.Nombre [Autor],
 --                   case 
 --                       when c.TransId > 0 then ''Creado'' 
 --                       else 
 --                           case when c.u_autorizado=''P'' then ''Pendiente (Autorización)'' 
 --                               when c.u_autorizado=''A'' then ''Autorizado'' 
 --                               when c.u_autorizado=''R'' then ''Rechazado'' 
 --                           else ''Pendiente'' 
 --                           end 
 --                   end Estado
 --                   ,isnull(c.u_oc,'''') [Orden de compra],
 --                   C.Comments [Comentarios]
	--				, sap.Get_StatusDocument(C.DocEntry, ''VENTAS'') [EstadoAut]
 --                   , CASE WHEN C.U_Autorizado = ''R'' THEN C.TaxInvNo ELSE C.PickRmrk END Detalles
 --                   ,''Ver''	Ver
	--				, [dbo].[fu_hnt_Exceptions](C.PickRmrk, C.ObjType)
 --               FROM  sap.ODRF C with (nolock)
 --                   LEFT JOIN hnt.Usuarios D with (nolock) ON D.UserID = C.U_FolioHalcon
 --                   LEFT JOIN SBOCTRZ.DBO.OCRD F with (nolock) ON C.CardCode COLLATE DATABASE_DEFAULT = F.CardCode
 --                   LEFT JOIN SBOCTRZ.DBO.ORDR H1 with (nolock) ON H1.DocEntry = C.TransId AND H1.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.ODLN H2 with (nolock) ON H2.DocEntry = C.TransId AND H2.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.OINV H3 with (nolock) ON H3.DocEntry = C.TransId AND H3.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.ORIN H4 with (nolock) ON H4.DocEntry = C.TransId AND H4.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.ORDN H5 with (nolock) ON H5.DocEntry = C.TransId AND H5.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.OPDN H6 with (nolock) ON H6.DocEntry = C.TransId AND H6.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.OPOR H7 with (nolock) ON H7.DocEntry = C.TransId AND H7.ObjType = C.ObjType
	--				LEFT JOIN hnt.Usuarios E WITH (nolock) ON E.titular = C.EDocPrefix
 --               WHERE cast(c.DocDate as date) between @Desde and @Hasta AND C.ObjType NOT IN (67)
	--			AND ISNULL(C.FatherCard, '''') = ''MOVIL'' '
	--			SET @Qry += '
	--					and E.UserID in (' + @Usuarios + ')'
 --       SET @QRY += ') T1
 --           ORDER BY 5 desc'

	--	SET @Parametros = '@Desde DATE, @Hasta DATE, @userID INT, @skip INT, @pageSize INT'
	--	EXEC sp_executesql @QRY, @Parametros, @Desde, @Hasta, @userID, @skip, @pageSize
	--end



	--documentos auorizados y pendientes Nw Version
	--IF @tipoconsulta = 111 
	--BEGIN
	--	Select @Rol = Rol From hnt.Usuarios Where UserID = @userID

	--	SET @QRY = '
 --           SELECT * FROM 
 --           (
 --               SELECT
 --                   0 WtmCode,
 --                   0 WddCode,
 --                   0 StepCode,
 --                   c.ObjType,
	--				c.DocType,
 --                   c.DocEntry [Numero de documento],
 --                   F.CardCode + '' - '' + f.CardName [Cliente],
 --                   case when c.ObjType=17 then ''Pedido'' 
 --                       when c.ObjType=13 then ''Factura'' 
 --                       when c.ObjType=15 then ''Entrega'' 
 --                       when c.ObjType=14 then ''Nota de crédito'' 
 --                       when c.ObjType=16 then ''Devolución''  
 --                       when c.ObjType=18 then ''Factura de proveedor''
 --                       when c.ObjType=20 then ''Entrada de mercancías'' 
 --                       when c.ObjType=22 then ''Pedido de proveedor''
 --                       else ''Documento'' 
 --                   end [Documento],
 --                   case when c.ObjType=17 then H1.DocNum 
 --                       when c.ObjType=13 then H3.DocNum 
 --                       when c.ObjType=14 then H4.DocNum 
 --                       when c.ObjType=15 then H2.DocNum
 --                       when c.ObjType=16 then H5.DocNum
 --                       when c.ObjType=20 then H6.DocNum
 --                       when c.ObjType=22 then H7.DocNum
	--					when c.ObjType=18 then H9.DocNum
 --                       else 0 
 --                   end [Documento SAP],
	--				CASE 
	--					CASE WHEN C.ObjType=17 THEN H1.DocStatus 
	--						 WHEN C.ObjType=13 THEN H3.DocStatus 
	--						 WHEN C.ObjType=14 THEN H4.DocStatus 
	--						 WHEN C.ObjType=15 THEN H2.DocStatus
	--						 WHEN C.ObjType=16 THEN H5.DocStatus
	--						 WHEN C.ObjType=20 THEN H6.DocStatus
	--						 WHEN C.ObjType=22 THEN H7.DocStatus
	--						 WHEN C.ObjType=18 THEN H8.DocStatus
	--					END 
	--				WHEN ''O'' THEN ''Abierto'' WHEN ''C'' THEN ''Cerrado'' ELSE '''' END [Estatus],
 --                   CASE WHEN C.ObjType=18 THEN H9.DocEntry ELSE C.TransId END [numDocEntry],
 --                   D.Nombre [Autor],
 --                   case 
 --                       when c.TransId > 0 then ''Creado'' 
 --                       else 
 --                           case when c.u_autorizado=''P'' then ''Pendiente (Autorización)'' 
 --                               when c.u_autorizado=''A'' then ''Autorizado'' 
 --                               when c.u_autorizado=''R'' then ''Rechazado'' 
 --                           else ''Pendiente'' 
 --                           end 
 --                   end Estado,
	--				isnull(c.u_oc,'''') [Orden de compra],
 --                   C.Comments [Comentarios]
	--				, sap.Get_StatusDocument(C.DocEntry, ''VENTAS'') [Estado Aut]
 --                   , CASE WHEN C.U_Autorizado = ''R'' THEN C.TaxInvNo ELSE C.PickRmrk END Detalles
 --                   , ''Ver''	Ver
	--				, [dbo].[fu_hnt_Exceptions](C.PickRmrk, C.ObjType)[Timbrar]
 --               FROM  sap.ODRF C with (nolock)
 --                   LEFT JOIN hnt.Usuarios D with (nolock) ON D.UserID = C.U_FolioHalcon
 --                   LEFT JOIN SBOCTRZ.DBO.OCRD F with (nolock) ON C.CardCode COLLATE DATABASE_DEFAULT = F.CardCode
 --                   LEFT JOIN SBOCTRZ.DBO.ORDR H1 with (nolock) ON H1.DocEntry = C.TransId AND H1.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.ODLN H2 with (nolock) ON H2.DocEntry = C.TransId AND H2.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.OINV H3 with (nolock) ON H3.DocEntry = C.TransId AND H3.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.ORIN H4 with (nolock) ON H4.DocEntry = C.TransId AND H4.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.ORDN H5 with (nolock) ON H5.DocEntry = C.TransId AND H5.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.OPDN H6 with (nolock) ON H6.DocEntry = C.TransId AND H6.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.OPOR H7 with (nolock) ON H7.DocEntry = C.TransId AND H7.ObjType = C.ObjType
	--				LEFT JOIN SBOCTRZ.DBO.ODRF H8 with (nolock) ON H8.DocEntry = C.TransId AND H8.ObjType = C.ObjType
	--				LEFT JOIN SBOCTRZ.DBO.OPCH H9 with (nolock) ON H9.draftKey = H8.DocEntry --AND H9.ObjType = H8.ObjType
 --               WHERE cast(c.DocDate as date) between @Desde and @Hasta AND C.ObjType NOT IN (67)'
 --       SET @Qry += '
 --                   and D.UserID in (' + @Usuarios + ')' 
 --       SET @QRY += '
 --               UNION ALL
 --               SELECT 
 --                   0 WtmCode,
 --                   0 WddCode,
 --                   0 StepCode,
 --                   c.ObjType,
	--				'''' DocType,
 --                   ISNULL(c.DocEntry, 0),
 --                   C.CardCode + '' - '' + C.CardName  [Cliente],
 --                   ''Socio de negocios'' [Documento],
 --                   NULL [Doc Sap],
	--				'''' [Estatus],
 --                   0 [numDocEntry],
 --                   D.Nombre [Autor],
 --                   CASE WHEN C.U_Autorizado =''A'' THEN ''Alta Pendiente'' 
 --                           WHEN C.U_Autorizado =''U'' THEN ''Actualizaciones Pendientes'' 
 --                           WHEN C.U_Autorizado =''C'' THEN ''Cambios aplicados'' 
 --                           WHEN C.U_Autorizado =''p'' THEN ''Pendiente (Vaidacion Transaction)'' 
 --                           ELSE ''Pendiente'' 
 --                   END Estado,
 --                   '''' [Orden de compra],
 --                   '''' [Comentarios]
	--				, '''' [EstadoAut]
 --                   , C.Notes Detalles
 --                   , ''Ver''	Ver
	--				, [dbo].[fu_hnt_Exceptions](C.Notes, C.ObjType)
 --               FROM sap.OCRD C 
 --                   JOIN hnt.Usuarios D with (nolock) ON D.UserID = C.UserSign
 --                   LEFT JOIN SBOCTRZ.DBO.OCRD E with (nolock) ON C.CardCode = E.CardCode
 --               WHERE CAST(C.UpdateDate AS DATE) = CAST(GETDATE() AS DATE) AND C.CardCode <> '''' '
 --       SET @Qry += '
 --                   and D.UserID in(' + @Usuarios + ')'
	--	SET @QRY += '
	--			UNION ALL
 --               SELECT 
 --                   0 WtmCode,
 --                   0 WddCode,
 --                   0 StepCode,
 --                   c.ObjType,
	--				c.DocType,
 --                   c.DocEntry ,
 --                   F.CardCode + '' - '' + f.CardName [Cliente],
 --                   case when c.ObjType=17 then ''Pedido'' 
 --                       when c.ObjType=13 then ''Factura'' 
 --                       when c.ObjType=15 then ''Entrega'' 
 --                       when c.ObjType=14 then ''Nota de crédito'' 
 --                       when c.ObjType=16 then ''Devolución'' 
 --                       when c.ObjType=20 then ''Entrada de mercancías'' 
 --                       when c.ObjType=22 then ''Pedido de proveedor''
 --                       else ''Documento'' 
 --                   end [Documento],
 --                   case when c.ObjType=17 then H1.DocNum 
 --                       when c.ObjType=13 then H3.DocNum 
 --                       when c.ObjType=14 then H4.DocNum 
 --                       when c.ObjType=15 then H2.DocNum
 --                       when c.ObjType=16 then H5.DocNum
 --                       when c.ObjType=20 then H6.DocNum
 --                       when c.ObjType=22 then H7.DocNum
 --                       else 0 
 --                   end [Doc Sap],
	--				CASE 
	--					CASE WHEN C.ObjType=17 THEN H1.DocStatus 
	--						 WHEN C.ObjType=13 THEN H3.DocStatus 
	--						 WHEN C.ObjType=14 THEN H4.DocStatus 
	--						 WHEN C.ObjType=15 THEN H2.DocStatus
	--						 WHEN C.ObjType=16 THEN H5.DocStatus
	--						 WHEN C.ObjType=20 THEN H6.DocStatus
	--						 WHEN C.ObjType=22 THEN H7.DocStatus
	--					END 
	--				WHEN ''O'' THEN ''Abierto'' WHEN ''C'' THEN ''Cerrado'' ELSE '''' END [Estatus],
 --                   c.TransId [numDocEntry],
 --                   D.Nombre [Autor],
 --                   case 
 --                       when c.TransId > 0 then ''Creado'' 
 --                       else 
 --                           case when c.u_autorizado=''P'' then ''Pendiente (Autorización)'' 
 --                               when c.u_autorizado=''A'' then ''Autorizado'' 
 --                               when c.u_autorizado=''R'' then ''Rechazado'' 
 --                           else ''Pendiente'' 
 --                           end 
 --                   end Estado
 --                   ,isnull(c.u_oc,'''') [Orden de compra],
 --                   C.Comments [Comentarios]
	--				, sap.Get_StatusDocument(C.DocEntry, ''VENTAS'') [EstadoAut]
 --                   , CASE WHEN C.U_Autorizado = ''R'' THEN C.TaxInvNo ELSE C.PickRmrk END Detalles
 --                   ,''Ver''	Ver
	--				, [dbo].[fu_hnt_Exceptions](C.PickRmrk, C.ObjType)
 --               FROM  sap.ODRF C with (nolock)
 --                   LEFT JOIN hnt.Usuarios D with (nolock) ON D.UserID = C.U_FolioHalcon
 --                   LEFT JOIN SBOCTRZ.DBO.OCRD F with (nolock) ON C.CardCode COLLATE DATABASE_DEFAULT = F.CardCode
 --                   LEFT JOIN SBOCTRZ.DBO.ORDR H1 with (nolock) ON H1.DocEntry = C.TransId AND H1.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.ODLN H2 with (nolock) ON H2.DocEntry = C.TransId AND H2.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.OINV H3 with (nolock) ON H3.DocEntry = C.TransId AND H3.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.ORIN H4 with (nolock) ON H4.DocEntry = C.TransId AND H4.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.ORDN H5 with (nolock) ON H5.DocEntry = C.TransId AND H5.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.OPDN H6 with (nolock) ON H6.DocEntry = C.TransId AND H6.ObjType = C.ObjType
 --                   LEFT JOIN SBOCTRZ.DBO.OPOR H7 with (nolock) ON H7.DocEntry = C.TransId AND H7.ObjType = C.ObjType
	--				LEFT JOIN hnt.Usuarios E WITH (nolock) ON E.titular = C.EDocPrefix
 --               WHERE cast(c.DocDate as date) between @Desde and @Hasta AND C.ObjType NOT IN (67)
	--			AND ISNULL(C.FatherCard, '''') = ''MOVIL'' '
	--			SET @Qry += '
	--					and E.UserID in (' + @Usuarios + ')'
 --       SET @QRY += ') T1
 --           ORDER BY [Numero de documento] desc'

	--	SET @Parametros = '@Desde DATE, @Hasta DATE, @userID INT, @skip INT, @pageSize INT'
	--	EXEC sp_executesql @QRY, @Parametros, @Desde, @Hasta, @userID, @skip, @pageSize
	--end


	/* Consulta para agregar la columna de EstatusAlmacen a los documentos preliminares */
	IF @tipoconsulta = -111
	BEGIN
		Select @Rol = Rol From hnt.Usuarios Where UserID = @userID

		SET @QRY = '
            SELECT 
				T1.*
				, case 
				when B.EsParcial IS NOT NULL 
						then
							case
								when B.Estatus = ''CR'' then ''CREADO''
								when B.Estatus = ''PR'' then ''PROCESO''
								when B.Estatus = ''SU'' THEN ''SURTIENDO/PARCIAL''
								WHEN B.Estatus = ''PA'' THEN ''PAUSADO/PARCIAL''
								WHEN B.Estatus = ''EN'' THEN ''ENTREGA/PARCIAL''
								when B.Estatus = ''LI'' then ''LISTO/PARCIAL''
								when B.Estatus = ''CA'' then ''CANCELADO''
								when B.Estatus = ''REE'' then ''REABIERTO/PARCIAL''
								WHEN B.Estatus = ''CI'' THEN ''CIEGO/PARCIAL''
								when B.Estatus = ''CO'' then ''COMPLETO/PARCIAL''

								when b.Estatus = ''COP'' then ''COMPLETO/PARCIAL''

								when B.Estatus = ''MO'' then ''MOVIENDO/PARCIAL''

								when B.Estatus = ''RE'' then ''RESURTIENDO/PARCIAL''
								when B.Estatus = ''R'' then ''REACOMODANDO/PARCIAL''
								WHEN B.Estatus = ''D'' then ''DEVOLVIENDO/PARCIAL''

								when B.Estatus = ''TLLR'' then ''ESPERA ART. TALLER''

							else ''''
							end
						else
							case
								when B.Estatus = ''CR'' then ''CREADO''
								when B.Estatus = ''PR'' then ''PROCESO''
								when B.Estatus = ''SU'' THEN ''SURTIENDO''
								WHEN B.Estatus = ''PA'' THEN ''PAUSADO''
								WHEN B.Estatus = ''EN'' THEN ''ENTREGA''
								when B.Estatus = ''LI'' then ''LISTO''
								when B.Estatus = ''CA'' then ''CANCELADO''
								when B.Estatus = ''REE'' then ''REABIERTO''
								WHEN B.Estatus = ''CI'' THEN ''CIEGO''
								when B.Estatus = ''CO'' then ''COMPLETO''

								when b.Estatus = ''COP'' then ''COMPLETO/PARCIAL''

								when B.Estatus = ''MO'' then ''MOVIENDO''

								when B.Estatus = ''RE'' then ''RESURTIENDO''
								when B.Estatus = ''R'' then ''REACOMODANDO''
								WHEN B.Estatus = ''D'' then ''DEVOLVIENDO''

								when B.Estatus = ''TLLR'' then ''ESPERA ART. TALLER''

							else ''''
							end
			END [Estatus almacen]
			FROM 
            (
                SELECT
                    0 WtmCode,
                    0 WddCode,
                    0 StepCode,
                    c.ObjType,
					c.DocType,
                    c.DocEntry [Numero de documento],
                    F.CardCode + '' - '' + f.CardName [Cliente],
                    case when c.ObjType=17 then ''Pedido'' 
                        when c.ObjType=13 then ''Factura'' 
                        when c.ObjType=15 then ''Entrega'' 
                        when c.ObjType=14 then ''Nota de crédito'' 
                        when c.ObjType=16 then ''Devolución''  
                        when c.ObjType=18 then ''Factura de proveedor''
                        when c.ObjType=20 then ''Entrada de mercancías'' 
                        when c.ObjType=22 then ''Pedido de proveedor''
                        else ''Documento'' 
                    end [Documento],
                    case when c.ObjType=17 then H1.DocNum 
                        when c.ObjType=13 then H3.DocNum 
                        when c.ObjType=14 then H4.DocNum 
                        when c.ObjType=15 then H2.DocNum
                        when c.ObjType=16 then H5.DocNum
                        when c.ObjType=20 then H6.DocNum
                        when c.ObjType=22 then H7.DocNum
						when c.ObjType=18 then H9.DocNum
                        else 0 
                    end [Documento SAP],
					CASE 
						CASE WHEN C.ObjType=17 THEN H1.DocStatus 
							 WHEN C.ObjType=13 THEN H3.DocStatus 
							 WHEN C.ObjType=14 THEN H4.DocStatus 
							 WHEN C.ObjType=15 THEN H2.DocStatus
							 WHEN C.ObjType=16 THEN H5.DocStatus
							 WHEN C.ObjType=20 THEN H6.DocStatus
							 WHEN C.ObjType=22 THEN H7.DocStatus
							 WHEN C.ObjType=18 THEN H8.DocStatus
						END 
					WHEN ''O'' THEN ''Abierto'' WHEN ''C'' THEN ''Cerrado'' ELSE '''' END [Estatus],
					CASE WHEN (C.ObjType = 22 AND C.DocType = ''S'' ) THEN (SELECT TOP 1 Z.Name FROM [HNT-Files].[dbo].[File_CFDI_HNT_TRZ] X JOIN [SBOCTRZ].dbo.[@HNT_FORMAPAGO] Z ON Z.Code COLLATE DATABASE_DEFAULT = X.FormaPago WHERE X.UUID COLLATE DATABASE_DEFAULT = C.U_Edocnum AND X.Extension = ''.xml'') END [Forma Pago],
					CASE WHEN (C.ObjType = 22 AND C.DocType = ''S'' ) THEN C.DocTotal END [Importe Total],
                    CASE WHEN C.ObjType=18 THEN H9.DocEntry ELSE C.TransId END [numDocEntry],
                    D.Nombre [Autor],
                    case 
                        when c.TransId > 0 then ''Creado'' 
                        else 
                            case when c.u_autorizado=''P'' then ''Pendiente (Autorización)'' 
                                when c.u_autorizado=''A'' then ''Autorizado'' 
                                when c.u_autorizado=''R'' then ''Rechazado'' 
                            else ''Pendiente'' 
                            end 
                    end Estado,
					isnull(c.u_oc,'''') [Orden de compra],
                    C.Comments [Comentarios]
					, sap.Get_StatusDocument(C.DocEntry, ''VENTAS'') [Estado Aut]
                    , CASE WHEN C.U_Autorizado = ''R'' THEN C.TaxInvNo ELSE C.PickRmrk END Detalles
                    , ''Ver''	Ver
					, [dbo].[fu_hnt_Exceptions](C.PickRmrk, C.ObjType)[Timbrar]
                FROM  sap.ODRF C with (nolock)
                    LEFT JOIN hnt.Usuarios D with (nolock) ON D.UserID = C.U_FolioHalcon
                    LEFT JOIN SBOCTRZ.DBO.OCRD F with (nolock) ON C.CardCode COLLATE DATABASE_DEFAULT = F.CardCode
                    LEFT JOIN SBOCTRZ.DBO.ORDR H1 with (nolock) ON H1.DocEntry = C.TransId AND H1.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.ODLN H2 with (nolock) ON H2.DocEntry = C.TransId AND H2.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.OINV H3 with (nolock) ON H3.DocEntry = C.TransId AND H3.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.ORIN H4 with (nolock) ON H4.DocEntry = C.TransId AND H4.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.ORDN H5 with (nolock) ON H5.DocEntry = C.TransId AND H5.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.OPDN H6 with (nolock) ON H6.DocEntry = C.TransId AND H6.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.OPOR H7 with (nolock) ON H7.DocEntry = C.TransId AND H7.ObjType = C.ObjType
					LEFT JOIN SBOCTRZ.DBO.ODRF H8 with (nolock) ON H8.DocEntry = C.TransId AND H8.ObjType = C.ObjType
					LEFT JOIN SBOCTRZ.DBO.OPCH H9 with (nolock) ON H9.draftKey = H8.DocEntry --AND H9.ObjType = H8.ObjType
                WHERE cast(c.DocDate as date) between @Desde and @Hasta AND C.ObjType NOT IN (67)'
        SET @Qry += '
                    and D.UserID in (' + @Usuarios + ')' 
        SET @QRY += '
                UNION ALL
                SELECT 
                    0 WtmCode,
                    0 WddCode,
                    0 StepCode,
                    c.ObjType,
					'''' DocType,
                    ISNULL(c.DocEntry, 0),
                    C.CardCode + '' - '' + C.CardName  [Cliente],
                    ''Socio de negocios'' [Documento],
                    NULL [Doc Sap],
					'''' [Estatus],
					'''' [Forma Pago],
					NULL [Importe Total],
                    0 [numDocEntry],
                    D.Nombre [Autor],
                    CASE WHEN C.U_Autorizado =''A'' THEN ''Alta Pendiente'' 
                            WHEN C.U_Autorizado =''U'' THEN ''Actualizaciones Pendientes'' 
                            WHEN C.U_Autorizado =''C'' THEN ''Cambios aplicados'' 
                            WHEN C.U_Autorizado =''p'' THEN ''Pendiente (Vaidacion Transaction)'' 
                            ELSE ''Pendiente'' 
                    END Estado,
                    '''' [Orden de compra],
                    '''' [Comentarios]
					, '''' [EstadoAut]
                    , C.Notes Detalles
                    , ''Ver''	Ver
					, [dbo].[fu_hnt_Exceptions](C.Notes, C.ObjType)
                FROM sap.OCRD C 
                    JOIN hnt.Usuarios D with (nolock) ON D.UserID = C.UserSign
                    LEFT JOIN SBOCTRZ.DBO.OCRD E with (nolock) ON C.CardCode = E.CardCode
                WHERE CAST(C.UpdateDate AS DATE) = CAST(GETDATE() AS DATE) AND C.CardCode <> '''' '
        SET @Qry += '
                    and D.UserID in(' + @Usuarios + ')'
		SET @QRY += '
				UNION ALL
                SELECT 
                    0 WtmCode,
                    0 WddCode,
                    0 StepCode,
                    c.ObjType,
					c.DocType,
                    c.DocEntry ,
                    F.CardCode + '' - '' + f.CardName [Cliente],
                    case when c.ObjType=17 then ''Pedido'' 
                        when c.ObjType=13 then ''Factura'' 
                        when c.ObjType=15 then ''Entrega'' 
                        when c.ObjType=14 then ''Nota de crédito'' 
                        when c.ObjType=16 then ''Devolución'' 
                        when c.ObjType=20 then ''Entrada de mercancías'' 
                        when c.ObjType=22 then ''Pedido de proveedor''
                        else ''Documento'' 
                    end [Documento],
                    case when c.ObjType=17 then H1.DocNum 
                        when c.ObjType=13 then H3.DocNum 
                        when c.ObjType=14 then H4.DocNum 
                        when c.ObjType=15 then H2.DocNum
                        when c.ObjType=16 then H5.DocNum
                        when c.ObjType=20 then H6.DocNum
                        when c.ObjType=22 then H7.DocNum
                        else 0 
                    end [Doc Sap],
					CASE 
						CASE WHEN C.ObjType=17 THEN H1.DocStatus 
							 WHEN C.ObjType=13 THEN H3.DocStatus 
							 WHEN C.ObjType=14 THEN H4.DocStatus 
							 WHEN C.ObjType=15 THEN H2.DocStatus
							 WHEN C.ObjType=16 THEN H5.DocStatus
							 WHEN C.ObjType=20 THEN H6.DocStatus
							 WHEN C.ObjType=22 THEN H7.DocStatus
						END 
					WHEN ''O'' THEN ''Abierto'' WHEN ''C'' THEN ''Cerrado'' ELSE '''' END [Estatus],
					'''' [Forma Pago],
					NULL [Importe Total],
                    c.TransId [numDocEntry],
                    D.Nombre [Autor],
                    case 
                        when c.TransId > 0 then ''Creado'' 
                        else 
                            case when c.u_autorizado=''P'' then ''Pendiente (Autorización)'' 
                                when c.u_autorizado=''A'' then ''Autorizado'' 
                                when c.u_autorizado=''R'' then ''Rechazado'' 
                            else ''Pendiente'' 
                            end 
                    end Estado
                    ,isnull(c.u_oc,'''') [Orden de compra],
                    C.Comments [Comentarios]
					, sap.Get_StatusDocument(C.DocEntry, ''VENTAS'') [EstadoAut]
                    , CASE WHEN C.U_Autorizado = ''R'' THEN C.TaxInvNo ELSE C.PickRmrk END Detalles
                    ,''Ver''	Ver
					, [dbo].[fu_hnt_Exceptions](C.PickRmrk, C.ObjType)
                FROM  sap.ODRF C with (nolock)
                    LEFT JOIN hnt.Usuarios D with (nolock) ON D.UserID = C.U_FolioHalcon
                    LEFT JOIN SBOCTRZ.DBO.OCRD F with (nolock) ON C.CardCode COLLATE DATABASE_DEFAULT = F.CardCode
                    LEFT JOIN SBOCTRZ.DBO.ORDR H1 with (nolock) ON H1.DocEntry = C.TransId AND H1.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.ODLN H2 with (nolock) ON H2.DocEntry = C.TransId AND H2.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.OINV H3 with (nolock) ON H3.DocEntry = C.TransId AND H3.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.ORIN H4 with (nolock) ON H4.DocEntry = C.TransId AND H4.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.ORDN H5 with (nolock) ON H5.DocEntry = C.TransId AND H5.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.OPDN H6 with (nolock) ON H6.DocEntry = C.TransId AND H6.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.OPOR H7 with (nolock) ON H7.DocEntry = C.TransId AND H7.ObjType = C.ObjType
					LEFT JOIN hnt.Usuarios E WITH (nolock) ON E.titular = C.EDocPrefix
                WHERE cast(c.DocDate as date) between @Desde and @Hasta AND C.ObjType NOT IN (67)
				AND ISNULL(C.FatherCard, '''') = ''MOVIL'' '
				SET @Qry += '
						and E.UserID in (' + @Usuarios + ')'
        SET @QRY += ') T1
				left join logistics.WMS_SurtidoDocumentos B on B.ObjType = T1.ObjType and B.DocEntry = T1.numDocEntry
            
			ORDER BY [Numero de documento] desc'

		SET @Parametros = '@Desde DATE, @Hasta DATE, @userID INT, @skip INT, @pageSize INT'
		EXEC sp_executesql @QRY, @Parametros, @Desde, @Hasta, @userID, @skip, @pageSize
	end


	IF @tipoconsulta = 111
	BEGIN
		Select @Rol = Rol From hnt.Usuarios Where UserID = @userID

		SET @QRY = '
            SELECT * FROM 
            (
                SELECT
                    0 WtmCode,
                    0 WddCode,
                    0 StepCode,
                    c.ObjType,
					c.DocType,
                    c.DocEntry [Numero de documento],
                    F.CardCode + '' - '' + f.CardName [Cliente],
                    case when c.ObjType=17 then ''Pedido'' 
                        when c.ObjType=13 then ''Factura'' 
                        when c.ObjType=15 then ''Entrega'' 
                        when c.ObjType=14 then ''Nota de crédito'' 
                        when c.ObjType=16 then ''Devolución''  
                        when c.ObjType=18 then ''Factura de proveedor''
                        when c.ObjType=20 then ''Entrada de mercancías'' 
                        when c.ObjType=22 then ''Pedido de proveedor''
                        else ''Documento'' 
                    end [Documento],
                    case when c.ObjType=17 then H1.DocNum 
                        when c.ObjType=13 then H3.DocNum 
                        when c.ObjType=14 then H4.DocNum 
                        when c.ObjType=15 then H2.DocNum
                        when c.ObjType=16 then H5.DocNum
                        when c.ObjType=20 then H6.DocNum
                        when c.ObjType=22 then H7.DocNum
						when c.ObjType=18 then H9.DocNum
                        else 0 
                    end [Documento SAP],
					CASE 
						CASE WHEN C.ObjType=17 THEN H1.DocStatus 
							 WHEN C.ObjType=13 THEN H3.DocStatus 
							 WHEN C.ObjType=14 THEN H4.DocStatus 
							 WHEN C.ObjType=15 THEN H2.DocStatus
							 WHEN C.ObjType=16 THEN H5.DocStatus
							 WHEN C.ObjType=20 THEN H6.DocStatus
							 WHEN C.ObjType=22 THEN H7.DocStatus
							 WHEN C.ObjType=18 THEN H8.DocStatus
						END 
					WHEN ''O'' THEN ''Abierto'' WHEN ''C'' THEN ''Cerrado'' ELSE '''' END [Estatus],
					CASE WHEN (C.ObjType = 22 AND C.DocType = ''S'' ) THEN (SELECT TOP 1 Z.Name FROM [HNT-Files].[dbo].[File_CFDI_HNT_TRZ] X JOIN [SBOCTRZ].dbo.[@HNT_FORMAPAGO] Z ON Z.Code COLLATE DATABASE_DEFAULT = X.FormaPago WHERE X.UUID COLLATE DATABASE_DEFAULT = C.U_Edocnum AND X.Extension = ''.xml'') END [Forma Pago],
					CASE WHEN (C.ObjType = 22 AND C.DocType = ''S'' ) THEN C.DocTotal END [Importe Total],
                    CASE WHEN C.ObjType=18 THEN H9.DocEntry ELSE C.TransId END [numDocEntry],
                    D.Nombre [Autor],
                    case 
                        when c.TransId > 0 then ''Creado'' 
                        else 
                            case when c.u_autorizado=''P'' then ''Pendiente (Autorización)'' 
                                when c.u_autorizado=''A'' then ''Autorizado'' 
                                when c.u_autorizado=''R'' then ''Rechazado'' 
                            else ''Pendiente'' 
                            end 
                    end Estado,
					isnull(c.u_oc,'''') [Orden de compra],
                    C.Comments [Comentarios]
					, sap.Get_StatusDocument(C.DocEntry, ''VENTAS'') [Estado Aut]
                    , CASE WHEN C.U_Autorizado = ''R'' THEN C.TaxInvNo ELSE C.PickRmrk END Detalles
                    , ''Ver''	Ver
					, [dbo].[fu_hnt_Exceptions](C.PickRmrk, C.ObjType)[Timbrar]
                FROM  sap.ODRF C with (nolock)
                    LEFT JOIN hnt.Usuarios D with (nolock) ON D.UserID = C.U_FolioHalcon
                    LEFT JOIN SBOCTRZ.DBO.OCRD F with (nolock) ON C.CardCode COLLATE DATABASE_DEFAULT = F.CardCode
                    LEFT JOIN SBOCTRZ.DBO.ORDR H1 with (nolock) ON H1.DocEntry = C.TransId AND H1.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.ODLN H2 with (nolock) ON H2.DocEntry = C.TransId AND H2.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.OINV H3 with (nolock) ON H3.DocEntry = C.TransId AND H3.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.ORIN H4 with (nolock) ON H4.DocEntry = C.TransId AND H4.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.ORDN H5 with (nolock) ON H5.DocEntry = C.TransId AND H5.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.OPDN H6 with (nolock) ON H6.DocEntry = C.TransId AND H6.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.OPOR H7 with (nolock) ON H7.DocEntry = C.TransId AND H7.ObjType = C.ObjType
					LEFT JOIN SBOCTRZ.DBO.ODRF H8 with (nolock) ON H8.DocEntry = C.TransId AND H8.ObjType = C.ObjType
					LEFT JOIN SBOCTRZ.DBO.OPCH H9 with (nolock) ON H9.draftKey = H8.DocEntry --AND H9.ObjType = H8.ObjType
                WHERE cast(c.DocDate as date) between @Desde and @Hasta AND C.ObjType NOT IN (67)'
        SET @Qry += '
                    and D.UserID in (' + @Usuarios + ')' 
        SET @QRY += '
                UNION ALL
                SELECT 
                    0 WtmCode,
                    0 WddCode,
                    0 StepCode,
                    c.ObjType,
					'''' DocType,
                    ISNULL(c.DocEntry, 0),
                    C.CardCode + '' - '' + C.CardName  [Cliente],
                    ''Socio de negocios'' [Documento],
                    NULL [Doc Sap],
					'''' [Estatus],
					'''' [Forma Pago],
					NULL [Importe Total],
                    0 [numDocEntry],
                    D.Nombre [Autor],
                    CASE WHEN C.U_Autorizado =''A'' THEN ''Alta Pendiente'' 
                            WHEN C.U_Autorizado =''U'' THEN ''Actualizaciones Pendientes'' 
                            WHEN C.U_Autorizado =''C'' THEN ''Cambios aplicados'' 
                            WHEN C.U_Autorizado =''p'' THEN ''Pendiente (Vaidacion Transaction)'' 
                            ELSE ''Pendiente'' 
                    END Estado,
                    '''' [Orden de compra],
                    '''' [Comentarios]
					, '''' [EstadoAut]
                    , C.Notes Detalles
                    , ''Ver''	Ver
					, [dbo].[fu_hnt_Exceptions](C.Notes, C.ObjType)
                FROM sap.OCRD C 
                    JOIN hnt.Usuarios D with (nolock) ON D.UserID = C.UserSign
                    LEFT JOIN SBOCTRZ.DBO.OCRD E with (nolock) ON C.CardCode = E.CardCode
                WHERE CAST(C.UpdateDate AS DATE) = CAST(GETDATE() AS DATE) AND C.CardCode <> '''' '
        SET @Qry += '
                    and D.UserID in(' + @Usuarios + ')'
		SET @QRY += '
				UNION ALL
                SELECT 
                    0 WtmCode,
                    0 WddCode,
                    0 StepCode,
                    c.ObjType,
					c.DocType,
                    c.DocEntry ,
                    F.CardCode + '' - '' + f.CardName [Cliente],
                    case when c.ObjType=17 then ''Pedido'' 
                        when c.ObjType=13 then ''Factura'' 
                        when c.ObjType=15 then ''Entrega'' 
                        when c.ObjType=14 then ''Nota de crédito'' 
                        when c.ObjType=16 then ''Devolución'' 
                        when c.ObjType=20 then ''Entrada de mercancías'' 
                        when c.ObjType=22 then ''Pedido de proveedor''
                        else ''Documento'' 
                    end [Documento],
                    case when c.ObjType=17 then H1.DocNum 
                        when c.ObjType=13 then H3.DocNum 
                        when c.ObjType=14 then H4.DocNum 
                        when c.ObjType=15 then H2.DocNum
                        when c.ObjType=16 then H5.DocNum
                        when c.ObjType=20 then H6.DocNum
                        when c.ObjType=22 then H7.DocNum
                        else 0 
                    end [Doc Sap],
					CASE 
						CASE WHEN C.ObjType=17 THEN H1.DocStatus 
							 WHEN C.ObjType=13 THEN H3.DocStatus 
							 WHEN C.ObjType=14 THEN H4.DocStatus 
							 WHEN C.ObjType=15 THEN H2.DocStatus
							 WHEN C.ObjType=16 THEN H5.DocStatus
							 WHEN C.ObjType=20 THEN H6.DocStatus
							 WHEN C.ObjType=22 THEN H7.DocStatus
						END 
					WHEN ''O'' THEN ''Abierto'' WHEN ''C'' THEN ''Cerrado'' ELSE '''' END [Estatus],
					'''' [Forma Pago],
					NULL [Importe Total],
                    c.TransId [numDocEntry],
                    D.Nombre [Autor],
                    case 
                        when c.TransId > 0 then ''Creado'' 
                        else 
                            case when c.u_autorizado=''P'' then ''Pendiente (Autorización)'' 
                                when c.u_autorizado=''A'' then ''Autorizado'' 
                                when c.u_autorizado=''R'' then ''Rechazado'' 
                            else ''Pendiente'' 
                            end 
                    end Estado
                    ,isnull(c.u_oc,'''') [Orden de compra],
                    C.Comments [Comentarios]
					, sap.Get_StatusDocument(C.DocEntry, ''VENTAS'') [EstadoAut]
                    , CASE WHEN C.U_Autorizado = ''R'' THEN C.TaxInvNo ELSE C.PickRmrk END Detalles
                    ,''Ver''	Ver
					, [dbo].[fu_hnt_Exceptions](C.PickRmrk, C.ObjType)
                FROM  sap.ODRF C with (nolock)
                    LEFT JOIN hnt.Usuarios D with (nolock) ON D.UserID = C.U_FolioHalcon
                    LEFT JOIN SBOCTRZ.DBO.OCRD F with (nolock) ON C.CardCode COLLATE DATABASE_DEFAULT = F.CardCode
                    LEFT JOIN SBOCTRZ.DBO.ORDR H1 with (nolock) ON H1.DocEntry = C.TransId AND H1.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.ODLN H2 with (nolock) ON H2.DocEntry = C.TransId AND H2.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.OINV H3 with (nolock) ON H3.DocEntry = C.TransId AND H3.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.ORIN H4 with (nolock) ON H4.DocEntry = C.TransId AND H4.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.ORDN H5 with (nolock) ON H5.DocEntry = C.TransId AND H5.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.OPDN H6 with (nolock) ON H6.DocEntry = C.TransId AND H6.ObjType = C.ObjType
                    LEFT JOIN SBOCTRZ.DBO.OPOR H7 with (nolock) ON H7.DocEntry = C.TransId AND H7.ObjType = C.ObjType
					LEFT JOIN hnt.Usuarios E WITH (nolock) ON E.titular = C.EDocPrefix
                WHERE cast(c.DocDate as date) between @Desde and @Hasta AND C.ObjType NOT IN (67)
				AND ISNULL(C.FatherCard, '''') = ''MOVIL'' '
				SET @Qry += '
						and E.UserID in (' + @Usuarios + ')'
        SET @QRY += ') T1
            ORDER BY [Numero de documento] desc'

		SET @Parametros = '@Desde DATE, @Hasta DATE, @userID INT, @skip INT, @pageSize INT'
		EXEC sp_executesql @QRY, @Parametros, @Desde, @Hasta, @userID, @skip, @pageSize
	end
	--INSERTA RETENCIONES PABLO CUAUTLE COATL
	IF @TipoConsulta = 112
	BEGIN
		BEGIN TRY
		--PARA QUE SIEMPRE SE INSERTEN TODAS LAS LINEAS, PARA EVITAR DUPLICADOS SE ELIMINAN AL TERMIANRE DE GUARDAR EL ENCABEZADO
		IF EXISTS(SELECT * FROM sap.ODRF WHERE DocNum = @DocEntry AND U_Autorizado IS NULL)
			SET @LineNum = -1

		IF @LineNum > -1 
		BEGIN
			UPDATE sap.ODRF set U_ComentarioAut = GETDATE() WHERE DocEntry = @DocEntry

			IF NOT EXISTS(SELECT * FROM sap.ODRF WHERE DocNum = @DocEntry AND (U_Autorizado in ('R', 'A')))
			BEGIN
				UPDATE sap.DRF5 SET 
					WTCode = @WTCode, 
					TaxbleAmnt = @TaxbleAmnt, 
					TxblAmntSC = @TxblAmntSC, 
					WTAmnt = @WTAmnt,
					WTAmntSC = @WTAmntSC,
					Type = @Type, 
					Rate = @Rate, 
					Category = @Category,
					BaseType = @BaseType, 
					Criteria = @Criteria, 
					Account = @AcctCode
				WHERE 
					AbsEntry = @DocEntry AND LineNum = @LineNum
			END
			ELSE
			BEGIN
				SET @DocEntry = @DocEntry
			END
		END
		ELSE
		BEGIN
			SET @LineNum = ISNULL((SELECT MAX(LineNum) FROM sap.DRF5 WHERE AbsEntry = @DocEntry) + 1, 1)		
			INSERT INTO sap.DRF5 ( AbsEntry,  LineNum,  ObjType,  WTCode,  TaxbleAmnt,  TxblAmntSC,  WTAmnt,  WTAmntSC,  Type,  Rate,  Category,  BaseType,  Criteria,  Account)
						  VALUES (@DocEntry, @LineNum, @ObjType, @WTCode, @TaxbleAmnt, @TxblAmntSC, @WTAmnt, @WTAmntSC, @Type, @Rate, @Category, @TipoBase, @Criteria, @AcctCode)
		END

		SELECT @LineNum
		END TRY
		BEGIN CATCH
			DECLARE @Error VARCHAR(MAX) = (SELECT ERROR_MESSAGE() + ' ' + ERROR_LINE() AS ErrorMessage);
			RAISERROR(@Error, 11, 1);
		END CATCH
	END
	--OBTIENE RETENCIONES PABLO CUAUTLE COATL
	IF @TipoConsulta = 113
	BEGIN
		IF @ObjType = 18
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY = '
					SELECT 
						AbsEntry, LineNum, ObjType, WTCode, TaxbleAmnt, TxblAmntSC, WTAmnt, WTAmntSC, Type, Rate, Category, BaseType, Criteria, Account
					FROM ' + @CIA + '.dbo.PCH5
					WHERE AbsEntry = @DocEntry'

				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SELECT 
					AbsEntry, LineNum, ObjType, WTCode, TaxbleAmnt, TxblAmntSC, WTAmnt, WTAmntSC, Type, Rate, Category, BaseType, Criteria, Account
				FROM sap.DRF5
				WHERE AbsEntry = @DocEntry
			END
		END
		--PRECIOS DE ENTREGA
		IF @ObjType = 69
		BEGIN
			IF @sType = ''
			BEGIN
				SET @QRY = ' SELECT A.* FROM ' + @CIA + '.dbo.IPF2 A WHERE DocEntry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
			ELSE IF @sType = 'BorradorHNT'
			BEGIN
				SET @QRY = ' SELECT A.* FROM sap.IPF2 A WHERE DocEntry = @DocEntry'
				SET @PARAMETROS = '@DocEntry INT'
			END
		END
		
		EXECUTE sp_executesql @QRY, @PARAMETROS, @DocEntry
	END

	IF @TipoConsulta = 114
	BEGIN
		SELECT 
			A.Street, A.Block, A.ZipCode, A.County, B.Name [State], C.Name [Country],
			CONCAT(A.Street, ' ', A.Block, ' ', A.ZipCode, ' ', A.County, ' ', B.Name, ' ', C.Name) Address
		FROM
			SBOCTRZ.dbo.CRD1 A
			JOIN SBOCTRZ.dbo.OCST B ON A.State = B.Code AND A.Country = B.Country
			JOIN SBOCTRZ.dbo.OCRY C ON A.Country = C.Code
		WHERE 
			A.CardCode = @CardCode
			AND AdresType = 'S'
			AND A.Address = @Address
	END
	
	--INSERTA BORRADOR DE PAGOS EN SAP PARA PROVEEDORES(ENCABEZADO)
	IF @TipoConsulta = 115
	BEGIN
		IF NOT EXISTS(SELECT * FROM sap.OVPM WHERE DocNum = @DocEntry)
		BEGIN
			SELECT @DocEntry = ISNULL(MAX(DocNum), 0) + 1 FROM sap.OVPM
			
			INSERT INTO sap.OVPM
			(DocEntry, DocNum, DocDate, CardCode, CardName, DocType, PayNoDoc, Address, CounterRef, TrsfrAcct, TrsfrSum, NoDocSum, TrsfrDate, TrsfrRef, DocCurr, JrnlMemo, U_Metpago, U_FormaPagoTes, FolioHalcon, U_Autorizado, CreateDate)
			VALUES
			(@DocEntry, @DocEntry, @DocDate, @CardCode, @CardName, @DocType, @PayNoDoc, @Address, @CounterRef, @TrsfrAcct, @TrsfrSum,@TrsfrSum, @TrsfrDate, @TrsfrRef, @DocCurr, @JrnlMemo, @U_MetPago, @FormaPagoTes, @U_FolioHalcon, 'P', GetDate())

			select top 1 DocNum from sap.OVPM ORDER BY DocNum desc
		END
		ELSE
		BEGIN
			 UPDATE sap.OVPM SET 
				DocDate = @DocDate, 
				CardCode = @CardCode, 
				TrsfrAcct = @TrsfrAcct, 
				TrsfrSum = @TrsfrSum, 
				TrsfrDate = @TrsfrDate, 
				TrsfrRef = @TrsfrRef, 
				DocCurr = @DocCurr, 
				JrnlMemo = @JrnlMemo, 
				U_Metpago = @U_MetPago, 
				U_FormaPagoTes = @FormaPagoTes
			 WHERE 
				DocNum = @DocEntry
		END
	END

	--INSERTA BORRADOR DE PAGOS EN SAP PARA PROVEEDORES(DETALLE)
	IF @TipoConsulta = 116
	BEGIN
		SET @LineNum = ISNULL((SELECT MAX(InvoiceId) + 1 FROM sap.VPM2 WHERE DocNum = @DocNum), 0)

		INSERT INTO sap.VPM2
		([DocNum],[InvoiceId],[DocEntry],[SumApplied],[AppliedFC],[InvType],[U_TipoPago])
		VALUES
		(@DocNum, @LineNum, @DocEntry, @SumApplied, @AppliedFC, @InvoiceType, @U_TipoPago)

		SELECT @LineNum
	END

	--ACTUALIZA ESTADO DESPUES DE VALIDAR TRANSACTION PARA PAGOS PROVEEDORES 
	if @TipoConsulta = 117 
	BEGIN
		UPDATE sap.OVPM SET U_Autorizado = @U_Autorizado WHERE DocNum = @DocNum 
		
		IF @U_Autorizado = 'A'  
			UPDATE sap.OVPM SET TransId = NULL WHERE DocNum = @DocNum
	END

	--COMENTARIO DE ERROR
	IF @TipoConsulta = 118
	BEGIN
		UPDATE sap.OVPM SET  U_ActMessage = @Comments WHERE DocNum = @DocNum
	END

	--ACTUALIZAR PAGOS
	IF @TipoConsulta = 119
	BEGIN
		IF @DocNumSAP = 0 
			SET @DocnumSAP = NULL

		UPDATE sap.OVPM SET TransId = @DocNumSAP, U_ActMessage = @Comments WHERE DocNum = @DocEntry
	END

	--OBTENER DÍAS ETD
	IF @TipoConsulta = 120
	BEGIN
		DECLARE  @dTiempoEsperaETD int = (SELECT ISNULL((SELECT dTiempoEsperaETD  FROM logistics.[ArribosDiasCompras] where CardCode = @CardCode),0));


		IF @dTiempoEsperaETD <> 0
		BEGIN 
				SELECT FORMAT(DATEADD(day, @dTiempoEsperaETD, @DocDueDate), 'yyyy/MM/dd') AS dTiempoEsperaETD
		END
		ELSE 
		BEGIN
		    SELECT '' AS dTiempoEsperaETD
		END
	END

	--AUTORIZACIONES PARA SURTIDO
	IF @TipoConsulta = 121
	BEGIN
		DECLARE @codigo_1 INT
		DECLARE @id2_ INT

		SET @codigo_1  = (select top 1 A.WddCode from sap.OWDD A JOIN sap.wdd1 B ON A.WddCode = B.WddCode where A.ObjType = @ObjType and A.docentry = @docentry AND UserID = @userID ORDER BY A.WddCode desc)
		
		IF EXISTS(SELECT * FROM sap.OWDD WHERE [ObjType] = @ObjType AND [DocEntry] = @docentry AND [WddCode] = @codigo_1 AND Status IN ('Y', 'N', 'S'))
		BEGIN
			RAISERROR('El documento ya ha sido procesado previamente', 11, 1);
		END

		UPDATE sap.OWDD SET [Status]= 'S' WHERE [ObjType] = @ObjType AND [DocEntry] = @docentry AND [WddCode] = @codigo_1
		UPDATE sap.WDD1 SET [Status]= 'S', [Comment] = @Comments, [UpdateDate] = GETDATE() WHERE [UserID] = @userID AND [WddCode] = @codigo_1
		UPDATE sap.ODRF SET [U_ComentarioAut] = @Comments WHERE [DocEntry] = @DocEntry	

		EXEC dbo.up_HNT_Autorizaciones @TipoConsulta = 1, @ObjType = @ObjType, @DocID = @docentry, @Valor = @docentry, @UserID = @userID, @OWDD_ID = @id2_ OUTPUT, @Test = 0, @Version ='V2'
	END	


	--INSERTA BORRADOR PARA PRECIOS DE ENTREGA EN SAP(ENCABEZADO)
	IF @TipoConsulta = 122
	BEGIN
		IF NOT EXISTS(SELECT * FROM sap.[OIPF] WHERE [DocEntry] = @DocEntry)
		BEGIN
			SELECT @DocEntry = ISNULL(MAX([DocEntry]), 0) + 1 FROM sap.[OIPF]
		
			INSERT INTO [sap].[OIPF]
			   ([DocEntry], [DocNum], [DocDate], [DocDueDate], [DocCur], [CreateDate], [ObjType], [incCustom], [U_FolioHalcon], [U_FolioSolicitud], [U_Autorizado], [U_EstadoEntrega], [U_EmpresaRel])
			VALUES
			   (@DocEntry, @DocEntry, @DocDate, @DocDueDate, @DocCur, GETDATE(), @ObjType, 'Y', @U_FolioHalcon, @U_FolioSolicitud, @U_Autorizado, @U_EstadoEntrega, @CIA)
			   
			SELECT @DocEntry[DocEntry]
		END
	END

	--INSERTA BORRADOR PARA PRECIOS DE ENTREGA EN SAP(DETALLE)
	IF @TipoConsulta = 123
	BEGIN
		INSERT INTO [sap].[IPF1]
           ([DocEntry], [LineNum], [BaseType], [BaseEntry])
		VALUES
           (@DocEntry, @LineNum, @BaseType, @BaseEntry)
	END

	--INSERTA BORRADOR PARA PRECIOS DE ENTREGA EN SAP(COSTOS)
	IF @TipoConsulta = 124
	BEGIN
		INSERT INTO [sap].[IPF2]
           ([DocEntry], [LineNum], [AlcCode], [OhType], [CostSum], [InCustCalc])
		VALUES
           (@DocEntry, @LineNum, @AlcCode, @OhType, @CostSum, @InCustCalc)
	END

	--ACTUALIZAR PRECIOS DE ENTREGA
	IF @TipoConsulta = 125
	BEGIN
		IF @DocNumSAP = 0 
			SET @DocnumSAP = NULL

		UPDATE sap.OIPF SET TransId = @DocNumSAP, U_ActMessage = @Comments WHERE DocNum = @DocEntry
		
		SET @U_EstadoEntrega = (SELECT U_EstadoEntrega FROM sap.OIPF WHERE DocEntry = @DocEntry)
		EXEC [dbo].[up_accounting_PreciosEntrega] @TipoConsulta = 4, @OPC = 7, @Empresa = @CIA, @DocEntry = @DocNumSAP, @U_EstadoEntrega = @U_EstadoEntrega
	END

	--ACTUALIZAR NORMAS DE REPARTO
	IF @TipoConsulta = 126
	BEGIN
		SELECT 
			PrcCode, CASE Active WHEN 'Y' THEN CAST(0 AS BIT) ELSE CAST(1 AS BIT) END [Active]
		FROM SBOCTRZ.DBO.OPRC WHERE PrcCode NOT IN(
		SELECT PrcCode FROM SBOCTRZ.DBO.OPRC WHERE UserSign = 1 AND GrpCode IS NOT NULL
		AND GrpCode <> 'FLET'
		UNION ALL
		SELECT PrcCode FROM SBOCTRZ.DBO.OPRC WHERE dimcode = 1)
	END

	--INSERTA BORRADOR PARA REVALORIZACIONES DE INVENTARIO EN SAP(ENCABEZADO)
	IF @TipoConsulta = 127
	BEGIN
		IF NOT EXISTS(SELECT * FROM sap.[OMRV] WHERE [DocEntry] = @DocEntry)
		BEGIN
			SELECT @DocEntry = ISNULL(MAX([DocEntry]), 0) + 1 FROM sap.[OMRV]
			INSERT INTO [sap].[OMRV]
				([DocEntry],[DocNum],[DocDate],[Ref2],[JrnlMemo],[Comments],[U_Autorizado],[U_FolioHalcon],[U_FolioSolicitud])
			VALUES
				(@DocEntry, @DocEntry, GETDATE(), @Reference, @JrnlMemo, @Comments, @U_Autorizado, @U_FolioHalcon, @U_FolioSolicitud)

			SELECT @DocEntry[DocEntry]
		END
	END

	--INSERTA BORRADOR PARA REVALORIZACIONES DE INVENTARIO EN SAP(DETALLE)
	IF @TipoConsulta = 128
	BEGIN
		INSERT INTO [sap].[MRV1]
			([DocEntry],[LineNum],[ItemCode],[Price],[WhsCode],[RIncmAcct],[RDcrmAcct],[OcrCode])
		VALUES
           (@DocEntry, @LineNum, @ItemCode, @Price, @WhsCode, @AcctCode, @AcctCode,@OcrCode)
	END

	--ACTUALIZAR PRECIOS DE ENTREGA
	IF @TipoConsulta = 129
	BEGIN
		IF @DocNumSAP = 0 
			SET @DocnumSAP = NULL

		UPDATE sap.[OMRV] SET TransId = @DocNumSAP, U_ActMessage = @Comments WHERE DocEntry = @DocEntry
	END

	--INSERTA BORRADOR DE DEVOLUCIONES EN SAP PARA PROVEEDORES(DETALLE)
	IF @TipoConsulta = 130
	BEGIN
		SET @LineNum = ISNULL((SELECT MAX(LineId) + 1 FROM sap.VPM4 WHERE DocNum = @DocNum), 0)

		INSERT INTO sap.VPM4
		([DocNum],[LineId], [AcctCode], [SumApplied],[AppliedFC], [AppliedSys], [Descrip], [ObjType])
		VALUES
		(@DocNum, @LineNum, @AcctCode, @SumApplied, @AppliedFC, @SumApplied, @Comments, @ObjType)

		SELECT @LineNum
	END

	--IF @TipoConsulta = 99999 --Consulta que va a reemplazar la 103
	--BEGIN
	--	IF(@ObjType = 13)
	--	BEGIN
	--		Select TOP 10
	--			'DPJ' Empresa,
	--			A.ObjType, 
	--			A.DocEntry,
	--			ISNULL(B.ReportId, C.ReportID),
	--			'DPJ001122MA2' Rfc,
	--			A.LicTradNum,
	--			CAST(CASE WHEN A.DocCur = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
	--			ISNULL(RIGHT(CAST(B.U_B1SYS_SignDigest AS VARCHAR(MAX)), 8), RIGHT(CAST(C.U_B1SYS_SignDigest AS VARCHAR(MAX)), 8)) Sello
	--		FROM SBOCTRZ.dbo.OINV A
	--			LEFT JOIN sap.ECM2 B ON A.DocEntry = B.SrcObjAbs AND A.ObjType = B.SrcObjType
	--			LEFT JOIN SBOCTRZ.dbo.ECM2 C ON A.DocEntry = C.SrcObjAbs AND A.ObjType = C.SrcObjType
	--		WHERE 
	--			DocEntry Not IN (Select X.DocEntry From sap.Document_QR X WHERE X.ObjType = 13) and 
	--			ISNULL(ISNULL(B.ReportId, C.ReportId), '') != '' 
	--		ORDER BY DOCDATE DESC
	--	END	
	--	IF(@ObjType = 14)
	--	BEGIN
	--		Select TOP 10
	--			'DPJ' Empresa,
	--			A.ObjType, 
	--			A.DocEntry,
	--			ISNULL(B.ReportId, C.ReportID),
	--			'DPJ001122MA2' Rfc,
	--			A.LicTradNum,
	--			CAST(CASE WHEN A.DocCur = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
	--			ISNULL(RIGHT(CAST(B.U_B1SYS_SignDigest AS VARCHAR(MAX)), 8), RIGHT(CAST(C.U_B1SYS_SignDigest AS VARCHAR(MAX)), 8)) Sello
	--		FROM SBOCTRZ.dbo.ORIN A
	--			LEFT JOIN sap.ECM2 B ON A.DocEntry = B.SrcObjAbs AND A.ObjType = B.SrcObjType
	--			LEFT JOIN SBOCTRZ.dbo.ECM2 C ON A.DocEntry = C.SrcObjAbs AND A.ObjType = C.SrcObjType
	--		WHERE 
	--			DocEntry Not IN (Select X.DocEntry From sap.Document_QR X WHERE X.ObjType = 14) and 
	--			ISNULL(ISNULL(B.ReportId, C.ReportId), '') != '' AND ISNULL(RIGHT(CAST(B.U_B1SYS_SignDigest AS VARCHAR(MAX)), 8), RIGHT(CAST(C.U_B1SYS_SignDigest AS VARCHAR(MAX)), 8)) <> ''
	--		ORDER BY DOCDATE DESC
	--	END	
	--	IF(@ObjType = 24)
	--	BEGIN
	--		Select TOP 10
	--			'DPJ' Empresa,	
	--			A.ObjType, 
	--			A.DocEntry,
	--			ISNULL(B.ReportId, C.ReportID),
	--			'DPJ001122MA2' Rfc,
	--			D.LicTradNum,
	--			CAST(CASE WHEN A.DocCurr = 'USD' THEN DocTotalFC ELSE DocTotal END AS DECIMAL(18, 2)) DocTotal,
	--			ISNULL(RIGHT(CAST(B.U_B1SYS_SignDigest AS VARCHAR(MAX)), 8), RIGHT(CAST(C.U_B1SYS_SignDigest AS VARCHAR(MAX)), 8)) Sello
	--		FROM SBOCTRZ.dbo.ORCT A
	--			LEFT JOIN sap.ECM2 B ON A.DocEntry = B.SrcObjAbs AND A.ObjType = B.SrcObjType
	--			LEFT JOIN SBOCTRZ.dbo.ECM2 C ON A.DocEntry = C.SrcObjAbs AND C.SrcObjType = 24
	--			JOIN SBOCTRZ.dbo.OCRD D ON A.CardCode = D.CardCode
	--		WHERE 
	--			A.DocEntry Not IN (Select X.DocEntry From sap.Document_QR X WHERE X.ObjType = 24) AND
	--			ISNULL(ISNULL(B.ReportId, C.ReportId), '') != '' 
	--			ORDER BY DOCDATE DESC
	--	END	
	--END

END

--SELECT * FROM SBOCTRZ.dbo.ocry-----------------
